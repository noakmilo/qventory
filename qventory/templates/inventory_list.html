{% extends "base_new.html" %}

{% block title %}{{ page_title }} ‚Äì Qventory{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">/</span>
<a href="{{ url_for('main.inventory_active') }}">Inventory</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">{{ page_title }}</span>
{% endblock %}

{% block content %}
<div data-username="{{ current_user.username }}" style="display:none"></div>

<div class="inventory-container page-shell page-shell--wide">

  <!-- Page Header -->
  <div style="margin-bottom:24px;">
    <h1 style="color:var(--text);font-size:28px;margin-bottom:8px;">
      {% if view_type == 'active' %}
        <i class="fas fa-box"></i> Active Inventory
      {% elif view_type == 'sold' %}
        <i class="fas fa-check-circle"></i> Sold Items
      {% elif view_type == 'inactive_user' %}
        <i class="fas fa-eye-slash"></i> Inactive Items
      {% elif view_type == 'ended' %}
        <i class="fas fa-times-circle"></i> Ended Inventory
      {% endif %}
    </h1>
    <p style="color:var(--text-secondary);font-size:14px;">
      {% if view_type == 'active' %}
        Items currently active and available for sale
      {% elif view_type == 'sold' %}
        Items that have been sold
      {% elif view_type == 'inactive_user' %}
        Items hidden from your active inventory
      {% elif view_type == 'ended' %}
        Items that are no longer active
      {% endif %}
    </p>
  </div>

  {% if view_type == 'active' and show_upgrade_banner|default(False) %}
  <div id="upgradePlanBanner" class="plan-upgrade-banner" data-dismiss-key="{{ upgrade_banner_dismiss_key|default('upgrade_banner_dismissed') }}" style="display:none;margin-bottom:16px;padding:16px 20px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.08);position:relative;overflow:hidden;">
    <button type="button" class="plan-upgrade-banner__close" data-dismiss-button aria-label="Dismiss upgrade reminder" style="position:absolute;top:12px;right:12px;background:none;border:none;color:var(--sub);font-size:18px;cursor:pointer;padding:4px;">&times;</button>
    <div style="display:flex;gap:16px;align-items:flex-start;">
      <div style="color:#dc2626;font-size:22px;"><i class="fas fa-exclamation-triangle"></i></div>
      <div style="flex:1;">
        <div style="font-weight:600;color:#dc2626;margin-bottom:4px;">Inventory limit reached</div>
        <div style="color:var(--sub);font-size:14px;line-height:1.5;">
          {% if items_remaining is not none and items_remaining <= 0 %}
            You cannot add more inventory items on the current plan.
          {% else %}
            You are close to your inventory limit. Only {{ items_remaining }} slot{{ '' if items_remaining == 1 else 's' }} remain out of {{ plan_max_items }}.
          {% endif %}
          Upgrade to unlock additional capacity.
        </div>
        <div style="margin-top:12px;">
          <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn" style="display:inline-block;">
            <i class="fas fa-arrow-up"></i> Upgrade Plan
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Filters Card -->
  <div id="filtersShell" class="card cardfilters filters-shell" style="margin-bottom:20px;">
    <div class="filters-bar">
      <h2>Filters</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="filtersToggle" class="btn filters-toggle submitbtn" type="button" aria-expanded="true">
          <i class="fas fa-filter"></i> Toggle
        </button>
      </div>
    </div>
    <div id="filtersContent" class="filters-content">
      <form id="filterForm" method="get" action="{{ request.path }}" class="filters-grid">
        <input type="hidden" name="page" value="1">
        <input type="hidden" name="per_page" value="{{ pagination.per_page }}">
        {% if sort_by %}
        <input type="hidden" name="sort" value="{{ sort_by }}">
        {% endif %}
        {% if sort_dir %}
        <input type="hidden" name="dir" value="{{ sort_dir }}">
        {% endif %}
        <div style="grid-column:1/-1">
          <div class="input-with-button" style="position:relative">
            <input class="input" type="text" id="q" name="q" placeholder="Search title / SKU / supplier‚Ä¶" autocomplete="off">
            <div id="dashboardAutocompleteList" class="autocomplete-list"></div>
            <button class="icon-btn" type="button" id="btnScanQR" title="Scan QR code with camera" aria-label="Scan QR code">
              <i class="fas fa-qrcode"></i>
            </button>
          </div>
        </div>

        {# Dynamic Filters #}
        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A">
            <option value="">All</option>
            {% for opt in options.A %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B">
            <option value="">All</option>
            {% for opt in options.B %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S">
            <option value="">All</option>
            {% for opt in options.S %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C">
            <option value="">All</option>
            {% for opt in options.C %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {# Missing Data Filter (only for Active inventory) #}
        {% if view_type == 'active' or view_type == 'slow_movers' %}
        <div>
          <label>Missing Data</label>
          <select name="missing_data">
            <option value="">All items</option>
            <option value="any">Any missing data</option>
            <option value="cost">Missing cost</option>
            <option value="supplier">Missing supplier</option>
            <option value="location">Missing location</option>
          </select>
        </div>
        {% endif %}

        <div style="grid-column:1/-1">
          <button class="btn submitbtn" type="submit">Apply</button>
          <a class="btn" href="{{ request.path }}">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Inventory Table Card -->
  <div class="card inventory-shell">
    <div class="items-header">
      <h2>Items ({{ total_items }})</h2>
      <div class="backup-actions">
        <!-- Bulk Actions -->
        <div id="bulkActionsContainer" style="display:none;margin-right:10px">
          <select id="bulkActionSelect" class="input" style="display:inline-block;width:auto;padding:0.5rem;margin-right:5px">
            <option value="">Bulk Actions</option>
            {% if view_type == 'active' or view_type == 'slow_movers' %}
            <option value="bulk_update">Batch Update Fields</option>
            <option value="deactivate_by_user">Deactivate (Hide from Active)</option>
            <option value="retire_items">Move to Retirements (Copy)</option>
            {% elif view_type == 'inactive_user' %}
            <option value="reactivate_by_user">Reactivate (Show in Active)</option>
            {% elif view_type == 'retired' %}
            <option value="purge_retired">Purge on eBay</option>
            {% endif %}
            {# Sync to eBay (kept for later) #}
            {#
            {% if view_type == 'active' %}
            <option value="sync_to_ebay">Sync to eBay</option>
            {% endif %}
            #}
            {% if view_type != 'retired' %}
            <option value="delete">Delete Selected</option>
            {% endif %}
          </select>
          <button id="bulkActionApply" class="btn" style="padding:0.5rem 1rem">
            <i class="fas fa-check"></i> Apply
          </button>
          <span id="bulkSelectedCount" style="margin-left:10px;color:var(--sub);font-size:var(--fs-sm)"></span>
        </div>
        {% if view_type == 'active' or view_type == 'slow_movers' %}
        <button id="bulkEditOpenBtn" class="btn" style="display:none;margin-right:10px">
          <i class="fas fa-layer-group"></i> Bulk Edit
        </button>
        {% endif %}

        <a class="btn backup-btn" href="{{ url_for('main.export_csv') }}" title="Export all items to CSV">
          <i class="fas fa-download"></i> Export
        </a>
        {% if view_type == 'active' %}
        <a class="btn backup-btn" href="{{ url_for('main.import_csv') }}" title="Import items from CSV">
          <i class="fas fa-upload"></i> Non-eBay Import
        </a>
        {# Sync eBay (kept for later) #}
        {#
        <button id="syncEbayActiveBtn" class="btn backup-btn" title="Sync existing inventory with eBay">
          <i class="fas fa-sync-alt"></i> Sync eBay
        </button>
        #}
        {% elif view_type == 'sold' %}
        {# Sync eBay Sales (kept for later) #}
        {#
        <button id="syncEbaySoldBtn" class="btn backup-btn" title="Sync sold items with eBay">
          <i class="fas fa-sync-alt"></i> Sync eBay Sales
        </button>
        #}
        {% endif %}
      </div>
    </div>

    <div class="table-wrap">
      {% set un = current_user.username %}
      <table class="inventory-table{% if view_type == 'sold' %} inventory-table--sold{% endif %}">
        <thead>
          {% if view_type == 'sold' %}
          <tr>
            <th data-col="photo" style="width:44px"></th>
            <th data-col="title">
              <span class="col-header sort-header" data-sort-key="title" data-default-dir="asc">
                Title
                {% if sort_by == 'title' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="supplier" class="mobile-hide">
              <span class="col-header sort-header" data-sort-key="supplier" data-default-dir="asc">Supplier
                {% if sort_by == 'supplier' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="cost">
              <span class="col-header sort-header" data-sort-key="cost" data-default-dir="desc">Cost
                {% if sort_by == 'cost' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="sold_price">
              <span class="col-header sort-header" data-sort-key="sold_price" data-default-dir="desc">Sold Price
                {% if sort_by == 'sold_price' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="tax" class="mobile-hide">
              <span class="col-header">Tax
              </span>
            </th>
            <th data-col="shipping_charged" class="mobile-hide">
              <span class="col-header sort-header" data-sort-key="shipping_charged" data-default-dir="desc">Shipping Charged
                {% if sort_by == 'shipping_charged' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="shipping_cost" class="mobile-hide">
              <span class="col-header sort-header" data-sort-key="shipping_cost" data-default-dir="desc">Shipping Cost
                {% if sort_by == 'shipping_cost' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="fees" class="mobile-hide">
              <span class="col-header">Total Marketplace Fees
              </span>
            </th>
            <th data-col="refund" class="mobile-hide">
              <span class="col-header">Refund</span>
            </th>
            <th data-col="net_profit">
              <span class="col-header sort-header" data-sort-key="net_profit" data-default-dir="desc">Net Profit
                {% if sort_by == 'net_profit' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
              <button class="tooltip-icon net-profit-info" type="button" aria-label="Net profit calculation info">
                <i class="fas fa-info-circle"></i>
              </button>
            </th>
            <th data-col="sold_at">
              <span class="col-header sort-header" data-sort-key="sold_at" data-default-dir="desc">Sold At
                {% if sort_by == 'sold_at' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="location">
              <span class="col-header sort-header" data-sort-key="location" data-default-dir="asc">Location
                {% if sort_by == 'location' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="listings" class="mobile-hide">
              <span class="col-header">Listings
              </span>
            </th>
          </tr>
          {% else %}
          <tr>
            <th data-col="select" style="width:40px;text-align:center">
              <span class="col-header col-header--center">
                <input type="checkbox" id="selectAllCheckbox" title="Select all items" style="cursor:pointer">
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="select" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            <th data-col="photo" style="width:44px"></th>
            <th data-col="title">
              <span class="col-header sort-header" data-sort-key="title" data-default-dir="asc">
                Title
                {% if sort_by == 'title' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="sku">
              <span class="col-header sort-header" data-sort-key="sku" data-default-dir="asc">SKU
                {% if sort_by == 'sku' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="sku" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            <th data-col="supplier" class="mobile-hide">
              <span class="col-header sort-header" data-sort-key="supplier" data-default-dir="asc">Supplier
                {% if sort_by == 'supplier' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="supplier" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            <th data-col="cost">
              <span class="col-header sort-header" data-sort-key="cost" data-default-dir="desc">Cost
                {% if sort_by == 'cost' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="cost" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            <th data-col="price">
              <span class="col-header sort-header" data-sort-key="price" data-default-dir="desc">Price
                {% if sort_by == 'price' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="price" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            {% if view_type == 'retired' %}
            <th data-col="status">
              <span class="col-header sort-header" data-sort-key="status" data-default-dir="asc">Status
                {% if sort_by == 'status' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
              </span>
            </th>
            <th data-col="note">
              <span class="col-header">Note</span>
            </th>
            {% else %}
            <th data-col="roi" class="mobile-hide">
              <span class="col-header">ROI
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="roi" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            {% endif %}
            <th data-col="location">
              <span class="col-header sort-header" data-sort-key="location" data-default-dir="asc">Location
                {% if sort_by == 'location' %}
                  <span class="sort-indicator">{{ '‚ñ≤' if sort_dir == 'asc' else '‚ñº' }}</span>
                {% endif %}
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="location" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            <th data-col="listings" class="mobile-hide">
              <span class="col-header">Listings
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="listings" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
            <th data-col="actions">
              <span class="col-header col-header--center">
                {% if view_type == 'sold' %}
                <button class="col-toggle" type="button" data-col-toggle="actions" title="Hide column" aria-label="Hide column" aria-pressed="false">
                  <i class="fas fa-eye"></i>
                </button>
                {% endif %}
              </span>
            </th>
          </tr>
          {% endif %}
        </thead>
        <tbody id="itemsTableBody">
          {% for it in items %}
            {% include "_item_row.html" %}
          {% endfor %}
        </tbody>
      </table>

      {% if total_items == 0 %}
      <div style="text-align:center;padding:60px 20px;color:var(--sub);">
        <i class="fas fa-box-open" style="font-size:64px;opacity:0.3;margin-bottom:20px;display:block;"></i>
        <p style="font-size:18px;margin-bottom:8px;">No items found</p>
        <p style="font-size:14px;">
          {% if view_type == 'active' %}
            Add items to your inventory to get started
          {% elif view_type == 'sold' %}
            No items have been sold yet
          {% elif view_type == 'slow_movers' %}
            No slow movers yet
          {% elif view_type == 'retired' %}
            No items in Retirements yet
          {% elif view_type == 'ended' %}
            No ended items found
          {% endif %}
        </p>
      </div>
      {% endif %}
    </div>

    <div class="pagination-bar">
      <div class="pagination-info">
        {% if pagination.total_items %}
          Showing {{ pagination.start_index }}‚Äì{{ pagination.end_index }} of {{ pagination.total_items }} items
        {% else %}
          No items to display
        {% endif %}
      </div>
      <div class="pagination-controls">
        <form method="get" class="pagination-size">
          <input type="hidden" name="page" value="1">
          {% for key, value in request.args.items() %}
            {% if key not in ['per_page', 'page'] %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
          {% endfor %}
          <label for="perPageSelect">Per page:</label>
          <select id="perPageSelect" name="per_page" onchange="this.form.submit()">
            {% for option in pagination.per_page_links %}
              <option value="{{ option.value }}" {% if option.active %}selected{% endif %}>{{ option.value }}</option>
            {% endfor %}
          </select>
        </form>
        <nav class="pagination-nav" aria-label="Inventory pagination">
          {% if pagination.has_prev %}
            <a class="pagination-link" href="{{ pagination.prev_url }}">&laquo; Prev</a>
          {% else %}
            <span class="pagination-link disabled">&laquo; Prev</span>
          {% endif %}

          {% for link in pagination.page_links %}
            {% if link.ellipsis %}
              <span class="pagination-ellipsis">‚Ä¶</span>
            {% else %}
              {% if link.active %}
                <span class="pagination-link active">{{ link.number }}</span>
              {% else %}
                <a class="pagination-link" href="{{ link.url }}">{{ link.number }}</a>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if pagination.has_next %}
            <a class="pagination-link" href="{{ pagination.next_url }}">Next &raquo;</a>
          {% else %}
            <span class="pagination-link disabled">Next &raquo;</span>
          {% endif %}
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Include the same modals as dashboard -->
<!-- QR Modal for Locations -->
<div id="qrModal" class="qr-modal hidden" role="dialog" aria-hidden="true" aria-labelledby="qrTitle">
  <div class="qr-sheet">
    <div class="qr-header">
      <strong id="qrTitle"><i class="fas fa-qrcode"></i> QR</strong>
      <div class="qr-actions">
        <a id="qrOpenNew" class="qr-icon" href="#" target="_blank" title="Open in new tab" aria-label="Open in new tab">
          <i class="fas fa-external-link-alt"></i>
          <span class="sr-only">Open in new tab</span>
        </a>
        <button type="button" id="qrClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport">
        <img id="qrImage" alt="QR code">
      </div>
      <div id="qrCaption" class="qr-tip"></div>
    </div>
  </div>
</div>

<!-- Update & Relist Modal -->
<div id="relistModal" class="qr-modal hidden" role="dialog" aria-hidden="true" aria-label="Update & Relist">
  <div class="qr-sheet relist-sheet" style="max-width:560px;width:92vw;">
    <div class="qr-header">
      <strong><i class="fas fa-sync" style="color:#f97316;"></i> Update & Relist</strong>
      <div class="qr-actions">
        <button type="button" id="relistClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body" style="padding:16px;">
      <form id="relistForm" class="relist-form" style="display:grid;gap:12px;">
        <input type="hidden" id="relistItemId">
        <div>
          <label style="display:block;margin-bottom:6px;color:var(--text);">Title</label>
          <input class="input relist-title-input" type="text" id="relistTitle" placeholder="Listing title">
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;color:var(--text);">Price</label>
          <input class="input" type="number" id="relistPrice" step="0.01" min="0" placeholder="0.00">
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button type="button" class="btn" id="relistPriceMinus5" style="padding:6px 10px;font-size:12px;">-5%</button>
            <button type="button" class="btn" id="relistPriceMinus10" style="padding:6px 10px;font-size:12px;">-10%</button>
            <button type="button" class="btn" id="relistPriceMinus15" style="padding:6px 10px;font-size:12px;">-15%</button>
          </div>
          <div id="relistMarginWarning" style="display:none;margin-top:8px;font-size:12px;color:#fca5a5;">
            New price is below cost. This may reduce your margin.
          </div>
        </div>
        <button type="submit" class="btn submitbtn relist-cta" id="relistSubmit">
          Relist Now
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imgModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Image viewer">
  <div class="qr-sheet" style="max-width:90vw;width:auto">
    <div class="qr-header">
      <strong><i class="fas fa-image"></i> Image</strong>
      <div class="qr-actions">
        <button type="button" id="imgClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="img-viewport">
        <img id="imgModalImg" alt="">
      </div>
    </div>
  </div>
</div>

<!-- Location Modal -->
<div id="locationInlineModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Edit location">
  <div class="qr-sheet location-modal">
    <div class="qr-header">
      <strong><i class="fas fa-map-marker-alt"></i> Edit Location</strong>
      <div class="qr-actions">
        <button type="button" id="locationModalScanQR" class="qr-icon" title="Scan QR to populate location" aria-label="Scan QR code">
          <i class="fas fa-qrcode"></i>
        </button>
        <button type="button" id="locationModalClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <form id="locationModalForm" class="location-modal__body">
      <div id="locationModalFields" class="inline-edit__grid">
        {# Fields are injected by dashboard.js based on row data-enable flags #}
      </div>
      <div class="inline-edit__actions">
        <button type="submit" class="inline-edit__action">Save &amp; Sync</button>
        <button type="button" class="inline-edit__action inline-edit__cancel" id="locationModalCancel">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk Location Assignment Modal -->
<div id="bulkLocationModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Bulk assign location">
  <div class="qr-sheet location-modal">
    <div class="qr-header">
      <strong><i class="fas fa-map-marker-alt"></i> Bulk Assign Location</strong>
      <div class="qr-actions">
        <button type="button" onclick="closeBulkLocationModal()" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <form id="bulkLocationForm" class="location-modal__body">
      <div style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:6px;padding:12px;margin-bottom:16px;">
        <div style="font-size:13px;color:var(--sub)">
          <i class="fas fa-info-circle" style="color:#60a5fa;"></i>
          Assigning location to <strong id="bulkLocationCount" style="color:#60a5fa;">0</strong> selected item(s)
        </div>
      </div>

      <div class="inline-edit__grid">
        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A" class="input">
            <option value="">‚Äî None ‚Äî</option>
            {% for opt in options.A %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B" class="input">
            <option value="">‚Äî None ‚Äî</option>
            {% for opt in options.B %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S" class="input">
            <option value="">‚Äî None ‚Äî</option>
            {% for opt in options.S %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C" class="input">
            <option value="">‚Äî None ‚Äî</option>
            {% for opt in options.C %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--glass-border);">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" name="sync_to_ebay" id="bulkSyncToEbay" style="cursor:pointer;">
          <span style="font-size:14px;">
            <i class="fab fa-ebay" style="color:#E53238;"></i>
            Sync location to eBay SKU (for eBay items only)
          </span>
        </label>
        <div style="font-size:12px;color:var(--sub);margin-top:4px;margin-left:28px;">
          Updates the Custom SKU field in eBay for items that have an eBay listing ID
        </div>
      </div>

      <div class="inline-edit__actions" style="margin-top:16px;">
        <button type="submit" class="inline-edit__action">
          <i class="fas fa-check"></i> Assign Location
        </button>
        <button type="button" class="inline-edit__action inline-edit__cancel" onclick="closeBulkLocationModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk Update Modal -->
<div id="bulkEditModal" class="modal" hidden>
  <div class="modal__backdrop" data-modal-close="bulkEdit"></div>
  <div class="modal__dialog modal__dialog--wide" role="dialog" aria-modal="true" aria-labelledby="bulkEditTitle">
    <div class="modal__header">
      <h3 id="bulkEditTitle"><i class="fas fa-layer-group"></i> Batch Update Selected Items</h3>
      <button class="modal__close" type="button" data-modal-close="bulkEdit" aria-label="Close">√ó</button>
    </div>
    <form id="bulkEditForm" class="modal__body">
      <div style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:8px;padding:12px;margin-bottom:16px;">
        <div style="font-size:13px;color:var(--sub)">
          <i class="fas fa-info-circle" style="color:#60a5fa;"></i>
          Updating <strong id="bulkEditCount" style="color:#60a5fa;">0</strong> selected item(s)
          <button type="button" id="bulkEditToggleItems" class="btn" style="padding:2px 8px;margin-left:8px;font-size:12px;">
            Show items
          </button>
        </div>
        <div id="bulkEditSelectedList" style="display:none;margin-top:10px;font-size:12px;color:var(--sub);">
          <div style="max-height:120px;overflow:auto;border-top:1px solid rgba(96,165,250,0.2);padding-top:8px;"></div>
        </div>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
        <button type="button" class="btn" data-bulk-preset="supplier_cost">
          <i class="fas fa-receipt"></i> Supplier + Cost
        </button>
        <button type="button" class="btn" data-bulk-preset="location_sync">
          <i class="fas fa-map-marker-alt"></i> Location + Sync
        </button>
        <button type="button" class="btn" data-bulk-preset="all">
          <i class="fas fa-layer-group"></i> All Fields
        </button>
      </div>

      <div style="display:grid;gap:16px;">
        <div style="border:1px solid var(--border);border-radius:12px;padding:14px;">
          <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <input type="checkbox" id="bulkEditApplySupplier" name="apply_supplier">
            <span style="font-weight:600;">Update Supplier</span>
          </label>
          <div class="bulk-edit-supplier" style="position:relative;">
            <input type="text" name="supplier" id="bulkEditSupplier" class="input" placeholder="Supplier name" autocomplete="off" disabled>
            <div id="bulkEditSupplierList" class="autocomplete-list"></div>
          </div>
          <div style="font-size:12px;color:var(--sub);margin-top:6px;">Leave empty to clear supplier.</div>
        </div>

        <div style="border:1px solid var(--border);border-radius:12px;padding:14px;">
          <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <input type="checkbox" id="bulkEditApplyCost" name="apply_cost">
            <span style="font-weight:600;">Update Cost</span>
          </label>
          <input type="number" name="item_cost" id="bulkEditCost" class="input" step="0.01" min="0" placeholder="0.00" disabled>
          <div style="font-size:12px;color:var(--sub);margin-top:6px;">Use 0 if needed. Leave empty to clear.</div>
        </div>

        <div style="border:1px solid var(--border);border-radius:12px;padding:14px;">
          <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <input type="checkbox" id="bulkEditApplyLocation" name="apply_location">
            <span style="font-weight:600;">Update Location</span>
          </label>
          <div class="inline-edit__grid">
            {% if settings.enable_A %}
            <div>
              <label>{{ settings.label_A }}</label>
              <input name="A" class="input bulk-edit-location" list="bulkEditLocationA" disabled>
              <datalist id="bulkEditLocationA">
                {% for opt in options.A %}
                <option value="{{ opt }}"></option>
                {% endfor %}
              </datalist>
            </div>
            {% endif %}

            {% if settings.enable_B %}
            <div>
              <label>{{ settings.label_B }}</label>
              <input name="B" class="input bulk-edit-location" list="bulkEditLocationB" disabled>
              <datalist id="bulkEditLocationB">
                {% for opt in options.B %}
                <option value="{{ opt }}"></option>
                {% endfor %}
              </datalist>
            </div>
            {% endif %}

            {% if settings.enable_S %}
            <div>
              <label>{{ settings.label_S }}</label>
              <input name="S" class="input bulk-edit-location" list="bulkEditLocationS" disabled>
              <datalist id="bulkEditLocationS">
                {% for opt in options.S %}
                <option value="{{ opt }}"></option>
                {% endfor %}
              </datalist>
            </div>
            {% endif %}

            {% if settings.enable_C %}
            <div>
              <label>{{ settings.label_C }}</label>
              <input name="C" class="input bulk-edit-location" list="bulkEditLocationC" disabled>
              <datalist id="bulkEditLocationC">
                {% for opt in options.C %}
                <option value="{{ opt }}"></option>
                {% endfor %}
              </datalist>
            </div>
            {% endif %}
          </div>
          <div style="margin-top:10px;font-size:12px;color:var(--sub);">
            Location preview: <span id="bulkEditLocationPreview" style="color:#60a5fa;font-weight:600;">‚Äî</span>
          </div>
          <div style="margin-top:12px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" name="sync_to_ebay" id="bulkEditSyncToEbay" disabled>
              <span style="font-size:14px;">
                <i class="fab fa-ebay" style="color:#E53238;"></i>
                Sync location to eBay SKU (for eBay items only)
              </span>
            </label>
            <div style="font-size:12px;color:var(--sub);margin-top:4px;margin-left:28px;">
              Updates the Custom SKU field in eBay for items with an eBay listing ID.
            </div>
          </div>
        </div>
      </div>
    </form>
    <div class="modal__footer">
      <button type="submit" form="bulkEditForm" class="btn submitbtn">
        <i class="fas fa-check"></i> Apply Selected Fields
      </button>
      <button type="button" class="btn" data-modal-close="bulkEdit">Cancel</button>
    </div>
  </div>
</div>

<!-- QR Scanner Modal -->
<div id="scanQRModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="QR Scanner">
  <div class="qr-sheet" style="max-width:480px">
    <div class="qr-header">
      <strong><i class="fas fa-qrcode"></i> Scan QR Code</strong>
      <div class="qr-actions">
        <button type="button" id="scanQRFlip" class="qr-icon" title="Flip camera" aria-label="Flip camera">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button type="button" id="scanQRFlashlight" class="qr-icon" title="Toggle flashlight" aria-label="Toggle flashlight">
          <i class="fas fa-lightbulb"></i>
        </button>
        <button type="button" id="scanQRClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport" style="position:relative;background:#000">
        <video id="scanQRVideo" style="width:100%;height:100%;object-fit:cover;display:none" playsinline autoplay muted></video>
        <div id="scanQRSpinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:#fff;font-size:24px">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div id="scanQRSuccess" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,200,100,0.3);color:#fff;font-size:48px;pointer-events:none">
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
      <div id="scanQRResult" class="qr-tip" style="display:none;color:#4ade80"></div>
      <div class="qr-tip">Position QR code within camera view</div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='dashboard.js') }}?v=retirements-1"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const upgradeBanner = document.getElementById('upgradePlanBanner');
  if (!upgradeBanner) {
    return;
  }

  const storage = (() => {
    try {
      return window.localStorage;
    } catch (_err) {
      return null;
    }
  })();

  const storageKey = upgradeBanner.dataset.dismissKey;
  if (storageKey && storage && storage.getItem(storageKey) === 'dismissed') {
    upgradeBanner.remove();
    return;
  }

  upgradeBanner.style.display = 'flex';

  const closeBtn = upgradeBanner.querySelector('[data-dismiss-button]');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      if (storageKey && storage) {
        storage.setItem(storageKey, 'dismissed');
      }
      upgradeBanner.remove();
    });
  }
});

// ==================== AUTOCOMPLETE ====================
(function() {
  const searchInput = document.getElementById('q');
  const autocompleteList = document.getElementById('dashboardAutocompleteList');
  const viewType = '{{ view_type }}'; // active, sold, or ended

  if (!searchInput || !autocompleteList) return;

  let debounceTimer;

  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();

    clearTimeout(debounceTimer);

    if (query.length < 2) {
      autocompleteList.classList.remove('show');
      autocompleteList.innerHTML = '';
      return;
    }

    debounceTimer = setTimeout(() => fetchAutocomplete(query), 300);
  });

  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteList.contains(e.target)) {
      autocompleteList.classList.remove('show');
    }
  });

  searchInput.addEventListener('keydown', function(e) {
    const items = autocompleteList.querySelectorAll('.autocomplete-item');
    const activeItem = autocompleteList.querySelector('.autocomplete-item.active');
    let index = Array.from(items).indexOf(activeItem);

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      index = Math.min(index + 1, items.length - 1);
      setActiveItem(items, index);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      index = Math.max(index - 1, 0);
      setActiveItem(items, index);
    } else if (e.key === 'Enter' && activeItem) {
      e.preventDefault();
      activeItem.click();
    } else if (e.key === 'Escape') {
      autocompleteList.classList.remove('show');
    }
  });

  function fetchAutocomplete(query) {
    fetch(`/api/autocomplete-items?q=${encodeURIComponent(query)}&view_type=${viewType}`)
      .then(response => response.json())
      .then(data => {
        if (data.ok && data.items) {
          displayResults(data.items);
        }
      })
      .catch(error => console.error('Autocomplete error:', error));
  }

  function displayResults(items) {
    autocompleteList.innerHTML = '';

    if (items.length === 0) {
      autocompleteList.classList.remove('show');
      return;
    }

    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <strong style="color:var(--text)">${highlightMatch(item.title, searchInput.value)}</strong>
          <div style="font-size:12px;color:var(--text-secondary);display:flex;gap:12px;flex-wrap:wrap">
            ${item.sku ? `<span>SKU: ${highlightMatch(item.sku, searchInput.value)}</span>` : ''}
            ${item.supplier ? `<span>Supplier: ${highlightMatch(item.supplier, searchInput.value)}</span>` : ''}
            ${item.location_code ? `<span>üìç ${item.location_code}</span>` : ''}
          </div>
        </div>
      `;

      div.addEventListener('click', () => {
        searchInput.value = item.title;
        autocompleteList.classList.remove('show');
        document.getElementById('filterForm').submit();
      });

      autocompleteList.appendChild(div);
    });

    autocompleteList.classList.add('show');
  }

  function highlightMatch(text, query) {
    if (!text || !query) return text || '';
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark style="background:#fbbf24;color:#000;padding:0 2px">$1</mark>');
  }

  function setActiveItem(items, index) {
    items.forEach((item, i) => {
      if (i === index) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  }
})();

// ==================== COLUMN TOGGLES ====================
(function() {
  const table = document.querySelector('.table-wrap table');
  if (!table) return;

  const viewType = '{{ view_type }}';
  if (viewType !== 'sold') return;
  const storageKey = `qventory.inventory.columns.${viewType}`;
  const resetBtn = document.getElementById('resetHiddenColumns');
  let stored = {};

  try {
    stored = JSON.parse(window.localStorage.getItem(storageKey) || '{}');
  } catch (_err) {
    stored = {};
  }

  function updateButton(btn, hidden) {
    const icon = btn.querySelector('i');
    if (icon) {
      icon.classList.toggle('fa-eye', !hidden);
      icon.classList.toggle('fa-eye-slash', hidden);
    }
    btn.setAttribute('aria-pressed', hidden ? 'true' : 'false');
    btn.setAttribute('title', hidden ? 'Show column' : 'Hide column');
    btn.setAttribute('aria-label', hidden ? 'Show column' : 'Hide column');
  }

  function setColumnHidden(col, hidden, persist = true) {
    table.querySelectorAll(`[data-col="${col}"]`).forEach(cell => {
      cell.style.display = hidden ? 'none' : '';
    });

    const btn = table.querySelector(`[data-col-toggle="${col}"]`);
    if (btn) {
      updateButton(btn, hidden);
    }

    if (persist) {
      try {
        stored[col] = hidden;
        window.localStorage.setItem(storageKey, JSON.stringify(stored));
      } catch (_err) {
        // Ignore storage errors (private mode, etc.)
      }
    }
  }

  const toggles = table.querySelectorAll('[data-col-toggle]');
  if (!toggles.length) return;

  resetBtn?.addEventListener('click', () => {
    table.querySelectorAll('[data-col]').forEach(cell => {
      cell.style.display = '';
    });
    toggles.forEach(btn => updateButton(btn, false));
    stored = {};
    try {
      window.localStorage.removeItem(storageKey);
    } catch (_err) {
      // Ignore storage errors
    }
  });

  toggles.forEach(btn => {
    const col = btn.dataset.colToggle;
    if (!col) return;

    if (Object.prototype.hasOwnProperty.call(stored, col)) {
      setColumnHidden(col, stored[col], false);
    } else {
      updateButton(btn, false);
    }

    btn.addEventListener('click', () => {
      const isHidden = btn.getAttribute('aria-pressed') === 'true';
      setColumnHidden(col, !isHidden, true);
    });
  });
})();

// ==================== SORTING ====================
(function() {
  const headers = document.querySelectorAll('.sort-header');
  if (!headers.length) return;

  headers.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.getAttribute('data-sort-key');
      if (!sortKey) return;

      const url = new URL(window.location.href);
      const currentSort = url.searchParams.get('sort');
      const currentDir = url.searchParams.get('dir') || '';
      const defaultDir = header.getAttribute('data-default-dir') || 'asc';

      let nextDir = defaultDir;
      if (currentSort === sortKey) {
        nextDir = currentDir.toLowerCase() === 'asc' ? 'desc' : 'asc';
      }

      url.searchParams.set('sort', sortKey);
      url.searchParams.set('dir', nextDir);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    });
  });
})();

// ==================== EBAY SYNC ====================
document.addEventListener('DOMContentLoaded', function() {
  const syncActiveBtn = document.getElementById('syncEbayActiveBtn');
  const syncSoldBtn = document.getElementById('syncEbaySoldBtn');

  if (syncActiveBtn) {
    syncActiveBtn.addEventListener('click', function() {
      syncEbayInventory('active');
    });
  }

  if (syncSoldBtn) {
    syncSoldBtn.addEventListener('click', function() {
      syncEbayInventory('sold');
    });
  }

  function syncEbayInventory(type) {
    const btn = type === 'active' ? syncActiveBtn : syncSoldBtn;
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

    const endpoint = type === 'active' ? '/sync-ebay-inventory' : '/sync-ebay-sold';

    fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      // Check for 403 (upgrade required)
      if (response.status === 403) {
        return response.json().then(data => {
          if (data.upgrade_required) {
            btn.innerHTML = originalHTML;
            btn.disabled = false;

            // Show upgrade notification
            const notification = document.createElement('div');
            notification.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 9999;
              padding: 20px 24px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              font-size: 14px;
              max-width: 400px;
              background: #fee2e2;
              color: #991b1b;
              border: 1px solid #f87171;
            `;

            notification.innerHTML = `
              <i class="fas fa-exclamation-circle"></i>
              <strong>${data.error}</strong>
              <div style="margin-top: 12px;">
                <a href="/upgrade" class="btn submitbtn" style="display: inline-block; padding: 8px 16px; text-decoration: none;">
                  <i class="fas fa-arrow-up"></i> Upgrade Plan
                </a>
              </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
              notification.remove();
            }, 8000);

            throw new Error('Upgrade required');
          }
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        btn.innerHTML = '<i class="fas fa-check"></i> Synced!';

        // Show success message
        showNotification(
          'success',
          data.message || `Successfully synced ${data.updated || 0} items`
        );

        // Reload page after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        btn.innerHTML = originalHTML;
        btn.disabled = false;

        showNotification('error', data.error || 'Sync failed');
      }
    })
    .catch(error => {
      console.error('Sync error:', error);
      btn.innerHTML = originalHTML;
      btn.disabled = false;

      showNotification('error', 'Network error. Please try again.');
    });
  }

  function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px;
      max-width: 400px;
      ${type === 'success'
        ? 'background: #d1fae5; color: #065f46; border: 1px solid #34d399;'
        : 'background: #fee2e2; color: #991b1b; border: 1px solid #f87171;'}
    `;

    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
      ${message}
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // Preserve filter values from URL params
  const urlParams = new URLSearchParams(window.location.search);
  const filterForm = document.getElementById('filterForm');

  if (filterForm) {
    // Preserve search query
    const qParam = urlParams.get('q');
    if (qParam) {
      const qInput = filterForm.querySelector('[name="q"]');
      if (qInput) qInput.value = qParam;
    }

    // Preserve ABSC filters
    ['A', 'B', 'S', 'C'].forEach(field => {
      const value = urlParams.get(field);
      if (value) {
        const select = filterForm.querySelector(`[name="${field}"]`);
        if (select) select.value = value;
      }
    });

    // Preserve missing_data filter (or legacy missing_cost/missing_supplier)
    const missingDataParam = urlParams.get('missing_data');
    const missingCostParam = urlParams.get('missing_cost');
    const missingSupplierParam = urlParams.get('missing_supplier');
    const missingDataSelect = filterForm.querySelector('[name="missing_data"]');
    if (missingDataSelect) {
      if (missingDataParam) {
        missingDataSelect.value = missingDataParam;
      } else if (missingCostParam) {
        missingDataSelect.value = 'cost';
      } else if (missingSupplierParam) {
        missingDataSelect.value = 'supplier';
      }
    }
  }
});
</script>

<!-- Cost History Modal -->
<div id="costHistoryModal" class="modal" hidden>
  <div class="modal__backdrop" onclick="closeCostHistoryModal()"></div>
  <div class="modal__dialog" style="max-width:720px">
    <div class="modal__header">
      <h3 id="costHistoryTitle">Cost History</h3>
      <button class="modal__close" onclick="closeCostHistoryModal()">√ó</button>
    </div>
    <div class="modal__body">
      <div id="costHistoryContent" style="display:grid;gap:16px;"></div>
    </div>
    <div class="modal__footer">
      <button type="button" class="btn btn-secondary" onclick="closeCostHistoryModal()">Close</button>
    </div>
  </div>
</div>

<div id="netProfitModal" class="modal" hidden>
  <div class="modal__backdrop" onclick="closeNetProfitModal()"></div>
  <div class="modal__dialog" style="max-width:620px">
    <div class="modal__header">
      <h3 style="margin:0;">Net Profit Calculation</h3>
      <button class="modal__close" onclick="closeNetProfitModal()">√ó</button>
    </div>
    <div class="modal__body">
      <div style="font-weight:600;margin-bottom:8px;">Formula</div>
      <div style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.03);">
        Net Profit = Sold Price - Cost - Shipping Cost - Total Marketplace Fees - Refund
      </div>
      <div style="margin-top:14px;color:var(--sub);font-size:13px;line-height:1.5;">
        Sold Price does not include tax. Shipping Charged is displayed separately.
        Total Marketplace Fees include marketplace, processing, ad, and other fees.
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" onclick="closeNetProfitModal()">Close</button>
    </div>
  </div>
</div>

<script>
/* ===== AUTO-REFRESH WITH SERVER-SENT EVENTS ===== */
{% if view_type == 'active' %}
(function(){
  let eventSource = null;
  let currentCount = {{ total_items }};
  let reconnectTimeout = null;
  let lastCheckTimestamp = new Date().toISOString();

  function setupPolling() {
    // Use simple polling instead of SSE - more reliable, no database connection issues

    async function checkForUpdates() {
      try {
        const response = await fetch('/api/inventory/count');
        if (!response.ok) throw new Error('Failed to fetch count');

        const data = await response.json();
        if (data.count !== currentCount) {
          const diff = data.count - currentCount;

          // Only fetch and insert new items if count increased
          if (diff > 0) {
            fetchAndInsertNewItems();
          } else {
            // If count decreased, show notification
            showNotification(diff);
          }

          currentCount = data.count;
        }
      } catch (e) {
        // silently ignore polling errors
      }
    }

    // Check immediately
    checkForUpdates();

    // Then check every 15 seconds
    setInterval(checkForUpdates, 15000);
  }

  function setupSSE() {
    // SSE disabled - using polling instead
    setupPolling();
    return;

    // SSE disabled
    eventSource = new EventSource('/api/inventory/stream');

    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        console.log('[SSE] Received:', data);

        if (data.type === 'update' && data.count !== currentCount) {
          console.log(`[SSE] Count changed: ${currentCount} ‚Üí ${data.count}`);
          const diff = data.count - currentCount;

          // Only fetch and insert new items if count increased
          if (diff > 0) {
            fetchAndInsertNewItems();
          } else {
            // If count decreased, show notification (items may have been deleted/sold elsewhere)
            showNotification(diff);
          }

          currentCount = data.count;
        }
      } catch (e) {
        console.error('[SSE] Parse error:', e);
      }
    };

    eventSource.onerror = function(e) {
      console.error('[SSE] Connection error, reconnecting in 10s...');
      eventSource.close();

      // Reconnect after 10 seconds
      clearTimeout(reconnectTimeout);
      reconnectTimeout = setTimeout(setupSSE, 10000);
    };

    eventSource.onopen = function() {
      console.log('[SSE] Connected successfully');
    };
  }

  async function fetchAndInsertNewItems() {
    try {
      console.log('[Auto-refresh] Fetching items since:', lastCheckTimestamp);

      const response = await fetch(`/api/items/recent?since=${encodeURIComponent(lastCheckTimestamp)}`);
      const data = await response.json();

      if (!data.ok) {
        console.error('[Auto-refresh] Error:', data.error);
        return;
      }

      if (data.count === 0) {
        console.log('[Auto-refresh] No new items to display');
        return;
      }

      console.log(`[Auto-refresh] Inserting ${data.count} new item(s)`);

      // Find the tbody in the items table
      const tbody = document.querySelector('table tbody');
      if (!tbody) {
        console.error('[Auto-refresh] Table body not found');
        return;
      }

      // Create temporary container to parse HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = data.html;

      // Get all new rows
      const newRows = tempDiv.querySelectorAll('tr[data-item-row]');

      // Insert new rows at the top of the table with animation
      newRows.forEach((row, index) => {
        // Check if row already exists (by item ID)
        const itemId = row.getAttribute('data-item-row');
        const existingRow = tbody.querySelector(`tr[data-item-row="${itemId}"]`);

        if (existingRow) {
          console.log(`[Auto-refresh] Item ${itemId} already exists, skipping`);
          return;
        }

        // Add animation class
        row.style.animation = 'slideInNew 0.5s ease-out';
        row.style.animationDelay = `${index * 0.1}s`;

        // Insert at the beginning of tbody
        tbody.insertBefore(row, tbody.firstChild);
      });

      // Update the item count display
      updateItemCountDisplay(currentCount);

      // Show success notification
      showNotification(data.count);

      // Update last check timestamp
      lastCheckTimestamp = new Date().toISOString();

      // Re-initialize inline edit handlers for new rows
      if (window.dashboardScripts && window.dashboardScripts.initInlineEdit) {
        window.dashboardScripts.initInlineEdit();
      }

    } catch (error) {
      console.error('[Auto-refresh] Failed to fetch items:', error);
    }
  }

  function updateItemCountDisplay(newCount) {
    // Update the item count in the header if it exists
    const countElement = document.querySelector('.inventory-header h1, .card-header h1');
    if (countElement) {
      const text = countElement.textContent;
      const match = text.match(/\((\d+)\)/);
      if (match) {
        countElement.textContent = text.replace(/\(\d+\)/, `(${newCount})`);
      }
    }
  }

  function showNotification(diff) {
    // Remove existing notification if any
    const existingNotif = document.getElementById('autoRefreshNotif');
    if (existingNotif) {
      existingNotif.remove();
    }

    const notif = document.createElement('div');
    notif.id = 'autoRefreshNotif';
    notif.style.cssText = `
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      animation: slideDown 0.3s ease-out;
    `;

    const message = diff > 0
      ? `${Math.abs(diff)} new item${Math.abs(diff) > 1 ? 's' : ''} added`
      : `${Math.abs(diff)} item${Math.abs(diff) > 1 ? 's' : ''} removed`;

    notif.innerHTML = `
      <i class="fas fa-check-circle" style="font-size: 16px;"></i>
      <span>${message}</span>
    `;

    // Add animation styles if not already added
    if (!document.getElementById('autoRefreshStyles')) {
      const style = document.createElement('style');
      style.id = 'autoRefreshStyles';
      style.textContent = `
        @keyframes slideDown {
          from {
            opacity: 0;
            transform: translate(-50%, -20px);
          }
          to {
            opacity: 1;
            transform: translate(-50%, 0);
          }
        }
        @keyframes slideInNew {
          from {
            opacity: 0;
            transform: translateX(-20px);
            background: rgba(102, 126, 234, 0.1);
          }
          to {
            opacity: 1;
            transform: translateX(0);
            background: transparent;
          }
        }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(notif);

    // Auto-dismiss after 3 seconds
    setTimeout(() => {
      if (notif.parentElement) {
        notif.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => notif.remove(), 300);
      }
    }, 3000);
  }

  // Start SSE connection
  setupSSE();

  // Cleanup on page unload
  window.addEventListener('beforeunload', function() {
    if (eventSource) {
      eventSource.close();
    }
    clearTimeout(reconnectTimeout);
  });
})();
{% endif %}
</script>

<script>
/* ===== QR SCANNER SCRIPT (Optimizado iOS + Android) ===== */
(function(){
  const btnScan = document.getElementById('btnScanQR');
  const modal = document.getElementById('scanQRModal');
  const btnClose = document.getElementById('scanQRClose');
  const btnFlip = document.getElementById('scanQRFlip');
  const btnFlash = document.getElementById('scanQRFlashlight');
  const video = document.getElementById('scanQRVideo');
  const spinner = document.getElementById('scanQRSpinner');
  const success = document.getElementById('scanQRSuccess');
  const result = document.getElementById('scanQRResult');
  const inputQ = document.getElementById('q');
  const form = document.getElementById('filterForm');

  const CAM_CACHE_KEY = 'qv_inventory_qr_cam_device_id';
  let stream = null, rafId = null;
  let detector = null;
  let usingBD = false, usingJsQR = false, jsQRLoaded = false;
  let videoDevices = [], currentDeviceIdx = -1, devicesLoaded = false;
  let flashlightOn = false;
  let isScanning = false;

  // === Audio beep cross-platform ===
  let beepAudio = null;
  let beepReady = false;

  function ensureBeep() {
    if (beepReady) return;
    try {
      beepAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");
      beepAudio.preload = "auto";
      const p = beepAudio.play();
      if (p && typeof p.then === "function") {
        p.then(() => {
          beepAudio.pause();
          beepAudio.currentTime = 0;
          beepReady = true;
        }).catch(()=>{});
      } else {
        beepAudio.pause();
        beepAudio.currentTime = 0;
        beepReady = true;
      }
    } catch(e) {}
  }

  function openModal(){
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden','false');
  }

  function closeModal(){
    document.body.classList.remove('modal-open');
    modal.setAttribute('hidden','');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden','true');
  }

  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }
  function showSuccess(){ success.style.display='flex'; setTimeout(()=>success.style.display='none', 450); }

  function cleanupLoop(){
    if (rafId){
      cancelAnimationFrame(rafId);
      rafId=null;
    }
    isScanning = false;
  }

  function cleanupAll(){
    cleanupLoop();
    if (stream){
      try{ stream.getTracks().forEach(t=>t.stop()); }catch{};
      stream=null;
    }
    flashlightOn=false;
    btnFlash.classList.remove('active');
    video.srcObject=null;
    video.style.display='none';
    usingBD=false;
    usingJsQR=false;
  }

  function showError(msg){
    console.error('[QR]', msg);
    alert(msg);
  }

  async function loadVideoDevices(){
    if (devicesLoaded) return;
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d=>d.kind==='videoinput');
    const prefers = ['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      const as = prefers.some(p=>la.includes(p)) ? 1:0;
      const bs = prefers.some(p=>lb.includes(p)) ? 1:0;
      return bs - as;
    });
    devicesLoaded = true;
  }

  async function startWithDevice(deviceId){
    cleanupLoop();
    showSpinner(true);

    // Simplified constraints for better browser compatibility with permission caching
    const constraints = {
      video: deviceId
        ? { deviceId:{exact:deviceId}, facingMode:'environment' }
        : { facingMode:{ideal:'environment'} },
      audio: false
    };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.setAttribute('playsinline','');
    video.setAttribute('autoplay','');
    video.setAttribute('muted','');
    video.srcObject = stream;

    await video.play();

    if (video.readyState < 2){
      await new Promise(res=>{
        const t = setTimeout(res, 250);
        video.onloadedmetadata = ()=>{ clearTimeout(t); res(); };
      });
    }

    showSpinner(false);
    video.style.display='block';

    // Guardar preferencia de c√°mara
    if (deviceId) {
      try{ localStorage.setItem(CAM_CACHE_KEY, deviceId); }catch{}
    }
  }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
    await startWithDevice(videoDevices[currentDeviceIdx].deviceId);
    if (usingBD) startBDLoop();
    if (usingJsQR) startJsQRLoop();
  }

  async function toggleFlashlight(){
    if (!stream) return;
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      if (!caps.torch) return alert('Flashlight not supported on this camera');
      flashlightOn = !flashlightOn;
      await track.applyConstraints({ advanced:[{ torch: flashlightOn }] });
      btnFlash.classList.toggle('active', flashlightOn);
    }catch{ alert('Unable to control flashlight'); }
  }

  function extractSku(val){
    if (!val) return '';
    const s = String(val).trim();
    try{
      const u = new URL(s);
      const m = u.href.match(/([A-Z0-9]{8,}|\d{10,}|\d{8}-[A-Z0-9]{3,})/i);
      return m ? m[1] : s;
    }catch{ return s; }
  }

  function onDetected(raw){
    if (isScanning) return;
    isScanning = true;

    // Check if there's a location callback (from location modal)
    const hasLocationCallback = window.qrScannerLocationCallback && typeof window.qrScannerLocationCallback === 'function';

    // For location callback, use raw value to preserve full URL
    // For search, extract SKU
    const v = hasLocationCallback ? raw.trim() : extractSku(raw);

    if (!v) {
      isScanning = false;
      return;
    }

    result.textContent = `Detected: ${v.slice(0,120)}`;
    result.style.display='block';
    showSuccess();

    try{
      if (navigator.vibrate) navigator.vibrate(80);
      if (beepReady && beepAudio) beepAudio.play().catch(()=>{});
    }catch{}

    setTimeout(()=>{
      cleanupAll();
      closeModal();

      if (hasLocationCallback) {
        // Location callback gets full URL/raw value
        window.qrScannerLocationCallback(v);
      } else {
        // Default behavior: populate search and submit with extracted SKU
        inputQ.value = v;
        form?.submit();
      }
    }, 500);
  }

  async function tryBarcodeDetector(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      detector = new window.BarcodeDetector({ formats: ['qr_code','qr'] });
    }catch{
      try{ detector = new window.BarcodeDetector(); }catch{ return false; }
    }
    usingBD = true;
    usingJsQR = false;
    startBDLoop();
    return true;
  }

  function startBDLoop(){
    cleanupLoop();
    isScanning = false;
    let frame = 0;

    const tick = async ()=>{
      if (!usingBD) return;
      frame++;
      try{
        if (frame%2===0 && detector && video.readyState >= 2){
          const codes = await detector.detect(video);
          if (codes && codes.length){
            const val = (codes[0].rawValue || '').trim();
            if (val){
              onDetected(val);
              return;
            }
          }
        }
      }catch(e){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function loadJsQR(){
    if (jsQRLoaded) return Promise.resolve();
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async=true;
      s.onload=()=>{ jsQRLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error('jsQR CDN blocked/failed to load'));
      document.head.appendChild(s);
    });
  }

  function startJsQRLoop(){
    usingBD=false;
    usingJsQR=true;
    cleanupLoop();
    isScanning = false;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const ROI_INSET = 0.08;

    let lastTS = 0;
    const MIN_INTERVAL = 100;

    const tick = (now)=>{
      if (!usingJsQR) return;

      try{
        if (now - lastTS >= MIN_INTERVAL && video.videoWidth>0 && video.readyState >= 2){
          lastTS = now;

          const vw = video.videoWidth, vh = video.videoHeight;
          const rx = Math.floor(vw*ROI_INSET), ry = Math.floor(vh*ROI_INSET);
          const rw = Math.floor(vw*(1-2*ROI_INSET)), rh = Math.floor(vh*(1-2*ROI_INSET));

          canvas.width = rw;
          canvas.height = rh;
          ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);

          const img = ctx.getImageData(0, 0, rw, rh);
          const qr = window.jsQR && window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
          const val = (qr?.data || '').trim();

          if (val){
            onDetected(val);
            return;
          }
        }
      }catch(e){
        console.error('[jsQR]', e);
      }
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startScan(){
    ensureBeep();
    openModal();
    result.style.display='none';
    success.style.display='none';
    isScanning = false;

    try{
      const cachedId = localStorage.getItem(CAM_CACHE_KEY) || null;
      await loadVideoDevices();

      if (videoDevices.length){
        if (cachedId){
          const idx = videoDevices.findIndex(d=>d.deviceId===cachedId);
          currentDeviceIdx = idx >= 0 ? idx : 0;
        } else {
          currentDeviceIdx = 0;
        }
      }

      await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);

      const bdOK = await tryBarcodeDetector();
      if (!bdOK){
        try{
          await loadJsQR();
          startJsQRLoop();
        }catch(e){
          showError('No QR engine available (BarcodeDetector unsupported and jsQR blocked).');
          cleanupAll();
          closeModal();
        }
      }
    }catch(e){
      showError(e?.message || 'Camera access denied or not available');
      cleanupAll();
      closeModal();
    }
  }

  function handleClose(){
    cleanupAll();
    closeModal();
  }

  // Event listeners
  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnFlash?.addEventListener('click', toggleFlashlight);
  btnClose?.addEventListener('click', handleClose);

  modal?.addEventListener('click', (e)=>{
    if (e.target === modal){
      handleClose();
    }
  });

  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && !modal.classList.contains('hidden')){
      handleClose();
    }
  });

  // Expose startScan globally for location modal QR button
  window.openQRScanner = startScan;
})();
</script>

<script>
/* ===== ITEM ACTIONS DROPDOWN MENU ===== */
function toggleItemActionsMenu(button) {
  const dropdown = button.closest('.item-actions-dropdown');
  const menu = dropdown.querySelector('.item-actions-menu');
  const isOpen = menu.style.display === 'block';

  // Close all other dropdowns first
  document.querySelectorAll('.item-actions-menu').forEach(m => {
    m.style.display = 'none';
  });

  // Toggle current dropdown
  menu.style.display = isOpen ? 'none' : 'block';

  // Prevent closing when clicking inside the menu
  if (!isOpen) {
    setTimeout(() => {
      document.addEventListener('click', closeAllMenus);
    }, 0);
  }
}

function closeAllMenus(e) {
  // Don't close if clicking on a dropdown trigger
  if (e && e.target.closest('.item-actions-dropdown button[onclick]')) {
    return;
  }

  document.querySelectorAll('.item-actions-menu').forEach(menu => {
    menu.style.display = 'none';
  });

  document.removeEventListener('click', closeAllMenus);
}

// Add hover effects to menu items
document.addEventListener('DOMContentLoaded', function() {
  // Delegate hover events to avoid issues with dynamically loaded rows
  document.addEventListener('mouseover', function(e) {
    const option = e.target.closest('.item-action-option');
    if (option) {
      option.style.background = 'var(--hover)';
    }
  });

  document.addEventListener('mouseout', function(e) {
    const option = e.target.closest('.item-action-option');
    if (option) {
      option.style.background = 'none';
    }
  });

  // Close menu when clicking an action
  document.addEventListener('click', function(e) {
    const option = e.target.closest('.item-action-option');
    if (option) {
      // Close the menu after a brief delay to allow the action to execute
      setTimeout(closeAllMenus, 100);
    }
  });
});

// Update & Relist modal
function openRelistModal(payload) {
  const modal = document.getElementById('relistModal');
  const titleInput = document.getElementById('relistTitle');
  const priceInput = document.getElementById('relistPrice');
  const itemIdInput = document.getElementById('relistItemId');
  const warning = document.getElementById('relistMarginWarning');
  if (!modal || !titleInput || !priceInput || !itemIdInput) return;
  itemIdInput.value = payload.itemId || '';
  titleInput.value = payload.title || '';
  priceInput.value = payload.price || '';
  modal.dataset.itemCost = payload.cost || '';
  if (warning) warning.style.display = 'none';
  modal.classList.remove('hidden');
  document.body.classList.add('modal-open');
}

function closeRelistModal() {
  const modal = document.getElementById('relistModal');
  if (!modal) return;
  modal.classList.add('hidden');
  document.body.classList.remove('modal-open');
}

function showRelistToast(message) {
  const toast = document.createElement('div');
  toast.style.position = 'fixed';
  toast.style.right = '16px';
  toast.style.bottom = '16px';
  toast.style.zIndex = '2500';
  toast.style.background = 'rgba(16,185,129,0.15)';
  toast.style.border = '1px solid rgba(16,185,129,0.35)';
  toast.style.color = '#10b981';
  toast.style.padding = '12px 16px';
  toast.style.borderRadius = '10px';
  toast.style.fontSize = '14px';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4500);
}

document.addEventListener('DOMContentLoaded', function() {
  const relistClose = document.getElementById('relistClose');
  const relistModal = document.getElementById('relistModal');
  relistClose?.addEventListener('click', closeRelistModal);
  relistModal?.addEventListener('click', (e) => {
    if (e.target === relistModal) {
      closeRelistModal();
    }
  });

  const relistForm = document.getElementById('relistForm');
  const relistTitle = document.getElementById('relistTitle');
  const relistPrice = document.getElementById('relistPrice');
  const relistItemId = document.getElementById('relistItemId');
  const relistSubmit = document.getElementById('relistSubmit');
  const relistWarning = document.getElementById('relistMarginWarning');
  const relistModalEl = document.getElementById('relistModal');
  const relistMinus5 = document.getElementById('relistPriceMinus5');
  const relistMinus10 = document.getElementById('relistPriceMinus10');
  const relistMinus15 = document.getElementById('relistPriceMinus15');

  function updateRelistMarginWarning() {
    if (!relistWarning || !relistPrice || !relistModalEl) return;
    const costRaw = relistModalEl.dataset.itemCost || '';
    const priceVal = parseFloat(relistPrice.value);
    const costVal = parseFloat(costRaw);
    if (isFinite(priceVal) && isFinite(costVal) && priceVal < costVal) {
      relistWarning.style.display = 'block';
    } else {
      relistWarning.style.display = 'none';
    }
  }

  function applyDiscount(percent) {
    if (!relistPrice) return;
    const current = parseFloat(relistPrice.value);
    if (!isFinite(current)) return;
    const newPrice = current * (1 - percent / 100);
    relistPrice.value = newPrice.toFixed(2);
    updateRelistMarginWarning();
  }

  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.relist-btn');
    if (btn) {
      const itemId = btn.getAttribute('data-item-id');
      const title = btn.getAttribute('data-item-title') || '';
      const price = btn.getAttribute('data-item-price') || '';
      const cost = btn.getAttribute('data-item-cost') || '';
      if (itemId) {
        openRelistModal({ itemId, title, price, cost });
        updateRelistMarginWarning();
      }
    }
  });

  relistPrice?.addEventListener('input', updateRelistMarginWarning);
  relistMinus5?.addEventListener('click', () => applyDiscount(5));
  relistMinus10?.addEventListener('click', () => applyDiscount(10));
  relistMinus15?.addEventListener('click', () => applyDiscount(15));

  relistForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!relistItemId?.value) {
      return;
    }
    const payload = {
      item_id: relistItemId.value,
      title: relistTitle?.value || '',
      price: relistPrice?.value || ''
    };
    if (relistSubmit) {
      relistSubmit.disabled = true;
      relistSubmit.textContent = 'Relisting...';
    }
    try {
      const response = await fetch('/items/relist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok || !data.ok) {
        throw new Error(data.error || 'Relist failed');
      }
      closeRelistModal();
      if (data.warning) {
        showRelistToast(data.warning);
      } else {
        showRelistToast('Relist completed successfully.');
      }
    } catch (error) {
      showRelistToast(error.message || 'Relist failed.');
    } finally {
      if (relistSubmit) {
        relistSubmit.disabled = false;
        relistSubmit.textContent = 'Relist Now';
      }
    }
  });
});

function closeCostHistoryModal() {
  const modal = document.getElementById('costHistoryModal');
  if (modal) modal.hidden = true;
}

function openNetProfitModal() {
  const modal = document.getElementById('netProfitModal');
  if (!modal) return;
  modal.hidden = false;
}

function closeNetProfitModal() {
  const modal = document.getElementById('netProfitModal');
  if (modal) modal.hidden = true;
}

document.addEventListener('DOMContentLoaded', () => {
  const infoBtn = document.querySelector('.net-profit-info');
  if (infoBtn) {
    infoBtn.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      openNetProfitModal();
    });
  }
});

function formatCostHistoryDate(value) {
  if (!value) return '‚Äî';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return '‚Äî';
  return date.toLocaleString();
}

function renderCostHistorySection(title, rows, formatter) {
  if (!rows || rows.length === 0) {
    return `<div>
      <h4 style="margin:0 0 8px 0;">${title}</h4>
      <div style="color:var(--sub);font-size:var(--fs-sm);">No entries found.</div>
    </div>`;
  }
  return `<div>
    <h4 style="margin:0 0 8px 0;">${title}</h4>
    <div style="display:grid;gap:10px;">
      ${rows.map(formatter).join('')}
    </div>
  </div>`;
}

async function openCostHistoryModal(itemId) {
  const modal = document.getElementById('costHistoryModal');
  const content = document.getElementById('costHistoryContent');
  const title = document.getElementById('costHistoryTitle');
  if (!modal || !content) return;

  content.innerHTML = '<div style="color:var(--sub);">Loading...</div>';
  modal.hidden = false;

  try {
    const response = await fetch(`/api/items/${itemId}/cost-history`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data.error || 'Failed to load cost history');
    }

    title.textContent = `Cost History ‚Äî ${data.item?.title || ''}`;

    const expensesHtml = renderCostHistorySection('Expenses', data.expenses, (exp) => `
      <div style="border:1px solid var(--glass-border);border-radius:8px;padding:10px;background:var(--card);">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
          <strong>${exp.description || 'Expense'}</strong>
          <span style="color:#ef4444;font-weight:600;">$${(exp.amount ?? 0).toFixed(2)}</span>
        </div>
        <div style="color:var(--sub);font-size:var(--fs-xs);margin-top:6px;">
          Added: ${formatCostHistoryDate(exp.applied_at)} ‚Ä¢ Expense date: ${exp.expense_date || '‚Äî'}
        </div>
        ${exp.notes ? `<div style="color:var(--sub);font-size:var(--fs-xs);margin-top:4px;">${exp.notes}</div>` : ''}
      </div>
    `);

    const receiptsHtml = renderCostHistorySection('Receipt Items', data.receipt_items, (ri) => {
      const qty = ri.quantity ? `${ri.quantity}x ` : '';
      const unit = ri.unit_price != null ? ` @ $${ri.unit_price.toFixed(2)}` : '';
      return `
        <div style="border:1px solid var(--glass-border);border-radius:8px;padding:10px;background:var(--card);">
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
            <strong>${qty}${ri.description || 'Receipt item'}${unit}</strong>
            <span style="color:#ef4444;font-weight:600;">$${(ri.amount ?? 0).toFixed(2)}</span>
          </div>
          <div style="color:var(--sub);font-size:var(--fs-xs);margin-top:6px;">
            Added: ${formatCostHistoryDate(ri.associated_at)} ‚Ä¢ Receipt: ${ri.merchant_name || '‚Äî'} ${ri.receipt_date ? `(${ri.receipt_date})` : ''}
          </div>
        </div>
      `;
    });

    const manualHtml = renderCostHistorySection('Manual Cost Changes', data.manual_changes, (entry) => `
      <div style="border:1px solid var(--glass-border);border-radius:8px;padding:10px;background:var(--card);">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
          <strong>Cost updated</strong>
          <span style="color:#ef4444;font-weight:600;">
            $${(entry.previous_cost ?? 0).toFixed(2)} ‚Üí $${(entry.new_cost ?? 0).toFixed(2)}
          </span>
        </div>
        <div style="color:var(--sub);font-size:var(--fs-xs);margin-top:6px;">
          Added: ${formatCostHistoryDate(entry.created_at)}${entry.note ? ` ‚Ä¢ ${entry.note}` : ''}
        </div>
      </div>
    `);

    content.innerHTML = `${expensesHtml}${receiptsHtml}${manualHtml}`;
  } catch (err) {
    content.innerHTML = `<div style="color:#ef4444;">${err.message}</div>`;
  }
}

document.addEventListener('click', function(e) {
  const btn = e.target.closest('.cost-history-btn');
  if (!btn) return;
  const itemId = btn.getAttribute('data-item-id');
  if (itemId) {
    openCostHistoryModal(itemId);
  }
});

// Close on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeAllMenus();
    closeRelistModal();
    closeCostHistoryModal();
  }
});
</script>

{% endblock %}
