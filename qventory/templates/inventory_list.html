{% extends "base_new.html" %}

{% block title %}{{ page_title }} – Qventory{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">/</span>
<a href="{{ url_for('main.inventory_active') }}">Inventory</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">{{ page_title }}</span>
{% endblock %}

{% block content %}
<div data-username="{{ current_user.username }}" style="display:none"></div>

<div class="inventory-container page-shell page-shell--wide">

  <!-- Page Header -->
  <div style="margin-bottom:24px;">
    <h1 style="color:var(--text);font-size:28px;margin-bottom:8px;">
      {% if view_type == 'active' %}
        <i class="fas fa-box"></i> Active Inventory
      {% elif view_type == 'sold' %}
        <i class="fas fa-check-circle"></i> Sold Items
      {% elif view_type == 'ended' %}
        <i class="fas fa-times-circle"></i> Ended Inventory
      {% endif %}
    </h1>
    <p style="color:var(--text-secondary);font-size:14px;">
      {% if view_type == 'active' %}
        Items currently active and available for sale
      {% elif view_type == 'sold' %}
        Items that have been sold
      {% elif view_type == 'ended' %}
        Items that are no longer active
      {% endif %}
    </p>
  </div>

  {% if view_type == 'active' and show_upgrade_banner|default(False) %}
  <div id="upgradePlanBanner" class="plan-upgrade-banner" data-dismiss-key="{{ upgrade_banner_dismiss_key|default('upgrade_banner_dismissed') }}" style="display:none;margin-bottom:16px;padding:16px 20px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.08);position:relative;overflow:hidden;">
    <button type="button" class="plan-upgrade-banner__close" data-dismiss-button aria-label="Dismiss upgrade reminder" style="position:absolute;top:12px;right:12px;background:none;border:none;color:var(--sub);font-size:18px;cursor:pointer;padding:4px;">&times;</button>
    <div style="display:flex;gap:16px;align-items:flex-start;">
      <div style="color:#dc2626;font-size:22px;"><i class="fas fa-exclamation-triangle"></i></div>
      <div style="flex:1;">
        <div style="font-weight:600;color:#dc2626;margin-bottom:4px;">Inventory limit reached</div>
        <div style="color:var(--sub);font-size:14px;line-height:1.5;">
          {% if items_remaining is not none and items_remaining <= 0 %}
            You cannot add more inventory items on the current plan.
          {% else %}
            You are close to your inventory limit. Only {{ items_remaining }} slot{{ '' if items_remaining == 1 else 's' }} remain out of {{ plan_max_items }}.
          {% endif %}
          Upgrade to unlock additional capacity.
        </div>
        <div style="margin-top:12px;">
          <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn" style="display:inline-block;">
            <i class="fas fa-arrow-up"></i> Upgrade Plan
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Filters Card -->
  <div id="filtersShell" class="card cardfilters filters-shell" style="margin-bottom:20px;">
    <div class="filters-bar">
      <h2>Filters</h2>
      <button id="filtersToggle" class="btn filters-toggle submitbtn" type="button" aria-expanded="true">
        <i class="fas fa-filter"></i> Toggle
      </button>
    </div>
    <div id="filtersContent" class="filters-content">
      <form id="filterForm" method="get" action="{{ request.path }}" class="filters-grid">
        <input type="hidden" name="page" value="1">
        <input type="hidden" name="per_page" value="{{ pagination.per_page }}">
        <div style="grid-column:1/-1">
          <div class="input-with-button" style="position:relative">
            <input class="input" type="text" id="q" name="q" placeholder="Search title / SKU / supplier…" autocomplete="off">
            <div id="dashboardAutocompleteList" class="autocomplete-list"></div>
            <button class="icon-btn" type="button" id="btnScanQR" title="Scan QR code with camera" aria-label="Scan QR code">
              <i class="fas fa-qrcode"></i>
            </button>
          </div>
        </div>

        {# Dynamic Filters #}
        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A">
            <option value="">All</option>
            {% for opt in options.A %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B">
            <option value="">All</option>
            {% for opt in options.B %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S">
            <option value="">All</option>
            {% for opt in options.S %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C">
            <option value="">All</option>
            {% for opt in options.C %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div style="grid-column:1/-1">
          <button class="btn submitbtn" type="submit">Apply</button>
          <a class="btn" href="{{ request.path }}">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Inventory Table Card -->
  <div class="card inventory-shell">
    <div class="items-header">
      <h2>Items ({{ total_items }})</h2>
      <div class="backup-actions">
        <!-- Bulk Actions -->
        <div id="bulkActionsContainer" style="display:none;margin-right:10px">
          <select id="bulkActionSelect" class="input" style="display:inline-block;width:auto;padding:0.5rem;margin-right:5px">
            <option value="">Bulk Actions</option>
            {% if view_type == 'active' %}
            <option value="sync_to_ebay">Sync to eBay</option>
            {% endif %}
            <option value="delete">Delete Selected</option>
          </select>
          <button id="bulkActionApply" class="btn" style="padding:0.5rem 1rem">
            <i class="fas fa-check"></i> Apply
          </button>
          <span id="bulkSelectedCount" style="margin-left:10px;color:var(--sub);font-size:var(--fs-sm)"></span>
        </div>

        <a class="btn backup-btn" href="{{ url_for('main.export_csv') }}" title="Export all items to CSV">
          <i class="fas fa-download"></i> Export
        </a>
        {% if view_type == 'active' %}
        <a class="btn backup-btn" href="{{ url_for('main.import_csv') }}" title="Import items from CSV">
          <i class="fas fa-upload"></i> Import
        </a>
        <a class="btn backup-btn" href="{{ url_for('main.import_ebay') }}" title="Import inventory from eBay">
          <i class="fab fa-ebay"></i> Import from eBay
        </a>
        <button id="syncEbayActiveBtn" class="btn backup-btn" title="Sync existing inventory with eBay">
          <i class="fas fa-sync-alt"></i> Sync eBay
        </button>
        {% elif view_type == 'sold' %}
        <button id="syncEbaySoldBtn" class="btn backup-btn" title="Sync sold items with eBay">
          <i class="fas fa-sync-alt"></i> Sync eBay Sales
        </button>
        {% endif %}
      </div>
    </div>

    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th style="width:40px;text-align:center">
              <input type="checkbox" id="selectAllCheckbox" title="Select all items" style="cursor:pointer">
            </th>
            <th style="width:44px"></th>
            <th>Title</th>
            <th>SKU</th>
            <th class="mobile-hide">Supplier</th>
            <th class="mobile-hide">Cost</th>
            <th>Price</th>
            <th class="mobile-hide">ROI</th>
            <th>Location</th>
            <th class="mobile-hide">Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsTableBody">
          {% for it in items %}
            {% include "_item_row.html" %}
          {% endfor %}
        </tbody>
      </table>

      {% if total_items == 0 %}
      <div style="text-align:center;padding:60px 20px;color:var(--sub);">
        <i class="fas fa-box-open" style="font-size:64px;opacity:0.3;margin-bottom:20px;display:block;"></i>
        <p style="font-size:18px;margin-bottom:8px;">No items found</p>
        <p style="font-size:14px;">
          {% if view_type == 'active' %}
            Add items to your inventory to get started
          {% elif view_type == 'sold' %}
            No items have been sold yet
          {% elif view_type == 'ended' %}
            No ended items found
          {% endif %}
        </p>
      </div>
      {% endif %}
    </div>

    <div class="pagination-bar">
      <div class="pagination-info">
        {% if pagination.total_items %}
          Showing {{ pagination.start_index }}–{{ pagination.end_index }} of {{ pagination.total_items }} items
        {% else %}
          No items to display
        {% endif %}
      </div>
      <div class="pagination-controls">
        <form method="get" class="pagination-size">
          <input type="hidden" name="page" value="1">
          {% for key, value in request.args.items() %}
            {% if key not in ['per_page', 'page'] %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
          {% endfor %}
          <label for="perPageSelect">Per page:</label>
          <select id="perPageSelect" name="per_page" onchange="this.form.submit()">
            {% for option in pagination.per_page_links %}
              <option value="{{ option.value }}" {% if option.active %}selected{% endif %}>{{ option.value }}</option>
            {% endfor %}
          </select>
        </form>
        <nav class="pagination-nav" aria-label="Inventory pagination">
          {% if pagination.has_prev %}
            <a class="pagination-link" href="{{ pagination.prev_url }}">&laquo; Prev</a>
          {% else %}
            <span class="pagination-link disabled">&laquo; Prev</span>
          {% endif %}

          {% for link in pagination.page_links %}
            {% if link.ellipsis %}
              <span class="pagination-ellipsis">…</span>
            {% else %}
              {% if link.active %}
                <span class="pagination-link active">{{ link.number }}</span>
              {% else %}
                <a class="pagination-link" href="{{ link.url }}">{{ link.number }}</a>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if pagination.has_next %}
            <a class="pagination-link" href="{{ pagination.next_url }}">Next &raquo;</a>
          {% else %}
            <span class="pagination-link disabled">Next &raquo;</span>
          {% endif %}
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Include the same modals as dashboard -->
<!-- QR Modal for Locations -->
<div id="qrModal" class="qr-modal hidden" role="dialog" aria-hidden="true" aria-labelledby="qrTitle">
  <div class="qr-sheet">
    <div class="qr-header">
      <strong id="qrTitle"><i class="fas fa-qrcode"></i> QR</strong>
      <div class="qr-actions">
        <a id="qrOpenNew" class="qr-icon" href="#" target="_blank" title="Open in new tab" aria-label="Open in new tab">
          <i class="fas fa-external-link-alt"></i>
        </a>
        <button type="button" id="qrClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport">
        <img id="qrImage" alt="QR code">
      </div>
      <div id="qrCaption" class="qr-tip"></div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imgModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Image viewer">
  <div class="qr-sheet" style="max-width:90vw;width:auto">
    <div class="qr-header">
      <strong><i class="fas fa-image"></i> Image</strong>
      <div class="qr-actions">
        <button type="button" id="imgClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="img-viewport">
        <img id="imgModalImg" alt="">
      </div>
    </div>
  </div>
</div>

<!-- Location Modal -->
<div id="locationInlineModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Edit location">
  <div class="qr-sheet location-modal">
    <div class="qr-header">
      <strong><i class="fas fa-map-marker-alt"></i> Edit Location</strong>
      <div class="qr-actions">
        <button type="button" id="locationModalClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <form id="locationModalForm" class="location-modal__body">
      <div id="locationModalFields" class="inline-edit__grid"></div>
      <div class="inline-edit__actions">
        <button type="submit" class="inline-edit__action">Save</button>
        <button type="button" class="inline-edit__action inline-edit__cancel" id="locationModalCancel">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk Location Assignment Modal -->
<div id="bulkLocationModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Bulk assign location">
  <div class="qr-sheet location-modal">
    <div class="qr-header">
      <strong><i class="fas fa-map-marker-alt"></i> Bulk Assign Location</strong>
      <div class="qr-actions">
        <button type="button" onclick="closeBulkLocationModal()" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <form id="bulkLocationForm" class="location-modal__body">
      <div style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:6px;padding:12px;margin-bottom:16px;">
        <div style="font-size:13px;color:var(--sub)">
          <i class="fas fa-info-circle" style="color:#60a5fa;"></i>
          Assigning location to <strong id="bulkLocationCount" style="color:#60a5fa;">0</strong> selected item(s)
        </div>
      </div>

      <div class="inline-edit__grid">
        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A" class="input">
            <option value="">— None —</option>
            {% for opt in options.A %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B" class="input">
            <option value="">— None —</option>
            {% for opt in options.B %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S" class="input">
            <option value="">— None —</option>
            {% for opt in options.S %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C" class="input">
            <option value="">— None —</option>
            {% for opt in options.C %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--glass-border);">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" name="sync_to_ebay" id="bulkSyncToEbay" style="cursor:pointer;">
          <span style="font-size:14px;">
            <i class="fab fa-ebay" style="color:#E53238;"></i>
            Sync location to eBay SKU (for eBay items only)
          </span>
        </label>
        <div style="font-size:12px;color:var(--sub);margin-top:4px;margin-left:28px;">
          Updates the Custom SKU field in eBay for items that have an eBay listing ID
        </div>
      </div>

      <div class="inline-edit__actions" style="margin-top:16px;">
        <button type="submit" class="inline-edit__action">
          <i class="fas fa-check"></i> Assign Location
        </button>
        <button type="button" class="inline-edit__action inline-edit__cancel" onclick="closeBulkLocationModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='dashboard.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const upgradeBanner = document.getElementById('upgradePlanBanner');
  if (!upgradeBanner) {
    return;
  }

  const storage = (() => {
    try {
      return window.localStorage;
    } catch (_err) {
      return null;
    }
  })();

  const storageKey = upgradeBanner.dataset.dismissKey;
  if (storageKey && storage && storage.getItem(storageKey) === 'dismissed') {
    upgradeBanner.remove();
    return;
  }

  upgradeBanner.style.display = 'flex';

  const closeBtn = upgradeBanner.querySelector('[data-dismiss-button]');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      if (storageKey && storage) {
        storage.setItem(storageKey, 'dismissed');
      }
      upgradeBanner.remove();
    });
  }
});

// ==================== AUTOCOMPLETE ====================
(function() {
  const searchInput = document.getElementById('q');
  const autocompleteList = document.getElementById('dashboardAutocompleteList');
  const viewType = '{{ view_type }}'; // active, sold, or ended

  if (!searchInput || !autocompleteList) return;

  let debounceTimer;

  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();

    clearTimeout(debounceTimer);

    if (query.length < 2) {
      autocompleteList.classList.remove('show');
      autocompleteList.innerHTML = '';
      return;
    }

    debounceTimer = setTimeout(() => fetchAutocomplete(query), 300);
  });

  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteList.contains(e.target)) {
      autocompleteList.classList.remove('show');
    }
  });

  searchInput.addEventListener('keydown', function(e) {
    const items = autocompleteList.querySelectorAll('.autocomplete-item');
    const activeItem = autocompleteList.querySelector('.autocomplete-item.active');
    let index = Array.from(items).indexOf(activeItem);

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      index = Math.min(index + 1, items.length - 1);
      setActiveItem(items, index);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      index = Math.max(index - 1, 0);
      setActiveItem(items, index);
    } else if (e.key === 'Enter' && activeItem) {
      e.preventDefault();
      activeItem.click();
    } else if (e.key === 'Escape') {
      autocompleteList.classList.remove('show');
    }
  });

  function fetchAutocomplete(query) {
    fetch(`/api/autocomplete-items?q=${encodeURIComponent(query)}&view_type=${viewType}`)
      .then(response => response.json())
      .then(data => {
        if (data.ok && data.items) {
          displayResults(data.items);
        }
      })
      .catch(error => console.error('Autocomplete error:', error));
  }

  function displayResults(items) {
    autocompleteList.innerHTML = '';

    if (items.length === 0) {
      autocompleteList.classList.remove('show');
      return;
    }

    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <strong style="color:var(--text)">${highlightMatch(item.title, searchInput.value)}</strong>
          <div style="font-size:12px;color:var(--text-secondary);display:flex;gap:12px;flex-wrap:wrap">
            ${item.sku ? `<span>SKU: ${highlightMatch(item.sku, searchInput.value)}</span>` : ''}
            ${item.supplier ? `<span>Supplier: ${highlightMatch(item.supplier, searchInput.value)}</span>` : ''}
            ${item.location_code ? `<span>📍 ${item.location_code}</span>` : ''}
          </div>
        </div>
      `;

      div.addEventListener('click', () => {
        searchInput.value = item.title;
        autocompleteList.classList.remove('show');
        document.getElementById('filterForm').submit();
      });

      autocompleteList.appendChild(div);
    });

    autocompleteList.classList.add('show');
  }

  function highlightMatch(text, query) {
    if (!text || !query) return text || '';
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark style="background:#fbbf24;color:#000;padding:0 2px">$1</mark>');
  }

  function setActiveItem(items, index) {
    items.forEach((item, i) => {
      if (i === index) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  }
})();

// ==================== EBAY SYNC ====================
document.addEventListener('DOMContentLoaded', function() {
  const syncActiveBtn = document.getElementById('syncEbayActiveBtn');
  const syncSoldBtn = document.getElementById('syncEbaySoldBtn');

  if (syncActiveBtn) {
    syncActiveBtn.addEventListener('click', function() {
      syncEbayInventory('active');
    });
  }

  if (syncSoldBtn) {
    syncSoldBtn.addEventListener('click', function() {
      syncEbayInventory('sold');
    });
  }

  function syncEbayInventory(type) {
    const btn = type === 'active' ? syncActiveBtn : syncSoldBtn;
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

    const endpoint = type === 'active' ? '/sync-ebay-inventory' : '/sync-ebay-sold';

    fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      // Check for 403 (upgrade required)
      if (response.status === 403) {
        return response.json().then(data => {
          if (data.upgrade_required) {
            btn.innerHTML = originalHTML;
            btn.disabled = false;

            // Show upgrade notification
            const notification = document.createElement('div');
            notification.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 9999;
              padding: 20px 24px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              font-size: 14px;
              max-width: 400px;
              background: #fee2e2;
              color: #991b1b;
              border: 1px solid #f87171;
            `;

            notification.innerHTML = `
              <i class="fas fa-exclamation-circle"></i>
              <strong>${data.error}</strong>
              <div style="margin-top: 12px;">
                <a href="/upgrade" class="btn submitbtn" style="display: inline-block; padding: 8px 16px; text-decoration: none;">
                  <i class="fas fa-arrow-up"></i> Upgrade Plan
                </a>
              </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
              notification.remove();
            }, 8000);

            throw new Error('Upgrade required');
          }
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        btn.innerHTML = '<i class="fas fa-check"></i> Synced!';

        // Show success message
        showNotification(
          'success',
          data.message || `Successfully synced ${data.updated || 0} items`
        );

        // Reload page after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        btn.innerHTML = originalHTML;
        btn.disabled = false;

        showNotification('error', data.error || 'Sync failed');
      }
    })
    .catch(error => {
      console.error('Sync error:', error);
      btn.innerHTML = originalHTML;
      btn.disabled = false;

      showNotification('error', 'Network error. Please try again.');
    });
  }

  function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px;
      max-width: 400px;
      ${type === 'success'
        ? 'background: #d1fae5; color: #065f46; border: 1px solid #34d399;'
        : 'background: #fee2e2; color: #991b1b; border: 1px solid #f87171;'}
    `;

    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
      ${message}
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 5000);
  }
});
</script>

{% endblock %}
