{% extends "base_new.html" %}
{% block title %}Dashboard â€“ Qventory{% endblock %}

{% block content %}
<div class="dashboard-home">

  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">
      <i class="fas fa-home"></i> Dashboard
    </h1>
    <p class="page-subtitle">Your inventory at a glance</p>
  </div>

  <!-- Motivational Message -->
  <div class="motivational-banner" id="motivationalBanner" style="
    background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.1) 100%);
    border: 1px solid rgba(59,130,246,0.3);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    animation: slideIn 0.5s ease-out;
  ">
    <div style="font-size: 32px;">
      <span id="motivationalEmoji">ğŸš€</span>
    </div>
    <div style="flex: 1;">
      <div style="font-weight: 600; color: var(--text); margin-bottom: 4px;" id="motivationalTitle">
        Great job today!
      </div>
      <div style="font-size: 14px; color: var(--sub);" id="motivationalMessage">
        Loading...
      </div>
    </div>
    <div style="
      background: rgba(59,130,246,0.15);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      color: #3b82f6;
      font-size: 18px;
    " id="motivationalCount">
      {{ today_listings_count }}
    </div>
  </div>

  <style>
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <script>
    (function() {
      const count = {{ today_listings_count }};
      const banner = document.getElementById('motivationalBanner');
      const emoji = document.getElementById('motivationalEmoji');
      const title = document.getElementById('motivationalTitle');
      const message = document.getElementById('motivationalMessage');

      // Messages for 0 listings (humorÃ­sticos + motivacionales)
      const zeroMessages = [
        {
          emoji: 'ğŸ˜´',
          title: 'Zero listings today?',
          message: 'Even your inventory is wondering if you forgot about it... Time to wake up and list something! ğŸ’ª'
        },
        {
          emoji: 'ğŸ¦—',
          title: 'Crickets...',
          message: 'Your listing dashboard is so quiet, you can hear the echoes. Let\'s break the silence and add some heat! ğŸ”¥'
        },
        {
          emoji: 'ğŸ¯',
          title: 'Mission: List Something',
          message: 'Zero listings = zero sales potential. Today is the perfect day to turn that around. You got this! ğŸ’ª'
        },
        {
          emoji: 'â°',
          title: 'Tick tock...',
          message: 'The day isn\'t over yet! Even one listing can make a difference. Your future self will thank you! ğŸ™Œ'
        },
        {
          emoji: 'ğŸŒ±',
          title: 'Plant the seed today',
          message: 'Every listing is like planting a money tree. Zero listings = zero trees. Let\'s get gardening! ğŸŒ³'
        },
        {
          emoji: 'ğŸ’¤',
          title: 'Sleeping on opportunities?',
          message: 'Your competitors are listing while you\'re resting. Time to get back in the game! âš¡'
        },
        {
          emoji: 'ğŸ›°ï¸',
          title: 'Cassini is watching...',
          message: 'eBay\'s algorithm rewards active sellers! Zero new listings = lower search rankings. Feed Cassini and boost your visibility! ğŸ“ˆ'
        },
        {
          emoji: 'ğŸ¤–',
          title: 'Cassini needs fuel!',
          message: 'The eBay algorithm loves fresh inventory. No new listings today means you\'re invisible. Let\'s change that! ğŸ‘ï¸'
        }
      ];

      // Messages for 1+ listings (motivacionales)
      const positiveMessages = [
        {
          emoji: 'ğŸ”¥',
          title: 'You\'re on fire!',
          message: 'listings added today! Keep that momentum going - you\'re building something great! ğŸš€'
        },
        {
          emoji: 'ğŸ’ª',
          title: 'Beast mode activated!',
          message: 'listings today! That\'s what we call consistent hustle. Your inventory is looking better already! âœ¨'
        },
        {
          emoji: 'âš¡',
          title: 'Lightning fast!',
          message: 'new listings today! You\'re not just working, you\'re CRUSHING it. Keep up the amazing work! ğŸ¯'
        },
        {
          emoji: 'ğŸ¯',
          title: 'Bullseye!',
          message: 'listings added! You\'re hitting your targets and building momentum. Success loves consistency! ğŸŒŸ'
        },
        {
          emoji: 'ğŸš€',
          title: 'To the moon!',
          message: 'listings today! Every item is a potential sale. You\'re setting yourself up for success! ğŸ’°'
        },
        {
          emoji: 'ğŸ’',
          title: 'Diamond hands!',
          message: 'listings today! You\'re building your empire one item at a time. Consistency is key! ğŸ‘‘'
        },
        {
          emoji: 'â­',
          title: 'Shining bright!',
          message: 'new listings! Your dedication shows. Keep grinding and watch your business grow! ğŸ“ˆ'
        },
        {
          emoji: 'ğŸ†',
          title: 'Champion vibes!',
          message: 'listings added today! Winners show up every day. You\'re proving you\'re in it to win it! ğŸ’¯'
        },
        {
          emoji: 'ğŸ›°ï¸',
          title: 'Cassini loves this!',
          message: 'new listings today! Fresh inventory = higher search visibility. The algorithm is smiling at you right now! ğŸ˜Š'
        },
        {
          emoji: 'ğŸ“¡',
          title: 'Algorithm approved!',
          message: 'listings added! Cassini rewards active sellers with better search placement. Keep feeding the beast! ğŸ¯'
        },
        {
          emoji: 'ğŸ¤–',
          title: 'Cassini is happy!',
          message: 'new listings! The eBay algorithm notices your consistency. More listings = more impressions = more sales! ğŸ“Š'
        }
      ];

      let selectedMessage;

      if (count === 0) {
        // Random zero message
        selectedMessage = zeroMessages[Math.floor(Math.random() * zeroMessages.length)];
      } else {
        // Random positive message
        selectedMessage = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];
        selectedMessage.message = count + ' ' + selectedMessage.message;
      }

      // Update banner
      emoji.textContent = selectedMessage.emoji;
      title.textContent = selectedMessage.title;
      message.textContent = selectedMessage.message;

      // Change banner color for zero listings
      if (count === 0) {
        banner.style.background = 'linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(251,146,60,0.1) 100%)';
        banner.style.borderColor = 'rgba(239,68,68,0.3)';
        document.getElementById('motivationalCount').style.background = 'rgba(239,68,68,0.15)';
        document.getElementById('motivationalCount').style.color = '#ef4444';
      }
    })();
  </script>

  {% if recommended_article %}
  <div class="card" style="margin-bottom:24px;border:1px solid rgba(34,197,94,0.35);background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(59,130,246,0.06));">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;">
      <div style="min-width:220px;flex:1;">
        <div style="font-size:12px;color:#22c55e;text-transform:uppercase;letter-spacing:0.08em;font-weight:700;margin-bottom:6px;">
          Recommended Help Article
        </div>
        <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:6px;">
          {{ recommended_article.title }}
        </div>
        {% if recommended_article.summary %}
        <div style="color:var(--sub);font-size:14px;line-height:1.6;">
          {{ recommended_article.summary }}
        </div>
        {% endif %}
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <a href="{{ url_for('main.help_center_article', slug=recommended_article.slug) }}" class="btn submitbtn">
          <i class="fas fa-book-open"></i> Read Article
        </a>
        <a href="{{ url_for('main.help_center_index') }}" class="btn">
          View Help Center
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Pending Tasks Section (Only show if there are tasks) -->
  {% if pending_tasks.upgrade_recommendation or pending_tasks.ebay_connected == 0 or pending_tasks.items_missing_cost > 0 or pending_tasks.items_missing_supplier > 0 %}
  <section class="dashboard-section pending-tasks-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-exclamation-circle" style="color:#f59e0b"></i> Pending Tasks
      </h2>
      <p class="section-subtitle">Complete these to get the most out of Qventory</p>
    </div>

    <div class="task-cards">
      {% if pending_tasks.upgrade_recommendation %}
      <div class="task-card task-card--warning" id="upgradeTaskCard" data-dismiss-key="{{ upgrade_task_dismiss_key }}" style="position:relative;display:none;">
        <button type="button" class="task-card__dismiss" data-dismiss-button aria-label="Dismiss upgrade reminder" style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--sub);font-size:18px;cursor:pointer;padding:4px;">&times;</button>
        <div class="task-card__icon">
          <i class="fas fa-arrow-up"></i>
        </div>
        <div class="task-card__content">
          <h3 class="task-card__title">Upgrade Plan</h3>
          {% set remaining = pending_tasks.items_remaining %}
          {% set max_items = pending_tasks.plan_max_items %}
          <p class="task-card__description">
            {% if remaining is not none and remaining <= 0 %}
              You have reached the inventory limit for your current plan.
            {% else %}
              Only {{ remaining }} slot{{ '' if remaining == 1 else 's' }} left out of {{ max_items }}.
            {% endif %}
          </p>
        </div>
        <a href="{{ url_for('main.upgrade') }}" class="task-card__action btn btn-primary">
          <i class="fas fa-arrow-up"></i> Upgrade
        </a>
      </div>
      {% endif %}

      <!-- eBay Connection Task -->
      {% if pending_tasks.ebay_connected == 0 %}
      <div class="task-card task-card--warning">
        <div class="task-card__icon">
          <i class="fab fa-ebay"></i>
        </div>
        <div class="task-card__content">
          <h3 class="task-card__title">Connect eBay Account</h3>
          <p class="task-card__description">Import your inventory automatically</p>
        </div>
        <a href="{{ url_for('main.settings') }}#ebay" class="task-card__action btn btn-primary">
          <i class="fas fa-link"></i> Connect
        </a>
      </div>
      {% endif %}

      <!-- Missing Costs Task -->
      {% if pending_tasks.items_missing_cost > 0 %}
      <div class="task-card task-card--info">
        <div class="task-card__icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="task-card__content">
          <h3 class="task-card__title">{{ pending_tasks.items_missing_cost }} items missing cost</h3>
          <p class="task-card__description">Add costs to calculate profit margins</p>
        </div>
        <a href="{{ url_for('main.inventory_active') }}?missing_cost=1" class="task-card__action btn btn-secondary">
          <i class="fas fa-edit"></i> Fix Costs
        </a>
      </div>
      {% endif %}

      <!-- Missing Supplier Task -->
      {% if pending_tasks.items_missing_supplier > 0 %}
      <div class="task-card task-card--info">
        <div class="task-card__icon">
          <i class="fas fa-store"></i>
        </div>
        <div class="task-card__content">
          <h3 class="task-card__title">{{ pending_tasks.items_missing_supplier }} items missing supplier</h3>
          <p class="task-card__description">Track your inventory sources</p>
        </div>
        <a href="{{ url_for('main.inventory_active') }}?missing_supplier=1" class="task-card__action btn btn-secondary">
          <i class="fas fa-edit"></i> Add Suppliers
        </a>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- Quick Stats Section -->
  <section class="dashboard-section stats-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-chart-line"></i> Quick Stats
      </h2>
      <p class="section-subtitle">Last 30 days</p>
    </div>

    <div class="stats-grid">
      <!-- Sales Count -->
      <div class="stat-card">
        <div class="stat-card__header">
          <span class="stat-card__label">Sales</span>
          <i class="fas fa-shopping-cart stat-card__icon" style="color:#8ab4ff"></i>
        </div>
        <div class="stat-card__value">{{ stats.sales_count }}</div>
        {% if stats.sales_change_pct is not none %}
        <div class="stat-card__change {% if stats.sales_change_pct >= 0 %}stat-card__change--positive{% else %}stat-card__change--negative{% endif %}">
          <i class="fas fa-{% if stats.sales_change_pct >= 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
          {{ "%.1f"|format(stats.sales_change_pct|abs) }}%
        </div>
        {% endif %}
      </div>

      <!-- Revenue -->
      <div class="stat-card">
        <div class="stat-card__header">
          <span class="stat-card__label">Revenue</span>
          <i class="fas fa-dollar-sign stat-card__icon" style="color:#9ae6b4"></i>
        </div>
        <div class="stat-card__value">${{ "%.2f"|format(stats.total_revenue) }}</div>
        {% if stats.revenue_change_pct is not none %}
        <div class="stat-card__change {% if stats.revenue_change_pct >= 0 %}stat-card__change--positive{% else %}stat-card__change--negative{% endif %}">
          <i class="fas fa-{% if stats.revenue_change_pct >= 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
          {{ "%.1f"|format(stats.revenue_change_pct|abs) }}%
        </div>
        {% endif %}
      </div>

      <!-- Shipped -->
      <div class="stat-card">
        <div class="stat-card__header">
          <span class="stat-card__label">Shipped</span>
          <i class="fas fa-shipping-fast stat-card__icon" style="color:#fbbf24"></i>
        </div>
        <div class="stat-card__value">{{ stats.shipped_count }}</div>
        {% if stats.shipped_change_pct is not none %}
        <div class="stat-card__change {% if stats.shipped_change_pct >= 0 %}stat-card__change--positive{% else %}stat-card__change--negative{% endif %}">
          <i class="fas fa-{% if stats.shipped_change_pct >= 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
          {{ "%.1f"|format(stats.shipped_change_pct|abs) }}%
        </div>
        {% endif %}
      </div>

      <!-- Delivered -->
      <div class="stat-card">
        <div class="stat-card__header">
          <span class="stat-card__label">Delivered</span>
          <i class="fas fa-check-circle stat-card__icon" style="color:#34d399"></i>
        </div>
        <div class="stat-card__value">{{ stats.delivered_count }}</div>
        {% if stats.delivered_change_pct is not none %}
        <div class="stat-card__change {% if stats.delivered_change_pct >= 0 %}stat-card__change--positive{% else %}stat-card__change--negative{% endif %}">
          <i class="fas fa-{% if stats.delivered_change_pct >= 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
          {{ "%.1f"|format(stats.delivered_change_pct|abs) }}%
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Recent Sales Section -->
  {% if recent_sales %}
  <section class="dashboard-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-money-bill-wave"></i> Recent Sales
      </h2>
      <a href="{{ url_for('reports.analytics') }}" class="section-link">View All <i class="fas fa-arrow-right"></i></a>
    </div>

    <div class="activity-list">
      {% for sale in recent_sales %}
      <div class="activity-card sale-card">
        <div class="activity-card__thumb">
          {% if sale.item_thumb %}
          <img src="{{ sale.item_thumb }}" alt="{{ sale.item_title or sale.current_title }}" referrerpolicy="no-referrer">
          {% else %}
          <div class="thumb-placeholder"><i class="fas fa-image"></i></div>
          {% endif %}
        </div>
        <div class="activity-card__content">
          <h3 class="activity-card__title">{{ sale.item_title or sale.current_title or 'Untitled' }}</h3>
          <p class="activity-card__meta">
            <span class="tag">{{ sale.item_sku or 'No SKU' }}</span>
            {% if sale.marketplace %}
            <span class="tag">{{ sale.marketplace }}</span>
            {% endif %}
          </p>
        </div>
        <div class="activity-card__details">
          <div class="activity-card__price">${{ "%.2f"|format(sale.sold_price) }}</div>
          <div class="activity-card__time">{{ sale.sold_at|timeago if sale.sold_at else 'â€”' }}</div>
          <div class="activity-card__status">
            {% if sale.fulfillment_status == 'delivered' %}
            <span class="status-badge status-badge--success"><i class="fas fa-check-circle"></i> Delivered</span>
            {% elif sale.fulfillment_status == 'shipped' %}
            <span class="status-badge status-badge--info"><i class="fas fa-shipping-fast"></i> Shipped</span>
            {% else %}
            <span class="status-badge status-badge--warning"><i class="fas fa-clock"></i> Awaiting Ship</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Recently Listed & Recently Sold (Side by Side) -->
  <div class="dashboard-grid">
    <!-- Recently Listed -->
    {% if recently_listed %}
    <section class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-plus-circle"></i> Recently Listed
        </h2>
        <a href="{{ url_for('main.inventory_active') }}" class="section-link">View All <i class="fas fa-arrow-right"></i></a>
      </div>

      <div class="item-list">
        {% for item in recently_listed %}
        <div class="item-card">
          <div class="item-card__thumb">
            {% if item.item_thumb %}
            <img src="{{ item.item_thumb }}" alt="{{ item.title }}" referrerpolicy="no-referrer">
            {% else %}
            <div class="thumb-placeholder"><i class="fas fa-image"></i></div>
            {% endif %}
          </div>
          <div class="item-card__content">
            <h3 class="item-card__title">{{ item.title }}</h3>
            <p class="item-card__meta">
              <span class="item-card__price">${{ "%.2f"|format(item.item_price) if item.item_price else 'â€”' }}</span>
              <span class="item-card__time">{{ item.listed_at|timeago if item.listed_at else 'â€”' }}</span>
            </p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Recently Sold Items -->
    {% if recently_sold %}
    <section class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-tags"></i> Recently Sold
        </h2>
        <a href="{{ url_for('main.inventory_sold') }}" class="section-link">View All <i class="fas fa-arrow-right"></i></a>
      </div>

      <div class="item-list">
        {% for item in recently_sold %}
        <div class="item-card">
          <div class="item-card__thumb">
            {% if item.item_thumb %}
            <img src="{{ item.item_thumb }}" alt="{{ item.title }}" referrerpolicy="no-referrer">
            {% else %}
            <div class="thumb-placeholder"><i class="fas fa-image"></i></div>
            {% endif %}
          </div>
          <div class="item-card__content">
            <h3 class="item-card__title">{{ item.title }}</h3>
            <p class="item-card__meta">
              <span class="item-card__price">${{ "%.2f"|format(item.last_sold_price) if item.last_sold_price else 'â€”' }}</span>
              <span class="item-card__time">{{ item.last_sold_at|timeago if item.last_sold_at else 'â€”' }}</span>
            </p>
            {% if item.sale_count > 1 %}
            <span class="tag">{{ item.sale_count }}x sold</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </div>

  <!-- Recent Fulfillment -->
  {% if recent_fulfillment %}
  <section class="dashboard-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-truck"></i> Fulfillment Status
      </h2>
      <a href="{{ url_for('main.fulfillment') }}" class="section-link">View All <i class="fas fa-arrow-right"></i></a>
    </div>

    <div class="fulfillment-list">
      {% for order in recent_fulfillment %}
      <div class="fulfillment-card">
        <div class="fulfillment-card__icon">
          {% if order.fulfillment_status == 'delivered' %}
          <i class="fas fa-check-circle" style="color:#34d399"></i>
          {% else %}
          <i class="fas fa-box" style="color:#fbbf24"></i>
          {% endif %}
        </div>
        <div class="fulfillment-card__content">
          <h3 class="fulfillment-card__title">{{ order.item_title or 'Untitled' }}</h3>
          <p class="fulfillment-card__meta">
            <span>${{ "%.2f"|format(order.sold_price) if order.sold_price else 'â€”' }}</span>
            <span>â€¢</span>
            {% if order.fulfillment_status == 'delivered' %}
            <span>Delivered {{ order.delivered_at|timeago if order.delivered_at else 'â€”' }}</span>
            {% else %}
            <span>Shipped {{ order.shipped_at|timeago if order.shipped_at else 'â€”' }}</span>
            {% endif %}
            {% if order.carrier %}
            <span>via {{ order.carrier }}</span>
            {% endif %}
          </p>
        </div>
        <div class="fulfillment-card__status">
          {% if order.fulfillment_status == 'delivered' %}
          <span class="status-badge status-badge--success">Delivered</span>
          {% else %}
          <span class="status-badge status-badge--info">Shipped</span>
          {% endif %}
          {% if order.tracking_number %}
          <span class="tracking-badge">Track: {{ order.tracking_number[:10] }}...</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Quick Actions -->
  <section class="dashboard-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-bolt"></i> Quick Actions
      </h2>
    </div>

    <div class="quick-actions">
      <a href="{{ url_for('main.new_item') }}" class="quick-action-btn">
        <i class="fas fa-plus-circle"></i>
        <span>Add Item</span>
      </a>
      <a href="{{ url_for('reports.analytics') }}" class="quick-action-btn">
        <i class="fas fa-chart-bar"></i>
        <span>Analytics</span>
      </a>
      <a href="{{ url_for('main.ai_research') }}" class="quick-action-btn">
        <i class="fas fa-robot"></i>
        <span>AI Research</span>
      </a>
      <a href="{{ url_for('main.settings') }}" class="quick-action-btn">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
    </div>
  </section>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const upgradeTaskCard = document.getElementById('upgradeTaskCard');
  const storage = (() => {
    try {
      return window.localStorage;
    } catch (_err) {
      return null;
    }
  })();

  if (upgradeTaskCard) {
    const storageKey = upgradeTaskCard.dataset.dismissKey;
    const closeBtn = upgradeTaskCard.querySelector('[data-dismiss-button]');

    if (storageKey && storage && storage.getItem(storageKey) === 'dismissed') {
      upgradeTaskCard.remove();
    } else {
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          if (storageKey && storage) {
            storage.setItem(storageKey, 'dismissed');
          }
          upgradeTaskCard.remove();
          pruneEmptyTaskSection();
        });
      }
      upgradeTaskCard.style.display = 'flex';
    }
  }

  pruneEmptyTaskSection();

  function pruneEmptyTaskSection() {
    const section = document.querySelector('.pending-tasks-section');
    if (!section) return;
    const hasCards = section.querySelector('.task-card');
    if (!hasCards) {
      section.remove();
    }
  }
});
</script>
{% endblock %}
