{% extends "base.html" %}
{% block title %}Dashboard ‚Äì Qventory{% endblock %}
{% block content %}
<div class="row">
  <div class="card cardfilters" style="flex:1 1 280px;min-width:280px">
    <h2>Filters</h2>
    <form id="filterForm" method="get" action="{{ url_for('main.dashboard') }}" class="grid cols-3">
      <div style="grid-column:1/-1">
        <div class="input-with-button">
          <input class="input" type="text" id="q" name="q" value="{{ q }}" placeholder="Search title or SKU‚Ä¶">
          <button class="icon-btn" type="button" id="btnScan" title="Scan barcode with camera"
            aria-label="Scan barcode">üì∑</button>
        </div>
      </div>

      {% if settings.enable_A %}
      <div>
        <label>{{ settings.label_A }}</label>
        <select name="A">
          <option value="">All</option>
          {% for opt in options.A %}
          <option value="{{ opt }}" {% if fA==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_B %}
      <div>
        <label>{{ settings.label_B }}</label>
        <select name="B">
          <option value="">All</option>
          {% for opt in options.B %}
          <option value="{{ opt }}" {% if fB==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_S %}
      <div>
        <label>{{ settings.label_S }}</label>
        <select name="S">
          <option value="">All</option>
          {% for opt in options.S %}
          <option value="{{ opt }}" {% if fS==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_C %}
      <div>
        <label>{{ settings.label_C }}</label>
        <select name="C">
          <option value="">All</option>
          {% for opt in options.C %}
          <option value="{{ opt }}" {% if fC==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if PLATFORMS %}
      <div>
        <label>Platform</label>
        <select name="platform">
          <option value="">All</option>
          {% for key,label in PLATFORMS %}
          <option value="{{ key }}" {% if fPlatform==key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div style="grid-column:1/-1">
        <button class="btn submitbtn" type="submit">Apply</button>
        <a class="btn" href="{{ url_for('main.dashboard') }}">Clear</a>
      </div>
    </form>
  </div>

  <div class="card" style="flex:3 1 600px;min-width:320px">
    <h2>Items ({{ total_items }})</h2>
    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>SKU</th>
            <th>Location</th>
            <th>Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.title }}</td>
            <td><span class="tag itsku">{{ it.sku }}</span></td>
            <td>
              {% if it.location_code %}
              <a href="{{ url_for('main.public_view_location', username=un, code=it.location_code) }}">{{
                it.location_code }}</a>
              &nbsp; <a class="tag" href="{{ url_for('main.qr_for_location', username=un, code=it.location_code) }}"
                target="_blank">QR</a>
              {% else %}
              ‚Äî
              {% endif %}
            </td>
            <td>
              <div class="platform-badges">
                {% if it.web_url %}<a class="tag" href="{{ it.web_url }}" target="_blank">Web</a>{% endif %}
                {% if it.ebay_url %}<a class="tag" href="{{ it.ebay_url }}" target="_blank">eBay</a>{% endif %}
                {% if it.amazon_url %}<a class="tag" href="{{ it.amazon_url }}" target="_blank">Amazon</a>{% endif %}
                {% if it.mercari_url %}<a class="tag" href="{{ it.mercari_url }}" target="_blank">Mercari</a>{% endif %}
                {% if it.vinted_url %}<a class="tag" href="{{ it.vinted_url }}" target="_blank">Vinted</a>{% endif %}
                {% if it.poshmark_url %}<a class="tag" href="{{ it.poshmark_url }}" target="_blank">Poshmark</a>{% endif
                %}
                {% if it.depop_url %}<a class="tag" href="{{ it.depop_url }}" target="_blank">Depop</a>{% endif %}
                {% if not (it.web_url or it.ebay_url or it.amazon_url or it.mercari_url or it.vinted_url or
                it.poshmark_url or it.depop_url) %}‚Äî{% endif %}
              </div>
            </td>
            <td>
              {% if current_user.is_authenticated %}
              <a class="btn settingsbtn" href="{{ url_for('main.edit_item', item_id=it.id) }}">üìù</a>

              <form style="display:inline" method="post" action="{{ url_for('main.print_item', item_id=it.id) }}">
                <button class="btn settingsbtn" type="submit" title="Print label">üñ®Ô∏è</button>
              </form>

              <form style="display:inline" method="post" action="{{ url_for('main.delete_item', item_id=it.id) }}"
                onsubmit="return confirm('Delete this item?')">
                <button class="btn settingsbtn" type="submit">‚ùå</button>
              </form>
              {% else %}
              <span class="tag ">Login to edit</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal del esc√°ner (compacto) -->
<div id="scanModal" class="scan-modal hidden" aria-hidden="true" aria-label="Barcode scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong>Scan a barcode</strong>
      <div class="scan-actions">
        <button type="button" id="scanFlashlight" class="icon-top" aria-label="Toggle flashlight"
          title="Toggle flashlight">üî¶</button>
        <button type="button" id="scanFlip" class="icon-top" aria-label="Flip camera" title="Flip camera">üîÅ</button>
        <button type="button" id="scanClose" class="icon-top" aria-label="Close">‚úï</button>
      </div>
    </div>

    <div class="scan-body">
      <div class="viewport">
        <video id="scanVideo" playsinline autoplay muted></video>
        <div class="guide"></div>
        <div id="scanTarget" class="scan-target"></div>
        <div id="scanSpinner" class="spinner"></div>
        <div id="scanSuccess" class="success-indicator">‚úì</div>
      </div>
      <div class="scan-tip">Align the barcode inside the frame</div>
      <div id="scanResult" class="scan-result"></div>
    </div>
  </div>
</div>
<script>
  // Inicializar el scanner cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function () {
    if (window.BarcodeScanner && BarcodeScanner.isSupported()) {
      BarcodeScanner.init({
        // Configuraci√≥n por defecto (los IDs ya est√°n correctos)
        scanButtonId: 'btnScan',
        modalId: 'scanModal',
        closeButtonId: 'scanClose',
        flipButtonId: 'scanFlip',
        flashButtonId: 'scanFlashlight',
        videoId: 'scanVideo',
        targetId: 'scanTarget',
        spinnerId: 'scanSpinner',
        successId: 'scanSuccess',
        resultId: 'scanResult',
        inputId: 'q',
        formId: 'filterForm',
        // Callback personalizado (opcional)
        onDetected: function (code) {
          const inputQ = document.getElementById('q');
          const form = document.getElementById('filterForm');
          if (inputQ) inputQ.value = code;
          if (form) form.submit();
        }
      });
      console.log('BarcodeScanner initialized successfully');
    } else {
      console.warn('BarcodeScanner not supported or not loaded');
      // Opcional: ocultar el bot√≥n de scanner
      const btnScan = document.getElementById('btnScan');
      if (btnScan) btnScan.style.display = 'none';
    }
  });
</script>
{% endblock %}