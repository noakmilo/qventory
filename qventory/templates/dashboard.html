{% extends "base.html" %}
{% block title %}Dashboard – Qventory{% endblock %}
{% block content %}
<div class="row">

  <!-- Filtros -->
  <div class="card cardfilters filters-shell" style="flex:1 1 100%;min-width:280px">
    <div class="filters-bar">
      <h2>Filters</h2>
      <button class="btn filters-toggle" type="button" onclick="document.querySelector('.filters-content').toggleAttribute('hidden')">
        <i class="fas fa-filter"></i> Toggle
      </button>
    </div>
    <div class="filters-content">
      <form id="filterForm" method="get" action="{{ url_for('main.dashboard') }}" class="filters-grid">
        <div style="grid-column:1/-1">
          <div class="input-with-button">
            <input class="input" type="text" id="q" name="q" value="{{ q }}" placeholder="Search title / SKU / supplier…">
            <button class="icon-btn" type="button" id="btnScanQR" title="Scan QR code with camera" aria-label="Scan QR code">
              <i class="fas fa-qrcode"></i>
            </button>
          </div>
        </div>

        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A">
            <option value="">All</option>
            {% for opt in options.A %}
            <option value="{{ opt }}" {% if fA==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B">
            <option value="">All</option>
            {% for opt in options.B %}
            <option value="{{ opt }}" {% if fB==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S">
            <option value="">All</option>
            {% for opt in options.S %}
            <option value="{{ opt }}" {% if fS==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C">
            <option value="">All</option>
            {% for opt in options.C %}
            <option value="{{ opt }}" {% if fC==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if options.supplier and options.supplier|length %}
        <div>
          <label>Supplier</label>
          <select name="supplier">
            <option value="">All</option>
            {% for opt in options.supplier %}
            <option value="{{ opt }}" {% if fSupplier==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if PLATFORMS %}
        <div>
          <label>Platform</label>
          <select name="platform">
            <option value="">All</option>
            {% for key,label in PLATFORMS %}
            <option value="{{ key }}" {% if fPlatform==key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div style="grid-column:1/-1">
          <button class="btn submitbtn" type="submit">Apply</button>
          <a class="btn" href="{{ url_for('main.dashboard') }}">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Inventario -->
  <div class="card inventory-shell" style="flex:1 1 100%;min-width:320px">
    <div class="items-header">
      <h2>Items ({{ total_items }})</h2>
      <div class="backup-actions">
        <a class="btn backup-btn" href="{{ url_for('main.export_csv') }}" title="Export all items to CSV">
          <i class="fas fa-download"></i> Export
        </a>
        <a class="btn backup-btn" href="{{ url_for('main.import_csv') }}" title="Import items from CSV">
          <i class="fas fa-upload"></i> Import
        </a>
      </div>
    </div>
    
    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th style="width:44px"></th>
            <th>Title</th>
            <th>SKU</th>
            <th class="mobile-hide">Supplier</th>
            <th class="mobile-hide">Cost</th>
            <th>Price</th>
            <th class="mobile-hide">ROI</th>
            <th>Location</th>
            <th class="mobile-hide">Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          {% set has_price = it.item_price is not none %}
          {% set has_cost = it.item_cost is not none and it.item_cost > 0 %}
          {% set roi = ( (it.item_price - it.item_cost) / it.item_cost * 100 ) if (has_price and has_cost) else None %}
          <tr>
            <td>
              {% if it.item_thumb %}
                <!-- Imagen con overlay de lupa y apertura de modal -->
                <button class="thumb-wrap" type="button" data-full="{{ it.item_thumb }}" aria-label="View image">
                  <img src="{{ it.item_thumb }}" alt="{{ it.title }}" class="thumb-img">
                  <span class="thumb-zoom"><i class="fas fa-search"></i></span>
                </button>
              {% else %}
                <div style="width:36px;height:36px;border-radius:6px;border:1px dashed #bbb;display:grid;place-items:center;font-size:12px;color:#888;">—</div>
              {% endif %}
            </td>
            <td>{{ it.title }}</td>
            <td><span class="tag itsku">{{ it.sku }}</span></td>

            <!-- Supplier -->
            <td class="mobile-hide">
              {% if it.supplier %}
                <span class="tag">{{ it.supplier }}</span>
              {% else %}—{% endif %}
            </td>

            <!-- Cost -->
            <td class="mobile-hide">
              {% if it.item_cost %}
                <span class="tag"><i class="fas fa-receipt"></i> ${{ '%.2f'|format(it.item_cost) }}</span>
              {% else %}—{% endif %}
            </td>

            <!-- Price -->
            <td>
              {% if it.item_price %}
                <span class="tag"><i class="fas fa-tag"></i> ${{ '%.2f'|format(it.item_price) }}</span>
              {% else %}—{% endif %}
            </td>

            <!-- ROI -->
            <td class="mobile-hide">
              {% if has_price and has_cost %}
                <span class="tag">ROI {{ roi|round(0) }}%</span>
              {% else %}—{% endif %}
            </td>

            <!-- Location -->
            <td>
              {% if it.location_code %}
              <a href="{{ url_for('main.public_view_location', username=un, code=it.location_code) }}">{{ it.location_code }}</a>
              &nbsp;
              <a class="tag qr-link"
                 href="{{ url_for('main.qr_for_location', username=un, code=it.location_code) }}"
                 data-caption="QR for {{ it.location_code }}">
                <i class="fas fa-qrcode"></i>
              </a>
              {% else %}
              —
              {% endif %}
            </td>

            <!-- Listings -->
            <td class="mobile-hide">
              <div class="platform-badges">
                {% if it.web_url %}<a class="tag" href="{{ it.web_url }}" target="_blank">Web</a>{% endif %}
                {% if it.ebay_url %}<a class="tag" href="{{ it.ebay_url }}" target="_blank">eBay</a>{% endif %}
                {% if it.amazon_url %}<a class="tag" href="{{ it.amazon_url }}" target="_blank">Amazon</a>{% endif %}
                {% if it.mercari_url %}<a class="tag" href="{{ it.mercari_url }}" target="_blank">Mercari</a>{% endif %}
                {% if it.vinted_url %}<a class="tag" href="{{ it.vinted_url }}" target="_blank">Vinted</a>{% endif %}
                {% if it.poshmark_url %}<a class="tag" href="{{ it.poshmark_url }}" target="_blank">Poshmark</a>{% endif %}
                {% if it.depop_url %}<a class="tag" href="{{ it.depop_url }}" target="_blank">Depop</a>{% endif %}
              </div>
            </td>

            <!-- Acciones -->
            <td>
              {% if current_user.is_authenticated %}
              <a class="btn settingsbtn" href="{{ url_for('main.edit_item', item_id=it.id) }}">
                <i class="fas fa-edit"></i>
              </a>
              <form style="display:inline" method="post" action="{{ url_for('main.print_item', item_id=it.id) }}">
                <button class="btn settingsbtn" type="submit" title="Print label">
                  <i class="fas fa-print"></i>
                </button>
              </form>
              <form style="display:inline" method="post" action="{{ url_for('main.delete_item', item_id=it.id) }}" onsubmit="return confirm('Delete this item?')">
                <button class="btn settingsbtn" type="submit">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
              {% else %}
              <span class="tag">Login to edit</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Modal de imagen ampliada ===== -->
<div id="imgModal" hidden aria-hidden="true" role="dialog" aria-modal="true" style="
  position:fixed; inset:0; display:grid; place-items:center; z-index:1000;
  background:rgba(0,0,0,.55);
">
  <div class="glass" style="
    position:relative; max-width:min(92vw,1000px); max-height:min(88vh,1000px);
    border-radius:16px; padding:10px; box-sizing:border-box;
  ">
    <button id="imgClose" class="btn small" aria-label="Close" style="position:absolute; top:8px; right:8px;">
      <i class="fas fa-times"></i>
    </button>
    <img id="imgModalImg" src="" alt="" style="
      display:block; width:100%; height:auto; max-height:80vh; object-fit:contain; border-radius:10px;
    ">
  </div>
</div>

<!-- ===== Modal ESCÁNER QR ===== -->
<div id="scanQRModal" hidden aria-hidden="true" role="dialog" aria-modal="true" style="
  position:fixed; inset:0; display:grid; place-items:center; z-index:1100;
  background:rgba(0,0,0,.55);
">
  <div class="glass" style="
    position:relative; width:min(96vw,520px); max-height:min(92vh,820px);
    border-radius:16px; padding:12px; box-sizing:border-box; overflow:hidden;
  ">
    <!-- Header -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
      <h3 style="margin:0; font-size:16px; display:flex; align-items:center; gap:8px">
        <i class="fas fa-qrcode"></i> Scan QR
      </h3>
      <div style="display:flex; gap:6px">
        <button id="scanQRFlashlight" class="btn small" type="button" title="Flashlight"><i class="fas fa-bolt"></i></button>
        <button id="scanQRFlip" class="btn small" type="button" title="Flip camera"><i class="fas fa-sync-alt"></i></button>
        <button id="scanQRClose" class="btn small" type="button" aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
    </div>

    <!-- Viewport -->
    <div style="position:relative; border-radius:12px; overflow:hidden; border:1px solid var(--glass-border); background:rgba(14,22,48,.55); aspect-ratio: 3/2;">
      <video id="scanQRVideo" playsinline muted autoplay style="width:100%; height:100%; object-fit:cover; display:block;"></video>

      <!-- Spinner -->
      <div id="scanQRSpinner" style="
        position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
        font-size:13px; background:rgba(0,0,0,.25);
      ">
        <div class="tag">Initializing camera…</div>
      </div>

      <!-- Success flash -->
      <div id="scanQRSuccess" style="
        position:absolute; inset:0; display:none; align-items:center; justify-content:center;
        pointer-events:none; background:rgba(0,255,128,.12);
      "></div>
    </div>

    <!-- Result -->
    <div id="scanQRResult" class="muted" style="margin-top:8px; display:none"></div>
  </div>
</div>

<style>
  /* ===== Visibilidad de modales (cerrados por defecto) ===== */
  #imgModal[hidden], #scanQRModal[hidden] { display: none !important; }
  #imgModal, #scanQRModal { display: grid; }
  .modal-open { overflow: hidden; }

  /* ===== Miniaturas con overlay de lupa ===== */
  .thumb-wrap{
    position:relative;
    width:36px; height:36px;
    padding:0; border:0;
    cursor:zoom-in;
    background:transparent;
    display:block;
    border-radius:6px;
  }
  .thumb-img{
    width:100%; height:100%;
    object-fit:cover;
    border-radius:inherit;
    border:1px solid var(--glass-border);
    display:block;
  }
  .thumb-zoom{
    position:absolute;
    right:2px; bottom:2px;
    display:grid; place-items:center;
    width:18px; height:18px;
    border-radius:4px;
    font-size:11px; line-height:1;
    background:var(--glass-bg-strong);
    border:1px solid var(--glass-border);
    color:#cfe0ff;
    box-shadow:0 2px 6px rgba(0,0,0,.35);
  }
  .thumb-wrap:hover .thumb-zoom{ filter:brightness(1.07) }
</style>

<!-- ======================= SCRIPTS ======================= -->

<script>
/* Toggle filtros con persistencia (solo si existen IDs) */
(function(){
  const btn = document.getElementById('filtersToggle');
  const content = document.getElementById('filtersContent');
  const shell = document.getElementById('filtersShell');
  if(!btn || !content) return;
  const KEY = 'qv_filters_collapsed';
  function setCollapsed(collapsed){
    content.hidden = collapsed;
    btn.setAttribute('aria-expanded', String(!collapsed));
    shell?.classList.toggle('collapsed', collapsed);
    try{ localStorage.setItem(KEY, collapsed ? '1':'0'); }catch{}
  }
  function initState(){
    let collapsed = false;
    try{ collapsed = localStorage.getItem(KEY) === '1'; }catch{}
    setCollapsed(collapsed);
  }
  btn.addEventListener('click', ()=> setCollapsed(!content.hasAttribute('hidden')));
  initState();
})();
</script>

<script>
/* ====== Modal de imagen ampliada ====== */
(function(){
  const modal  = document.getElementById('imgModal');
  const imgEl  = document.getElementById('imgModalImg');
  const closeBtn = document.getElementById('imgClose');

  function openImg(url, alt){
    if(!url) return;
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.setAttribute('aria-hidden','false');
    imgEl.src = url;
    imgEl.alt = alt || '';
  }
  function closeImg(){
    modal.setAttribute('hidden', '');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    imgEl.src = '';
  }

  // Delegación: funciona para todos los .thumb-wrap
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.thumb-wrap');
    if(!btn) return;
    const url = btn.getAttribute('data-full');
    const alt = btn.querySelector('img')?.getAttribute('alt') || '';
    openImg(url, alt);
  });

  closeBtn?.addEventListener('click', closeImg);
  // Cerrar tocando fuera (clic en backdrop)
  modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeImg(); });
  // Esc para cerrar
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hasAttribute('hidden')) closeImg(); });
})();
</script>

<script>
/* ========== SCRIPT SCANNER QR (robusto) ========== */
(function(){
  const btnScan = document.getElementById('btnScanQR');
  const modal = document.getElementById('scanQRModal');
  const btnClose = document.getElementById('scanQRClose');
  const btnFlip = document.getElementById('scanQRFlip');
  const btnFlash = document.getElementById('scanQRFlashlight');
  const video = document.getElementById('scanQRVideo');
  const spinner = document.getElementById('scanQRSpinner');
  const success = document.getElementById('scanQRSuccess');
  const result = document.getElementById('scanQRResult');
  const inputQ = document.getElementById('q');
  const form = document.getElementById('filterForm');

  const CAM_CACHE_KEY = 'qv_dashboard_qr_cam_device_id';
  let stream = null, rafId = null;
  let detector = null;
  let usingBD = false, usingJsQR = false, jsQRLoaded = false;
  let videoDevices = [], currentDeviceIdx = -1, devicesLoaded = false;
  let flashlightOn = false;

  function openModal(){
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    document.body.classList.remove('modal-open');
    modal.setAttribute('hidden','');
    modal.setAttribute('aria-hidden','true');
  }
  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }
  function showSuccess(){ success.style.display='block'; setTimeout(()=>success.style.display='none', 450); }
  function cleanupLoop(){ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } }
  function cleanupAll(){
    cleanupLoop();
    if (stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch{}; stream=null; }
    flashlightOn=false; btnFlash.classList.remove('active');
    video.srcObject=null; video.style.display='none';
    usingBD=false; usingJsQR=false;
  }
  function showError(msg){ console.error('[QR]', msg); alert(msg); }

  async function loadVideoDevices(){
    if (devicesLoaded) return;
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d=>d.kind==='videoinput');
    const prefers = ['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      const as = prefers.some(p=>la.includes(p)) ? 1:0;
      const bs = prefers.some(p=>lb.includes(p)) ? 1:0;
      return bs - as;
    });
    devicesLoaded = true;
  }

  async function startWithDevice(deviceId){
    cleanupLoop();
    showSpinner(true);
    const constraints = {
      video: deviceId ? { deviceId:{exact:deviceId}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30}, facingMode:'environment' }
                      : { facingMode:{ideal:'environment'}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30} },
      audio: false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
    video.srcObject = stream;
    await video.play();
    if (video.readyState < 2){
      await new Promise(res=>{
        const t = setTimeout(res, 250);
        video.onloadedmetadata = ()=>{ clearTimeout(t); res(); };
      });
    }
    showSpinner(false);
    video.style.display='block';
  }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
    await startWithDevice(videoDevices[currentDeviceIdx].deviceId);
    if (usingBD) startBDLoop();
    if (usingJsQR) startJsQRLoop();
  }

  async function toggleFlashlight(){
    if (!stream) return;
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      if (!caps.torch) return alert('Flashlight not supported on this camera');
      flashlightOn = !flashlightOn;
      await track.applyConstraints({ advanced:[{ torch: flashlightOn }] });
      btnFlash.classList.toggle('active', flashlightOn);
    }catch{ alert('Unable to control flashlight'); }
  }

  function extractSku(val){
    if (!val) return '';
    const s = String(val).trim();
    try{
      const u = new URL(s);
      const m = u.href.match(/([A-Z0-9]{8,}|\d{10,}|\d{8}-[A-Z0-9]{3,})/i);
      return m ? m[1] : s;
    }catch{ return s; }
  }

  function onDetected(raw){
    const v = extractSku(raw);
    if (!v) return;
    result.textContent = `Detected: ${v.slice(0,120)}`;
    result.style.display='block';
    showSuccess();
    try{ navigator.vibrate && navigator.vibrate(80); }catch{}
    setTimeout(()=>{
      cleanupAll(); closeModal();
      inputQ.value = v;
      form?.submit();
    }, 500);
  }

  async function tryBarcodeDetector(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      detector = new window.BarcodeDetector({ formats: ['qr_code','qr'] });
    }catch{
      try{ detector = new window.BarcodeDetector(); }catch{ return false; }
    }
    usingBD = true; usingJsQR = false;
    startBDLoop();
    return true;
  }

  function startBDLoop(){
    cleanupLoop();
    let frame = 0;
    const tick = async ()=>{
      frame++;
      try{
        if (frame%2===0 && detector && video.readyState >= 2){
          const codes = await detector.detect(video);
          if (codes && codes.length){
            const val = (codes[0].rawValue || '').trim();
            if (val){ onDetected(val); return; }
          }
        }
      }catch(e){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function loadJsQR(){
    if (jsQRLoaded) return Promise.resolve();
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async=true;
      s.onload=()=>{ jsQRLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error('jsQR CDN blocked/failed to load'));
      document.head.appendChild(s);
    });
  }

  function startJsQRLoop(){
    usingBD=false; usingJsQR=true;
    cleanupLoop();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const ROI_INSET = 0.08;

    let lastTS = 0;
    const MIN_INTERVAL = 80;

    const tick = (now)=>{
      try{
        if (!usingJsQR) return;
        if (now - lastTS >= MIN_INTERVAL && video.videoWidth>0){
          const vw = video.videoWidth, vh = video.videoHeight;
          const rx = Math.floor(vw*ROI_INSET), ry = Math.floor(vh*ROI_INSET);
          const rw = Math.floor(vw*(1-2*ROI_INSET)), rh = Math.floor(vh*(1-2*ROI_INSET));
          canvas.width = rw; canvas.height = rh;
          ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);
          const img = ctx.getImageData(0, 0, rw, rh);
          const qr = window.jsQR && window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
          const val = (qr?.data || '').trim();
          if (val){ onDetected(val); return; }
        }
      }catch{}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startScan(){
    openModal(); result.style.display='none'; success.style.display='none';
    try{
      const cachedId = localStorage.getItem(CAM_CACHE_KEY) || null;
      await loadVideoDevices();
      if (videoDevices.length){
        if (cachedId){
          const idx = videoDevices.findIndex(d=>d.deviceId===cachedId);
          currentDeviceIdx = idx >= 0 ? idx : 0;
        } else {
          currentDeviceIdx = 0;
        }
      }
      await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);

      const bdOK = await tryBarcodeDetector();
      if (!bdOK){
        try{
          await loadJsQR();
          startJsQRLoop();
        }catch(e){
          showError('No QR engine available (BarcodeDetector unsupported and jsQR blocked).');
          cleanupAll(); closeModal();
        }
      }
    }catch(e){
      showError(e?.message || 'Camera error');
      cleanupAll(); closeModal();
    }
  }

  btnScan?.addEventListener('click', startScan);
  document.getElementById('scanQRFlip')?.addEventListener('click', async ()=>{ await flipCamera(); });
  document.getElementById('scanQRFlashlight')?.addEventListener('click', async ()=>{ await toggleFlashlight(); });
  document.getElementById('scanQRClose')?.addEventListener('click', ()=>{ cleanupAll(); closeModal(); });

  // Cerrar tocando fuera del contenido
  document.getElementById('scanQRModal')?.addEventListener('click', (e)=>{
    if (e.target===document.getElementById('scanQRModal')){
      cleanupAll(); closeModal();
    }
  });

  // ===== Modal QR desde enlaces de ubicación (QR PNG) =====
  const qrModal   = document.getElementById('qrModal');     // Si lo usas en otra parte
  const qrClose   = document.getElementById('qrClose');
  const qrImage   = document.getElementById('qrImage');
  const qrOpenNew = document.getElementById('qrOpenNew');
  const qrCaption = document.getElementById('qrCaption');
  const qrTitle   = document.getElementById('qrTitle');

  function openQrModal(url, caption){
    if(!qrModal) return; // opcional si no está este modal
    document.body.classList.add('modal-open');
    qrModal.classList.remove('hidden');
    qrModal.setAttribute('aria-hidden','false');
    qrImage.src = '';
    setTimeout(()=>{ qrImage.src = url; }, 0);
    if(qrOpenNew) qrOpenNew.href = url;
    if(qrCaption) qrCaption.textContent = caption || '';
    if(qrTitle)   qrTitle.textContent   = caption || 'QR';
  }
  function closeQrModal(){
    if(!qrModal) return;
    document.body.classList.remove('modal-open');
    qrModal.classList.add('hidden');
    qrModal.setAttribute('aria-hidden','true');
    qrImage.src = '';
  }
  document.body.addEventListener('click', (e) => {
    const a = e.target.closest('a.qr-link');
    if (!a) return;
    e.preventDefault();
    const url = a.getAttribute('href');
    const caption = a.getAttribute('data-caption') || a.textContent || 'QR';
    openQrModal(url, caption);
  });
  qrClose?.addEventListener('click', closeQrModal);
  qrModal?.addEventListener('click', (e)=>{ if (e.target === qrModal) closeQrModal(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && qrModal && !qrModal.classList.contains('hidden')) closeQrModal(); });

})();
</script>

{% endblock %}
