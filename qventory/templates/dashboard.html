{% extends "base.html" %}
{% block title %}Dashboard ‚Äì Qventory{% endblock %}
{% block content %}
<div class="row">
  <div class="card cardfilters" style="flex:1 1 280px;min-width:280px">
    <h2>Filters</h2>
    <form id="filterForm" method="get" action="{{ url_for('main.dashboard') }}" class="grid cols-3">
      <div style="grid-column:1/-1">
        <div class="input-with-button">
          <input class="input" type="text" id="q" name="q" value="{{ q }}" placeholder="Search title or SKU‚Ä¶">
          <button class="icon-btn" type="button" id="btnScan" title="Scan barcode with camera" aria-label="Scan barcode">üì∑</button>
        </div>
      </div>

      {% if settings.enable_A %}
      <div>
        <label>{{ settings.label_A }}</label>
        <select name="A">
          <option value="">All</option>
          {% for opt in options.A %}
          <option value="{{ opt }}" {% if fA==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_B %}
      <div>
        <label>{{ settings.label_B }}</label>
        <select name="B">
          <option value="">All</option>
          {% for opt in options.B %}
          <option value="{{ opt }}" {% if fB==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_S %}
      <div>
        <label>{{ settings.label_S }}</label>
        <select name="S">
          <option value="">All</option>
          {% for opt in options.S %}
          <option value="{{ opt }}" {% if fS==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_C %}
      <div>
        <label>{{ settings.label_C }}</label>
        <select name="C">
          <option value="">All</option>
          {% for opt in options.C %}
          <option value="{{ opt }}" {% if fC==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if PLATFORMS %}
      <div>
        <label>Platform</label>
        <select name="platform">
          <option value="">All</option>
          {% for key,label in PLATFORMS %}
          <option value="{{ key }}" {% if fPlatform==key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div style="grid-column:1/-1">
        <button class="btn submitbtn" type="submit">Apply</button>
        <a class="btn" href="{{ url_for('main.dashboard') }}">Clear</a>
      </div>
    </form>
  </div>

  <div class="card" style="flex:3 1 600px;min-width:320px">
    <h2>Items ({{ total_items }})</h2>
    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>SKU</th>
            <th>Location</th>
            <th>Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.title }}</td>
            <td><span class="tag itsku">{{ it.sku }}</span></td>
            <td>
              {% if it.location_code %}
              <a href="{{ url_for('main.public_view_location', username=un, code=it.location_code) }}">{{ it.location_code }}</a>
              &nbsp; <a class="tag" href="{{ url_for('main.qr_for_location', username=un, code=it.location_code) }}" target="_blank">QR</a>
              {% else %}
              ‚Äî
              {% endif %}
            </td>
            <td>
              <div class="platform-badges">
                {% if it.web_url %}<a class="tag" href="{{ it.web_url }}" target="_blank">Web</a>{% endif %}
                {% if it.ebay_url %}<a class="tag" href="{{ it.ebay_url }}" target="_blank">eBay</a>{% endif %}
                {% if it.amazon_url %}<a class="tag" href="{{ it.amazon_url }}" target="_blank">Amazon</a>{% endif %}
                {% if it.mercari_url %}<a class="tag" href="{{ it.mercari_url }}" target="_blank">Mercari</a>{% endif %}
                {% if it.vinted_url %}<a class="tag" href="{{ it.vinted_url }}" target="_blank">Vinted</a>{% endif %}
                {% if it.poshmark_url %}<a class="tag" href="{{ it.poshmark_url }}" target="_blank">Poshmark</a>{% endif %}
                {% if it.depop_url %}<a class="tag" href="{{ it.depop_url }}" target="_blank">Depop</a>{% endif %}
                {% if not (it.web_url or it.ebay_url or it.amazon_url or it.mercari_url or it.vinted_url or it.poshmark_url or it.depop_url) %}‚Äî{% endif %}
              </div>
            </td>
            <td>
              {% if current_user.is_authenticated %}
              <a class="btn settingsbtn" href="{{ url_for('main.edit_item', item_id=it.id) }}">üìù</a>

              <form style="display:inline" method="post" action="{{ url_for('main.print_item', item_id=it.id) }}">
                <button class="btn settingsbtn" type="submit" title="Print label">üñ®Ô∏è</button>
              </form>

              <form style="display:inline" method="post" action="{{ url_for('main.delete_item', item_id=it.id) }}" onsubmit="return confirm('Delete this item?')">
                <button class="btn settingsbtn" type="submit">‚ùå</button>
              </form>
              {% else %}
              <span class="tag ">Login to edit</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal del esc√°ner -->
<div id="scanModal" class="scan-modal hidden" aria-hidden="true" aria-label="Barcode scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong>Scan a barcode</strong>
      <div class="scan-actions">
        <button type="button" id="scanFlip" class="icon-top" aria-label="Flip camera" title="Flip camera">üîÅ</button>
        <button type="button" id="scanClose" class="icon-top" aria-label="Close">‚úï</button>
      </div>
    </div>

    <div class="scan-body">
      <div class="viewport">
        <video id="scanVideo" playsinline autoplay muted></video>
        <div class="guide"></div>
        <div id="scanTarget" class="scan-target"></div>
        <div id="scanSpinner" class="spinner"></div>
      </div>
      <div class="scan-tip">Align the barcode inside the frame</div>
      <!-- pitido corto (backup si WebAudio no puede) -->
      <audio id="scanBeep" preload="auto">
        <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkYXRhAAAAAA==" type="audio/wav">
      </audio>
    </div>
  </div>
</div>

<script>
(function(){
  const btnScan   = document.getElementById('btnScan');
  const modal     = document.getElementById('scanModal');
  const btnClose  = document.getElementById('scanClose');
  const btnFlip   = document.getElementById('scanFlip');
  const video     = document.getElementById('scanVideo');
  const target    = document.getElementById('scanTarget');
  const spinner   = document.getElementById('scanSpinner');
  const inputQ    = document.getElementById('q');
  const form      = document.getElementById('filterForm');
  const beepEl    = document.getElementById('scanBeep');

  const CAM_CACHE_KEY = 'qv_cam_device_id';
  let cachedDeviceId = null;

  let stream = null, rafId = null, detector = null, usingQuagga = false;
  let videoDevices = [], currentDeviceIdx = -1, currentTrack = null;

  // === Precisi√≥n equilibrada ===
  const ALLOWED_FORMATS_BD = ['ean_13','ean_8','upc_a','upc_e','code_128'];
  const ALLOWED_READERS_QG = ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'];

  // Consenso m√°s laxo
  const CONSENSUS_NEEDED = 2;
  const CONSENSUS_WINDOW = 5;
  let seenBuffer = [];
  let lastHitAt = 0;
  const HIT_COOLDOWN_MS = 900;

  function isValidByFormat(code, format){
    const onlyDigits = /^\d+$/;
    const f = (format||'').toLowerCase();
    if (!code) return false;

    if (f.includes('ean')) {
      if (!(onlyDigits.test(code) && (code.length===13 || code.length===8))) return false;
      if (code.length===13) return ean13ChecksumValid(code);
      if (code.length===8)  return ean8ChecksumValid(code);
      return true;
    }
    if (f.includes('upc')) {
      if (!(onlyDigits.test(code) && (code.length===12 || code.length===8))) return false;
      if (code.length===12) return upcChecksumValid(code);
      return true;
    }
    if (f.includes('128')) {
      return /^[A-Za-z0-9\-\._]+$/.test(code) && code.length >= 6;
    }
    return onlyDigits.test(code) && code.length >= 12;
  }
  function ean13ChecksumValid(s){
    if (s.length!==13) return false;
    let sum=0;
    for (let i=0;i<12;i++){ sum += (i%2?3:1)*parseInt(s[i],10); }
    const check=(10-(sum%10))%10;
    return check===parseInt(s[12],10);
  }
  function ean8ChecksumValid(s){
    if (s.length!==8) return false;
    let sum=0;
    for (let i=0;i<7;i++){ sum += (i%2?3:1)*parseInt(s[i],10); }
    const check=(10-(sum%10))%10;
    return check===parseInt(s[7],10);
  }
  function upcChecksumValid(s){
    if (s.length!==12) return false;
    let odd=0, even=0;
    for (let i=0;i<11;i++){ (i%2?even:odd) += parseInt(s[i],10); }
    const check=(10-(((odd*3)+even)%10))%10;
    return check===parseInt(s[11],10);
  }

  function pushAndCheckConsensus(code){
    const now = performance.now();
    seenBuffer.push({code, t: now});
    if (seenBuffer.length > CONSENSUS_WINDOW) seenBuffer.shift();
    const count = seenBuffer.filter(x => x.code === code).length;
    return count >= CONSENSUS_NEEDED;
  }
  function canHit(){
    const now = performance.now();
    if (now - lastHitAt < HIT_COOLDOWN_MS) return false;
    lastHitAt = now;
    return true;
  }

  const BD_FORMATS = ALLOWED_FORMATS_BD;

  video.setAttribute('playsinline',''); video.setAttribute('muted',''); video.setAttribute('autoplay','');

  function openModal(){ document.body.classList.add('modal-open'); modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ document.body.classList.remove('modal-open'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
  function cancelLoop(){ if (rafId){ cancelAnimationFrame(rafId); rafId = null; } }
  function stopStream(){ if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; currentTrack=null; } }
  function cleanupAll(){
    cancelLoop(); stopStream();
    if (usingQuagga && window.Quagga){ try { window.Quagga.stop(); } catch(e){} usingQuagga=false; }
    video.style.display='none'; target.style.display='none';
    seenBuffer = [];
  }

  // sonido + vibraci√≥n
  function beep(){
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = 880;
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.32, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.12);
      o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime + 0.14);
    } catch (e) {
      try { beepEl.currentTime = 0; beepEl.play().catch(()=>{}); } catch(_) {}
    }
  }
  function onDetected(value){
    try { navigator.vibrate && navigator.vibrate([30,40,30]); } catch(_){}
    beep();
    cleanupAll(); closeModal();
    inputQ.value = value;
    form?.submit();
  }

  function showError(err, where=''){
    const name = err?.name || String(err) || 'Error';
    const msg  = err?.message || '';
    console.error('[Scanner]', where, err);
    alert(`${name}${msg ? ': ' + msg : ''}`);
  }
  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }

  function rememberActiveDevice(){
    try {
      const track = stream?.getVideoTracks?.()[0];
      const id = track?.getSettings?.().deviceId || track?.getConstraints?.().deviceId?.exact;
      if (id) { localStorage.setItem(CAM_CACHE_KEY, id); cachedDeviceId = id; }
      currentTrack = track || null;
    } catch {}
  }

  async function ensurePermissionOnce(){
    const tmp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    tmp.getTracks().forEach(t=>t.stop());
  }
  async function loadVideoDevices(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d => d.kind === 'videoinput');
    const prefers = ['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      const as = prefers.some(p=>la.includes(p)) ? 1 : 0;
      const bs = prefers.some(p=>lb.includes(p)) ? 1 : 0;
      return bs - as;
    });
  }

  async function startWithDevice(deviceId){
    stopStream(); cancelLoop(); showSpinner(true);
    const constraints = {
      video: deviceId
        ? { deviceId: { exact: deviceId }, width:{ideal:960}, height:{ideal:720}, frameRate:{ideal:30}, focusMode:'continuous' }
        : { facingMode:{ideal:'environment'}, width:{ideal:960}, height:{ideal:720}, frameRate:{ideal:30}, focusMode:'continuous' },
      audio: false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    showSpinner(false);
    rememberActiveDevice();
  }

  // BarcodeDetector con consenso
  function startBDLoop(){
    seenBuffer = [];
    const tick = async () => {
      try {
        const detections = await detector.detect(video);
        if (detections && detections.length){
          // prioriza el m√°s largo
          detections.sort((a,b)=> (b.rawValue?.length||0) - (a.rawValue?.length||0));
          for (const d of detections){
            const val = (d.rawValue || '').trim();
            const fmt = (d.format || '').toLowerCase();
            if (!ALLOWED_FORMATS_BD.includes(fmt)) continue;
            if (!isValidByFormat(val, fmt)) continue;
            if (pushAndCheckConsensus(val) && canHit()) { onDetected(val); return; }
          }
        }
      } catch(_) {}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }
  async function startBarcodeDetector(){
    detector = new window.BarcodeDetector({ formats: BD_FORMATS });
    video.style.display = 'block';
    target.style.display = 'none';
    startBDLoop();
  }

  // Carga Quagga con varios CDNs
  function loadQuagga(){
    const CANDIDATES = [
      'https://cdn.jsdelivr.net/npm/@ericblade/quagga2@v0.0.14/dist/quagga.min.js',
      'https://unpkg.com/@ericblade/quagga2@0.0.14/dist/quagga.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js'
    ];
    if (window.Quagga) return Promise.resolve('existing');

    return new Promise(async (resolve, reject) => {
      for (const url of CANDIDATES) {
        try {
          await inject(url);
          const ok = await waitGlobal('Quagga', 3000);
          if (ok) { console.log('[Scanner] Quagga loaded from:', url); return resolve(url); }
        } catch (e) { console.warn('[Scanner] Failed', url, e); }
      }
      reject(new Error('Quagga2 could not be loaded from any CDN'));
    });

    function inject(src){
      return new Promise((resolve,reject)=>{
        if ([...document.scripts].some(s => s.src === src)) return resolve();
        const s=document.createElement('script'); s.src=src; s.async=true;
        s.onload=()=>resolve(); s.onerror=()=>reject(new Error('script load error'));
        document.head.appendChild(s);
      });
    }
    function waitGlobal(name, ms){
      return new Promise((resolve)=>{
        const t0=performance.now();
        (function loop(){
          if (window[name]) return resolve(true);
          if (performance.now()-t0>ms) return resolve(false);
          requestAnimationFrame(loop);
        })();
      });
    }
  }

  // Quagga con ROI m√°s amplio + consenso + checksum
  async function startQuagga(){
    if (!window.Quagga) throw new Error('Quagga global is missing after load');
    usingQuagga = true;
    video.style.display = 'none';
    target.style.display = 'block';

    let constraints = {};
    if (videoDevices.length && currentDeviceIdx >= 0) {
      constraints.deviceId = { exact: videoDevices[currentDeviceIdx].deviceId };
    } else if (cachedDeviceId) {
      constraints.deviceId = { exact: cachedDeviceId };
    } else {
      constraints.facingMode = 'environment';
    }

    await new Promise((resolve, reject) => {
      window.Quagga.init({
        inputStream: {
          type: 'LiveStream',
          // ROI m√°s permisivo: banda central ancha
          area: { top: "30%", right: "5%", left: "5%", bottom: "30%" },
          constraints: { ...constraints, width: { ideal: 1280 }, height: { ideal: 720 } },
          target: target
        },
        locator: { patchSize: 'large', halfSample: false },
        numOfWorkers: 1,
        frequency: 25,
        decoder: { readers: ALLOWED_READERS_QG }
      }, (err) => {
        if (err) return reject(err);
        window.Quagga.start();

        seenBuffer = [];

        window.Quagga.onDetected(res => {
          const code = res?.codeResult?.code;
          const fmt  = (res?.codeResult?.format || '').toLowerCase();

          // confianza (si existe). Umbral m√°s bajo
          const conf = res?.codeResult?.confidence;
          if (conf != null) {
            const confNorm = conf > 1 ? conf/100 : conf;
            if (confNorm < 0.2) return;
          }

          if (!code || !fmt) return;
          if (!isValidByFormat(code, fmt)) return;

          if (pushAndCheckConsensus(code) && canHit()) {
            onDetected(code);
          }
        });
        resolve();
      });
    });
  }

  // Torch (opcional) si el dispositivo la soporta
  async function setTorch(on){
    try{
      const track = currentTrack || stream?.getVideoTracks?.()[0];
      if (!track) return;
      const caps = track.getCapabilities?.();
      if (caps && 'torch' in caps){
        await track.applyConstraints({ advanced: [{ torch: !!on }] });
      }
    }catch(e){ /* no pasa nada si falla */ }
  }

  async function startScan(){
    openModal();
    try{
      cachedDeviceId = localStorage.getItem(CAM_CACHE_KEY) || null;

      await loadVideoDevices();

      if (cachedDeviceId) {
        await startWithDevice(cachedDeviceId);
      } else {
        await ensurePermissionOnce();
        await loadVideoDevices();
        if (videoDevices.length) currentDeviceIdx = 0;
        await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);
      }

      // Prende torch si existe (mejora much√≠simo lectura en interiores)
      setTorch(true);

      if ('BarcodeDetector' in window) {
        await startBarcodeDetector();
      } else {
        await loadQuagga();
        await startQuagga();
      }
    }catch(err){
      showError(err, 'startScan');
      cleanupAll(); closeModal();
    }
  }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;

    if (usingQuagga && window.Quagga){
      try { window.Quagga.stop(); } catch(_){}
      usingQuagga=false;
      await startQuagga();
      rememberActiveDevice();
      return;
    }

    cancelLoop();
    await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);
    rememberActiveDevice();
    if (detector) startBDLoop();
  }

  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnClose?.addEventListener('click', () => { setTorch(false); cleanupAll(); closeModal(); });
  modal?.addEventListener('click', (e)=>{ if (e.target === modal){ setTorch(false); cleanupAll(); closeModal(); } });
})();
</script>

{% endblock %}
