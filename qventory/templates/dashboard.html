{% extends "base.html" %}
{% block title %}Dashboard ‚Äì Qventory{% endblock %}
{% block content %}
<div class="row">
  <div class="card cardfilters" style="flex:1 1 280px;min-width:280px">
    <h2>Filters</h2>
    <form id="filterForm" method="get" action="{{ url_for('main.dashboard') }}" class="grid cols-3">
      <div style="grid-column:1/-1">
        <div class="input-with-button">
          <input class="input" type="text" id="q" name="q" value="{{ q }}" placeholder="Search title or SKU‚Ä¶">
          <button class="icon-btn" type="button" id="btnScan" title="Scan barcode with camera" aria-label="Scan barcode">üì∑</button>
        </div>
      </div>

      {% if settings.enable_A %}
      <div>
        <label>{{ settings.label_A }}</label>
        <select name="A">
          <option value="">All</option>
          {% for opt in options.A %}
          <option value="{{ opt }}" {% if fA==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_B %}
      <div>
        <label>{{ settings.label_B }}</label>
        <select name="B">
          <option value="">All</option>
          {% for opt in options.B %}
          <option value="{{ opt }}" {% if fB==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_S %}
      <div>
        <label>{{ settings.label_S }}</label>
        <select name="S">
          <option value="">All</option>
          {% for opt in options.S %}
          <option value="{{ opt }}" {% if fS==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if settings.enable_C %}
      <div>
        <label>{{ settings.label_C }}</label>
        <select name="C">
          <option value="">All</option>
          {% for opt in options.C %}
          <option value="{{ opt }}" {% if fC==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if PLATFORMS %}
      <div>
        <label>Platform</label>
        <select name="platform">
          <option value="">All</option>
          {% for key,label in PLATFORMS %}
          <option value="{{ key }}" {% if fPlatform==key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div style="grid-column:1/-1">
        <button class="btn submitbtn" type="submit">Apply</button>
        <a class="btn" href="{{ url_for('main.dashboard') }}">Clear</a>
      </div>
    </form>
  </div>

  <div class="card" style="flex:3 1 600px;min-width:320px">
    <h2>Items ({{ total_items }})</h2>
    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>SKU</th>
            <th>Location</th>
            <th>Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.title }}</td>
            <td><span class="tag itsku">{{ it.sku }}</span></td>
            <td>
              {% if it.location_code %}
              <a href="{{ url_for('main.public_view_location', username=un, code=it.location_code) }}">{{ it.location_code }}</a>
              &nbsp; <a class="tag" href="{{ url_for('main.qr_for_location', username=un, code=it.location_code) }}" target="_blank">QR</a>
              {% else %}
              ‚Äî
              {% endif %}
            </td>
            <td>
              <div class="platform-badges">
                {% if it.web_url %}<a class="tag" href="{{ it.web_url }}" target="_blank">Web</a>{% endif %}
                {% if it.ebay_url %}<a class="tag" href="{{ it.ebay_url }}" target="_blank">eBay</a>{% endif %}
                {% if it.amazon_url %}<a class="tag" href="{{ it.amazon_url }}" target="_blank">Amazon</a>{% endif %}
                {% if it.mercari_url %}<a class="tag" href="{{ it.mercari_url }}" target="_blank">Mercari</a>{% endif %}
                {% if it.vinted_url %}<a class="tag" href="{{ it.vinted_url }}" target="_blank">Vinted</a>{% endif %}
                {% if it.poshmark_url %}<a class="tag" href="{{ it.poshmark_url }}" target="_blank">Poshmark</a>{% endif %}
                {% if it.depop_url %}<a class="tag" href="{{ it.depop_url }}" target="_blank">Depop</a>{% endif %}
                {% if not (it.web_url or it.ebay_url or it.amazon_url or it.mercari_url or it.vinted_url or it.poshmark_url or it.depop_url) %}‚Äî{% endif %}
              </div>
            </td>
            <td>
              {% if current_user.is_authenticated %}
              <a class="btn settingsbtn" href="{{ url_for('main.edit_item', item_id=it.id) }}">üìù</a>

              <form style="display:inline" method="post" action="{{ url_for('main.print_item', item_id=it.id) }}">
                <button class="btn settingsbtn" type="submit" title="Print label">üñ®Ô∏è</button>
              </form>

              <form style="display:inline" method="post" action="{{ url_for('main.delete_item', item_id=it.id) }}" onsubmit="return confirm('Delete this item?')">
                <button class="btn settingsbtn" type="submit">‚ùå</button>
              </form>
              {% else %}
              <span class="tag ">Login to edit</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal del esc√°ner (reutilizable para ambos m√©todos) -->
<div id="scanModal" class="scan-modal hidden" aria-hidden="true" aria-label="Barcode scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong>Scan a barcode</strong>
      <button type="button" id="scanClose" class="icon-btn" aria-label="Close">‚úï</button>
    </div>
    <div class="scan-body">
      <!-- Modo BarcodeDetector -->
      <video id="scanVideo" playsinline autoplay muted></video>
      <!-- Modo Quagga2: container donde inyecta el <video/canvas> -->
      <div id="scanTarget" class="scan-target"></div>
      <div class="scan-tip">Align the barcode inside the frame</div>
    </div>
  </div>
</div>

<style>
  .input-with-button{ position:relative; display:flex; align-items:center; }
  .input-with-button > .input{ padding-right:42px; }
  .icon-btn{
    position:absolute; right:8px; border:none; background:transparent;
    cursor:pointer; line-height:1; font-size:18px; opacity:.8;
  }
  .icon-btn:hover{ opacity:1; }

  .scan-modal.hidden{ display:none; }
  .scan-modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:grid; place-items:center; z-index:9999; }
  .scan-sheet{ width:min(640px,92vw); background:#111; color:#fff; border-radius:10px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.5); }
  .scan-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#181818; border-bottom:1px solid #222; }
  .scan-body{ position:relative; }
  #scanVideo{ width:100%; height:auto; display:none; background:#000; } /* oculto hasta usar BD */
  .scan-target{ width:100%; display:none; background:#000; } /* contenedor para Quagga */
  .scan-tip{ text-align:center; font-size:12px; opacity:.8; padding:8px 0 12px; }
</style>

<script>
(function(){
  const btnScan   = document.getElementById('btnScan');
  const modal     = document.getElementById('scanModal');
  const btnClose  = document.getElementById('scanClose');
  const video     = document.getElementById('scanVideo');
  const target    = document.getElementById('scanTarget');
  const inputQ    = document.getElementById('q');
  const form      = document.getElementById('filterForm');

  let stream = null, rafId = null, detector = null, usingQuagga = false;

  const BD_FORMATS = ['code_128','ean_13','upc_a','upc_e','code_39','qr_code'];

  function openModal(){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
  function stopVideo(){
    if (rafId){ cancelAnimationFrame(rafId); rafId = null; }
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
  }
  function cleanupAll(){
    stopVideo();
    if (usingQuagga && window.Quagga){ try{ window.Quagga.stop(); }catch(e){} usingQuagga=false; }
    video.style.display = 'none';
    target.style.display = 'none';
  }
  function onDetected(value){
    cleanupAll(); closeModal();
    inputQ.value = value;
    form?.submit(); // quita esta l√≠nea si prefieres revisar antes
  }

  // --- Helpers de c√°mara robustos ---
  async function ensureVideoPermission() {
    // iOS necesita un getUserMedia previo para que enumerateDevices revele labels
    let tmp;
    try {
      tmp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      tmp.getTracks().forEach(t=>t.stop());
    } catch (e) {
      // si el usuario niega, relanzamos
      throw e;
    }
  }

  async function getRearDeviceId() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videos = devices.filter(d => d.kind === 'videoinput');
    if (!videos.length) return null;

    // Preferir por nombre com√∫n de c√°mara trasera
    const prefer = ['back', 'rear', 'environment'];
    const byLabel = videos.find(d => {
      const L = (d.label || '').toLowerCase();
      return prefer.some(k => L.includes(k));
    });
    if (byLabel) return byLabel.deviceId;

    // Si no hay pistas, devolver la √∫ltima (suele ser la trasera en m√≥viles)
    return videos[videos.length - 1].deviceId || videos[0].deviceId;
  }

  async function getCameraStream() {
    // Intento 1: facingMode environment
    try {
      return await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
    } catch (e1) {
      // Intento 2: elegir deviceId tras pedir permiso y enumerar
      try {
        await ensureVideoPermission();
        const deviceId = await getRearDeviceId();
        if (deviceId) {
          return await navigator.mediaDevices.getUserMedia({
            video: { deviceId: { exact: deviceId } }, audio: false
          });
        }
        throw e1;
      } catch (e2) {
        // Intento 3: constraints gen√©ricos (cualquier c√°mara)
        try {
          return await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        } catch (e3) {
          // Propaga el √∫ltimo error
          throw e3;
        }
      }
    }
  }

  function humanizeGetUserMediaError(err){
    const name = err && (err.name || err.toString());
    if (name === 'NotAllowedError' || name === 'SecurityError') {
      return 'Permiso de c√°mara denegado. Habil√≠talo en el navegador y vuelve a intentar.';
    }
    if (name === 'NotFoundError' || name === 'OverconstrainedError') {
      return 'No se encontr√≥ una c√°mara compatible. Revisa que ninguna otra app la est√© usando.';
    }
    if (name === 'NotReadableError') {
      return 'La c√°mara est√° en uso por otra aplicaci√≥n. Ci√©rrala e intenta de nuevo.';
    }
    return 'No se pudo acceder a la c√°mara. Verifica HTTPS/permiso y vuelve a intentar.';
  }

  async function startScan(){
    openModal();

    // 1) BarcodeDetector si existe
    if ('BarcodeDetector' in window) {
      try {
        detector = new window.BarcodeDetector({ formats: BD_FORMATS });
        stream = await getCameraStream();
        video.srcObject = stream;
        await video.play();
        video.style.display = 'block';
        target.style.display = 'none';

        const tick = async () => {
          try {
            const codes = await detector.detect(video);
            if (codes && codes.length) {
              const val = (codes[0].rawValue || '').trim();
              if (val) { onDetected(val); return; }
            }
          } catch (_) { /* ignore frame errors */ }
          rafId = requestAnimationFrame(tick);
        };
        rafId = requestAnimationFrame(tick);
        return;
      } catch (err) {
        console.warn('BarcodeDetector fall√≥, usando Quagga2. Motivo:', err);
        cleanupAll();
      }
    }

    // 2) Fallback Quagga2
    try {
      await loadQuagga();
      await initQuagga(); // lanza si falla
    } catch (err) {
      alert(humanizeGetUserMediaError(err));
      cleanupAll(); closeModal();
    }
  }

  function loadQuagga(){
    return new Promise((resolve, reject) => {
      if (window.Quagga) { resolve(); return; }
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@ericblade/quagga2@v0.0.14/dist/quagga.min.js';
      s.async = true;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('Failed to load Quagga2'));
      document.head.appendChild(s);
    });
  }

  async function initQuagga(){
    usingQuagga = true;
    video.style.display = 'none';
    target.style.display = 'block';

    // Preparar constraints robustos para Quagga
    let constraints;
    try {
      await ensureVideoPermission();
      const deviceId = await getRearDeviceId();
      constraints = deviceId
        ? { deviceId: { exact: deviceId } }
        : { facingMode: 'environment' };
    } catch {
      constraints = { facingMode: 'environment' };
    }

    return new Promise((resolve, reject) => {
      window.Quagga.init({
        inputStream: {
          type: 'LiveStream',
          constraints: { ...constraints, width: { ideal: 1280 }, height: { ideal: 720 } },
          target: target
        },
        locator: { patchSize: 'medium', halfSample: true },
        numOfWorkers: navigator.hardwareConcurrency || 2,
        frequency: 10,
        decoder: {
          readers: [
            'code_128_reader',
            'ean_reader',
            'ean_8_reader',
            'upc_reader',
            'upc_e_reader',
            'code_39_reader'
          ]
        }
      }, (err) => {
        if (err) return reject(err);
        window.Quagga.start();
        window.Quagga.onDetected(res => {
          const code = res?.codeResult?.code;
          if (code) onDetected(code);
        });
        resolve();
      });
    });
  }

  // Eventos UI
  btnScan?.addEventListener('click', startScan);
  btnClose?.addEventListener('click', () => { cleanupAll(); closeModal(); });
  modal?.addEventListener('click', (e)=>{ if (e.target === modal){ cleanupAll(); closeModal(); } });

  // Tips:
  // - Requiere HTTPS (o localhost) para getUserMedia.
  // - Si tu app est√° embebida en un <iframe>, agrega allow="camera" al iframe.
  // - En iOS, aseg√∫rate de que la PWA/ pesta√±a tenga foco y no est√© en modo ‚ÄúPrivate Relay‚Äù con pol√≠ticas restrictivas.
})();
</script>

{% endblock %}
