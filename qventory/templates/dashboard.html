{% extends "base.html" %}
{% block title %}Dashboard – Qventory{% endblock %}
{% block content %}
<!-- Después de la etiqueta de apertura de content -->
<div data-username="{{ current_user.username }}" style="display:none"></div>
<div class="row">

  <!-- Filtros -->
  <div id="filtersShell" class="card cardfilters filters-shell" style="flex:1 1 100%;min-width:280px">
    <div class="filters-bar">
      <h2>Filters</h2>
      <button id="filtersToggle" class="btn filters-toggle submitbtn" type="button" aria-expanded="true">
        <i class="fas fa-filter"></i> Toggle
      </button>
    </div>
    <div id="filtersContent" class="filters-content">
      <form id="filterForm" method="get" action="{{ url_for('main.dashboard') }}" class="filters-grid">
        <div style="grid-column:1/-1">
          <div class="input-with-button">
            <input class="input" type="text" id="q" name="q" value="{{ q }}" placeholder="Search title / SKU / supplier…">
            <button class="icon-btn" type="button" id="btnScanQR" title="Scan QR code with camera" aria-label="Scan QR code">
              <i class="fas fa-qrcode"></i>
            </button>
          </div>
        </div>

        {# Filtros dinámicos #}
        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A">
            <option value="">All</option>
            {% for opt in options.A %}
            <option value="{{ opt }}" {% if fA==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B">
            <option value="">All</option>
            {% for opt in options.B %}
            <option value="{{ opt }}" {% if fB==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S">
            <option value="">All</option>
            {% for opt in options.S %}
            <option value="{{ opt }}" {% if fS==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C">
            <option value="">All</option>
            {% for opt in options.C %}
            <option value="{{ opt }}" {% if fC==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if options.supplier and options.supplier|length %}
        <div>
          <label>Supplier</label>
          <select name="supplier">
            <option value="">All</option>
            {% for opt in options.supplier %}
            <option value="{{ opt }}" {% if fSupplier==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if PLATFORMS %}
        <div>
          <label>Platform</label>
          <select name="platform">
            <option value="">All</option>
            {% for key,label in PLATFORMS %}
            <option value="{{ key }}" {% if fPlatform==key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div style="grid-column:1/-1">
          <button class="btn submitbtn" type="submit">Apply</button>
          <a class="btn" href="{{ url_for('main.dashboard') }}">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Inventario -->
  <div class="card inventory-shell" style="flex:1 1 100%;min-width:320px">
    <div class="items-header">
      <h2>Items ({{ total_items }})</h2>
      <div class="backup-actions">
        <a class="btn backup-btn" href="{{ url_for('main.export_csv') }}" title="Export all items to CSV">
          <i class="fas fa-download"></i> Export
        </a>
        <a class="btn backup-btn" href="{{ url_for('main.import_csv') }}" title="Import items from CSV">
          <i class="fas fa-upload"></i> Import
        </a>
        <a class="btn backup-btn" href="{{ url_for('main.import_ebay') }}" title="Import inventory from eBay" style="background:rgba(229,50,56,0.1);border-color:rgba(229,50,56,0.3);color:#E53238">
          <i class="fab fa-ebay"></i> Import from eBay
        </a>
      </div>
    </div>
    
    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th style="width:44px"></th>
            <th>Title</th>
            <th>SKU</th>
            <th class="mobile-hide">Supplier</th>
            <th class="mobile-hide">Cost</th>
            <th>Price</th>
            <th class="mobile-hide">ROI</th>
            <th>Location</th>
            <th class="mobile-hide">Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsTableBody">
          {% for it in items %}
            {% include "_item_row.html" %}
          {% endfor %}
        </tbody>
      </table>

      <!-- Spinner para carga de más items -->
      <div id="loadingSpinner" style="display:none;text-align:center;padding:20px;color:#888;">
        <i class="fas fa-spinner fa-spin"></i> Loading more items...
      </div>

      <!-- Marcador para detectar cuando se llega al final -->
      <div id="scrollSentinel" style="height:1px;"></div>
    </div>
  </div>
</div>

<!-- ===== Modal QR para Locations ===== -->
<div id="qrModal" class="qr-modal hidden" role="dialog" aria-hidden="true" aria-labelledby="qrTitle">
  <div class="qr-sheet">
    <div class="qr-header">
      <strong id="qrTitle"><i class="fas fa-qrcode"></i> QR</strong>
      <div class="qr-actions">
        <a id="qrOpenNew" class="qr-icon" href="#" target="_blank" title="Open in new tab" aria-label="Open in new tab">
          <i class="fas fa-external-link-alt"></i>
        </a>
        <button type="button" id="qrClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport">
        <img id="qrImage" alt="QR code">
      </div>
      <div id="qrCaption" class="qr-tip"></div>
    </div>
  </div>
</div>

<!-- ===== Modal de Imagen Ampliada ===== -->
<div id="imgModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Image viewer">
  <div class="qr-sheet" style="max-width:90vw;width:auto">
    <div class="qr-header">
      <strong><i class="fas fa-image"></i> Image</strong>
      <div class="qr-actions">
        <button type="button" id="imgClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="img-viewport">
        <img id="imgModalImg" alt="">
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal Profit Calculator ===== -->
<div id="profitCalcModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Profit Calculator">
  <div class="qr-sheet" style="max-width:560px;max-height:90vh;overflow-y:auto">
    <div class="qr-header">
      <strong><i class="fas fa-calculator"></i> Profit Calculator</strong>
      <div class="qr-actions">
        <button type="button" id="profitCalcClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body" style="padding:16px;align-items:stretch">
      <div id="profitModalContent" style="width:100%">
        <!-- Content injected by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal AI Research ===== -->
<div id="aiResearchModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="AI Market Research">
  <div class="qr-sheet" style="max-width:800px;max-height:90vh;overflow-y:auto">
    <div class="qr-header">
      <strong><i class="fas fa-robot"></i> AI Market Research</strong>
      <div class="qr-actions">
        <button type="button" id="aiResearchClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body" style="padding:16px;align-items:stretch">
      <div id="aiResearchModalContent" style="width:100%">
        <!-- Item Title with Autocomplete -->
        <label for="aiItemTitle" style="display:block;margin-top:0;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Item Title</label>
        <div style="position:relative">
          <input type="text" id="aiItemTitle" class="input" placeholder="e.g. Sony PlayStation 5 Console" autocomplete="off" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text);font-size:var(--fs-base)">
          <div id="aiAutocompleteList" class="autocomplete-list"></div>
        </div>

        <!-- Condition -->
        <label for="aiCondition" style="display:block;margin-top:1rem;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Condition</label>
        <input type="text" id="aiCondition" class="input" placeholder="e.g. Used - Fully working" value="Used" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text);font-size:var(--fs-base)">

        <!-- Notes -->
        <label for="aiNotes" style="display:block;margin-top:1rem;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Relevant Notes (Optional)</label>
        <textarea id="aiNotes" class="input" placeholder="e.g. Includes controller, original box" rows="3" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text);font-size:var(--fs-base);resize:vertical;font-family:inherit"></textarea>

        <!-- Market Region -->
        <label for="aiMarketRegion" style="display:block;margin-top:1rem;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Market Region</label>
        <select id="aiMarketRegion" class="input" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text);font-size:var(--fs-base)">
          <option value="US">United States</option>
          <option value="UK">United Kingdom</option>
          <option value="CA">Canada</option>
          <option value="AU">Australia</option>
          <option value="DE">Germany</option>
        </select>

        <!-- Currency -->
        <label for="aiCurrency" style="display:block;margin-top:1rem;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Currency</label>
        <select id="aiCurrency" class="input" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text);font-size:var(--fs-base)">
          <option value="USD">USD ($)</option>
          <option value="GBP">GBP (£)</option>
          <option value="CAD">CAD ($)</option>
          <option value="AUD">AUD ($)</option>
          <option value="EUR">EUR (€)</option>
        </select>

        <!-- Analyze Button -->
        <button class="btn submitbtn block" onclick="analyzeAIResearch()" style="margin-top:1.2rem;width:100%" id="aiAnalyzeBtn">
          <i class="fas fa-robot"></i> Analyze Market
        </button>

        <!-- Result Display with Progress Bar -->
        <div id="aiResult" class="ai-result-box" style="display:none">
          <!-- Progress Bar -->
          <div id="aiProgressBar" style="display:none;margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <span id="aiProgressMessage" style="font-size:12px;color:#9ca3af">Starting...</span>
              <span id="aiProgressPercent" style="font-size:12px;color:#60a5fa;font-weight:600">0%</span>
            </div>
            <div style="height:6px;background:#1a1d24;border-radius:3px;overflow:hidden">
              <div id="aiProgressFill" style="height:100%;width:0%;background:linear-gradient(90deg, #60a5fa, #34d399);transition:width 0.3s ease"></div>
            </div>
          </div>
          <div id="aiResultContent"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal Scanner QR ===== -->
<div id="scanQRModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="QR Scanner">
  <div class="qr-sheet" style="max-width:480px">
    <div class="qr-header">
      <strong><i class="fas fa-qrcode"></i> Scan QR Code</strong>
      <div class="qr-actions">
        <button type="button" id="scanQRFlip" class="qr-icon" title="Flip camera" aria-label="Flip camera">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button type="button" id="scanQRFlashlight" class="qr-icon" title="Toggle flashlight" aria-label="Toggle flashlight">
          <i class="fas fa-lightbulb"></i>
        </button>
        <button type="button" id="scanQRClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport" style="position:relative;background:#000">
        <video id="scanQRVideo" style="width:100%;height:100%;object-fit:cover;display:none" playsinline autoplay muted></video>
        <div id="scanQRSpinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:#fff;font-size:24px">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div id="scanQRSuccess" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,200,100,0.3);color:#fff;font-size:48px;pointer-events:none">
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
      <div id="scanQRResult" class="qr-tip" style="display:none;color:#4ade80"></div>
      <div class="qr-tip">Position QR code within camera view</div>
    </div>
  </div>
</div>

<style>
  body.modal-open{ overflow:hidden; touch-action:none; }
  .qr-modal.hidden{ display:none; }
  .qr-modal{ position:fixed; inset:0; z-index:9999; display:grid; place-items:center; padding:16px; background:rgba(0,0,0,.6); }
  .qr-sheet{ width:min(380px,92vw); background:#0f1115; color:#fff; border-radius:14px; overflow:hidden; border:1px solid #222; box-shadow:0 20px 60px rgba(0,0,0,.5); }
  .qr-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#141821; border-bottom:1px solid #222; }
  .qr-actions{ display:flex; align-items:center; gap:6px; }
  .qr-icon{ border:none; background:transparent; color:#fff; font-size:18px; cursor:pointer; opacity:.9; text-decoration:none; display:flex; align-items:center; justify-content:center; width:30px; height:30px; transition:opacity .2s; }
  .qr-icon:hover{ opacity:1; }
  .qr-icon.active{ color:#4ade80; opacity:1; }
  .qr-body{ padding:12px; display:flex; flex-direction:column; gap:10px; align-items:center; }
  .qr-viewport{ width:100%; aspect-ratio:1/1; background:#fff; border-radius:10px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
  #qrImage{ width:100%; height:100%; object-fit:contain; display:block; }
  .qr-tip{ text-align:center; font-size:12px; opacity:.8; }

  /* ===== Viewport específico para imágenes ampliadas ===== */
  .img-viewport{ 
    width:100%; 
    max-height:30vh; 
    background:#000; 
    border-radius:10px; 
    overflow:hidden; 
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #imgModalImg{ 
    max-width:100%; 
    max-height:30vh; 
    width:auto;
    height:auto;
    object-fit:contain; 
    display:block; 
  }

  /* ===== Miniaturas con overlay de lupa ===== */
  .thumb-wrap{
    position:relative;
    width:36px; height:36px;
    padding:0; border:0;
    cursor:zoom-in;
    background:transparent;
    display:block;
    border-radius:6px;
  }
  .thumb-img{
    width:100%; height:100%;
    object-fit:cover;
    border-radius:inherit;
    border:1px solid var(--glass-border);
    display:block;
  }
  .thumb-zoom{
    position:absolute;
    right:2px; bottom:2px;
    display:grid; place-items:center;
    width:18px; height:18px;
    border-radius:4px;
    font-size:11px; line-height:1;
    background:var(--glass-bg-strong);
    border:1px solid var(--glass-border);
    color:#cfe0ff;
    box-shadow:0 2px 6px rgba(0,0,0,.35);
  }
  .thumb-wrap:hover .thumb-zoom{ filter:brightness(1.07) }
</style>

<!-- ======================= SCRIPTS ======================= -->

<script>
/* ===== Toggle filtros con persistencia ===== */
(function(){
  const btn = document.getElementById('filtersToggle');
  const content = document.getElementById('filtersContent');
  const shell = document.getElementById('filtersShell');
  if(!btn || !content) return;
  
  const KEY = 'qv_filters_collapsed';
  
  function setCollapsed(collapsed){
    content.hidden = collapsed;
    btn.setAttribute('aria-expanded', String(!collapsed));
    shell?.classList.toggle('collapsed', collapsed);
    try{ localStorage.setItem(KEY, collapsed ? '1':'0'); }catch{}
  }
  
  function initState(){
    let collapsed = false;
    try{ collapsed = localStorage.getItem(KEY) === '1'; }catch{}
    setCollapsed(collapsed);
  }
  
  btn.addEventListener('click', ()=> setCollapsed(content.hidden !== true));
  initState();
})();
</script>

<script>
/* ===== Modal QR para Locations ===== */
(function(){
  const qrModal   = document.getElementById('qrModal');
  const qrClose   = document.getElementById('qrClose');
  const qrImage   = document.getElementById('qrImage');
  const qrOpenNew = document.getElementById('qrOpenNew');
  const qrCaption = document.getElementById('qrCaption');
  const qrTitle   = document.getElementById('qrTitle');

  function openQrModal(url, caption){
    document.body.classList.add('modal-open');
    qrModal.classList.remove('hidden');
    qrModal.setAttribute('aria-hidden','false');
    qrImage.src = '';
    qrImage.src = url;
    qrOpenNew.href = url;
    qrCaption.textContent = caption || '';
    qrTitle.textContent = caption || 'QR';
  }
  
  function closeQrModal(){
    document.body.classList.remove('modal-open');
    qrModal.classList.add('hidden');
    qrModal.setAttribute('aria-hidden','true');
    qrImage.src = '';
  }

  document.body.addEventListener('click', (e) => {
    const a = e.target.closest('a.qr-link');
    if (!a) return;
    e.preventDefault();
    const url = a.getAttribute('href');
    const caption = a.getAttribute('data-caption') || a.textContent || 'QR';
    openQrModal(url, caption);
  });

  qrClose?.addEventListener('click', closeQrModal);
  qrModal?.addEventListener('click', (e)=>{ if (e.target === qrModal) closeQrModal(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !qrModal.classList.contains('hidden')) closeQrModal(); });
})();
</script>

<script>
/* ===== Modal de imagen ampliada ===== */
(function(){
  const modal  = document.getElementById('imgModal');
  const imgEl  = document.getElementById('imgModalImg');
  const closeBtn = document.getElementById('imgClose');

  function openImg(url, alt){
    if(!url) return;
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden','false');
    imgEl.src = url;
    imgEl.alt = alt || '';
  }
  
  function closeImg(){
    modal.setAttribute('hidden', '');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    imgEl.src = '';
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.thumb-wrap');
    if(!btn) return;
    const url = btn.getAttribute('data-full');
    const alt = btn.querySelector('img')?.getAttribute('alt') || '';
    openImg(url, alt);
  });

  closeBtn?.addEventListener('click', closeImg);
  modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeImg(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeImg(); });
})();
</script>

<script>
/* ===== SCRIPT SCANNER QR (Optimizado iOS + Android) ===== */
(function(){
  const btnScan = document.getElementById('btnScanQR');
  const modal = document.getElementById('scanQRModal');
  const btnClose = document.getElementById('scanQRClose');
  const btnFlip = document.getElementById('scanQRFlip');
  const btnFlash = document.getElementById('scanQRFlashlight');
  const video = document.getElementById('scanQRVideo');
  const spinner = document.getElementById('scanQRSpinner');
  const success = document.getElementById('scanQRSuccess');
  const result = document.getElementById('scanQRResult');
  const inputQ = document.getElementById('q');
  const form = document.getElementById('filterForm');

  const CAM_CACHE_KEY = 'qv_dashboard_qr_cam_device_id';
  let stream = null, rafId = null;
  let detector = null;
  let usingBD = false, usingJsQR = false, jsQRLoaded = false;
  let videoDevices = [], currentDeviceIdx = -1, devicesLoaded = false;
  let flashlightOn = false;
  let isScanning = false;

  // === Audio beep cross-platform ===
  let beepAudio = null;
  let beepReady = false;
  
  function ensureBeep() {
    if (beepReady) return;
    try {
      beepAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");
      beepAudio.preload = "auto";
      const p = beepAudio.play();
      if (p && typeof p.then === "function") {
        p.then(() => {
          beepAudio.pause();
          beepAudio.currentTime = 0;
          beepReady = true;
        }).catch(()=>{});
      } else {
        beepAudio.pause();
        beepAudio.currentTime = 0;
        beepReady = true;
      }
    } catch(e) {}
  }

  function openModal(){
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden','false');
  }
  
  function closeModal(){
    document.body.classList.remove('modal-open');
    modal.setAttribute('hidden','');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden','true');
  }
  
  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }
  function showSuccess(){ success.style.display='flex'; setTimeout(()=>success.style.display='none', 450); }
  
  function cleanupLoop(){ 
    if (rafId){ 
      cancelAnimationFrame(rafId); 
      rafId=null; 
    }
    isScanning = false;
  }
  
  function cleanupAll(){
    cleanupLoop();
    if (stream){ 
      try{ stream.getTracks().forEach(t=>t.stop()); }catch{}; 
      stream=null; 
    }
    flashlightOn=false; 
    btnFlash.classList.remove('active');
    video.srcObject=null; 
    video.style.display='none';
    usingBD=false; 
    usingJsQR=false;
  }
  
  function showError(msg){ 
    console.error('[QR]', msg); 
    alert(msg); 
  }

  async function loadVideoDevices(){
    if (devicesLoaded) return;
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d=>d.kind==='videoinput');
    const prefers = ['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      const as = prefers.some(p=>la.includes(p)) ? 1:0;
      const bs = prefers.some(p=>lb.includes(p)) ? 1:0;
      return bs - as;
    });
    devicesLoaded = true;
  }

  async function startWithDevice(deviceId){
    cleanupLoop();
    showSpinner(true);
    
    const constraints = {
      video: deviceId 
        ? { deviceId:{exact:deviceId}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30}, facingMode:'environment' }
        : { facingMode:{ideal:'environment'}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30} },
      audio: false
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.setAttribute('playsinline',''); 
    video.setAttribute('autoplay',''); 
    video.setAttribute('muted','');
    video.srcObject = stream;
    
    await video.play();
    
    if (video.readyState < 2){
      await new Promise(res=>{
        const t = setTimeout(res, 250);
        video.onloadedmetadata = ()=>{ clearTimeout(t); res(); };
      });
    }
    
    showSpinner(false);
    video.style.display='block';
    
    // Guardar preferencia de cámara
    if (deviceId) {
      try{ localStorage.setItem(CAM_CACHE_KEY, deviceId); }catch{}
    }
  }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
    await startWithDevice(videoDevices[currentDeviceIdx].deviceId);
    if (usingBD) startBDLoop();
    if (usingJsQR) startJsQRLoop();
  }

  async function toggleFlashlight(){
    if (!stream) return;
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      if (!caps.torch) return alert('Flashlight not supported on this camera');
      flashlightOn = !flashlightOn;
      await track.applyConstraints({ advanced:[{ torch: flashlightOn }] });
      btnFlash.classList.toggle('active', flashlightOn);
    }catch{ alert('Unable to control flashlight'); }
  }

  function extractSku(val){
    if (!val) return '';
    const s = String(val).trim();
    try{
      const u = new URL(s);
      const m = u.href.match(/([A-Z0-9]{8,}|\d{10,}|\d{8}-[A-Z0-9]{3,})/i);
      return m ? m[1] : s;
    }catch{ return s; }
  }

  function onDetected(raw){
    if (isScanning) return; // Prevenir detecciones múltiples
    isScanning = true;
    
    const v = extractSku(raw);
    if (!v) {
      isScanning = false;
      return;
    }
    
    result.textContent = `Detected: ${v.slice(0,120)}`;
    result.style.display='block';
    showSuccess();

    try{
      if (navigator.vibrate) navigator.vibrate(80);
      if (beepReady && beepAudio) beepAudio.play().catch(()=>{});
    }catch{}

    setTimeout(()=>{
      cleanupAll(); 
      closeModal();
      inputQ.value = v;
      form?.submit();
    }, 500);
  }

  async function tryBarcodeDetector(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      detector = new window.BarcodeDetector({ formats: ['qr_code','qr'] });
    }catch{
      try{ detector = new window.BarcodeDetector(); }catch{ return false; }
    }
    usingBD = true; 
    usingJsQR = false;
    startBDLoop();
    return true;
  }

  function startBDLoop(){
    cleanupLoop();
    isScanning = false;
    let frame = 0;
    
    const tick = async ()=>{
      if (!usingBD) return;
      frame++;
      try{
        if (frame%2===0 && detector && video.readyState >= 2){
          const codes = await detector.detect(video);
          if (codes && codes.length){
            const val = (codes[0].rawValue || '').trim();
            if (val){ 
              onDetected(val); 
              return; 
            }
          }
        }
      }catch(e){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function loadJsQR(){
    if (jsQRLoaded) return Promise.resolve();
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async=true;
      s.onload=()=>{ jsQRLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error('jsQR CDN blocked/failed to load'));
      document.head.appendChild(s);
    });
  }

  function startJsQRLoop(){
    usingBD=false; 
    usingJsQR=true;
    cleanupLoop();
    isScanning = false;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const ROI_INSET = 0.08;

    let lastTS = 0;
    const MIN_INTERVAL = 100; // Optimizado: 100ms entre escaneos

    const tick = (now)=>{
      if (!usingJsQR) return;
      
      try{
        if (now - lastTS >= MIN_INTERVAL && video.videoWidth>0 && video.readyState >= 2){
          lastTS = now;
          
          const vw = video.videoWidth, vh = video.videoHeight;
          const rx = Math.floor(vw*ROI_INSET), ry = Math.floor(vh*ROI_INSET);
          const rw = Math.floor(vw*(1-2*ROI_INSET)), rh = Math.floor(vh*(1-2*ROI_INSET));
          
          canvas.width = rw; 
          canvas.height = rh;
          ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);
          
          const img = ctx.getImageData(0, 0, rw, rh);
          const qr = window.jsQR && window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
          const val = (qr?.data || '').trim();
          
          if (val){ 
            onDetected(val); 
            return; 
          }
        }
      }catch(e){
        console.error('[jsQR]', e);
      }
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startScan(){
    ensureBeep(); // Autoriza audio en iOS
    openModal(); 
    result.style.display='none'; 
    success.style.display='none';
    isScanning = false;
    
    try{
      const cachedId = localStorage.getItem(CAM_CACHE_KEY) || null;
      await loadVideoDevices();
      
      if (videoDevices.length){
        if (cachedId){
          const idx = videoDevices.findIndex(d=>d.deviceId===cachedId);
          currentDeviceIdx = idx >= 0 ? idx : 0;
        } else {
          currentDeviceIdx = 0;
        }
      }
      
      await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);

      const bdOK = await tryBarcodeDetector();
      if (!bdOK){
        try{
          await loadJsQR();
          startJsQRLoop();
        }catch(e){
          showError('No QR engine available (BarcodeDetector unsupported and jsQR blocked).');
          cleanupAll(); 
          closeModal();
        }
      }
    }catch(e){
      showError(e?.message || 'Camera access denied or not available');
      cleanupAll(); 
      closeModal();
    }
  }

  function handleClose(){
    cleanupAll(); 
    closeModal();
  }

  // Event listeners
  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnFlash?.addEventListener('click', toggleFlashlight);
  btnClose?.addEventListener('click', handleClose);
  
  // Cerrar tocando fuera del contenido
  modal?.addEventListener('click', (e)=>{
    if (e.target === modal){
      handleClose();
    }
  });
  
  // Cerrar con tecla Escape
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && !modal.classList.contains('hidden')){
      handleClose();
    }
  });
})();
</script>

<script>
/* ===== Infinite Scroll para Dashboard ===== */
(function(){
  const tbody = document.getElementById('itemsTableBody');
  const spinner = document.getElementById('loadingSpinner');
  const sentinel = document.getElementById('scrollSentinel');

  if (!tbody || !sentinel) return;

  let offset = {{ items|length }};  // Número de items ya cargados
  const totalItems = {{ total_items }};
  let loading = false;
  let hasMore = offset < totalItems;

  // Obtener filtros actuales de la URL
  function getCurrentFilters() {
    const params = new URLSearchParams(window.location.search);
    return {
      q: params.get('q') || '',
      A: params.get('A') || '',
      B: params.get('B') || '',
      S: params.get('S') || '',
      C: params.get('C') || '',
      platform: params.get('platform') || ''
    };
  }

  async function loadMoreItems() {
    if (loading || !hasMore) return;

    loading = true;
    spinner.style.display = 'block';

    try {
      const filters = getCurrentFilters();
      const url = new URL('/api/load-more-items', window.location.origin);
      url.searchParams.set('offset', offset);
      url.searchParams.set('limit', 20);

      // Agregar filtros a la petición
      Object.entries(filters).forEach(([key, value]) => {
        if (value) url.searchParams.set(key, value);
      });

      const response = await fetch(url);
      const data = await response.json();

      if (data.ok && data.items && data.items.length > 0) {
        // Insertar las nuevas filas en el tbody
        data.items.forEach(itemHtml => {
          tbody.insertAdjacentHTML('beforeend', itemHtml);
        });

        offset += data.items.length;
        hasMore = data.has_more;

        // Si no hay más items, ocultar el sentinel
        if (!hasMore) {
          sentinel.style.display = 'none';
        }
      } else {
        hasMore = false;
        sentinel.style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading more items:', error);
      hasMore = false;
    } finally {
      loading = false;
      spinner.style.display = 'none';
    }
  }

  // Usar Intersection Observer para detectar cuando el usuario llega al final
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting && hasMore && !loading) {
        loadMoreItems();
      }
    });
  }, {
    root: null,
    rootMargin: '200px',  // Empezar a cargar 200px antes de llegar al final
    threshold: 0
  });

  observer.observe(sentinel);
})();
</script>

<script>
/* ===== Modal Profit Calculator ===== */
const ModalProfitCalc = (function() {
  'use strict';

  // eBay fee structures
  const standardFees = {
    "Electronics": 12.9, "Clothing, Shoes & Accessories": 13.25, "Toys & Hobbies": 12.9,
    "Collectibles": 12.9, "Books, Movies & Music": 14.95, "Video Games & Consoles": 12.9,
    "Home & Garden": 12.9, "Tools & Equipment": 12.9, "Sports": 12.9,
    "Health & Beauty": 12.9, "Business & Industrial": 12.9, "Pet Supplies": 12.9
  };

  const storeFees = {
    "Electronics": 11.7, "Clothing, Shoes & Accessories": 11.5, "Toys & Hobbies": 11.5,
    "Collectibles": 11.5, "Books, Movies & Music": 12.0, "Video Games & Consoles": 11.5,
    "Home & Garden": 11.5, "Tools & Equipment": 11.5, "Sports": 11.5,
    "Health & Beauty": 11.5, "Business & Industrial": 11.5, "Pet Supplies": 11.5
  };

  const depopPaymentFeeRate = 3.3, depopPaymentFixedFee = 0.45, depopBoostFeeRate = 8;

  let modal, closeBtn, contentDiv;
  let elements = {};

  function init() {
    modal = document.getElementById('profitCalcModal');
    closeBtn = document.getElementById('profitCalcClose');
    contentDiv = document.getElementById('profitModalContent');

    // Event delegation for calculator buttons
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.profit-calc-btn');
      if (btn) {
        const itemData = {
          id: btn.getAttribute('data-item-id'),
          title: btn.getAttribute('data-item-title'),
          cost: btn.getAttribute('data-item-cost'),
          price: btn.getAttribute('data-item-price')
        };
        openModal(itemData);
      }
    });

    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });
  }

  function openModal(itemData) {
    renderContent(itemData);
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeModal() {
    document.body.classList.remove('modal-open');
    modal.setAttribute('hidden', '');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden', 'true');
    saveToCache();
  }

  function renderContent(itemData) {
    const cached = loadFromCache();
    contentDiv.innerHTML = `
      <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Marketplace</label>
      <select id="modalMarketplace" class="modal-input" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">
        <option value="ebay">eBay</option>
        <option value="depop">Depop</option>
      </select>

      <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Item Name</label>
      <input type="text" id="modalItemName" class="modal-input" readonly value="${itemData.title}" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">

      <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Purchase Price ($)</label>
      <input type="number" id="modalBuyPrice" class="modal-input" step="0.01" value="${itemData.cost || ''}" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">

      <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Estimated Resale Price ($)</label>
      <input type="number" id="modalResalePrice" class="modal-input" step="0.01" value="${itemData.price || ''}" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">

      <label id="modalFeesLabel" style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Marketplace Fees (%)</label>
      <input type="number" id="modalFees" class="modal-input" readonly value="15" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">

      <div id="modalEbaySection" style="display:block">
        <div style="display:flex;align-items:center;margin-top:0.8rem">
          <input type="checkbox" id="modalHasStore" style="margin-right:0.5rem;width:auto">
          <label for="modalHasStore" style="font-size:var(--fs-sm)">I have an eBay Store</label>
        </div>
        <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">eBay Category</label>
        <select id="modalEbayCategory" class="modal-input" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)"></select>
        <div style="display:flex;align-items:center;margin-top:0.8rem">
          <input type="checkbox" id="modalTopRated" style="margin-right:0.5rem;width:auto">
          <label for="modalTopRated" style="font-size:var(--fs-sm)">Top Rated Seller</label>
        </div>
        <div style="display:flex;align-items:center;margin-top:0.8rem">
          <input type="checkbox" id="modalFixedFee" style="margin-right:0.5rem;width:auto">
          <label for="modalFixedFee" style="font-size:var(--fs-sm)">Include $0.30 fixed fee</label>
        </div>
      </div>

      <div id="modalDepopSection" style="display:none">
        <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Depop Category</label>
        <select id="modalDepopCategory" class="modal-input" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">
          <option value="Women's Clothing">Women's Clothing</option>
          <option value="Men's Clothing">Men's Clothing</option>
          <option value="Vintage">Vintage</option>
          <option value="Streetwear">Streetwear</option>
          <option value="Sneakers">Sneakers</option>
          <option value="Accessories">Accessories</option>
          <option value="Jewelry">Jewelry</option>
          <option value="Beauty">Beauty</option>
          <option value="Home & Living">Home & Living</option>
          <option value="Art & Collectibles">Art & Collectibles</option>
          <option value="Other">Other</option>
        </select>
        <div style="display:flex;align-items:center;margin-top:0.8rem">
          <input type="checkbox" id="modalDepopBoost" style="margin-right:0.5rem;width:auto">
          <label for="modalDepopBoost" style="font-size:var(--fs-sm)">Use Boosted Listing (+8%)</label>
        </div>
        <div style="display:flex;align-items:center;margin-top:0.8rem">
          <input type="checkbox" id="modalDepopShipping" style="margin-right:0.5rem;width:auto">
          <label for="modalDepopShipping" style="font-size:var(--fs-sm)">Shipping included in item price</label>
        </div>
      </div>

      <label style="display:block;margin-top:0.8rem;font-size:var(--fs-sm);color:var(--sub)">Shipping Cost ($)</label>
      <input type="number" id="modalShipping" class="modal-input" value="0" step="0.01" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--muted);color:var(--text)">

      <button class="btn submitbtn" onclick="ModalProfitCalc.calculate()" style="width:100%;margin-top:1.2rem">
        <i class="fas fa-calculator"></i> Calculate Profit
      </button>

      <div id="modalResult" style="display:none;margin-top:1rem;padding:1rem;background:var(--muted);border-radius:var(--radius);font-size:var(--fs-sm);white-space:pre-wrap"></div>
    `;

    initElements();
    updateCategoryOptions();
    if (cached) applyCache(cached);
    updateFees();
  }

  function initElements() {
    elements = {
      marketplace: document.getElementById('modalMarketplace'),
      buyPrice: document.getElementById('modalBuyPrice'),
      resalePrice: document.getElementById('modalResalePrice'),
      fees: document.getElementById('modalFees'),
      feesLabel: document.getElementById('modalFeesLabel'),
      shipping: document.getElementById('modalShipping'),
      hasStore: document.getElementById('modalHasStore'),
      ebayCategory: document.getElementById('modalEbayCategory'),
      topRated: document.getElementById('modalTopRated'),
      fixedFee: document.getElementById('modalFixedFee'),
      ebaySection: document.getElementById('modalEbaySection'),
      depopCategory: document.getElementById('modalDepopCategory'),
      depopBoost: document.getElementById('modalDepopBoost'),
      depopShipping: document.getElementById('modalDepopShipping'),
      depopSection: document.getElementById('modalDepopSection'),
      result: document.getElementById('modalResult')
    };

    elements.marketplace.addEventListener('change', switchMarketplace);
    elements.hasStore.addEventListener('change', () => { updateCategoryOptions(); });
    elements.ebayCategory.addEventListener('change', updateFees);
    elements.topRated.addEventListener('change', updateFees);
    elements.depopBoost.addEventListener('change', updateDepopFees);
  }

  function switchMarketplace() {
    const marketplace = elements.marketplace.value;
    elements.ebaySection.style.display = marketplace === 'ebay' ? 'block' : 'none';
    elements.depopSection.style.display = marketplace === 'depop' ? 'block' : 'none';
    elements.feesLabel.textContent = marketplace === 'ebay' ? 'eBay + PayPal Fees (%)' : 'Depop Fees (%)';
    updateFees();
  }

  function updateCategoryOptions() {
    const hasStore = elements.hasStore.checked;
    const fees = hasStore ? storeFees : standardFees;
    const current = elements.ebayCategory.value;

    elements.ebayCategory.innerHTML = '<option value="">Select a category</option>';
    for (let category in fees) {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      elements.ebayCategory.appendChild(option);
    }

    if (current && fees[current]) elements.ebayCategory.value = current;
    updateFees();
  }

  function updateDepopFees() {
    const includeBoost = elements.depopBoost.checked;
    const totalFee = includeBoost ? depopPaymentFeeRate + depopBoostFeeRate : depopPaymentFeeRate;
    elements.fees.value = totalFee.toFixed(2);
  }

  function updateFees() {
    const marketplace = elements.marketplace.value;
    if (marketplace === 'ebay') {
      const hasStore = elements.hasStore.checked;
      const selectedCategory = elements.ebayCategory.value;
      const topRated = elements.topRated.checked;
      let fee = hasStore ? storeFees[selectedCategory] : standardFees[selectedCategory];
      if (fee && topRated) fee *= 0.90;
      elements.fees.value = fee ? fee.toFixed(2) : '15';
    } else {
      updateDepopFees();
    }
  }

  function calculate() {
    const marketplace = elements.marketplace.value;
    const buyPrice = parseFloat(elements.buyPrice.value) || 0;
    const resalePrice = parseFloat(elements.resalePrice.value) || 0;
    const shippingCost = parseFloat(elements.shipping.value) || 0;

    if (!buyPrice || !resalePrice) {
      elements.result.innerHTML = '<p style="color:var(--err)">Please fill in Purchase Price and Resale Price.</p>';
      elements.result.style.display = 'block';
      return;
    }

    let totalFees, feeDetails, net, profit, totalCost, breakeven;

    if (marketplace === 'ebay') {
      const feePercent = parseFloat(elements.fees.value) || 0;
      const includeFixedFee = elements.fixedFee.checked;
      const variableFees = resalePrice * (feePercent / 100);
      const fixedFee = includeFixedFee ? 0.30 : 0;
      totalFees = variableFees + fixedFee;
      feeDetails = `eBay + PayPal Fees (${feePercent}% + $${fixedFee.toFixed(2)})`;
      net = resalePrice - totalFees - shippingCost;
      totalCost = buyPrice + shippingCost + totalFees;
      breakeven = ((buyPrice + shippingCost + fixedFee) / (1 - (feePercent / 100))).toFixed(2);
    } else {
      const useBoost = elements.depopBoost.checked;
      const includeShippingInPrice = elements.depopShipping.checked;
      const feeBasis = includeShippingInPrice ? resalePrice : resalePrice + shippingCost;
      const paymentProcessingFee = (feeBasis * (depopPaymentFeeRate / 100)) + depopPaymentFixedFee;
      const boostFee = useBoost ? (resalePrice * (depopBoostFeeRate / 100)) : 0;
      totalFees = paymentProcessingFee + boostFee;
      feeDetails = `Depop Fees (${depopPaymentFeeRate}% + $${depopPaymentFixedFee.toFixed(2)}${useBoost ? ` + Boost ${depopBoostFeeRate}%` : ''})`;
      net = resalePrice - totalFees - (includeShippingInPrice ? 0 : shippingCost);
      totalCost = buyPrice + (includeShippingInPrice ? 0 : shippingCost) + totalFees;
      breakeven = ((buyPrice + (includeShippingInPrice ? 0 : shippingCost) + depopPaymentFixedFee) / (1 - (depopPaymentFeeRate / 100))).toFixed(2);
    }

    profit = net - buyPrice;
    const taxRate = 0.0875;
    const buyerPays = resalePrice * (1 + taxRate);
    const roi = ((profit / buyPrice) * 100).toFixed(2);
    const markup = (((resalePrice - buyPrice) / buyPrice) * 100).toFixed(2);
    const earningsPerDollar = (profit / buyPrice).toFixed(2);

    const output = `
💰 Profit: $${profit.toFixed(2)}
🔄 ROI: ${roi}%
📊 Markup: ${markup}%
📦 Net Sale: $${net.toFixed(2)}
💼 Total Cost: $${totalCost.toFixed(2)}
💸 ${feeDetails}: $${totalFees.toFixed(2)}
🚚 Shipping: $${marketplace === 'depop' && elements.depopShipping.checked ? 'Included' : shippingCost.toFixed(2)}
🧾 Buyer Pays (w/ tax): $${buyerPays.toFixed(2)}
🧮 Break-even: $${breakeven}
💡 Earnings per $1: $${earningsPerDollar}
`.trim();

    elements.result.innerHTML = `<pre>${output}</pre>`;
    elements.result.style.display = 'block';
  }

  function saveToCache() {
    if (!elements.marketplace) return;
    const data = {
      marketplace: elements.marketplace.value,
      shipping: elements.shipping.value,
      hasStore: elements.hasStore.checked,
      topRated: elements.topRated.checked,
      fixedFee: elements.fixedFee.checked,
      ebayCategory: elements.ebayCategory.value,
      depopCategory: elements.depopCategory.value,
      depopBoost: elements.depopBoost.checked,
      depopShipping: elements.depopShipping.checked
    };
    try { localStorage.setItem('qventoryModalProfitCalc', JSON.stringify(data)); } catch {}
  }

  function loadFromCache() {
    try { return JSON.parse(localStorage.getItem('qventoryModalProfitCalc')); } catch { return null; }
  }

  function applyCache(data) {
    elements.marketplace.value = data.marketplace || 'ebay';
    elements.shipping.value = data.shipping || '0';
    elements.hasStore.checked = data.hasStore || false;
    elements.topRated.checked = data.topRated || false;
    elements.fixedFee.checked = data.fixedFee || false;
    elements.depopBoost.checked = data.depopBoost || false;
    elements.depopShipping.checked = data.depopShipping || false;
    if (data.ebayCategory) elements.ebayCategory.value = data.ebayCategory;
    if (data.depopCategory) elements.depopCategory.value = data.depopCategory;
    switchMarketplace();
  }

  return { init, calculate };
})();

document.addEventListener('DOMContentLoaded', ModalProfitCalc.init);
</script>

<style>
/* ===== AI Research Modal Styles ===== */
.ai-result-box {
  margin-top: 1.5rem;
  padding: 0;
  background: transparent;
  border-radius: var(--radius);
  font-size: var(--fs-sm);
  line-height: 1.6;
}

#aiResultContent {
  /* HTML content with inline styles */
}

/* Typing indicator animation */
.typing-indicator {
  display: flex;
  gap: 6px;
  padding: 1rem 0;
  align-items: center;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  animation: typing-bounce 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(1) {
  animation-delay: -0.32s;
}

.typing-indicator span:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes typing-bounce {
  0%, 80%, 100% {
    transform: scale(0);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}
</style>

<script>
/* ===== AI Research Modal ===== */
const ModalAIResearch = (function() {
  'use strict';

  let modal, closeBtn, currentItemId = null;
  const typingSpeed = 15; // ms per character

  function init() {
    modal = document.getElementById('aiResearchModal');
    closeBtn = document.getElementById('aiResearchClose');

    // Event delegation for AI research buttons in item rows
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.ai-research-btn');
      if (btn) {
        const itemData = {
          id: btn.getAttribute('data-item-id'),
          title: btn.getAttribute('data-item-title')
        };
        openModal(itemData);
      }
    });

    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    });

    // Autocomplete functionality
    const itemTitle = document.getElementById('aiItemTitle');
    const autocompleteList = document.getElementById('aiAutocompleteList');

    itemTitle?.addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      if (query.length < 2) {
        autocompleteList.classList.remove('show');
        return;
      }

      try {
        const response = await fetch(`/api/autocomplete-items?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.ok && data.items.length > 0) {
          autocompleteList.innerHTML = data.items.map(item => `
            <div class="autocomplete-item ai-autocomplete-item" data-item-id="${item.id}" data-item-title="${item.title.replace(/"/g, '&quot;')}">
              <strong>${item.title.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</strong>
              <small>SKU: ${item.sku}${item.supplier ? ' • Supplier: ' + item.supplier.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''}</small>
            </div>
          `).join('');
          autocompleteList.classList.add('show');
        } else {
          autocompleteList.classList.remove('show');
        }
      } catch (err) {
        console.error('Autocomplete error:', err);
      }
    });

    // Close autocomplete on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#aiItemTitle') && !e.target.closest('#aiAutocompleteList')) {
        autocompleteList?.classList.remove('show');
      }
    });

    // Delegated event for autocomplete item clicks
    document.addEventListener('click', (e) => {
      const item = e.target.closest('.ai-autocomplete-item');
      if (item) {
        const itemId = parseInt(item.getAttribute('data-item-id'));
        const itemTitle = item.getAttribute('data-item-title');
        selectItem(itemId, itemTitle);
      }
    });
  }

  function openModal(itemData = null) {
    if (itemData) {
      currentItemId = itemData.id;
      document.getElementById('aiItemTitle').value = itemData.title;
      // Notes will be fetched from backend based on item_id
      document.getElementById('aiNotes').value = '';
    } else {
      currentItemId = null;
      document.getElementById('aiItemTitle').value = '';
      document.getElementById('aiNotes').value = '';
    }

    // Reset result
    document.getElementById('aiResult').style.display = 'none';
    document.getElementById('aiResultContent').innerHTML = '';

    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeModal() {
    document.body.classList.remove('modal-open');
    modal.setAttribute('hidden', '');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden', 'true');
  }

  function selectItem(itemId, title) {
    currentItemId = itemId;
    document.getElementById('aiItemTitle').value = title;
    document.getElementById('aiAutocompleteList').classList.remove('show');
  }

  function updateProgress(message, percent) {
    const progressBar = document.getElementById('aiProgressBar');
    const progressMessage = document.getElementById('aiProgressMessage');
    const progressPercent = document.getElementById('aiProgressPercent');
    const progressFill = document.getElementById('aiProgressFill');

    progressBar.style.display = 'block';
    progressMessage.textContent = message;
    progressPercent.textContent = `${percent}%`;
    progressFill.style.width = `${percent}%`;
  }

  function hideProgress() {
    const progressBar = document.getElementById('aiProgressBar');
    progressBar.style.display = 'none';
  }

  async function analyze() {
    const itemTitle = document.getElementById('aiItemTitle').value.trim();
    const condition = document.getElementById('aiCondition').value.trim();
    const notes = document.getElementById('aiNotes').value.trim();
    const marketRegion = document.getElementById('aiMarketRegion').value;
    const currency = document.getElementById('aiCurrency').value;

    if (!itemTitle) {
      alert('Please enter an item title');
      return;
    }

    const analyzeBtn = document.getElementById('aiAnalyzeBtn');
    const resultBox = document.getElementById('aiResult');
    const resultContent = document.getElementById('aiResultContent');

    // Show loading state
    analyzeBtn.classList.add('loading');
    analyzeBtn.style.opacity = '0.6';
    analyzeBtn.style.pointerEvents = 'none';
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    resultBox.style.display = 'block';
    resultContent.innerHTML = '';

    // Start progress animation
    updateProgress('🚀 Starting AI Market Research...', 5);

    try {
      const payload = currentItemId
        ? { item_id: currentItemId }
        : { title: itemTitle, condition, notes, market_region: marketRegion, currency };

      console.log('[AI Research] Starting analysis with payload:', payload);

      updateProgress('🔗 Building eBay search URL...', 10);

      await new Promise(resolve => setTimeout(resolve, 300));
      updateProgress('📡 Connecting to Browse.AI...', 15);

      const startTime = Date.now();
      console.log('[AI Research] Sending request to /api/ai-research-async...');

      const response = await fetch('/api/ai-research-async', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });

      console.log(`[AI Research] Response received (${response.status}) after ${((Date.now() - startTime) / 1000).toFixed(1)}s`);

      // Simulate progress during long request with detailed feedback
      const simulateProgress = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        const estimatedTotal = 90; // 90 seconds estimate
        const percent = Math.min(85, 15 + (elapsed / estimatedTotal) * 70);

        if (elapsed < 8) {
          updateProgress('🚀 Launching Browse.AI robot...', Math.floor(percent));
        } else if (elapsed < 18) {
          updateProgress('🌐 Connecting to eBay servers...', Math.floor(percent));
        } else if (elapsed < 30) {
          updateProgress('🕷️  Browse.AI bypassing anti-bot protection...', Math.floor(percent));
        } else if (elapsed < 42) {
          updateProgress('📡 Scraping sold listings from eBay...', Math.floor(percent));
        } else if (elapsed < 54) {
          updateProgress('⏳ Extracting prices and titles...', Math.floor(percent));
        } else if (elapsed < 66) {
          updateProgress(`🔍 Processing HTML data (${Math.floor(elapsed)}s)...`, Math.floor(percent));
        } else if (elapsed < 78) {
          updateProgress('💾 Saving to cache...', Math.floor(percent));
        } else {
          updateProgress(`⚡ Finalizing (${Math.floor(elapsed)}s elapsed)...`, Math.floor(percent));
        }
      }, 1500);

      // Check if response is JSON
      const contentType = response.headers.get('content-type');
      clearInterval(simulateProgress);

      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('Non-JSON response received:', text.substring(0, 500));
        updateProgress('❌ Server error', 100);
        throw new Error(`Server returned non-JSON response (${response.status}). Check console for details.`);
      }

      const data = await response.json();
      console.log('[AI Research] Response:', data);

      if (data.ok) {
        // ASYNC MODE: Report started in background
        updateProgress('✅ Report generation started!', 100);
        await new Promise(resolve => setTimeout(resolve, 800));

        hideProgress();

        // Show success message with token info
        const tokenInfo = data.token_stats ?
          `<div style="font-size:11px;color:#9ca3af;margin-top:8px">
            🎫 Tokens remaining today: ${data.token_stats.remaining}/${data.token_stats.daily_limit}
          </div>` : '';

        resultContent.innerHTML = `
          <div style="padding:20px;background:#1a1d24;border-radius:8px;text-align:center">
            <div style="font-size:48px;margin-bottom:16px">⚡</div>
            <h3 style="color:#34d399;margin-bottom:8px">Report Processing Started!</h3>
            <p style="color:#e8e8e8;font-size:14px;margin-bottom:12px">
              Your AI market research is being generated in the background.
            </p>
            <p style="color:#9ca3af;font-size:12px;margin-bottom:20px">
              This usually takes 60-90 seconds. You'll be notified when it's ready.
            </p>
            ${tokenInfo}
            <div style="margin-top:20px">
              <a href="/reports" class="btn btn-primary" style="text-decoration:none;display:inline-block;padding:12px 24px">
                <i class="fas fa-file-chart"></i> View Reports
              </a>
              <button onclick="document.getElementById('aiModal').style.display='none'" class="btn" style="margin-left:8px;padding:12px 24px">
                Close
              </button>
            </div>
          </div>
        `;

      } else {
        // Error handling
        updateProgress('❌ Error occurred', 100);
        hideProgress();

        let errorMsg = data.error || 'Unknown error';

        // Special handling for no tokens
        if (data.error_type === 'no_tokens' && data.token_stats) {
          errorMsg = `
            <div style="text-align:center;padding:20px">
              <div style="font-size:48px;margin-bottom:16px">🎫</div>
              <h3 style="color:#f59e0b;margin-bottom:8px">No AI Tokens Remaining</h3>
              <p style="color:#e8e8e8;margin-bottom:8px">
                You've used ${data.token_stats.used_today}/${data.token_stats.daily_limit} tokens today.
              </p>
              <p style="color:#9ca3af;font-size:12px;margin-bottom:16px">
                Your role: <strong>${data.token_stats.role}</strong><br>
                Tokens reset daily at midnight UTC.
              </p>
              <a href="/settings" class="btn btn-primary" style="text-decoration:none;display:inline-block">
                <i class="fas fa-crown"></i> Upgrade Plan
              </a>
            </div>
          `;
        }

        resultContent.innerHTML = `<div style="color:var(--error);margin-top:20px">${errorMsg}</div>`;
      }
    } catch (err) {
      console.error('Full error:', err);
      hideProgress();
      resultContent.innerHTML = `<div style="color:var(--error);margin-top:20px"><strong>Error:</strong> ${err.message}<br><small>Check browser console for details</small></div>`;
    } finally {
      analyzeBtn.classList.remove('loading');
      analyzeBtn.style.opacity = '1';
      analyzeBtn.style.pointerEvents = 'auto';
      analyzeBtn.innerHTML = '<i class="fas fa-robot"></i> Analyze Market';
    }
  }

  function typewriterEffect(element, text) {
    let index = 0;
    element.innerHTML = '';

    const type = () => {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        index++;
        setTimeout(type, typingSpeed);
      }
    };

    type();
  }

  return { init, openModal, closeModal, selectItem, analyze };
})();

// Global function for modal opening from header button
function openAIResearchModal() {
  ModalAIResearch.openModal();
}

// Global function for closing modal
function closeAIResearchModal() {
  ModalAIResearch.closeModal();
}

// Global function for analyze button
function analyzeAIResearch() {
  ModalAIResearch.analyze();
}

document.addEventListener('DOMContentLoaded', ModalAIResearch.init);
</script>

{% endblock %}