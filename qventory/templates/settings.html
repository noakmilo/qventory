{% extends "base_new.html" %}
{% block title %}Settings – Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">Settings</span>
</nav>
{% endblock %}

{% block content %}

<div class="settings-row">
  <!-- eBay Integration Section -->
  <div class="card">
    <h2><i class="fab fa-ebay" style="color:#E53238"></i> eBay Integration</h2>

    {% if ebay_connected %}
      <!-- Connected State -->
      <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <i class="fas fa-check-circle" style="color:#10b981;font-size:24px"></i>
          <div>
            <div style="font-weight:600;color:#10b981">Connected to eBay</div>
            <div style="font-size:13px;color:var(--sub)">Account: {{ ebay_username }}</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--sub);margin-top:12px">
          <div>✓ Import inventory from eBay</div>
          <div>✓ Sync location to Custom SKU</div>
          <div>✓ Auto-sync sales and orders</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <form method="post" action="{{ url_for('ebay_auth.refresh_token') }}" style="display:inline">
          <button type="submit" class="btn" style="background:rgba(96,165,250,0.1);border-color:rgba(96,165,250,0.3);color:#60a5fa">
            <i class="fas fa-sync-alt"></i> Refresh Token
          </button>
        </form>
        <form method="post" action="{{ url_for('ebay_auth.disconnect') }}" style="display:inline"
              onsubmit="return confirm('Are you sure you want to disconnect your eBay account?')">
          <button type="submit" class="btn" style="background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#ef4444">
            <i class="fas fa-unlink"></i> Disconnect
          </button>
        </form>
      </div>
    {% else %}
      <!-- Not Connected State -->
      <div style="background:rgba(156,163,175,0.1);border:1px solid rgba(156,163,175,0.3);border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <i class="fas fa-link-slash" style="color:#9ca3af;font-size:24px"></i>
          <div>
            <div style="font-weight:600;color:var(--text)">Not Connected</div>
            <div style="font-size:13px;color:var(--sub)">Connect your eBay seller account to unlock:</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--sub);margin-top:12px;margin-left:36px">
          <div>• Import all your eBay listings to Qventory</div>
          <div>• Sync inventory locations to eBay Custom SKU</div>
          <div>• Auto-import sales and order data</div>
          <div>• Real-time analytics from your eBay store</div>
        </div>
      </div>

      <a href="{{ url_for('ebay_auth.connect') }}"
         class="btn btn-primary"
         style="background:#60a5fa;border-color:#60a5fa"
         onclick="event.preventDefault(); window.location.href = '{{ url_for('ebay_auth.connect') }}';">
        <i class="fab fa-ebay"></i> Connect eBay Account
      </a>
    {% endif %}
  </div>

  <!-- Subscription Section -->
  <div class="card">
    <h2><i class="fas fa-receipt" style="color:#22c55e"></i> My Subscription</h2>
  {% if subscription %}
    {% set plan_display = subscription.plan.replace('_', ' ').title() %}
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;margin-top:12px;">
      <div style="min-width:220px;">
        <div style="font-size:13px;color:var(--sub);text-transform:uppercase;letter-spacing:0.08em;">Current Plan</div>
        <div style="font-size:20px;font-weight:600;color:var(--text);margin-top:4px;">{{ plan_display }}</div>
        {% if plan_limits and plan_limits.monthly_price is not none %}
          <div style="font-size:14px;color:var(--sub);margin-top:4px;">
            ${{ '%.2f'|format(plan_limits.monthly_price) }} / month
          </div>
        {% endif %}
      </div>
      <div style="min-width:200px;">
        <div style="font-size:13px;color:var(--sub);text-transform:uppercase;letter-spacing:0.08em;">Status</div>
        {% if subscription.plan == 'free' %}
          <div style="font-size:16px;color:var(--text);margin-top:4px;">Free</div>
        {% else %}
          <div style="font-size:16px;color:var(--text);margin-top:4px;">{{ subscription.status|capitalize }}</div>
          {% if subscription.on_trial and subscription.trial_ends_at %}
            <div style="font-size:13px;color:var(--sub);margin-top:4px;">
              Trial ends {{ subscription.trial_ends_at.strftime('%b %d, %Y') }}
            </div>
          {% elif subscription.status == 'active' and subscription.current_period_end %}
            <div style="font-size:13px;color:var(--sub);margin-top:4px;">
              Renews {{ subscription.current_period_end.strftime('%b %d, %Y') }}
            </div>
          {% endif %}
        {% endif %}
      </div>
      <div style="margin-left:auto;">
        <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn">
          <i class="fas fa-arrow-up"></i> Manage Plan
        </a>
      </div>
    </div>

    {% if subscription.plan != 'free' and subscription.stripe_subscription_id %}
    <div style="margin-top:18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
      <form method="POST" action="{{ url_for('main.stripe_customer_portal') }}" style="display:inline;">
        <button type="submit" class="btn">
          <i class="fas fa-credit-card"></i> Update Payment Method
        </button>
      </form>
      <form method="POST" action="{{ url_for('main.stripe_cancel_subscription') }}" style="display:inline;" id="cancel-subscription-form">
        <button type="button" class="btn" id="cancel-subscription-button" style="background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.35);color:#ef4444;">
          <i class="fas fa-ban"></i> Cancel Subscription
        </button>
      </form>
    </div>
    <div style="margin-top:14px;padding:14px 16px;border:1px solid rgba(239,68,68,0.2);background:rgba(239,68,68,0.06);border-radius:10px;">
      <div style="font-weight:600;color:#ef4444;margin-bottom:6px;">Before you cancel</div>
      <div style="color:var(--sub);font-size:14px;line-height:1.6;">
        You'll lose higher item limits, advanced analytics, AI research capacity, and bulk workflows that save hours every week.
        If you're downsizing, consider switching to a lower tier instead of cancelling.
      </div>
    </div>
    {% elif subscription.plan == 'free' %}
    <div style="margin-top:18px;">
      <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn">
        <i class="fas fa-arrow-up"></i> Upgrade Plan
      </a>
    </div>
    {% endif %}
  {% else %}
    <p style="color:var(--sub);margin-top:8px;">No subscription details available yet.</p>
    <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn" style="margin-top:10px;">
      <i class="fas fa-arrow-up"></i> View Plans
    </a>
  {% endif %}
  </div>

  <!-- Support Section -->
  <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
    <div>
      <h2 style="margin-bottom:6px;"><i class="fab fa-discord" style="color:#5865F2;"></i> Support</h2>
      <p style="color:var(--sub); font-size:14px; max-width:360px; margin:0;">
        Get support from the team, share feedback, and see what other sellers are building.
      </p>
    </div>
    <a href="https://discord.gg/KWGCZDGWMN" target="_blank" rel="noopener" class="btn submitbtn" style="white-space:nowrap;">
      <i class="fab fa-discord"></i> Join the community
    </a>
  </div>

  <!-- Suppliers Section -->
  <div class="card">
    <h2><i class="fas fa-truck" style="color:#f97316"></i> Suppliers</h2>
    <p style="color:var(--sub);font-size:14px;margin-top:6px;">
      Manage suppliers, see how many items are assigned, and track unassigned inventory.
    </p>

    <div style="margin-top:16px;display:grid;grid-template-columns:1fr;gap:16px;">
      <div style="border:1px solid var(--glass-border);border-radius:12px;padding:12px;background:var(--glass-bg);">
        <canvas id="suppliersChart" style="width:100%;max-height:260px;"></canvas>
      </div>
      <div class="table-wrap" style="border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Supplier</th>
              <th style="text-align:right;">Items</th>
              <th style="text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="suppliersTableBody">
            <tr>
              <td colspan="3" style="color:var(--sub);">Loading suppliers...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if subscription and subscription.stripe_subscription_id %}
<div id="cancel-modal" style="position:fixed;inset:0;background:rgba(9,12,18,0.6);display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:520px;width:92%;padding:22px 24px;box-shadow:0 18px 48px rgba(0,0,0,0.35);">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:rgba(239,68,68,0.12);color:#ef4444;">
          <i class="fas fa-triangle-exclamation"></i>
        </div>
        <div style="font-size:18px;font-weight:600;color:var(--text);">Before you cancel</div>
      </div>
      <button type="button" id="cancel-modal-close" class="btn" style="padding:6px 10px;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <p style="color:var(--sub);line-height:1.7;margin:14px 0 16px 0;">
      Canceling will remove higher item limits, advanced analytics, AI research capacity, and bulk workflows.
      If you're still in trial, the cancellation is immediate and items above the Free plan limit are removed.
    </p>
    <div style="padding:14px 16px;border:1px solid rgba(34,197,94,0.2);background:rgba(34,197,94,0.08);border-radius:10px;margin-bottom:16px;">
      <div style="font-weight:600;color:#22c55e;margin-bottom:6px;">Consider downgrading instead</div>
      <div style="color:var(--sub);font-size:14px;line-height:1.6;">
        Keep essential tools active and lower your monthly cost. You can downgrade from the Upgrade page in seconds.
      </div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;">
      <a href="{{ url_for('main.upgrade') }}" class="btn">
        View Plans
      </a>
      <button type="button" class="btn" id="cancel-modal-back">
        Keep My Plan
      </button>
      <button type="button" class="btn" id="cancel-modal-confirm" style="background:#ef4444;border-color:#ef4444;color:#fff;">
        Cancel Anyway
      </button>
    </div>
  </div>
</div>
{% endif %}

<div class="settings-grid" style="margin-top:20px;">
  <a class="settings-card" href="{{ url_for('main.settings_labels') }}">
    <div class="settings-card__icon"><i class="fas fa-layer-group"></i></div>
    <div>
      <h3>Location Labels</h3>
      <p>Configure A/B/S/C hierarchy and labels.</p>
    </div>
  </a>
  <a class="settings-card" href="{{ url_for('main.settings_link_bio') }}">
    <div class="settings-card__icon"><i class="fas fa-link"></i></div>
    <div>
      <h3>Link In Bio</h3>
      <p>Customize your public storefront link.</p>
    </div>
  </a>
  <a class="settings-card" href="{{ url_for('main.settings_pickup_scheduler') }}">
    <div class="settings-card__icon"><i class="fas fa-calendar-check"></i></div>
    <div>
      <h3>Pickup Scheduler</h3>
      <p>Let buyers book pickups from your public link.</p>
    </div>
  </a>
  <a class="settings-card" href="{{ url_for('main.settings_theme') }}">
    <div class="settings-card__icon"><i class="fas fa-palette"></i></div>
    <div>
      <h3>Theme</h3>
      <p>Switch between dark and light modes.</p>
    </div>
  </a>
  <a class="settings-card" href="{{ url_for('main.inventory_inactive_by_user') }}">
    <div class="settings-card__icon"><i class="fas fa-eye-slash"></i></div>
    <div>
      <h3>Manage Inactive Items</h3>
      <p>Review and reactivate items hidden from your active inventory.</p>
    </div>
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  let suppliersChartInstance = null;

  function renderSuppliersTable(rows, unassignedCount) {
    const tbody = document.getElementById('suppliersTableBody');
    if (!tbody) return;

    if (!rows.length && !unassignedCount) {
      tbody.innerHTML = '<tr><td colspan="3" style="color:var(--sub);">No suppliers found.</td></tr>';
      return;
    }

    const html = [];
    rows.forEach(row => {
      html.push(`
        <tr data-supplier-name="${row.name}">
          <td>
            <span class="supplier-name">${row.name}</span>
            <input class="input supplier-edit-input" type="text" value="${row.name}" style="display:none;max-width:220px;">
          </td>
          <td style="text-align:right;">${row.count}</td>
          <td style="text-align:right;">
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
              <button class="btn btn-sm supplier-edit-btn" type="button">Edit</button>
              <button class="btn btn-sm supplier-save-btn" type="button" style="display:none;background:#10b981;color:#fff;">Save</button>
              <button class="btn btn-sm supplier-cancel-btn" type="button" style="display:none;">Cancel</button>
              <button class="btn btn-sm supplier-delete-btn" type="button" style="background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#ef4444;">Delete</button>
            </div>
          </td>
        </tr>
      `);
    });

    if (unassignedCount) {
      html.push(`
        <tr>
          <td style="color:var(--sub);">Unassigned</td>
          <td style="text-align:right;">${unassignedCount}</td>
          <td style="text-align:right;color:var(--sub);">—</td>
        </tr>
      `);
    }

    tbody.innerHTML = html.join('');
  }

  function renderSuppliersChart(rows, unassignedCount) {
    const canvas = document.getElementById('suppliersChart');
    if (!canvas) return;

    const labels = rows.map(r => r.name);
    const data = rows.map(r => r.count);
    if (unassignedCount) {
      labels.push('Unassigned');
      data.push(unassignedCount);
    }

    const palette = ['#38bdf8', '#22c55e', '#f97316', '#a855f7', '#f43f5e', '#facc15', '#14b8a6', '#8b5cf6'];
    const colors = labels.map((_, idx) => palette[idx % palette.length]);

    if (suppliersChartInstance) {
      suppliersChartInstance.destroy();
    }

    if (!labels.length) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      return;
    }

    suppliersChartInstance = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: colors,
          borderColor: 'rgba(17,24,39,0.2)',
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#cbd5f5' }
          }
        }
      }
    });
  }

  async function fetchSuppliersData() {
    const response = await fetch('/api/suppliers');
    const data = await response.json();
    if (!response.ok || !data.ok) {
      return { suppliers: [], unassigned: 0 };
    }
    return { suppliers: data.suppliers || [], unassigned: data.unassigned || 0 };
  }

  async function refreshSuppliers() {
    const { suppliers, unassigned } = await fetchSuppliersData();
    renderSuppliersTable(suppliers, unassigned);
    renderSuppliersChart(suppliers, unassigned);
  }

  async function renameSupplier(oldName, newName) {
    const response = await fetch('/api/suppliers/rename', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ old_name: oldName, new_name: newName })
    });
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data.error || 'Failed to rename supplier');
    }
  }

  async function deleteSupplier(name) {
    const response = await fetch('/api/suppliers/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data.error || 'Failed to delete supplier');
    }
  }

  document.addEventListener('click', async (event) => {
    const row = event.target.closest('tr[data-supplier-name]');
    if (!row) return;

    const supplierName = row.dataset.supplierName;
    const nameSpan = row.querySelector('.supplier-name');
    const input = row.querySelector('.supplier-edit-input');
    const editBtn = row.querySelector('.supplier-edit-btn');
    const saveBtn = row.querySelector('.supplier-save-btn');
    const cancelBtn = row.querySelector('.supplier-cancel-btn');

    if (event.target.closest('.supplier-edit-btn')) {
      nameSpan.style.display = 'none';
      input.style.display = 'inline-block';
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
      input.focus();
      return;
    }

    if (event.target.closest('.supplier-cancel-btn')) {
      input.value = supplierName;
      input.style.display = 'none';
      nameSpan.style.display = 'inline-block';
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      return;
    }

    if (event.target.closest('.supplier-save-btn')) {
      const newName = input.value.trim();
      if (!newName) {
        alert('Supplier name cannot be empty.');
        return;
      }
      if (newName === supplierName) {
        input.style.display = 'none';
        nameSpan.style.display = 'inline-block';
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        return;
      }
      try {
        await renameSupplier(supplierName, newName);
        await refreshSuppliers();
      } catch (err) {
        alert(err.message);
      }
      return;
    }

    if (event.target.closest('.supplier-delete-btn')) {
      if (!confirm(`Delete supplier "${supplierName}" and set its items to Unassigned?`)) {
        return;
      }
      try {
        await deleteSupplier(supplierName);
        await refreshSuppliers();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  document.addEventListener('DOMContentLoaded', refreshSuppliers);
</script>

<style>
  .settings-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
  }
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }
  .settings-card {
    display: flex;
    gap: 14px;
    padding: 16px;
    border-radius: 14px;
    border: 1px solid var(--glass-border);
    background: var(--glass-bg);
    text-decoration: none;
    color: var(--text);
    transition: transform 0.15s ease, border-color 0.15s ease;
  }
  .settings-card:hover {
    transform: translateY(-2px);
    border-color: rgba(96,165,250,0.45);
  }
  .settings-card__icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: rgba(96,165,250,0.12);
    color: #60a5fa;
    display: grid;
    place-items: center;
    font-size: 18px;
    flex: 0 0 auto;
  }
  .settings-card h3 {
    margin: 0 0 4px 0;
    font-size: 16px;
  }
  .settings-card p {
    margin: 0;
    color: var(--sub);
    font-size: 13px;
  }
</style>

<script>
  (function() {
    const cancelModal = document.getElementById("cancel-modal");
    const cancelButton = document.getElementById("cancel-subscription-button");
    const cancelClose = document.getElementById("cancel-modal-close");
    const cancelBack = document.getElementById("cancel-modal-back");
    const cancelConfirm = document.getElementById("cancel-modal-confirm");
    const cancelForm = document.getElementById("cancel-subscription-form");

    if (cancelModal && cancelButton && cancelForm) {
      function openCancelModal() {
        cancelModal.style.display = "flex";
      }
      function closeCancelModal() {
        cancelModal.style.display = "none";
      }

      cancelButton.addEventListener("click", openCancelModal);
      cancelClose?.addEventListener("click", closeCancelModal);
      cancelBack?.addEventListener("click", closeCancelModal);
      cancelModal.addEventListener("click", (event) => {
        if (event.target === cancelModal) {
          closeCancelModal();
        }
      });
      cancelConfirm?.addEventListener("click", () => {
        cancelForm.submit();
      });
    }

  })();
</script>
{% endblock %}
