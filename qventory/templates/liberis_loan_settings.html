{% extends "base_new.html" %}
{% block title %}Liberis Loan - Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <a href="{{ url_for('main.expenses_list') }}">Expenses</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">Liberis Loan</span>
</nav>
{% endblock %}

{% block content %}
<div class="container page-shell page-shell--large">

  <!-- Header -->
  <div style="margin-bottom:var(--space-6);">
    <h1 style="font-size:var(--fs-2xl);margin:0 0 var(--space-2) 0;color:var(--text);">
      <i class="fas fa-hand-holding-usd"></i> Liberis Loan Management
    </h1>
    <p style="color:var(--sub);margin:0;">
      Track your eBay Seller Capital loan repayment. The percentage fee will be automatically deducted from sales analytics.
    </p>
  </div>

  {% if active_loan %}
  <!-- Active Loan Card -->
  <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;padding:var(--space-5);margin-bottom:var(--space-5);">
    <div style="display:flex;align-items:start;justify-content:space-between;margin-bottom:var(--space-4);">
      <div>
        <h2 style="color:#22c55e;margin:0 0 var(--space-2) 0;font-size:var(--fs-lg);">
          <i class="fas fa-check-circle"></i> Active Loan
        </h2>
        <p style="margin:0;color:var(--sub);font-size:var(--fs-sm);">
          Started {{ active_loan.start_date.strftime('%b %d, %Y') }}
        </p>
      </div>
      <div style="text-align:right;">
        <div style="font-size:var(--fs-2xl);font-weight:600;color:#22c55e;">
          {{ active_loan.percentage }}%
        </div>
        <div style="font-size:var(--fs-xs);color:var(--sub);">per sale</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div style="margin-bottom:var(--space-4);">
      <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-2);">
        <span style="font-size:var(--fs-sm);color:var(--sub);">Repayment Progress</span>
        <span style="font-size:var(--fs-sm);font-weight:600;">{{ "%.1f"|format(active_loan.progress_percentage) }}%</span>
      </div>
      <div style="background:rgba(255,255,255,0.1);border-radius:999px;height:12px;overflow:hidden;">
        <div style="background:linear-gradient(90deg, #22c55e, #16a34a);height:100%;width:{{ active_loan.progress_percentage }}%;transition:width 0.3s ease;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:var(--space-2);font-size:var(--fs-sm);">
        <span style="color:#22c55e;font-weight:600;">${{ "%.2f"|format(active_loan.paid_amount) }} paid</span>
        <span style="color:var(--sub);">${{ "%.2f"|format(active_loan.total_amount) }} total</span>
      </div>
    </div>

    <!-- Remaining -->
    <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:var(--space-3);margin-bottom:var(--space-4);">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="color:var(--sub);font-size:var(--fs-sm);">Remaining to pay</span>
        <span style="font-size:var(--fs-xl);font-weight:600;color:#10b981;">
          ${{ "%.2f"|format(active_loan.remaining_amount) }}
        </span>
      </div>
    </div>

    <!-- Actions -->
    <div style="display:flex;gap:var(--space-2);">
      <form method="POST" style="flex:1;">
        <input type="hidden" name="action" value="recalculate">
        <button type="submit" class="btn" style="width:100%;background:rgba(96,165,250,0.2);color:#60a5fa;border:1px solid rgba(96,165,250,0.3);">
          <i class="fas fa-sync"></i> Recalculate
        </button>
      </form>
      <form method="POST" onsubmit="return confirm('Are you sure you want to deactivate this loan? You can always create a new one later.');">
        <input type="hidden" name="action" value="deactivate">
        <button type="submit" class="btn" style="background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid rgba(239,68,68,0.3);">
          <i class="fas fa-times-circle"></i> Deactivate
        </button>
      </form>
    </div>

    {% if active_loan.is_paid_off %}
    <div style="background:rgba(34,197,94,0.2);border-radius:6px;padding:var(--space-3);margin-top:var(--space-3);text-align:center;">
      <i class="fas fa-trophy" style="color:#22c55e;font-size:var(--fs-2xl);"></i>
      <p style="margin:var(--space-2) 0 0 0;color:#22c55e;font-weight:600;">
        Congratulations! Loan fully paid off!
      </p>
    </div>
    {% endif %}
  </div>

  {% else %}
  <!-- No Active Loan - Create Form -->
  <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:var(--space-5);margin-bottom:var(--space-5);">
    <h2 style="margin:0 0 var(--space-2) 0;font-size:var(--fs-lg);">
      <i class="fas fa-plus-circle"></i> Create New Loan
    </h2>
    <p style="color:var(--sub);margin:0 0 var(--space-4) 0;font-size:var(--fs-sm);">
      Set up tracking for your eBay Seller Capital loan. The fee will be automatically calculated on all sales after the start date.
    </p>

    <form method="POST">
      <input type="hidden" name="action" value="create">

      <div style="display:grid;gap:var(--space-4);">
        <!-- Percentage -->
        <div>
          <label style="display:block;margin-bottom:var(--space-2);font-weight:500;">
            <i class="fas fa-percentage"></i> Fee Percentage
          </label>
          <input
            type="number"
            name="percentage"
            step="0.01"
            min="0.01"
            max="100"
            required
            placeholder="e.g., 17.00"
            style="width:100%;padding:var(--space-3);background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);"
          >
          <small style="color:var(--sub);font-size:var(--fs-xs);display:block;margin-top:var(--space-1);">
            The percentage that Liberis charges on each sale (e.g., 17%)
          </small>
        </div>

        <!-- Start Date -->
        <div>
          <label style="display:block;margin-bottom:var(--space-2);font-weight:500;">
            <i class="fas fa-calendar-alt"></i> Start Date
          </label>
          <input
            type="date"
            name="start_date"
            required
            style="width:100%;padding:var(--space-3);background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);"
          >
          <small style="color:var(--sub);font-size:var(--fs-xs);display:block;margin-top:var(--space-1);">
            The date when the loan repayment started
          </small>
        </div>

        <!-- Total Amount -->
        <div>
          <label style="display:block;margin-bottom:var(--space-2);font-weight:500;">
            <i class="fas fa-dollar-sign"></i> Total Amount to Repay
          </label>
          <input
            type="number"
            name="total_amount"
            step="0.01"
            min="0.01"
            required
            placeholder="e.g., 5000.00"
            style="width:100%;padding:var(--space-3);background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);"
          >
          <small style="color:var(--sub);font-size:var(--fs-xs);display:block;margin-top:var(--space-1);">
            The total amount you need to repay to Liberis
          </small>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn" style="background:#10b981;color:#fff;padding:var(--space-3);">
          <i class="fas fa-check"></i> Create Loan
        </button>
      </div>
    </form>
  </div>
  {% endif %}

  <!-- Historical Loans -->
  {% if all_loans|length > 1 or (all_loans|length == 1 and not active_loan) %}
  <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:var(--space-5);">
    <h2 style="margin:0 0 var(--space-4) 0;font-size:var(--fs-lg);">
      <i class="fas fa-history"></i> Loan History
    </h2>

    <div style="display:flex;flex-direction:column;gap:var(--space-3);">
      {% for loan in all_loans %}
      {% if not loan.is_active or loan.id != active_loan.id %}
      <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:6px;padding:var(--space-3);">
        <div style="display:flex;justify-content:space-between;align-items:start;">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:var(--space-2);margin-bottom:var(--space-1);">
              <span style="font-weight:600;">{{ loan.percentage }}%</span>
              {% if loan.is_paid_off %}
              <span style="background:rgba(34,197,94,0.2);color:#22c55e;padding:2px 8px;border-radius:4px;font-size:var(--fs-xs);">
                <i class="fas fa-check"></i> Paid Off
              </span>
              {% else %}
              <span style="background:rgba(107,114,128,0.2);color:#9ca3af;padding:2px 8px;border-radius:4px;font-size:var(--fs-xs);">
                Inactive
              </span>
              {% endif %}
            </div>
            <div style="color:var(--sub);font-size:var(--fs-sm);">
              {{ loan.start_date.strftime('%b %d, %Y') }} -
              {% if loan.completed_at %}
                {{ loan.completed_at.strftime('%b %d, %Y') }}
              {% else %}
                Deactivated {{ loan.updated_at.strftime('%b %d, %Y') }}
              {% endif %}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:600;">${{ "%.2f"|format(loan.paid_amount) }}</div>
            <div style="color:var(--sub);font-size:var(--fs-sm);">of ${{ "%.2f"|format(loan.total_amount) }}</div>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Info Box -->
  <div style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:8px;padding:var(--space-4);margin-top:var(--space-5);">
    <h3 style="color:#60a5fa;margin:0 0 var(--space-2) 0;font-size:var(--fs-base);">
      <i class="fas fa-info-circle"></i> How it works
    </h3>
    <ul style="margin:0;padding-left:var(--space-5);color:var(--sub);font-size:var(--fs-sm);line-height:1.6;">
      <li>The Liberis fee is automatically deducted from your net profit in Analytics</li>
      <li>Only sales after the start date are affected by the fee</li>
      <li>The progress bar shows how much you've paid based on your sales</li>
      <li>When you reach 100%, the loan is automatically marked as paid off</li>
      <li>You can deactivate the loan anytime (e.g., if you paid it off early through other means)</li>
      <li>Use "Recalculate" if you imported historical sales and want to update the paid amount</li>
    </ul>
  </div>

  <!-- Back Link -->
  <div style="margin-top:var(--space-5);text-align:center;">
    <a href="{{ url_for('main.expenses_list') }}" style="color:var(--link);text-decoration:none;">
      <i class="fas fa-arrow-left"></i> Back to Expenses
    </a>
  </div>

</div>
{% endblock %}
