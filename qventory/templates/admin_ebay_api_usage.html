{% extends "base_admin.html" %}
{% block title %}eBay API Usage – Qventory{% endblock %}

{% block breadcrumb %}
<nav class="admin-breadcrumb">
  <a href="{{ url_for('main.admin_dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">eBay API Usage</span>
</nav>
{% endblock %}

{% block content %}
<div class="row">
  <div class="card" style="width:98%;margin:0 auto;">
    <div class="admin-header">
      <div>
        <h1><i class="fas fa-signal"></i> eBay API Usage</h1>
        <p style="color:var(--sub);">App-level and User-level rate limits</p>
      </div>
      <div class="admin-actions">
        <a href="{{ url_for('main.admin_dashboard') }}" class="btn">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </div>

    <hr class="divider">

    <div style="margin-bottom:var(--space-4);display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <a href="{{ url_for('main.admin_ebay_api_usage', view='import', api=api_filter) }}" class="btn" style="background:{% if view == 'import' %}#3b82f6{% else %}#374151{% endif %};color:#fff;">
        <i class="fas fa-filter"></i> Import Endpoints
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view='all', api=api_filter) }}" class="btn" style="background:{% if view == 'all' %}#3b82f6{% else %}#374151{% endif %};color:#fff;">
        <i class="fas fa-list"></i> All Endpoints
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api=api_filter) }}" class="btn" style="background:#10b981;color:#fff;">
        <i class="fas fa-sync-alt"></i> Refresh
      </a>
    </div>

    <div style="margin-bottom:var(--space-4);display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='all') }}" class="btn" style="background:{% if api_filter == 'all' %}#111827{% else %}#374151{% endif %};color:#fff;">
        All APIs
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='trading') }}" class="btn" style="background:{% if api_filter == 'trading' %}#111827{% else %}#374151{% endif %};color:#fff;">
        Trading
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='inventory') }}" class="btn" style="background:{% if api_filter == 'inventory' %}#111827{% else %}#374151{% endif %};color:#fff;">
        Inventory
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='fulfillment') }}" class="btn" style="background:{% if api_filter == 'fulfillment' %}#111827{% else %}#374151{% endif %};color:#fff;">
        Fulfillment
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='finances') }}" class="btn" style="background:{% if api_filter == 'finances' %}#111827{% else %}#374151{% endif %};color:#fff;">
        Finances
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='sell') }}" class="btn" style="background:{% if api_filter == 'sell' %}#111827{% else %}#374151{% endif %};color:#fff;">
        Sell
      </a>
      <a href="{{ url_for('main.admin_ebay_api_usage', view=view, api='buy') }}" class="btn" style="background:{% if api_filter == 'buy' %}#111827{% else %}#374151{% endif %};color:#fff;">
        Buy
      </a>
    </div>

    <div style="margin-bottom:var(--space-5);">
      <h2 style="margin-bottom:var(--space-3);">
        <i class="fas fa-server"></i> App-Level Usage
      </h2>
      {% if app_error %}
        <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:var(--space-3);color:#ef4444;">
          {{ app_error }}
        </div>
      {% elif app_rows %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>API Context</th>
                <th>API Name</th>
                <th>Resource</th>
                <th>Limit</th>
                <th>Remaining</th>
                <th>Used</th>
                <th>Usage</th>
                <th>Window</th>
              </tr>
            </thead>
            <tbody>
              {% for rl in app_rows %}
                {% set used, pct = compute_usage(rl) %}
                {% set warn = pct is not none and pct >= 80 %}
                <tr>
                  <td>{{ rl.api_context or '—' }}</td>
                  <td>{{ rl.api_name or '—' }}</td>
                  <td>{{ rl.resource_name or '—' }}</td>
                  <td style="text-align:center;">{{ rl.limit or '—' }}</td>
                  <td style="text-align:center;">{{ rl.remaining or '—' }}</td>
                  <td style="text-align:center;{% if warn %}color:#ef4444;font-weight:700;{% endif %}">{{ used if used is not none else '—' }}</td>
                  <td style="min-width:220px;">
                    <div class="usage-bar">
                      <div class="usage-fill" style="width:{{ pct if pct is not none else 0 }}%;{% if warn %}background:linear-gradient(90deg, rgba(239,68,68,0.9), rgba(245,158,11,0.9));{% endif %}"></div>
                    </div>
                    <div style="font-size:var(--fs-xs);color:var(--sub);">
                      {% if pct is not none %}
                        {{ pct }}%{% if warn %} • High{% endif %}
                      {% else %}
                        —
                      {% endif %}
                    </div>
                  </td>
                  <td>{{ rl.time_window or '—' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div style="text-align:center;padding:var(--space-5);color:var(--sub);">
          <i class="fas fa-inbox" style="font-size:48px;opacity:0.3;margin-bottom:var(--space-3);"></i>
          <p>No app-level usage data (eBay returned empty response).</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.usage-bar {
  height: 10px;
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--glass-border);
  border-radius: 999px;
  overflow: hidden;
}
.usage-fill {
  height: 100%;
  background: linear-gradient(90deg, rgba(16,185,129,0.9), rgba(59,130,246,0.9));
  transition: width 200ms ease;
}
</style>
{% endblock %}
