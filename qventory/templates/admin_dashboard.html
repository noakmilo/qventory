{% extends "base.html" %}
{% block title %}Admin Dashboard – Qventory{% endblock %}
{% block content %}
<div class="row">
  <div class="card" style="width:98%;margin:0 auto;">
    <div class="admin-header">
      <div>
        <h1>Admin Backoffice</h1>
        <p style="color:var(--sub);">Manage all users and their inventory</p>
      </div>
      <div class="admin-actions">
        <a href="{{ url_for('main.admin_create_user') }}" class="btn">
          <i class="fas fa-user-plus"></i> Create User
        </a>
        <a href="{{ url_for('main.admin_logout') }}" class="btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>

    <hr class="divider">

    <div class="admin-stats">
      <div class="stat-card">
        <div class="stat-value">{{ user_stats|length }}</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ user_stats|selectattr('has_inventory')|list|length }}</div>
        <div class="stat-label">With Inventory</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ user_stats|map(attribute='item_count')|sum }}</div>
        <div class="stat-label">Total Items</div>
      </div>
    </div>

    <h2 style="margin:var(--space-5) 0 var(--space-3) 0;">User List</h2>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Items</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for stat in user_stats %}
          <tr>
            <td><strong>{{ stat.user.username }}</strong></td>
            <td>{{ stat.user.email }}</td>
            <td>
              {% if stat.item_count > 0 %}
                <span class="tag">{{ stat.item_count }} items</span>
              {% else %}
                <span style="color:var(--sub);">—</span>
              {% endif %}
            </td>
            <td>
              {% if stat.has_inventory %}
                <span class="tag" style="background:rgba(74,222,128,0.15);border-color:rgba(74,222,128,0.3);color:#4ade80;">
                  <i class="fas fa-check-circle"></i> Active
                </span>
              {% else %}
                <span class="tag" style="background:rgba(156,163,175,0.15);border-color:rgba(156,163,175,0.3);color:#9ca3af;">
                  <i class="fas fa-circle"></i> Empty
                </span>
              {% endif %}
            </td>
            <td style="font-family:ui-monospace,'SF Mono',Consolas,monospace;font-size:var(--fs-xs);">
              {{ stat.user.created_at.strftime('%Y-%m-%d') if stat.user.created_at else '—' }}
            </td>
            <td>
              <div style="display:flex;gap:8px;align-items:center;">
                <a href="{{ url_for('main.dashboard') }}?user={{ stat.user.username }}" class="btn settingsbtn" title="View user items">
                  <i class="fas fa-eye"></i>
                </a>
                <form method="post" action="{{ url_for('main.admin_delete_user', user_id=stat.user.id) }}"
                      onsubmit="return confirm('Delete user \'{{ stat.user.username }}\' and all their data ({{ stat.item_count }} items)? This cannot be undone!')"
                      style="display:inline;">
                  <button type="submit" class="btn settingsbtn" title="Delete user">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if not user_stats %}
    <div style="text-align:center;padding:var(--space-5);color:var(--sub);">
      <i class="fas fa-users" style="font-size:48px;opacity:0.3;margin-bottom:var(--space-3);"></i>
      <p>No users found</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
