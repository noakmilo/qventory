{% extends "base.html" %}
{% block title %}Admin Dashboard – Qventory{% endblock %}
{% block content %}
<div class="row">
  <div class="card" style="width:98%;margin:0 auto;">
    <div class="admin-header">
      <div>
        <h1>Admin Backoffice</h1>
        <p style="color:var(--sub);">Manage all users and their inventory</p>
      </div>
      <div class="admin-actions">
        <a href="{{ url_for('main.admin_user_roles') }}" class="btn">
          <i class="fas fa-user-tag"></i> User Roles
        </a>
        <a href="{{ url_for('main.admin_plan_limits') }}" class="btn">
          <i class="fas fa-layer-group"></i> Plan Limits
        </a>
        <a href="{{ url_for('main.admin_token_config') }}" class="btn">
          <i class="fas fa-cog"></i> Token Config
        </a>
        <a href="{{ url_for('main.admin_create_user') }}" class="btn">
          <i class="fas fa-user-plus"></i> Create User
        </a>
        <a href="{{ url_for('main.admin_logout') }}" class="btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>

    <hr class="divider">

    <div class="admin-stats">
      <div class="stat-card">
        <div class="stat-value">{{ user_stats|length }}</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ user_stats|selectattr('has_inventory')|list|length }}</div>
        <div class="stat-label">With Inventory</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ user_stats|map(attribute='item_count')|sum }}</div>
        <div class="stat-label">Total Items</div>
      </div>
    </div>

    <h2 style="margin:var(--space-5) 0 var(--space-3) 0;">User List</h2>

    <!-- Search Bar -->
    <div style="margin-bottom:var(--space-4);">
      <div style="position:relative;max-width:500px;">
        <input
          type="text"
          id="userSearch"
          placeholder="Search by username or email..."
          style="width:100%;padding:12px 40px 12px 40px;border-radius:8px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.05);color:var(--text);font-size:var(--fs-sm);"
        >
        <i class="fas fa-search" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--sub);"></i>
        <button
          id="clearSearch"
          onclick="document.getElementById('userSearch').value='';filterUsers();"
          style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--sub);cursor:pointer;display:none;font-size:18px;padding:4px 8px;"
        >×</button>
      </div>
      <div id="searchStats" style="margin-top:8px;font-size:var(--fs-xs);color:var(--sub);"></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Items</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for stat in user_stats %}
          <tr>
            <td><strong>{{ stat.user.username }}</strong></td>
            <td>{{ stat.user.email }}</td>
            <td>
              {% if stat.item_count > 0 %}
                <span class="tag">{{ stat.item_count }} items</span>
              {% else %}
                <span style="color:var(--sub);">—</span>
              {% endif %}
            </td>
            <td>
              {% if stat.has_inventory %}
                <span class="tag" style="background:rgba(74,222,128,0.15);border-color:rgba(74,222,128,0.3);color:#4ade80;">
                  <i class="fas fa-check-circle"></i> Active
                </span>
              {% else %}
                <span class="tag" style="background:rgba(156,163,175,0.15);border-color:rgba(156,163,175,0.3);color:#9ca3af;">
                  <i class="fas fa-circle"></i> Empty
                </span>
              {% endif %}
            </td>
            <td style="font-size:var(--fs-xs);color:var(--sub);white-space:nowrap;">
              {% if stat.user.last_login %}
                <div style="display:flex;flex-direction:column;gap:2px;">
                  <span style="color:var(--text);">{{ stat.user.last_login.strftime('%Y-%m-%d') }}</span>
                  <span style="color:var(--sub);font-size:10px;">{{ stat.user.last_login.strftime('%H:%M:%S') }}</span>
                </div>
              {% else %}
                <span style="color:#9ca3af;font-style:italic;">Never</span>
              {% endif %}
            </td>
            <td style="font-family:ui-monospace,'SF Mono',Consolas,monospace;font-size:var(--fs-xs);">
              {{ stat.user.created_at.strftime('%Y-%m-%d') if stat.user.created_at else '—' }}
            </td>
            <td>
              <div style="display:flex;gap:8px;align-items:center;">
                <a href="{{ url_for('main.dashboard') }}?user={{ stat.user.username }}" class="btn settingsbtn" title="View user items">
                  <i class="fas fa-eye"></i>
                </a>
                <form method="post" action="{{ url_for('main.admin_delete_user', user_id=stat.user.id) }}"
                      onsubmit="return confirm('Delete user \'{{ stat.user.username }}\' and all their data ({{ stat.item_count }} items)? This cannot be undone!')"
                      style="display:inline;">
                  <button type="submit" class="btn settingsbtn" title="Delete user">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if not user_stats %}
    <div style="text-align:center;padding:var(--space-5);color:var(--sub);">
      <i class="fas fa-users" style="font-size:48px;opacity:0.3;margin-bottom:var(--space-3);"></i>
      <p>No users found</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
// Real-time user search
const searchInput = document.getElementById('userSearch');
const clearBtn = document.getElementById('clearSearch');
const searchStats = document.getElementById('searchStats');
const userRows = document.querySelectorAll('tbody tr');
const totalUsers = userRows.length;

function filterUsers() {
  const searchTerm = searchInput.value.toLowerCase().trim();
  let visibleCount = 0;

  userRows.forEach(row => {
    const username = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
    const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();

    const matches = username.includes(searchTerm) || email.includes(searchTerm);

    if (matches) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });

  // Show/hide clear button
  clearBtn.style.display = searchTerm ? 'block' : 'none';

  // Update stats
  if (searchTerm) {
    searchStats.textContent = `Showing ${visibleCount} of ${totalUsers} users`;
    if (visibleCount === 0) {
      searchStats.innerHTML = '<span style="color:#f87171;">No users found</span>';
    }
  } else {
    searchStats.textContent = '';
  }
}

// Filter on input
searchInput.addEventListener('input', filterUsers);

// Filter on Enter key
searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    filterUsers();
  }
});

// Focus search with Ctrl+K or Cmd+K
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    searchInput.focus();
    searchInput.select();
  }
});
</script>

<style>
#userSearch:focus {
  outline: none;
  border-color: #60a5fa;
  box-shadow: 0 0 0 3px rgba(96,165,250,0.1);
}

.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--space-3);
}

.admin-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.admin-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-4);
  margin-bottom: var(--space-5);
}

.stat-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: var(--space-4);
  text-align: center;
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  color: #60a5fa;
  line-height: 1;
  margin-bottom: var(--space-2);
  font-family: ui-monospace, 'SF Mono', Consolas, monospace;
}

.stat-label {
  font-size: var(--fs-sm);
  color: var(--sub);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}
</style>
{% endblock %}
