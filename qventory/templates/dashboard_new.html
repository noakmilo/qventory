{% extends "base_new.html" %}

{% block title %}Dashboard – Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <span class="breadcrumb-current">Dashboard</span>
</nav>
{% endblock %}

{% block content %}
<div data-username="{{ current_user.username }}" style="display:none"></div>

<div class="dashboard-container" style="max-width:1600px;margin:0 auto;">

  <!-- Dashboard Header -->
  <div style="margin-bottom:24px;">
    <h1 style="color:var(--text);font-size:28px;margin-bottom:8px;">
      <i class="fas fa-home"></i> Dashboard
    </h1>
    <p style="color:var(--text-secondary);font-size:14px;">
      Welcome back, {{ current_user.username }}! Here's your inventory overview.
    </p>
  </div>

  <!-- Filters Card -->
  <div id="filtersShell" class="card cardfilters filters-shell" style="margin-bottom:20px;">
    <div class="filters-bar">
      <h2>Filters</h2>
      <button id="filtersToggle" class="btn filters-toggle submitbtn" type="button" aria-expanded="true">
        <i class="fas fa-filter"></i> Toggle
      </button>
    </div>
    <div id="filtersContent" class="filters-content">
      <form id="filterForm" method="get" action="{{ url_for('main.dashboard') }}" class="filters-grid">
        <div style="grid-column:1/-1">
          <div class="input-with-button" style="position:relative">
            <input class="input" type="text" id="q" name="q" value="{{ q }}" placeholder="Search title / SKU / supplier…" autocomplete="off">
            <div id="dashboardAutocompleteList" class="autocomplete-list"></div>
            <button class="icon-btn" type="button" id="btnScanQR" title="Scan QR code with camera" aria-label="Scan QR code">
              <i class="fas fa-qrcode"></i>
            </button>
          </div>
        </div>

        {# Dynamic Filters #}
        {% if settings.enable_A %}
        <div>
          <label>{{ settings.label_A }}</label>
          <select name="A">
            <option value="">All</option>
            {% for opt in options.A %}
            <option value="{{ opt }}" {% if fA==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_B %}
        <div>
          <label>{{ settings.label_B }}</label>
          <select name="B">
            <option value="">All</option>
            {% for opt in options.B %}
            <option value="{{ opt }}" {% if fB==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_S %}
        <div>
          <label>{{ settings.label_S }}</label>
          <select name="S">
            <option value="">All</option>
            {% for opt in options.S %}
            <option value="{{ opt }}" {% if fS==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% if settings.enable_C %}
        <div>
          <label>{{ settings.label_C }}</label>
          <select name="C">
            <option value="">All</option>
            {% for opt in options.C %}
            <option value="{{ opt }}" {% if fC==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if PLATFORMS %}
        <div>
          <label>Platform</label>
          <select name="platform">
            <option value="">All</option>
            {% for key,label in PLATFORMS %}
            <option value="{{ key }}" {% if fPlatform==key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div style="grid-column:1/-1">
          <button class="btn submitbtn" type="submit">Apply</button>
          <a class="btn" href="{{ url_for('main.dashboard') }}">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Inventory Table Card -->
  <div class="card inventory-shell">
    <div class="items-header">
      <h2>Items ({{ total_items }})</h2>
      <div class="backup-actions">
        <!-- Bulk Actions -->
        <div id="bulkActionsContainer" style="display:none;margin-right:10px">
          <select id="bulkActionSelect" class="input" style="display:inline-block;width:auto;padding:0.5rem;margin-right:5px">
            <option value="">Bulk Actions</option>
            <option value="sync_to_ebay">Sync to eBay</option>
            <option value="delete">Delete Selected</option>
          </select>
          <button id="bulkActionApply" class="btn" style="padding:0.5rem 1rem">
            <i class="fas fa-check"></i> Apply
          </button>
          <span id="bulkSelectedCount" style="margin-left:10px;color:var(--sub);font-size:var(--fs-sm)"></span>
        </div>

        <a class="btn backup-btn" href="{{ url_for('main.export_csv') }}" title="Export all items to CSV">
          <i class="fas fa-download"></i> Export
        </a>
        <a class="btn backup-btn" href="{{ url_for('main.import_csv') }}" title="Import items from CSV">
          <i class="fas fa-upload"></i> Import
        </a>
        <a class="btn backup-btn" href="{{ url_for('main.import_ebay') }}" title="Import inventory from eBay">
          <i class="fab fa-ebay"></i> Import from eBay
        </a>
      </div>
    </div>

    <div class="table-wrap">
      {% set un = current_user.username %}
      <table>
        <thead>
          <tr>
            <th style="width:40px;text-align:center">
              <input type="checkbox" id="selectAllCheckbox" title="Select all items" style="cursor:pointer">
            </th>
            <th style="width:44px"></th>
            <th>Title</th>
            <th>SKU</th>
            <th class="mobile-hide">Supplier</th>
            <th class="mobile-hide">Cost</th>
            <th>Price</th>
            <th class="mobile-hide">ROI</th>
            <th>Location</th>
            <th class="mobile-hide">Listings</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsTableBody">
          {% for it in items %}
            {% include "_item_row.html" %}
          {% endfor %}
        </tbody>
      </table>

      <!-- Spinner for loading more items -->
      <div id="loadingSpinner" style="display:none;text-align:center;padding:20px;color:#888;">
        <i class="fas fa-spinner fa-spin"></i> Loading more items...
      </div>

      <!-- Scroll sentinel for infinite loading -->
      <div id="scrollSentinel" style="height:1px;"></div>
    </div>
  </div>
</div>

<!-- QR Modal for Locations -->
<div id="qrModal" class="qr-modal hidden" role="dialog" aria-hidden="true" aria-labelledby="qrTitle">
  <div class="qr-sheet">
    <div class="qr-header">
      <strong id="qrTitle"><i class="fas fa-qrcode"></i> QR</strong>
      <div class="qr-actions">
        <a id="qrOpenNew" class="qr-icon" href="#" target="_blank" title="Open in new tab" aria-label="Open in new tab">
          <i class="fas fa-external-link-alt"></i>
        </a>
        <button type="button" id="qrClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport">
        <img id="qrImage" alt="QR code">
      </div>
      <div id="qrCaption" class="qr-tip"></div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imgModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Image viewer">
  <div class="qr-sheet" style="max-width:90vw;width:auto">
    <div class="qr-header">
      <strong><i class="fas fa-image"></i> Image</strong>
      <div class="qr-actions">
        <button type="button" id="imgClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="img-viewport">
        <img id="imgModalImg" alt="">
      </div>
    </div>
  </div>
</div>

<!-- Profit Calculator Modal -->
<div id="profitCalcModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Profit Calculator">
  <div class="qr-sheet" style="max-width:560px;max-height:90vh;overflow-y:auto">
    <div class="qr-header">
      <strong><i class="fas fa-calculator"></i> Profit Calculator</strong>
      <div class="qr-actions">
        <button type="button" id="profitCalcClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body" style="padding:16px;align-items:stretch">
      <div id="profitModalContent" style="width:100%">
        <!-- Content injected by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- AI Research Modal -->
<div id="aiResearchModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="AI Market Research">
  <div class="qr-sheet" style="max-width:800px;max-height:90vh;overflow-y:auto">
    <div class="qr-header">
      <strong><i class="fas fa-robot"></i> AI Market Research</strong>
      <div class="qr-actions">
        <button type="button" id="aiResearchClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body" style="padding:16px;align-items:stretch">
      <div id="aiResearchModalContent" style="width:100%">
        <!-- Item Title with Autocomplete -->
        <label for="aiItemTitle" style="display:block;margin-top:0;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Item Title</label>
        <div style="position:relative;margin-bottom:1rem">
          <input
            type="text"
            id="aiItemTitle"
            placeholder="Enter or select an item title..."
            autocomplete="off"
            style="width:100%;padding:0.75rem;border-radius:8px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.05);color:var(--text);font-size:var(--fs-base);"
          >
          <div id="aiItemAutocompleteList" class="autocomplete-list"></div>
        </div>

        <!-- Prompt Textarea -->
        <label for="aiPrompt" style="display:block;font-size:var(--fs-sm);color:var(--sub);margin-bottom:0.3rem">Research Prompt (optional)</label>
        <textarea
          id="aiPrompt"
          rows="3"
          placeholder="e.g., Find the best selling price and market demand..."
          style="width:100%;padding:0.75rem;border-radius:8px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.05);color:var(--text);font-size:var(--fs-base);resize:vertical;margin-bottom:1rem;"
        ></textarea>

        <!-- Submit Button -->
        <button id="aiResearchSubmit" class="btn submitbtn" style="width:100%">
          <i class="fas fa-search"></i> Start Research
        </button>

        <!-- Results Area -->
        <div id="aiResearchResults" style="margin-top:1.5rem;display:none;">
          <hr style="border:none;border-top:1px solid var(--glass-border);margin:1.5rem 0;">
          <h3 style="color:var(--text);font-size:var(--fs-base);margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
            <i class="fas fa-lightbulb"></i> Research Results
          </h3>
          <div id="aiResearchContent" style="background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:8px;padding:1rem;color:var(--text);font-size:var(--fs-sm);line-height:1.6;white-space:pre-wrap;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
{% endblock %}
