{# templates/new_item.html #}
{% extends "base_new.html" %}
{% block title %}Add Item – Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">Add Item</span>
</nav>
{% endblock %}

{% block content %}
<div class="card">
  <h2><i class="fas fa-plus-circle"></i> Add Item</h2>

  <form method="post" class="form-sections" id="newItemForm">

    {# =========== SECCIÓN: Información Básica (siempre visible) =========== #}
    <div class="form-section">
      <div class="section-header">
        <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
      </div>
      <div class="section-content">
        <div class="grid cols-3">
          <div style="grid-column:1/-1">
            <label><i class="fas fa-heading"></i> Title</label>
            <input class="input" type="text" name="title" id="title" placeholder="Item title" required>
          </div>

          <div style="position:relative;">
            <label><i class="fas fa-store-alt"></i> Supplier</label>
            <input class="input" type="text" id="supplierInput" name="supplier" placeholder="Store or supplier name" autocomplete="off">
            <div id="supplierAutocompleteList" class="autocomplete-list"></div>
          </div>
          <div>
            <label><i class="fas fa-dollar-sign"></i> Item cost</label>
            <input class="input" type="number" name="item_cost" step="0.01" min="0" placeholder="0.00">
          </div>
          <div>
            <label><i class="fas fa-tags"></i> Item price</label>
            <input class="input" type="number" name="item_price" step="0.01" min="0" placeholder="0.00">
          </div>

          <div style="grid-column:1/-1">
            <label><i class="fas fa-calendar-day"></i> Listing date</label>
            <input class="input" type="date" name="listing_date">
          </div>
        </div>
      </div>
    </div>

    {# =========== SECCIÓN: Import desde URL (colapsable, opcional) =========== #}
    <div class="form-section collapsible" data-section="import">
      <div class="section-header" onclick="toggleSection('import')">
        <h3><i class="fas fa-download"></i> Import from URL</h3>
        <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
      </div>
      <div class="section-content">
        <div class="grid" style="grid-template-columns: 1fr auto; gap: 8px;">
          <div>
            <label><i class="fas fa-link"></i> eBay Item URL</label>
            <input class="input" type="url" id="import_url" placeholder="Paste eBay item URL (https://www.ebay.com/itm/...)">
          </div>
          <div style="display:flex; align-items:flex-end">
            <button class="btn submitbtn" id="btnFetch" type="button" title="Fetch title & fill fields">
              <i class="fas fa-cloud-download-alt"></i> GET
            </button>
          </div>
        </div>
        <div id="import_status" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

    {# =========== SECCIÓN: Photo Upload (colapsable, opcional) =========== #}
    <div class="form-section collapsible" data-section="photo">
      <div class="section-header" onclick="toggleSection('photo')">
        <h3><i class="far fa-image"></i> Item Photo</h3>
        <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
      </div>
      <div class="section-content">
        <div class="uploader-card">
          <div class="uploader-head">
            <div class="uploader-actions">
              <label for="fileLibrary" class="btn ghost">
                <i class="far fa-image"></i> Choose photo
              </label>
              <input id="fileLibrary" type="file" accept="image/*" class="hidden-input">
              <button type="button" class="btn submitbtn" id="btnUpload" disabled>
                <i class="fas fa-cloud-upload-alt"></i> Upload
              </button>
            </div>
          </div>

          <div class="uploader-body">
            <div class="thumb-wrap" id="thumbWrap">
              <div class="thumb-skeleton" id="thumbSkeleton">
                <i class="far fa-image"></i>
                <span>No image selected</span>
              </div>
              <img id="thumbPreview" alt="Preview" class="thumb-img hidden">
            </div>

            <div class="uploader-meta">
              <div class="rowy" style="display: none;">
                <label class="inline"><i class="fas fa-link"></i> CDN URL</label>
                <input class="input" type="url" name="item_thumb" id="item_thumb" placeholder="(auto-filled after upload)">
              </div>
              <div class="progress hidden" id="uploadProgress">
                <div class="bar" id="uploadBar" style="width:0%"></div>
              </div>
              <div class="muted" id="uploadStatus"></div>
            </div>
          </div>

          <div class="uploader-foot">
            <small>
              We compress on device (~100 KB) before uploading to avoid 413 errors.
              Formats: JPG/PNG/HEIC/HEIF/WebP (iOS/Android supported).
            </small>
          </div>
        </div>
      </div>
    </div>

    {# =========== SECCIÓN: Marketplace Links (colapsable, opcional) =========== #}
    <div class="form-section collapsible" data-section="marketplace">
      <div class="section-header" onclick="toggleSection('marketplace')">
        <h3><i class="fas fa-store"></i> Marketplace Links</h3>
        <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
      </div>
      <div class="section-content">
        <div class="grid cols-3">
          <div style="grid-column:1/-1">
            <label><i class="fas fa-link"></i> Main Listing Link</label>
            <input class="input" type="url" name="listing_link" placeholder="https://...">
          </div>

          <div>
            <label><i class="fas fa-globe"></i> Website</label>
            <input class="input" type="url" name="web_url" placeholder="https://yourstore.com/...">
          </div>
          <div>
            <label><i class="fab fa-ebay"></i> eBay</label>
            <input class="input" type="url" name="ebay_url" id="ebay_url" placeholder="https://www.ebay.com/itm/...">
          </div>
          <div>
            <label><i class="fab fa-amazon"></i> Amazon</label>
            <input class="input" type="url" name="amazon_url" placeholder="https://www.amazon.com/dp/...">
          </div>
          <div>
            <label><i class="fas fa-store"></i> Mercari</label>
            <input class="input" type="url" name="mercari_url" placeholder="https://www.mercari.com/us/item/...">
          </div>
          <div>
            <label><i class="fas fa-tshirt"></i> Vinted</label>
            <input class="input" type="url" name="vinted_url" placeholder="https://www.vinted.com/items/...">
          </div>
          <div>
            <label><i class="fas fa-shopping-bag"></i> Poshmark</label>
            <input class="input" type="url" name="poshmark_url" placeholder="https://posh.mk/...">
          </div>
          <div>
            <label><i class="fas fa-shopping-cart"></i> Depop</label>
            <input class="input" type="url" name="depop_url" placeholder="https://www.depop.com/products/...">
          </div>
        </div>
      </div>
    </div>

    {# =========== SECCIÓN: Location (siempre visible - importante) =========== #}
    <div class="form-section">
      <div class="section-header">
        <h3><i class="fas fa-map-marker-alt"></i> Location</h3>
        <button type="button" id="btnScanLocation" class="btn small" title="Scan location QR code">
          <i class="fas fa-qrcode"></i> Scan QR
        </button>
      </div>
      <div class="section-content">
        <div class="grid cols-3">
          {% if settings.enable_A %}
          <div>
            <label><i class="fas fa-tag"></i> {{ settings.label_A }} (A)</label>
            <input class="input" type="text" name="A" id="input_A" placeholder="e.g., 1">
          </div>
          {% endif %}
          {% if settings.enable_B %}
          <div>
            <label><i class="fas fa-tag"></i> {{ settings.label_B }} (B)</label>
            <input class="input" type="text" name="B" id="input_B" placeholder="e.g., 1">
          </div>
          {% endif %}
          {% if settings.enable_S %}
          <div>
            <label><i class="fas fa-tag"></i> {{ settings.label_S }} (S)</label>
            <input class="input" type="text" name="S" id="input_S" placeholder="e.g., 1">
          </div>
          {% endif %}
          {% if settings.enable_C %}
          <div>
            <label><i class="fas fa-tag"></i> {{ settings.label_C }} (C)</label>
            <input class="input" type="text" name="C" id="input_C" placeholder="e.g., 1">
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# =========== BOTONES DE ACCIÓN =========== #}
    <div class="form-actions">
      <button class="btn submitbtn" type="submit" name="submit_action" value="create">
        <i class="fas fa-save"></i> Create Item
      </button>
      <button class="btn submitbtn" type="submit" name="submit_action" value="create_another" title="Save and keep this page ready for a new item">
        <i class="fas fa-plus-circle"></i> Save & Add Another
      </button>
      <a class="btn" href="{{ url_for('main.dashboard') }}">
        <i class="fas fa-times"></i> Cancel
      </a>
    </div>
  </form>
</div>

{# ===== Modal del QR Scanner ===== #}
<div id="qrModal" class="scan-modal hidden" aria-hidden="true" aria-label="QR code scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong><i class="fas fa-qrcode"></i> Scan location QR code</strong>
      <div class="scan-actions">
        <button type="button" id="qrFlashlight" class="icon-top" aria-label="Toggle flashlight" title="Toggle flashlight">
          <i class="fas fa-lightbulb"></i>
        </button>
        <button type="button" id="qrFlip" class="icon-top" aria-label="Flip camera" title="Flip camera">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button type="button" id="qrClose" class="icon-top" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="scan-body">
      <div class="viewport">
        <video id="qrVideo" playsinline autoplay muted></video>
        <div class="guide"></div>
        <div id="qrTarget" class="scan-target"></div>
        <div id="qrSpinner" class="spinner"></div>
        <div id="qrSuccess" class="success-indicator">
          <i class="fas fa-check"></i>
        </div>
      </div>
      <div class="scan-tip">Align the QR code inside the frame</div>
      <div id="qrResult" class="scan-result"></div>
    </div>
  </div>
</div>

<style>
  /* ===== Form Sections System ===== */
  .form-sections{ display:flex; flex-direction:column; gap:var(--space-4) }

  .form-section{
    border-radius:var(--radius);
    border:1px solid var(--glass-border);
    background:var(--glass-bg);
    overflow:hidden;
  }

  .section-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:var(--space-3);
    background:rgba(26,36,70,.3);
    border-bottom:1px solid var(--glass-border);
    gap:var(--space-2);
  }

  .collapsible .section-header{
    cursor:pointer;
    transition:background .2s ease;
    user-select:none;
  }

  .collapsible .section-header:hover{
    background:rgba(26,36,70,.5);
  }

  .section-header h3{
    margin:0;
    font-size:var(--fs-base);
    font-weight:600;
    display:flex;
    align-items:center;
    gap:8px;
    color:var(--text);
  }

  .toggle-icon{
    display:flex;
    align-items:center;
    justify-content:center;
    width:24px;
    height:24px;
    border-radius:6px;
    background:var(--glass-bg-strong);
    transition:transform .2s ease;
  }

  .collapsible.collapsed .toggle-icon{
    transform:rotate(-90deg);
  }

  .section-content{
    padding:var(--space-3);
    transition:all .3s ease;
  }

  .collapsible.collapsed .section-content{
    display:none;
  }

  .form-actions{
    display:flex;
    gap:var(--space-2);
    flex-wrap:wrap;
    padding-top:var(--space-2);
  }

  /* Mobile adjustments */
  @media (max-width:720px){
    .form-actions{
      flex-direction:column;
    }
    .form-actions .btn{
      width:100%;
    }
  }

  .muted{ font-size:12px; opacity:.8; min-height:1.2em }
  .h3{ margin:0 0 8px 0; font-size:16px; display:flex; align-items:center; gap:8px }
  .sep{ border-color:var(--border); opacity:.3; margin:8px 0 }
  .btn.small{ padding:4px 8px; font-size:12px }

  /* Uploader card */
  .uploader-card{
    border:1px dashed var(--border);
    border-radius:12px;
    padding:12px;
    background: var(--panel);
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .uploader-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .uploader-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .btn.ghost{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
  }
  .btn.ghost:hover{ background:rgba(255,255,255,0.04) }

  .hidden-input{ display:none }

  .uploader-body{
    display:grid;
    grid-template-columns: 120px 1fr;
    gap:12px;
  }
  @media (max-width: 720px){
    .uploader-body{ grid-template-columns: 120px 1fr }
  }

  .thumb-wrap{
    position:relative;
    width:120px;
    height:120px;
    border-radius:12px;
    overflow:hidden;
    background:#0c0e12;
    border:1px solid rgba(255,255,255,.08);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .thumb-skeleton{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:8px;
    color:#8892a6;
    font-size:11px;
    width:100%;
    height:100%;
  }
  .thumb-skeleton i{ font-size:48px; opacity:.6 }
  .thumb-img{ width:100%; height:100%; object-fit:cover; display:block }
  .hidden{ display:none !important }

  .uploader-meta .rowy{ display:flex; gap:8px; align-items:center }
  .uploader-meta .rowy .inline{ min-width:80px }

  .progress{ width:100%; height:8px; background:#1a1d23; border-radius:6px; overflow:hidden; border:1px solid #333; }
  .progress .bar{ height:100%; width:0%; background:linear-gradient(90deg, #60a5fa, #22c55e); transition:width .25s ease }

  /* Modal / scanner (iguales a tus estilos previos) */
  body.modal-open{ overflow:hidden; touch-action:none; }
  .scan-modal.hidden{ display:none; }
  .scan-modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:grid; place-items:center; z-index:9999; padding:16px; }
  .scan-sheet{ width:min(420px, 92vw); background:#0f1115; color:#fff; border-radius:14px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.5); border:1px solid #222; }
  .scan-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#141821; border-bottom:1px solid #222; }
  .scan-actions .icon-top{ border:none; background:transparent; color:#fff; font-size:18px; margin-left:6px; opacity:.85; cursor:pointer; display:flex; align-items:center; justify-content:center; width:30px; height:30px; }
  .scan-actions .icon-top:hover{ opacity:1; }
  .scan-actions .icon-top.active{ opacity:1; color:#ffd700; }
  .scan-body{ padding:12px; display:flex; flex-direction:column; gap:10px; }
  .viewport{ position:relative; width:100%; aspect-ratio: 3 / 4; max-height: 60vh; border-radius:12px; overflow:hidden; background:#000; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
  #qrVideo, .scan-target{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:none; }
  .guide{ position:absolute; inset:10%; border:2px dashed rgba(255,255,255,.6); border-radius:10px; pointer-events:none; animation: pulse-guide 2s infinite; }
  @keyframes pulse-guide { 0%,100%{opacity:.6} 50%{opacity:1} }
  .success-indicator { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:48px; color:#00ff00; display:none; text-shadow:0 0 20px rgba(0,255,0,0.8); animation: success-flash .5s ease-out; }
  @keyframes success-flash { 0%{transform:translate(-50%,-50%) scale(.5);opacity:0} 50%{transform:translate(-50%,-50%) scale(1.2);opacity:1} 100%{transform:translate(-50%,-50%) scale(1);opacity:1} }
  .scan-tip{ text-align:center; font-size:12px; opacity:.8; }
  .scan-result{ background:#1a1d23; border:1px solid #333; border-radius:8px; padding:8px 12px; font-family:monospace; font-size:12px; color:#0ff; min-height:20px; display:none; }
  .spinner{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); }
  .spinner::after{ content:""; width:28px; height:28px; border-radius:50%; border:3px solid rgba(255,255,255,.3); border-top-color:#fff; animation:spin .9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
/* ========== Cookie Helper Functions ========== */
function setCookie(name, value, days = 365) {
  const d = new Date();
  d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
  document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
}

function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for(let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

/* ========== Toggle Section System ========== */
function toggleSection(sectionName) {
  const section = document.querySelector(`[data-section="${sectionName}"]`);
  if (!section) return;

  const isCollapsed = section.classList.toggle('collapsed');

  // Save preference to cookie
  const preferences = JSON.parse(getCookie('qv_section_prefs') || '{}');
  preferences[sectionName] = isCollapsed ? 'collapsed' : 'expanded';
  setCookie('qv_section_prefs', JSON.stringify(preferences));
}

/* ========== Initialize Section States from Cookies ========== */
document.addEventListener('DOMContentLoaded', () => {
  const preferences = JSON.parse(getCookie('qv_section_prefs') || '{}');

  // Default collapsed sections (optional sections collapsed by default)
  const defaultCollapsed = ['import', 'marketplace'];

  Object.keys(preferences).forEach(sectionName => {
    const section = document.querySelector(`[data-section="${sectionName}"]`);
    if (section && preferences[sectionName] === 'collapsed') {
      section.classList.add('collapsed');
    } else if (section && preferences[sectionName] === 'expanded') {
      section.classList.remove('collapsed');
    }
  });

  // Apply defaults for sections without saved preferences
  defaultCollapsed.forEach(sectionName => {
    const section = document.querySelector(`[data-section="${sectionName}"]`);
    if (section && !preferences.hasOwnProperty(sectionName)) {
      section.classList.add('collapsed');
    }
  });
});

/* ========== GET desde eBay ========== */
document.addEventListener('DOMContentLoaded', () => {
  const btn   = document.getElementById('btnFetch');
  const urlI  = document.getElementById('import_url');
  const titleI= document.getElementById('title');
  const ebayI = document.getElementById('ebay_url');
  const status= document.getElementById('import_status');

  if (!btn) return;

  btn.addEventListener('click', async () => {
    const url = (urlI?.value || '').trim();
    if (!url) {
      status.textContent = 'Pega primero una URL de eBay (/itm/...)';
      status.style.color = '#eab308';
      urlI?.focus();
      return;
    }

    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting…';
    status.textContent = 'Consultando eBay…';
    status.style.color = '#aaa';

    try {
      const resp = await fetch(`/api/fetch-market-title?url=${encodeURIComponent(url)}`, { credentials: 'same-origin' });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        const msg = (data && (data.error || data.message)) || `HTTP ${resp.status}`;
        throw new Error(msg);
      }

      if (titleI && data.fill?.title)  titleI.value = data.fill.title;
      if (ebayI  && data.fill?.ebay_url) ebayI.value = data.fill.ebay_url;

      status.textContent = '✓ Título importado correctamente';
      status.style.color = '#22c55e';
      btn.innerHTML = '<i class="fas fa-check"></i> Listo';
      setTimeout(() => { btn.innerHTML = original; }, 1200);
    } catch (err) {
      console.error(err);
      status.textContent = `No se pudo obtener el título: ${err.message}`;
      status.style.color = '#ef4444';
      btn.innerHTML = original;
    } finally {
      btn.disabled = false;
    }
  });
});
</script>

<script>
/* ========== Subida a Cloudinary con compresión (~100KB) ========== */
(function(){
  const inputLib   = document.getElementById('fileLibrary');
  const btnUpload  = document.getElementById('btnUpload');
  const thumbPrev  = document.getElementById('thumbPreview');
  const thumbWrap  = document.getElementById('thumbWrap');
  const skeleton   = document.getElementById('thumbSkeleton');
  const outUrl     = document.getElementById('item_thumb');
  const barWrap    = document.getElementById('uploadProgress');
  const bar        = document.getElementById('uploadBar');
  const status     = document.getElementById('uploadStatus');

  let selectedFile = null;

  inputLib?.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    selectedFile = f;
    status.textContent = '';
    barWrap.classList.add('hidden');
    bar.style.width = '0%';

    try{
      const img = await loadImageFromFile(f); // con orientación EXIF
      const { blob, dataUrl } = await compressImage(img, 100 * 1024, 1920, 1920);
      // Vista previa
      skeleton.classList.add('hidden');
      thumbPrev.src = dataUrl;
      thumbPrev.classList.remove('hidden');
      btnUpload.disabled = false;
      // Guardamos blob comprimido para upload
      selectedFile = new File([blob], (f.name || 'photo.jpeg').replace(/\.(heic|heif)$/i,'.jpg'), { type: 'image/jpeg' });
    }catch(err){
      console.error(err);
      status.textContent = `Cannot preview: ${err.message}`;
      status.style.color = '#ef4444';
      btnUpload.disabled = true;
    }
  });

  btnUpload?.addEventListener('click', async ()=>{
    if (!selectedFile){
      status.textContent = 'Choose a photo first.';
      status.style.color = '#eab308';
      return;
    }
    btnUpload.disabled = true;
    status.textContent = 'Uploading…';
    status.style.color = '#aaa';
    barWrap.classList.remove('hidden');
    bar.style.width = '5%';

    try{
      const fd = new FormData();
      fd.append('file', selectedFile, selectedFile.name);

      const resp = await fetch('{{ url_for("main.api_upload_image") }}', {
        method: 'POST',
        body: fd,
        credentials: 'same-origin'
      });

      const total = Number(resp.headers.get('Content-Length')||0);
      // Nota: fetch estándar no da progreso; simulamos suave
      let prog = 10;
      const sim = setInterval(()=>{ prog = Math.min(95, prog+5); bar.style.width = prog+'%'; }, 120);

      const data = await resp.json().catch(()=> ({}));
      clearInterval(sim);

      if (!resp.ok || !data.ok) {
        const msg = (data && (data.error||data.message)) || `HTTP ${resp.status}`;
        throw new Error(msg);
      }

      bar.style.width = '100%';
      status.textContent = '✓ Uploaded';
      status.style.color = '#22c55e';
      outUrl.value = data.url || '';
    }catch(err){
      console.error(err);
      status.textContent = `Upload failed: ${err.message}`;
      status.style.color = '#ef4444';
    }finally{
      btnUpload.disabled = false;
    }
  });

  // ----- helpers -----
  // Respeta orientación EXIF cuando es posible
  function loadImageFromFile(file){
    return new Promise(async (resolve, reject) => {
      if ('createImageBitmap' in window) {
        try {
          const bmp = await createImageBitmap(file, { imageOrientation: 'from-image' });
          const canvas = document.createElement('canvas');
          canvas.width = bmp.width; canvas.height = bmp.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(bmp, 0, 0);
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('Unable to decode image'));
          img.src = canvas.toDataURL('image/jpeg', 0.9);
          return;
        } catch(e){ /* fallback */ }
      }
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('Unable to decode image'));
      try { img.src = URL.createObjectURL(file); } catch(e){ reject(e); }
    });
  }

  function compressImage(img, targetBytes=100*1024, maxW=1920, maxH=1920){
    return new Promise((resolve)=>{
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      w = Math.round(w * ratio); h = Math.round(h * ratio);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      let q = 0.9, step = 0.08, dataUrl, binStrLen=Infinity;
      for (let i=0;i<8;i++){
        dataUrl = canvas.toDataURL('image/jpeg', q);
        // estimación bytes = (longitud base64)*3/4
        binStrLen = Math.floor((dataUrl.length - dataUrl.indexOf(',') - 1) * 0.75);
        if (binStrLen <= targetBytes || q <= 0.4) break;
        q -= step; step *= 0.75;
      }
      canvas.toBlob((blob)=>{
        resolve({ blob, dataUrl });
      }, 'image/jpeg', Math.max(q,0.4));
    });
  }
})();
</script>

<script>
/* ========== QR Scanner (BarcodeDetector → jsQR fallback) ========== */
(function(){
  const btnScan = document.getElementById('btnScanLocation');
  const modal = document.getElementById('qrModal');
  const btnClose = document.getElementById('qrClose');
  const btnFlip = document.getElementById('qrFlip');
  const btnFlash = document.getElementById('qrFlashlight');
  const video = document.getElementById('qrVideo');
  const target = document.getElementById('qrTarget');
  const spinner = document.getElementById('qrSpinner');
  const success = document.getElementById('qrSuccess');
  const result = document.getElementById('qrResult');

  const CAM_CACHE_KEY = 'qv_qr_cam_device_id';
  let stream=null, rafId=null, detector=null;
  let usingBD=false, usingJsQR=false, jsQRLoaded=false;
  let videoDevices=[], currentDeviceIdx=-1, devicesLoaded=false;
  let flashlightOn=false, lastDetections=[];

  function openModal(){ document.body.classList.add('modal-open'); modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ document.body.classList.remove('modal-open'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }
  function cleanupLoop(){ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } }
  function cleanupAll(){
    cleanupLoop();
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    flashlightOn=false; btnFlash.classList.remove('active');
    video.srcObject=null; video.style.display='none'; target.style.display='none';
    result.style.display='none'; success.style.display='none';
    usingBD=false; usingJsQR=false; lastDetections.length=0;
  }
  function showError(err, where=''){ console.error('[QR]', where, err); alert((err?.name||'Error') + (err?.message?': '+err.message:'')); }

  async function loadVideoDevices(){
    if (devicesLoaded) return;
    const devs = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devs.filter(d=>d.kind==='videoinput');
    const prefers=['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      return (prefers.some(p=>lb.includes(p))?1:0) - (prefers.some(p=>la.includes(p))?1:0);
    });
    devicesLoaded=true;
  }

  async function startWithDevice(deviceId){
    cleanupLoop(); showSpinner(true);
    const constraints = {
      video: deviceId ? { deviceId:{exact:deviceId}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30}, facingMode:'environment' }
                      : { facingMode:{ideal:'environment'}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30} },
      audio:false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
    video.srcObject = stream;
    await video.play();
    showSpinner(false);
    rememberActiveDevice();
  }

  function rememberActiveDevice(){
    try{
      const track=stream?.getVideoTracks?.()[0];
      const settings=track?.getSettings?.()||{};
      const id=settings.deviceId || track?.getConstraints?.().deviceId?.exact;
      if (id){ localStorage.setItem(CAM_CACHE_KEY, id); }
    }catch{}
  }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
    await startWithDevice(videoDevices[currentDeviceIdx].deviceId);
    if (usingBD) startBDLoop();
    if (usingJsQR) startJsQRLoop();
  }

  async function toggleFlashlight(){
    if (!stream) return;
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.()||{};
      if (!caps.torch) return alert('Flashlight not supported on this camera');
      flashlightOn = !flashlightOn;
      await track.applyConstraints({ advanced:[{ torch: flashlightOn }] });
      btnFlash.classList.toggle('active', flashlightOn);
    }catch(e){ console.warn(e); alert('Unable to control flashlight'); }
  }

  function validateDetection(val){
    if (!val || val.length<3) return false;
    lastDetections.push(val);
    if (lastDetections.length>3) lastDetections.shift();
    return lastDetections[lastDetections.length-1];
  }

  function parseLocationQR(qrText){
    try{
      let part = qrText.includes('/location/') ? qrText.split('/location/')[1] : qrText;
      if (!part) return null;
      const m = part.match(/^(?:.*?)(A(\d+))?(B(\d+))?(S(\d+))?(C(\d+))?/i);
      if (!m) return null;
      return { A:m[2]||null, B:m[4]||null, S:m[6]||null, C:m[8]||null, original:part };
    }catch(e){ console.error('parseLocationQR',e); return null; }
  }

  function populateLocationFields(loc){
    const ids=['A','B','S','C']; const done=[];
    ids.forEach(k=>{
      const el=document.getElementById(`input_${k}`);
      if (el && loc[k]){ el.value=loc[k]; done.push(`${k}=${loc[k]}`); el.style.background='#e8f5e8'; setTimeout(()=>el.style.background='',1500); }
    });
    return done;
  }

  function onDetected(raw){
    const v = validateDetection(raw);
    if (!v) return;
    const loc = parseLocationQR(v);
    if (loc){
      result.textContent = `Location: ${loc.original}`;
      result.style.display='block';
      success.style.display='block'; setTimeout(()=>success.style.display='none',500);
      try{ navigator.vibrate && navigator.vibrate([80,40,80]); }catch(_){}
      setTimeout(()=>{
        const filled = populateLocationFields(loc);
        cleanupAll(); closeModal();
      }, 600);
    } else {
      result.textContent = `QR: ${String(v).slice(0,80)}…`;
      result.style.display='block';
    }
  }

  async function startBarcodeDetector(){
    let supported=[];
    try{ supported = await window.BarcodeDetector.getSupportedFormats(); }catch{}
    if (!supported.includes('qr_code')) return false;
    detector = new window.BarcodeDetector({ formats:['qr_code'] });
    usingBD=true; usingJsQR=false;
    video.style.display='block'; target.style.display='none';
    startBDLoop();
    return true;
  }

  function startBDLoop(){
    cleanupLoop();
    let frame=0;
    const tick = async ()=>{
      try{
        frame++;
        if (frame%3===0 && detector){
          const codes = await detector.detect(video);
          if (codes?.length){
            const qr = codes.find(c=>c.format==='qr_code') || codes[0];
            const val = (qr.rawValue||'').trim();
            if (val){ onDetected(val); return; }
          }
        }
      }catch(_){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function loadJsQR(){
    if (jsQRLoaded) return Promise.resolve();
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async=true;
      s.onload=()=>{ jsQRLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error('Failed to load jsQR'));
      document.head.appendChild(s);
    });
  }

  function startJsQRLoop(){
    usingBD=false; usingJsQR=true;
    video.style.display='block'; target.style.display='none';
    cleanupLoop();

    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d',{ willReadFrequently:true });
    const ROI_INSET=0.10;

    let lastTS=0; const MIN_INTERVAL=80;
    const tick=(now)=>{
      try{
        if (!usingJsQR) return;
        if (now-lastTS>=MIN_INTERVAL && video.videoWidth>0){
          lastTS=now;
          const vw=video.videoWidth, vh=video.videoHeight;
          const rx=Math.floor(vw*ROI_INSET), ry=Math.floor(vh*ROI_INSET);
          const rw=Math.floor(vw*(1-2*ROI_INSET)), rh=Math.floor(vh*(1-2*ROI_INSET));
          canvas.width=rw; canvas.height=rh;
          ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);
          const img=ctx.getImageData(0,0,rw,rh);
          const qr=window.jsQR && window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
          const val=(qr?.data||'').trim();
          if (val){ onDetected(val); return; }
        }
      }catch(_){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startScan(){
    openModal(); result.style.display='none'; success.style.display='none';
    try{
      const cached = localStorage.getItem(CAM_CACHE_KEY);
      if (cached){ await startWithDevice(cached); }
      else {
        await loadVideoDevices();
        if (videoDevices.length) currentDeviceIdx=0;
        await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);
      }

      if ('BarcodeDetector' in window){
        const ok = await startBarcodeDetector();
        if (ok) return;
      }
      await loadJsQR();
      startJsQRLoop();
    }catch(e){
      showError(e,'startScan');
      cleanupAll(); closeModal();
    }
  }

  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnFlash?.addEventListener('click', toggleFlashlight);
  btnClose?.addEventListener('click', ()=>{ cleanupAll(); closeModal(); });
  modal?.addEventListener('click', (e)=>{ if (e.target===modal){ cleanupAll(); closeModal(); }});
})();
</script>

<style>
/* Autocomplete dropdown styling */
.autocomplete-list {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-top: 4px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  display: none;
}

.autocomplete-list.show {
  display: block;
}

.autocomplete-item {
  padding: 10px 12px;
  cursor: pointer;
  color: var(--text);
  transition: background 0.15s ease;
  border-bottom: 1px solid var(--border);
}

.autocomplete-item:last-child {
  border-bottom: none;
}

.autocomplete-item:hover,
.autocomplete-item.active {
  background: rgba(96, 165, 250, 0.15);
}

.autocomplete-item .match {
  font-weight: 600;
  color: #60a5fa;
}
</style>

<script>
/* ========== Supplier Autocomplete ========== */
document.addEventListener('DOMContentLoaded', () => {
  const supplierInput = document.getElementById('supplierInput');
  const autocompleteList = document.getElementById('supplierAutocompleteList');

  if (!supplierInput || !autocompleteList) return;

  let activeIndex = -1;
  let debounceTimer = null;

  supplierInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();

    // Clear previous timer
    clearTimeout(debounceTimer);

    // Hide list if query is too short
    if (query.length < 1) {
      autocompleteList.classList.remove('show');
      autocompleteList.innerHTML = '';
      return;
    }

    // Debounce API call (300ms)
    debounceTimer = setTimeout(async () => {
      try {
        const response = await fetch(`/api/suppliers/search?q=${encodeURIComponent(query)}`);
        const suppliers = await response.json();

        if (!suppliers || suppliers.length === 0) {
          autocompleteList.classList.remove('show');
          autocompleteList.innerHTML = '';
          return;
        }

        // Build autocomplete list
        autocompleteList.innerHTML = '';
        suppliers.forEach((supplier, index) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.innerHTML = highlightMatch(supplier, query);
          div.dataset.value = supplier;
          div.dataset.index = index;

          div.addEventListener('click', () => {
            supplierInput.value = supplier;
            autocompleteList.classList.remove('show');
            autocompleteList.innerHTML = '';
          });

          autocompleteList.appendChild(div);
        });

        autocompleteList.classList.add('show');
        activeIndex = -1;
      } catch (error) {
        console.error('Supplier autocomplete error:', error);
      }
    }, 300);
  });

  // Keyboard navigation
  supplierInput.addEventListener('keydown', (e) => {
    const items = autocompleteList.querySelectorAll('.autocomplete-item');

    if (!items.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = (activeIndex + 1) % items.length;
      updateActiveItem(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = activeIndex <= 0 ? items.length - 1 : activeIndex - 1;
      updateActiveItem(items);
    } else if (e.key === 'Enter' && activeIndex >= 0) {
      e.preventDefault();
      items[activeIndex].click();
    } else if (e.key === 'Escape') {
      autocompleteList.classList.remove('show');
      autocompleteList.innerHTML = '';
      activeIndex = -1;
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!supplierInput.contains(e.target) && !autocompleteList.contains(e.target)) {
      autocompleteList.classList.remove('show');
      autocompleteList.innerHTML = '';
      activeIndex = -1;
    }
  });

  function updateActiveItem(items) {
    items.forEach((item, index) => {
      if (index === activeIndex) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  }

  function highlightMatch(text, query) {
    if (!text || !query) return text || '';
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<span class="match">$1</span>');
  }

  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
});
</script>

{% endblock %}
