{# templates/new_item.html #}
{% extends "base.html" %}
{% block title %}Add Item – Qventory{% endblock %}
{% block content %}
<div class="card">
  <h2><i class="fas fa-plus-circle"></i> Add Item</h2>

  {# --------- Bloque de Import desde URL + GET --------- #}
  <div class="grid" style="grid-template-columns: 1fr auto; gap: 8px; margin-bottom:12px">
    <div>
      <label><i class="fas fa-download"></i> Import from URL (eBay supported)</label>
      <input class="input" type="url" id="import_url" placeholder="Paste eBay item URL (https://www.ebay.com/itm/...)">
    </div>
    <div style="display:flex; align-items:flex-end">
      <button class="btn submitbtn" id="btnFetch" type="button" title="Fetch title & fill fields">
        <i class="fas fa-cloud-download-alt"></i> GET
      </button>
    </div>
  </div>
  <div id="import_status" style="font-size:12px; opacity:.8; min-height:1.2em"></div>

  <form method="post" class="grid cols-3" id="newItemForm">
    <div style="grid-column:1/-1">
      <label><i class="fas fa-heading"></i> Title</label>
      <input class="input" type="text" name="title" id="title" placeholder="Item title" required>
    </div>

    <div style="grid-column:1/-1">
      <label><i class="fas fa-link"></i> Listing Link (optional)</label>
      <input class="input" type="url" name="listing_link" placeholder="https://...">
    </div>

    <div style="grid-column:1/-1">
      <hr style="border-color:var(--border);opacity:.3;margin:8px 0">
    </div>

    <div style="grid-column:1/-1">
      <h3 style="margin:0 0 8px 0;font-size:16px"><i class="fas fa-store"></i> Marketplace Links (optional)</h3>
    </div>

    <div>
      <label><i class="fas fa-globe"></i> Website</label>
      <input class="input" type="url" name="web_url" placeholder="https://yourstore.com/...">
    </div>
    <div>
      <label><i class="fab fa-ebay"></i> eBay</label>
      <input class="input" type="url" name="ebay_url" id="ebay_url" placeholder="https://www.ebay.com/itm/...">
    </div>
    <div>
      <label><i class="fab fa-amazon"></i> Amazon</label>
      <input class="input" type="url" name="amazon_url" placeholder="https://www.amazon.com/dp/...">
    </div>
    <div>
      <label><i class="fas fa-store"></i> Mercari</label>
      <input class="input" type="url" name="mercari_url" placeholder="https://www.mercari.com/us/item/...">
    </div>
    <div>
      <label><i class="fas fa-tshirt"></i> Vinted</label>
      <input class="input" type="url" name="vinted_url" placeholder="https://www.vinted.com/items/...">
    </div>
    <div>
      <label><i class="fas fa-shopping-bag"></i> Poshmark</label>
      <input class="input" type="url" name="poshmark_url" placeholder="https://posh.mk/...">
    </div>
    <div>
      <label><i class="fas fa-shopping-cart"></i> Depop</label>
      <input class="input" type="url" name="depop_url" placeholder="https://www.depop.com/products/...">
    </div>

    {# ------------------ Bloque: Imagen Thumb (Cloudinary) ------------------ #}
    <div style="grid-column:1/-1">
      <hr style="border-color:var(--border);opacity:.3;margin:12px 0">
      <h3 style="margin:0 0 8px 0;font-size:16px"><i class="fas fa-image"></i> Item thumbnail</h3>

      <div class="grid" style="grid-template-columns: repeat(3, minmax(160px, 1fr)); gap: 8px;">
        <div>
          <label>Take photo</label>
          <input class="input" id="item_thumb_camera" type="file" accept="image/*" capture="environment">
        </div>
        <div>
          <label>Choose from library</label>
          <input class="input" id="item_thumb_library" type="file" accept="image/*">
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap">
          <button type="button" class="btn" id="btnChooseFile"><i class="fas fa-folder-open"></i> Library…</button>
          <button type="button" class="btn" id="btnTakePhoto"><i class="fas fa-camera"></i> Camera…</button>
          <button type="button" class="btn submitbtn" id="btnUploadThumb" disabled>
            <i class="fas fa-cloud-upload-alt"></i> Upload
          </button>
        </div>
      </div>

      <div style="margin-top:8px; display:flex; align-items:center; gap:12px;">
        <img id="item_thumb_preview" alt="Preview" style="display:none; width:90px; height:90px; object-fit:cover; border-radius:8px; border:1px solid var(--border);" />
        <div id="upload_status" style="font-size:12px; opacity:.9; min-height:1.2em;"></div>
      </div>

      <input type="url" class="input" name="item_thumb" id="item_thumb" placeholder="Cloudinary image URL (auto-filled after upload)" style="margin-top:8px">
    </div>

    {# ------------------ Nuevos campos de negocio ------------------ #}
    <div>
      <label><i class="fas fa-store-alt"></i> Supplier</label>
      <input class="input" type="text" name="supplier" placeholder="e.g., Goodwill, Local shop…">
    </div>
    <div>
      <label><i class="fas fa-dollar-sign"></i> Cost</label>
      <input class="input" type="number" name="item_cost" step="0.01" min="0" placeholder="0.00">
    </div>
    <div>
      <label><i class="fas fa-tag"></i> Price</label>
      <input class="input" type="number" name="item_price" step="0.01" min="0" placeholder="0.00">
    </div>
    <div>
      <label><i class="fas fa-calendar-day"></i> Listing date</label>
      <input class="input" type="date" name="listing_date">
    </div>

    <div class="card" style="grid-column:1/-1; margin-top:16px">
      <div style="grid-column:1/-1">
        <hr style="border-color:var(--border);opacity:.3;margin:8px 0">
      </div>
      
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px">
        <h3 style="margin:0;font-size:16px"><i class="fas fa-map-marker-alt"></i> Location</h3>
        <button type="button" id="btnScanLocation" class="btn" style="padding:4px 8px; font-size:12px" title="Scan location QR code">
          <i class="fas fa-qrcode"></i> Scan QR
        </button>
      </div>

      {% if settings.enable_A %}
      <div>
        <label><i class="fas fa-tag"></i> {{ settings.label_A }} (A)</label>
        <input class="input" type="text" name="A" id="input_A" placeholder="e.g., 1">
      </div>
      {% endif %}

      {% if settings.enable_B %}
      <div>
        <label><i class="fas fa-tag"></i> {{ settings.label_B }} (B)</label>
        <input class="input" type="text" name="B" id="input_B" placeholder="e.g., 1">
      </div>
      {% endif %}

      {% if settings.enable_S %}
      <div>
        <label><i class="fas fa-tag"></i> {{ settings.label_S }} (S)</label>
        <input class="input" type="text" name="S" id="input_S" placeholder="e.g., 1">
      </div>
      {% endif %}

      {% if settings.enable_C %}
      <div>
        <label><i class="fas fa-tag"></i> {{ settings.label_C }} (C)</label>
        <input class="input" type="text" name="C" id="input_C" placeholder="e.g., 1">
      </div>
      {% endif %}

      <div style="grid-column:1/-1; margin-top:8px">
        <button class="btn submitbtn" type="submit" name="submit_action" value="create">
          <i class="fas fa-save"></i> Create Item
        </button>
        <button class="btn submitbtn" type="submit" name="submit_action" value="create_another" title="Save and keep this page ready for a new item">
          <i class="fas fa-plus-circle"></i> Save & Add Another
        </button>
        <a class="btn" href="{{ url_for('main.dashboard') }}">
          <i class="fas fa-times"></i> Cancel
        </a>
      </div>
    </div>
  </form>
</div>

<!-- Modal del QR Scanner -->
<div id="qrModal" class="scan-modal hidden" aria-hidden="true" aria-label="QR code scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong><i class="fas fa-qrcode"></i> Scan location QR code</strong>
      <div class="scan-actions">
        <button type="button" id="qrFlashlight" class="icon-top" aria-label="Toggle flashlight" title="Toggle flashlight">
          <i class="fas fa-lightbulb"></i>
        </button>
        <button type="button" id="qrFlip" class="icon-top" aria-label="Flip camera" title="Flip camera">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button type="button" id="qrClose" class="icon-top" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="scan-body">
      <div class="viewport">
        <video id="qrVideo" playsinline autoplay muted></video>
        <div class="guide"></div>
        <div id="qrTarget" class="scan-target"></div>
        <div id="qrSpinner" class="spinner"></div>
        <div id="qrSuccess" class="success-indicator">
          <i class="fas fa-check"></i>
        </div>
      </div>
      <div class="scan-tip">Align the QR code inside the frame</div>
      <div id="qrResult" class="scan-result"></div>
    </div>
  </div>
</div>

<style>
  /* Modal compacto y bloqueo de scroll */
  body.modal-open{ overflow:hidden; touch-action:none; }
  .scan-modal.hidden{ display:none; }
  .scan-modal{
    position:fixed; inset:0; background:rgba(0,0,0,.6);
    display:grid; place-items:center; z-index:9999; padding:16px;
  }
  .scan-sheet{
    width:min(420px, 92vw); background:#0f1115; color:#fff;
    border-radius:14px; overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.5); border:1px solid #222;
  }
  .scan-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; background:#141821; border-bottom:1px solid #222;
  }
  .scan-actions .icon-top{
    border:none; background:transparent; color:#fff; font-size:18px; margin-left:6px; opacity:.85; cursor:pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
  }
  .scan-actions .icon-top:hover{ opacity:1; }
  .scan-actions .icon-top.active{ opacity:1; color:#ffd700; }

  .scan-body{ padding:12px; display:flex; flex-direction:column; gap:10px; }

  /* Viewport fijo */
  .viewport{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 4;
    max-height: 60vh;
    border-radius:12px;
    overflow:hidden;
    background:#000;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  }
  #qrVideo, .scan-target{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:none;
  }
  .guide{
    position:absolute; inset:10%;
    border:2px dashed rgba(255,255,255,.6);
    border-radius:10px;
    pointer-events:none;
    animation: pulse-guide 2s infinite;
  }
  
  @keyframes pulse-guide {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .success-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    color: #00ff00;
    display: none;
    text-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
    animation: success-flash 0.5s ease-out;
  }

  @keyframes success-flash {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  }

  .scan-tip{ text-align:center; font-size:12px; opacity:.8; }
  
  .scan-result {
    background: #1a1d23;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 8px 12px;
    font-family: monospace;
    font-size: 12px;
    color: #0ff;
    min-height: 20px;
    display: none;
  }

  /* Spinner simple */
  .spinner{
    position:absolute; inset:0; display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.25);
  }
  .spinner::after{
    content:"";
    width:28px; height:28px; border-radius:50%;
    border:3px solid rgba(255,255,255,.3);
    border-top-color:#fff; animation:spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  /* Estilos para iconos en formulario */
  label i {
    margin-right: 8px;
    width: 16px;
    color: #666;
  }
  
  .btn i {
    margin-right: 5px;
  }
</style>

<script>
/* ========== SCRIPT GET desde eBay ========== */
document.addEventListener('DOMContentLoaded', () => {
  const btn   = document.getElementById('btnFetch');
  const urlI  = document.getElementById('import_url');
  const titleI= document.getElementById('title');
  const ebayI = document.getElementById('ebay_url');
  const status= document.getElementById('import_status');

  if (!btn) return;

  btn.addEventListener('click', async () => {
    const url = (urlI?.value || '').trim();
    if (!url) {
      status.textContent = 'Pega primero una URL de eBay (/itm/...)';
      status.style.color = '#eab308';
      urlI?.focus();
      return;
    }

    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting…';
    status.textContent = 'Consultando eBay…';
    status.style.color = '#aaa';

    try {
      const resp = await fetch(`/api/fetch-market-title?url=${encodeURIComponent(url)}`, {
        credentials: 'same-origin'
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        const msg = (data && (data.error || data.message)) || `HTTP ${resp.status}`;
        throw new Error(msg);
      }

      if (titleI && data.fill?.title)  titleI.value = data.fill.title;
      if (ebayI  && data.fill?.ebay_url) ebayI.value = data.fill.ebay_url;

      status.textContent = '✓ Título importado correctamente';
      status.style.color = '#22c55e';
      btn.innerHTML = '<i class="fas fa-check"></i> Listo';
      setTimeout(() => { btn.innerHTML = original; }, 1200);
    } catch (err) {
      console.error(err);
      status.textContent = `No se pudo obtener el título: ${err.message}`;
      status.style.color = '#ef4444';
      btn.innerHTML = original;
    } finally {
      btn.disabled = false;
    }
  });
});
</script>

<script>
/* ========== COMPRESIÓN A ~100 KB + UPLOAD A CLOUDINARY ========== */
(function(){
  const btnTake  = document.getElementById('btnTakePhoto');
  const btnPick  = document.getElementById('btnChooseFile');
  const btnUp    = document.getElementById('btnUploadThumb');
  const inCam    = document.getElementById('item_thumb_camera');
  const inLib    = document.getElementById('item_thumb_library');
  const preview  = document.getElementById('item_thumb_preview');
  const urlField = document.getElementById('item_thumb');
  const statusEl = document.getElementById('upload_status');

  let selectedFile = null;

  function setStatus(msg, ok=null){
    if (!statusEl) return;
    statusEl.textContent = msg || '';
    if (ok === true)  statusEl.style.color = '#22c55e';
    else if (ok === false) statusEl.style.color = '#ef4444';
    else statusEl.style.color = '';
  }

  function onFileSelected(file){
    if (!file) return;
    selectedFile = file;
    btnUp.disabled = false;
    try {
      preview.style.display = 'block';
      preview.src = URL.createObjectURL(file);
    } catch {}
    setStatus(`Seleccionado: ${file.name || 'photo'}`);
  }

  btnTake?.addEventListener('click', () => inCam?.click());
  btnPick?.addEventListener('click', () => inLib?.click());

  inCam?.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    onFileSelected(f);
    if (inLib) inLib.value = '';
  });

  inLib?.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    onFileSelected(f);
    if (inCam) inCam.value = '';
  });

  // Carga imagen en <img> de forma segura
  function loadImageFromFile(file){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload  = () => resolve(img);
      img.onerror = () => reject(new Error('No se pudo decodificar la imagen'));
      try {
        img.src = URL.createObjectURL(file);
      } catch (e) {
        reject(e);
      }
    });
  }

  // Render a canvas con reescalado
  function drawToCanvas(img, maxW, maxH){
    const { naturalWidth:w0, naturalHeight:h0 } = img;
    let w = w0, h = h0;
    const sw = maxW / w, sh = maxH / h, s = Math.min(1, sw, sh); // no subir tamaño
    w = Math.round(w * s);
    h = Math.round(h * s);
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    return canvas;
  }

  // Convierte canvas → blob jpeg con calidad dada
  function canvasToJpeg(canvas, quality){
    return new Promise((resolve, reject) => {
      canvas.toBlob((blob) => {
        if (!blob) return reject(new Error('toBlob failed'));
        resolve(blob);
      }, 'image/jpeg', quality);
    });
  }

  // Compresión iterativa a objetivo ~100 KB
  async function compressToTarget(file, targetKB = 100, ceilingKB = 120){
    // Valores iniciales
    let maxW = 1600;
    let maxH = 1600;
    let quality = 0.82;

    const img = await loadImageFromFile(file);

    // Intentos máximos para evitar loops
    const MAX_STEPS = 10;
    let attempt = 0;
    let lastBlob = null;

    while (attempt < MAX_STEPS) {
      attempt++;
      const canvas = drawToCanvas(img, maxW, maxH);
      let blob = await canvasToJpeg(canvas, quality);
      const kb = Math.round(blob.size / 1024);

      // ¿ya estamos dentro del rango aceptable?
      if (kb <= ceilingKB) return blob;

      // Si todavía está grande, bajamos calidad primero; luego tamaño
      // Heurística: si > 400 KB, reduce tamaño agresivamente
      if (kb > 400) {
        maxW = Math.round(maxW * 0.75);
        maxH = Math.round(maxH * 0.75);
        quality = Math.max(0.6, quality * 0.9);
      } else {
        // Bajar calidad progresivamente
        quality = Math.max(0.5, quality * 0.88);
        // Si ya estamos cerca pero no llegamos, baja un poco tamaño
        if (kb <= 200 && (attempt % 2 === 0)) {
          maxW = Math.round(maxW * 0.9);
          maxH = Math.round(maxH * 0.9);
        }
      }

      lastBlob = blob;
    }

    // Si no llegó, devuelve lo mejor que logró (último blob)
    return lastBlob;
  }

  async function uploadToCloudinary(){
    try {
      if (!selectedFile) { setStatus('Primero elige o toma una foto', false); return; }

      setStatus('Procesando imagen a ~100 KB…');

      let compressedBlob;
      try {
        compressedBlob = await compressToTarget(selectedFile, 100, 120);
      } catch (e) {
        console.warn('Compresión falló, subiendo original:', e);
        compressedBlob = selectedFile; // último recurso
      }

      const finalNameBase = (selectedFile.name && selectedFile.name.split('.')[0]) || `photo-${Date.now()}`;
      const finalName = finalNameBase + '.jpg';

      // Si por alguna razón quedó > 2 MB (muy raro), avisamos y abortamos
      if (compressedBlob && compressedBlob.size > 2 * 1024 * 1024) {
        setStatus('La imagen sigue siendo muy grande (>2MB) incluso tras comprimir. Intenta otra foto.', false);
        return;
      }

      const fd = new FormData();
      fd.append('file', compressedBlob || selectedFile, finalName);

      btnUp.disabled = true;
      const original = btnUp.innerHTML;
      btnUp.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading…';
      setStatus(`Subiendo (${Math.round((compressedBlob?.size || selectedFile.size)/1024)} KB)…`);

      const resp = await fetch('/api/upload-image', {
        method: 'POST',
        body: fd,
        credentials: 'same-origin'
      });

      let data = {};
      try { data = await resp.json(); } catch {}

      if (!resp.ok || !data.ok) {
        const msg = (data && (data.error || data.message)) || `HTTP ${resp.status}`;
        throw new Error(msg);
      }

      if (urlField) urlField.value = data.url || '';
      setStatus('✓ Subida completa', true);
      btnUp.innerHTML = '<i class="fas fa-check"></i> Uploaded';
      setTimeout(()=> btnUp.innerHTML = original, 1200);
    } catch (err) {
      console.error(err);
      setStatus(`Upload failed: ${err.message || err}`, false);
    } finally {
      btnUp.disabled = false;
    }
  }

  btnUp?.addEventListener('click', uploadToCloudinary);
})();
</script>

<script>
/* ========== SCRIPT SCANNER QR (completo) ========== */
(function(){
  const btnScan = document.getElementById('btnScanLocation');
  const modal = document.getElementById('qrModal');
  const btnClose = document.getElementById('qrClose');
  const btnFlip = document.getElementById('qrFlip');
  const btnFlash = document.getElementById('qrFlashlight');
  const video = document.getElementById('qrVideo');
  const target = document.getElementById('qrTarget');
  const spinner = document.getElementById('qrSpinner');
  const success = document.getElementById('qrSuccess');
  const result = document.getElementById('qrResult');

  const CAM_CACHE_KEY = 'qv_qr_cam_device_id';
  let cachedDeviceId = null;
  let stream = null, rafId = null;
  let detector = null;
  let usingBD = false;
  let usingJsQR = false;
  let jsQRLoaded = false;
  let videoDevices = [], currentDeviceIdx = -1;
  let devicesLoaded = false;
  let flashlightOn = false;
  let lastDetections = [];

  function openModal(){ document.body.classList.add('modal-open'); modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ document.body.classList.remove('modal-open'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }
  function showSuccess(){ success.style.display='block'; setTimeout(()=>success.style.display='none',500); }
  function cleanupAll(){
    if (rafId){ cancelAnimationFrame(rafId); rafId=null; }
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    flashlightOn=false; btnFlash.classList.remove('active');
    video.srcObject=null; video.style.display='none';
    target.style.display='none'; result.style.display='none';
    usingBD=false; usingJsQR=false; lastDetections.length=0;
  }
  function showError(err, where=''){
    const name = err?.name || 'Error';
    const msg  = err?.message || String(err || '');
    console.error('[QR]', where, err);
    alert(`${name}${msg ? ': ' + msg : ''}`);
  }

  async function loadVideoDevices(){
    if (devicesLoaded) return;
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d=>d.kind==='videoinput');
    const prefers = ['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      const as = prefers.some(p=>la.includes(p)) ? 1:0;
      const bs = prefers.some(p=>lb.includes(p)) ? 1:0;
      return bs - as;
    });
    devicesLoaded = true;
  }

  async function startWithDevice(deviceId){
    cleanupLoop();
    showSpinner(true);
    const constraints = {
      video: deviceId ? { deviceId:{exact:deviceId}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30}, facingMode:'environment' }
                      : { facingMode:{ideal:'environment'}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30} },
      audio: false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.setAttribute('playsinline','');
    video.setAttribute('autoplay','');
    video.setAttribute('muted','');
    video.srcObject = stream;
    await video.play();
    showSpinner(false);
    rememberActiveDevice();
  }

  function rememberActiveDevice(){
    try {
      const track = stream?.getVideoTracks?.()[0];
      const settings = track?.getSettings?.() || {};
      const id = settings.deviceId || track?.getConstraints?.().deviceId?.exact;
      if (id){ localStorage.setItem(CAM_CACHE_KEY, id); }
    } catch {}
  }

  function cleanupLoop(){ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
    cleanupLoop();
    await startWithDevice(videoDevices[currentDeviceIdx].deviceId);
    if (usingBD) startBDLoop();
    if (usingJsQR) startJsQRLoop();
  }

  async function toggleFlashlight(){
    if (!stream) return;
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      if (!caps.torch) return alert('Flashlight not supported on this camera');
      flashlightOn = !flashlightOn;
      await track.applyConstraints({ advanced:[{ torch: flashlightOn }] });
      btnFlash.classList.toggle('active', flashlightOn);
    }catch(e){ console.warn(e); alert('Unable to control flashlight'); }
  }

  function validateDetection(val){
    if (!val || val.length<3) return false;
    lastDetections.push(val);
    if (lastDetections.length>3) lastDetections.shift();
    return lastDetections[lastDetections.length-1];
  }

  function parseLocationQR(qrText){
    try{
      let locationPart = qrText.includes('/location/') ? qrText.split('/location/')[1] : qrText;
      if (!locationPart) return null;
      const m = locationPart.match(/^(?:.*?)(A(\d+))?(B(\d+))?(S(\d+))?(C(\d+))?/i);
      if (!m) return null;
      return { A: m[2]||null, B: m[4]||null, S: m[6]||null, C: m[8]||null, original: locationPart };
    }catch(e){ console.error('parseLocationQR',e); return null; }
  }

  function populateLocationFields(loc){
    const ids = ['A','B','S','C']; const done=[];
    ids.forEach(k=>{
      const el = document.getElementById(`input_${k}`);
      if (el && loc[k]){ el.value = loc[k]; done.push(`${k}=${loc[k]}`); el.style.background='#e8f5e8'; setTimeout(()=>el.style.background='',1500); }
    });
    return done;
  }

  function onDetected(raw){
    const v = validateDetection(raw);
    if (!v) return;
    const loc = parseLocationQR(v);
    if (loc){
      result.textContent = `Location: ${loc.original}`;
      result.style.display='block';
      showSuccess();
      try{ navigator.vibrate && navigator.vibrate([80,40,80]); }catch(_){}
      setTimeout(()=>{
        const filled = populateLocationFields(loc);
        cleanupAll(); closeModal();
      }, 600);
    } else {
      result.textContent = `QR: ${String(v).slice(0,80)}…`;
      result.style.display='block';
    }
  }

  async function startBarcodeDetector(){
    let supported = [];
    try{ supported = await window.BarcodeDetector.getSupportedFormats(); }catch{}
    if (!supported.includes('qr_code')) return false;

    detector = new window.BarcodeDetector({ formats: ['qr_code'] });
    usingBD = true; usingJsQR = false;
    video.style.display='block'; target.style.display='none';
    startBDLoop();
    return true;
  }

  function startBDLoop(){
    cleanupLoop();
    let frame=0;
    const tick = async ()=>{
      try{
        frame++;
        if (frame%3===0 && detector){
          const codes = await detector.detect(video);
          if (codes?.length){
            const qr = codes.find(c=>c.format==='qr_code') || codes[0];
            const val = (qr.rawValue||'').trim();
            if (val){ onDetected(val); return; }
          }
        }
      }catch(_){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function loadJsQR(){
    if (jsQRLoaded) return Promise.resolve();
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async=true;
      s.onload=()=>{ jsQRLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error('Failed to load jsQR'));
      document.head.appendChild(s);
    });
  }

  function startJsQRLoop(){
    usingBD=false; usingJsQR=true;
    video.style.display='block'; target.style.display='none';
    cleanupLoop();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const ROI_INSET = 0.10;

    let lastTS = 0;
    const MIN_INTERVAL = 80;

    const tick = (now)=>{
      try{
        if (!usingJsQR) return;
        if (now - lastTS >= MIN_INTERVAL && video.videoWidth>0){
          lastTS = now;
          const vw = video.videoWidth, vh = video.videoHeight;
          const rx = Math.floor(vw*ROI_INSET), ry = Math.floor(vh*ROI_INSET);
          const rw = Math.floor(vw*(1-2*ROI_INSET)), rh = Math.floor(vh*(1-2*ROI_INSET));
          canvas.width = rw; canvas.height = rh;
          ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);
          const img = ctx.getImageData(0, 0, rw, rh);
          const qr = window.jsQR && window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
          const val = (qr?.data || '').trim();
          if (val){ onDetected(val); return; }
        }
      }catch(_){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startScan(){
    openModal(); result.style.display='none'; success.style.display='none';
    try{
      cachedDeviceId = localStorage.getItem(CAM_CACHE_KEY) || null;
      if (cachedDeviceId){ await startWithDevice(cachedDeviceId); }
      else {
        await loadVideoDevices();
        if (videoDevices.length) currentDeviceIdx = 0;
        await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);
      }

      if ('BarcodeDetector' in window){
        const ok = await startBarcodeDetector();
        if (ok) return;
      }
      await loadJsQR();
      startJsQRLoop();
    }catch(e){
      showError(e, 'startScan');
      cleanupAll(); closeModal();
    }
  }

  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnFlash?.addEventListener('click', toggleFlashlight);
  btnClose?.addEventListener('click', ()=>{ cleanupAll(); closeModal(); });
  modal?.addEventListener('click', (e)=>{ if (e.target===modal){ cleanupAll(); closeModal(); } });

})();
</script>

{% endblock %}
