{# templates/new_item.html #}
{% extends "base.html" %}
{% block title %}Add Item ‚Äì Qventory{% endblock %}
{% block content %}
<div class="card">
  <h2>Add Item</h2>

  {# --------- Bloque de Import desde URL + GET --------- #}
  <div class="grid" style="grid-template-columns: 1fr auto; gap: 8px; margin-bottom:12px">
    <div>
      <label>Import from URL (eBay supported)</label>
      <input class="input" type="url" id="import_url" placeholder="Paste eBay item URL (https://www.ebay.com/itm/...)">
    </div>
    <div style="display:flex; align-items:flex-end">
      <button class="btn submitbtn" id="btnFetch" type="button" title="Fetch title & fill fields">GET</button>
    </div>
  </div>
  <div id="import_status" style="font-size:12px; opacity:.8; min-height:1.2em"></div>

  <form method="post" class="grid cols-3" id="newItemForm">
    <div style="grid-column:1/-1">
      <label>Title</label>
      <input class="input" type="text" name="title" placeholder="Item title" required>
    </div>

    <div style="grid-column:1/-1">
      <label>Listing Link (optional)</label>
      <input class="input" type="url" name="listing_link" placeholder="https://...">
    </div>

    <div style="grid-column:1/-1">
      <hr style="border-color:var(--border);opacity:.3;margin:8px 0">
    </div>

    <div style="grid-column:1/-1">
      <h3 style="margin:0 0 8px 0;font-size:16px">Marketplace Links (optional)</h3>
    </div>

    <div>
      <label>Website</label>
      <input class="input" type="url" name="web_url" placeholder="https://yourstore.com/...">
    </div>
    <div>
      <label>eBay</label>
      <input class="input" type="url" name="ebay_url" placeholder="https://www.ebay.com/itm/...">
    </div>
    <div>
      <label>Amazon</label>
      <input class="input" type="url" name="amazon_url" placeholder="https://www.amazon.com/dp/...">
    </div>
    <div>
      <label>Mercari</label>
      <input class="input" type="url" name="mercari_url" placeholder="https://www.mercari.com/us/item/...">
    </div>
    <div>
      <label>Vinted</label>
      <input class="input" type="url" name="vinted_url" placeholder="https://www.vinted.com/items/...">
    </div>
    <div>
      <label>Poshmark</label>
      <input class="input" type="url" name="poshmark_url" placeholder="https://posh.mk/...">
    </div>
    <div>
      <label>Depop</label>
      <input class="input" type="url" name="depop_url" placeholder="https://www.depop.com/products/...">
    </div>

    <div class="card" style="grid-column:1/-1; margin-top:16px">
      <div style="grid-column:1/-1">
        <hr style="border-color:var(--border);opacity:.3;margin:8px 0">
      </div>
      
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px">
        <h3 style="margin:0;font-size:16px">Location</h3>
        <button type="button" id="btnScanLocation" class="btn" style="padding:4px 8px; font-size:12px" title="Scan location QR code">üì± Scan QR</button>
      </div>

      {% if settings.enable_A %}
      <div>
        <label>{{ settings.label_A }} (A)</label>
        <input class="input" type="text" name="A" id="input_A" placeholder="e.g., 1">
      </div>
      {% endif %}

      {% if settings.enable_B %}
      <div>
        <label>{{ settings.label_B }} (B)</label>
        <input class="input" type="text" name="B" id="input_B" placeholder="e.g., 1">
      </div>
      {% endif %}

      {% if settings.enable_S %}
      <div>
        <label>{{ settings.label_S }} (S)</label>
        <input class="input" type="text" name="S" id="input_S" placeholder="e.g., 1">
      </div>
      {% endif %}

      {% if settings.enable_C %}
      <div>
        <label>{{ settings.label_C }} (C)</label>
        <input class="input" type="text" name="C" id="input_C" placeholder="e.g., 1">
      </div>
      {% endif %}

      <div style="grid-column:1/-1; margin-top:8px">
        <button class="btn submitbtn" type="submit" name="submit_action" value="create">Create Item</button>
        <button class="btn submitbtn" type="submit" name="submit_action" value="create_another" title="Save and keep this page ready for a new item">Save & Add Another</button>
        <a class="btn" href="{{ url_for('main.dashboard') }}">Cancel</a>
      </div>
    </div>
  </form>
</div>

<!-- Modal del QR Scanner (igual que el barcode scanner) -->
<div id="qrModal" class="scan-modal hidden" aria-hidden="true" aria-label="QR code scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong>Scan location QR code</strong>
      <div class="scan-actions">
        <button type="button" id="qrFlashlight" class="icon-top" aria-label="Toggle flashlight" title="Toggle flashlight">üî¶</button>
        <button type="button" id="qrFlip" class="icon-top" aria-label="Flip camera" title="Flip camera">üîÅ</button>
        <button type="button" id="qrClose" class="icon-top" aria-label="Close">‚úï</button>
      </div>
    </div>

    <div class="scan-body">
      <div class="viewport">
        <video id="qrVideo" playsinline autoplay muted></video>
        <div class="guide"></div>
        <div id="qrTarget" class="scan-target"></div>
        <div id="qrSpinner" class="spinner"></div>
        <div id="qrSuccess" class="success-indicator">‚úì</div>
      </div>
      <div class="scan-tip">Align the QR code inside the frame</div>
      <div id="qrResult" class="scan-result"></div>
    </div>
  </div>
</div>

<style>
  /* Modal compacto y bloqueo de scroll */
  body.modal-open{ overflow:hidden; touch-action:none; }
  .scan-modal.hidden{ display:none; }
  .scan-modal{
    position:fixed; inset:0; background:rgba(0,0,0,.6);
    display:grid; place-items:center; z-index:9999; padding:16px;
  }
  .scan-sheet{
    width:min(420px, 92vw); background:#0f1115; color:#fff;
    border-radius:14px; overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.5); border:1px solid #222;
  }
  .scan-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; background:#141821; border-bottom:1px solid #222;
  }
  .scan-actions .icon-top{
    border:none; background:transparent; color:#fff; font-size:18px; margin-left:6px; opacity:.85; cursor:pointer;
  }
  .scan-actions .icon-top:hover{ opacity:1; }
  .scan-actions .icon-top.active{ opacity:1; color:#ffd700; }

  .scan-body{ padding:12px; display:flex; flex-direction:column; gap:10px; }

  /* Viewport fijo */
  .viewport{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 4;
    max-height: 60vh;
    border-radius:12px;
    overflow:hidden;
    background:#000;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  }
  #qrVideo, .scan-target{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:none;
  }
  .guide{
    position:absolute; inset:10%;
    border:2px dashed rgba(255,255,255,.6);
    border-radius:10px;
    pointer-events:none;
    animation: pulse-guide 2s infinite;
  }
  
  @keyframes pulse-guide {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .success-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    color: #00ff00;
    display: none;
    text-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
    animation: success-flash 0.5s ease-out;
  }

  @keyframes success-flash {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  }

  .scan-tip{ text-align:center; font-size:12px; opacity:.8; }
  
  .scan-result {
    background: #1a1d23;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 8px 12px;
    font-family: monospace;
    font-size: 12px;
    color: #0ff;
    min-height: 20px;
    display: none;
  }

  /* Spinner simple */
  .spinner{
    position:absolute; inset:0; display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.25);
  }
  .spinner::after{
    content:"";
    width:28px; height:28px; border-radius:50%;
    border:3px solid rgba(255,255,255,.3);
    border-top-color:#fff; animation:spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
// Script para import desde URL (original)
(function(){
  const btn = document.getElementById('btnFetch');
  const urlInput = document.getElementById('import_url');
  const statusEl = document.getElementById('import_status');
  const form = document.getElementById('newItemForm');

  function setStatus(msg, ok=true){
    statusEl.textContent = msg || '';
    statusEl.style.color = ok ? 'var(--text-muted, #666)' : 'var(--error, #b00020)';
  }

  btn?.addEventListener('click', async () => {
    const raw = (urlInput?.value || '').trim();
    if (!raw) {
      setStatus('Please paste a URL first.', false);
      return;
    }
    setStatus('Fetching‚Ä¶');

    try {
      const qp = new URLSearchParams({ url: raw });
      const res = await fetch(`{{ url_for('main.api_fetch_market_title') }}?` + qp.toString(), {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (!data.ok) {
        setStatus(data.error || 'Could not fetch data.', false);
        return;
      }

      // Rellenar campos
      const titleInput = form.querySelector('input[name="title"]');
      const ebayInput  = form.querySelector('input[name="ebay_url"]');

      if (data.fill?.title && titleInput) {
        titleInput.value = data.fill.title;
      }
      if (data.marketplace === 'ebay' && ebayInput) {
        ebayInput.value = raw;
      }

      setStatus(`Detected: ${data.marketplace || 'unknown'}${data.title ? ' ¬∑ Title found' : ''}.`);
    } catch (e) {
      setStatus('Fetch failed. Try again or fill manually.', false);
    }
  });
})();

// Script para QR Scanner de ubicaciones
(function(){
  const btnScan = document.getElementById('btnScanLocation');
  const modal = document.getElementById('qrModal');
  const btnClose = document.getElementById('qrClose');
  const btnFlip = document.getElementById('qrFlip');
  const btnFlash = document.getElementById('qrFlashlight');
  const video = document.getElementById('qrVideo');
  const target = document.getElementById('qrTarget');
  const spinner = document.getElementById('qrSpinner');
  const success = document.getElementById('qrSuccess');
  const result = document.getElementById('qrResult');

  // Variables del scanner
  const CAM_CACHE_KEY = 'qv_qr_cam_device_id';
  let cachedDeviceId = null;
  let stream = null, rafId = null, detector = null, usingQuagga = false;
  let videoDevices = [], currentDeviceIdx = -1;
  let flashlightOn = false;
  let lastDetections = [];
  let devicesLoaded = false;

  // Formatos QR
  const QR_FORMATS = ['qr_code', 'data_matrix', 'aztec', 'pdf417'];

  video.setAttribute('playsinline',''); 
  video.setAttribute('muted',''); 
  video.setAttribute('autoplay','');

  function openModal(){ 
    document.body.classList.add('modal-open'); 
    modal.classList.remove('hidden'); 
    modal.setAttribute('aria-hidden','false'); 
  }
  
  function closeModal(){ 
    document.body.classList.remove('modal-open'); 
    modal.classList.add('hidden'); 
    modal.setAttribute('aria-hidden','true'); 
  }
  
  function cancelLoop(){ 
    if (rafId){ cancelAnimationFrame(rafId); rafId = null; } 
  }
  
  function stopStream(){ 
    if (stream){ 
      stream.getTracks().forEach(t=>t.stop()); 
      stream = null; 
    } 
  }
  
  function cleanupAll(){
    cancelLoop(); 
    stopStream();
    flashlightOn = false;
    btnFlash.classList.remove('active');
    if (usingQuagga && window.Quagga){ 
      try { window.Quagga.stop(); } catch(e){} 
      usingQuagga=false; 
    }
    video.style.display='none'; 
    target.style.display='none';
    success.style.display='none';
    result.style.display='none';
    lastDetections = [];
  }

  function showSuccessAnimation(){
    success.style.display = 'block';
    setTimeout(() => {
      success.style.display = 'none';
    }, 500);
  }

  function parseLocationQR(qrText) {
    try {
      // Parsear URLs como: https://qventory.com/90percerntgeek/location/A1B1S2C3
      // o https://qventory.com/90percerntgeek/location/B1S2C3
      
      let locationPart;
      
      if (qrText.includes('/location/')) {
        const parts = qrText.split('/location/');
        locationPart = parts[1];
      } else {
        // Si es solo el c√≥digo de ubicaci√≥n
        locationPart = qrText;
      }

      if (!locationPart) return null;

      // Extraer componentes usando regex
      const matches = locationPart.match(/(?:A(\d+))?(?:B(\d+))?(?:S(\d+))?(?:C(\d+))?/i);
      
      if (!matches) return null;

      return {
        A: matches[1] || null,
        B: matches[2] || null,
        S: matches[3] || null,
        C: matches[4] || null,
        original: locationPart
      };
      
    } catch (e) {
      console.error('Error parsing location QR:', e);
      return null;
    }
  }

  function populateLocationFields(location) {
    // Popular los campos del formulario
    const fields = ['A', 'B', 'S', 'C'];
    let populated = [];
    
    fields.forEach(field => {
      const input = document.getElementById(`input_${field}`);
      if (input && location[field]) {
        input.value = location[field];
        populated.push(`${field}=${location[field]}`);
        // A√±adir efecto visual
        input.style.background = '#e8f5e8';
        setTimeout(() => {
          input.style.background = '';
        }, 2000);
      }
    });

    return populated;
  }

  function validateDetection(value) {
    if (!value || value.length < 3) return false;
    
    lastDetections.push(value);
    if (lastDetections.length > 3) { // Menos strict para QR
      lastDetections.shift();
    }

    // Para QR de ubicaci√≥n, ser m√°s permisivo
    const counts = {};
    lastDetections.forEach(code => {
      counts[code] = (counts[code] || 0) + 1;
    });

    const mostCommon = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
    
    if (mostCommon && mostCommon[1] >= 1) { // Solo necesita 1 detecci√≥n para QR
      return mostCommon[0];
    }

    return false;
  }
  
  function onDetected(qrText){
    const validatedCode = validateDetection(qrText);
    
    if (validatedCode) {
      const location = parseLocationQR(validatedCode);
      
      if (location) {
        result.textContent = `Location: ${location.original}`;
        result.style.display = 'block';
        showSuccessAnimation();
        
        try { 
          navigator.vibrate && navigator.vibrate([100, 50, 100]); 
        } catch(_){}
        
        setTimeout(() => {
          const populated = populateLocationFields(location);
          cleanupAll(); 
          closeModal();
          
          // Mostrar confirmaci√≥n
          if (populated.length > 0) {
            alert(`Location populated: ${populated.join(', ')}`);
          } else {
            alert('QR detected but no location fields were populated. Check the QR format.');
          }
        }, 800);
      } else {
        result.textContent = `Not a location QR: ${validatedCode.substring(0, 50)}...`;
        result.style.display = 'block';
      }
    } else {
      result.textContent = `Reading QR...`;
      result.style.display = 'block';
    }
  }

  function showSpinner(on){ 
    spinner.style.display = on ? 'flex' : 'none'; 
  }

  async function toggleFlashlight(){
    if (!stream) return;
    
    try {
      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      
      if (capabilities.torch) {
        flashlightOn = !flashlightOn;
        await track.applyConstraints({
          advanced: [{torch: flashlightOn}]
        });
        
        if (flashlightOn) {
          btnFlash.classList.add('active');
        } else {
          btnFlash.classList.remove('active');
        }
      } else {
        alert('Flashlight not supported on this camera');
      }
    } catch (err) {
      console.error('Flashlight error:', err);
      alert('Unable to control flashlight');
    }
  }

  function rememberActiveDevice(){
    try {
      const track = stream?.getVideoTracks?.()[0];
      const settings = track?.getSettings?.() || {};
      const id = settings.deviceId || track?.getConstraints?.().deviceId?.exact;
      if (id) {
        localStorage.setItem(CAM_CACHE_KEY, id);
        cachedDeviceId = id;
      }
    } catch {}
  }

  function findBestRearCamera(devices) {
    const rearKeywords = ['back', 'rear', 'environment', 'main', 'primary'];
    const frontKeywords = ['front', 'user', 'selfie', 'face'];
    
    const scored = devices.map(device => {
      const label = (device.label || '').toLowerCase();
      let score = 0;
      
      rearKeywords.forEach(keyword => {
        if (label.includes(keyword)) score += 10;
      });
      
      frontKeywords.forEach(keyword => {
        if (label.includes(keyword)) score -= 15;
      });
      
      if (devices.indexOf(device) === 0 && score >= 0) score += 5;
      
      return { device, score };
    });
    
    scored.sort((a, b) => b.score - a.score);
    return scored.map(item => item.device);
  }

  async function loadVideoDevices(){
    if (devicesLoaded && videoDevices.length > 0) {
      return;
    }
    
    const devices = await navigator.mediaDevices.enumerateDevices();
    const rawVideoDevices = devices.filter(d => d.kind === 'videoinput');
    
    videoDevices = findBestRearCamera(rawVideoDevices);
    devicesLoaded = true;
  }

  async function startWithDevice(deviceId){
    stopStream(); 
    cancelLoop();
    showSpinner(true);
    
    const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome'));
    
    let constraints;
    
    if (deviceId) {
      constraints = {
        video: isIOSSafari ? {
          deviceId: { exact: deviceId },
          width: { ideal: 640, max: 1280 },
          height: { ideal: 480, max: 720 },
          frameRate: { ideal: 24, max: 30 }
        } : {
          deviceId: { exact: deviceId }, 
          width: { ideal: 1280, min: 640 }, 
          height: { ideal: 720, min: 480 }, 
          frameRate: { ideal: 30 }
        },
        audio: false
      };
    } else {
      constraints = {
        video: isIOSSafari ? {
          facingMode: { ideal: 'environment' },
          width: { ideal: 640 },
          height: { ideal: 480 },
          frameRate: { ideal: 24 }
        } : {
          facingMode: { ideal: 'environment' }, 
          width: { ideal: 1280, min: 640 }, 
          height: { ideal: 720, min: 480 }, 
          frameRate: { ideal: 30 }
        },
        audio: false
      };
    }
    
    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      
      if (isIOSSafari) {
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve).catch(resolve);
          };
        });
      } else {
        await video.play();
      }
      
      showSpinner(false);
    } catch (error) {
      console.error('[QR Scanner] Error starting camera:', error);
      showSpinner(false);
      throw error;
    }
  }

  function startBDLoop(){
    let frameCount = 0;
    const tick = async () => {
      try {
        frameCount++;
        if (frameCount % 5 === 0) { // Menos frecuente para QR
          const codes = await detector.detect(video);
          if (codes && codes.length){
            const qrCode = codes.find(code => code.format === 'qr_code') || codes[0];
            const val = (qrCode.rawValue || '').trim();
            if (val && val.length >= 5){ 
              onDetected(val); 
              return; 
            }
          }
        }
      } catch(_) {}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startBarcodeDetector(){
    detector = new window.BarcodeDetector({ formats: QR_FORMATS });
    video.style.display = 'block';
    target.style.display = 'none';
    startBDLoop();
  }

  async function startScan(){
    if (!('BarcodeDetector' in window) && !window.Quagga) {
      alert('QR scanning not supported in this browser. Please use Chrome, Safari, or Firefox.');
      return;
    }

    openModal();
    lastDetections = [];
    result.style.display = 'none';
    
    try{
      cachedDeviceId = localStorage.getItem(CAM_CACHE_KEY) || null;
      
      const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome'));
      
      if (isIOSSafari && cachedDeviceId) {
        try {
          await startWithDevice(cachedDeviceId);
        } catch (error) {
          cachedDeviceId = null;
          localStorage.removeItem(CAM_CACHE_KEY);
          await startWithDevice(null);
        }
      } else if (isIOSSafari) {
        await startWithDevice(null);
        loadVideoDevices().catch(console.warn);
      } else {
        await loadVideoDevices();
        
        if (cachedDeviceId) {
          const deviceExists = videoDevices.some(d => d.deviceId === cachedDeviceId);
          if (deviceExists) {
            await startWithDevice(cachedDeviceId);
          } else {
            cachedDeviceId = null;
            localStorage.removeItem(CAM_CACHE_KEY);
            currentDeviceIdx = 0;
            await startWithDevice(videoDevices[0]?.deviceId);
          }
        } else {
          if (videoDevices.length) {
            currentDeviceIdx = 0;
            await startWithDevice(videoDevices[0]?.deviceId);
          } else {
            await startWithDevice(null);
          }
        }
      }

      if ('BarcodeDetector' in window) {
        await startBarcodeDetector();
      }

      rememberActiveDevice();
    }catch(err){
      console.error('[QR Scanner] Error:', err);
      alert('Camera access failed. Please allow camera permission and try again.');
      cleanupAll(); 
      closeModal();
    }
  }

  async function flipCamera(){
    if (!devicesLoaded) {
      await loadVideoDevices();
    }
    
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;

    cancelLoop();
    await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);
    rememberActiveDevice();
    if (detector) startBDLoop();
  }

  // Event listeners
  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnFlash?.addEventListener('click', toggleFlashlight);
  btnClose?.addEventListener('click', () => { cleanupAll(); closeModal(); });
  modal?.addEventListener('click', (e) => { 
    if (e.target === modal) { cleanupAll(); closeModal(); } 
  });

})();
</script>
{% endblock %}