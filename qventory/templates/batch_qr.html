{% extends "base_new.html" %}
{% block title %}QR Batch – Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">QR Batch</span>
</nav>
{% endblock %}

{% block content %}
<div class="qr-batch">
  <div class="card qr-batch__hero">
    <div class="qr-batch__hero-header">
      <div>
        <p class="qr-batch__eyebrow">QR Labels</p>
        <h2>Batch generator</h2>
        <p class="qr-batch__subtitle">
          Create a clean sheet of 40×30mm labels with the exact location codes you need.
        </p>
      </div>
      <div class="qr-batch__badge">
        <span class="qr-batch__badge-dot"></span>
        Uses your Qventory location settings
      </div>
    </div>

    <div class="qr-batch__layout">
      <form method="post" class="qr-batch__form">
        <div class="qr-batch__fields">
          {% if settings.enable_A %}
          <div class="qr-batch__field">
            <label>{{ settings.label_A }} values</label>
            <input class="input" type="text" name="A" placeholder="1-3 or 1,3,7">
          </div>
          {% endif %}
          {% if settings.enable_B %}
          <div class="qr-batch__field">
            <label>{{ settings.label_B }} values</label>
            <input class="input" type="text" name="B" placeholder="1-5 or 2,4,6">
          </div>
          {% endif %}
          {% if settings.enable_S %}
          <div class="qr-batch__field">
            <label>{{ settings.label_S }} values</label>
            <input class="input" type="text" name="S" placeholder="1-10 or 1,2,4">
          </div>
          {% endif %}
          {% if settings.enable_C %}
          <div class="qr-batch__field">
            <label>{{ settings.label_C }} values</label>
            <input class="input" type="text" name="C" placeholder="1-8 or 1,3,5">
          </div>
          {% endif %}
        </div>
        <div class="qr-batch__actions">
          <button class="btn btn-primary" type="submit">Build PDF</button>
          <a class="btn btn-ghost" href="{{ url_for('main.dashboard') }}">Cancel</a>
        </div>
      </form>

      <div class="qr-batch__tips">
        <div class="qr-batch__tip">
          <h3>How it works</h3>
          <p>Enter ranges or comma lists for each enabled level. We'll combine them into location codes.</p>
        </div>
        <div class="qr-batch__tip">
          <h3>Examples</h3>
          <div class="qr-batch__chips">
            <span class="qr-chip">1-4</span>
            <span class="qr-chip">1,3,7</span>
            <span class="qr-chip">2-2</span>
            <span class="qr-chip">5,9</span>
          </div>
        </div>
        <div class="qr-batch__tip qr-batch__tip--accent">
          <p>Labels are 1 per page at 40×30mm.</p>
        </div>
      </div>
    </div>
  </div>

{% if location_tree and location_tree|length %}
<div class="card qr-batch__locations">
  <div class="qr-batch__locations-header">
    <div>
      <h2>Active inventory locations</h2>
      <p class="qr-batch__subtitle">Print labels for locations detected in your active inventory.</p>
    </div>
    <div class="qr-batch__summary">
      <div class="qr-summary">
        <span class="qr-summary__label">Detected locations</span>
        <span class="qr-summary__value">{{ total_location_items }}</span>
      </div>
      <div class="qr-summary">
        <span class="qr-summary__label">Selected</span>
        <span class="qr-summary__value" id="selectedCount">0</span>
      </div>
    </div>
  </div>

  <form method="post" action="{{ url_for('main.qr_batch_print_selected') }}" target="_blank">
    <div class="qr-batch__toolbar">
      <div class="qr-batch__toolbar-main">
        <button class="btn btn-primary" type="submit">Print Selected</button>
        <button class="btn btn-outline" type="button" id="printAllBtn">Print All</button>
      </div>
      <div class="qr-batch__toolbar-secondary">
        <button class="btn btn-ghost" type="button" id="selectAllBtn">Select All</button>
        <button class="btn btn-ghost" type="button" id="deselectAllBtn">Deselect All</button>
      </div>
    </div>

  {% macro render_tree(nodes) %}
    <ul class="qr-tree">
      {% for key, node in nodes.items() %}
      <li class="qr-tree__node">
        <div class="qr-tree__row">
          <label class="qr-tree__check">
            <input type="checkbox" name="location_codes" value="{{ node.code }}" class="location-checkbox">
            <span class="qr-tree__label">{{ location_labels.get(node.level, node.level) }} {{ node.value }}</span>
          </label>
          <span class="qr-tree__count">{{ node.count }}</span>
          {% if node.code %}
          <a class="btn btn-ghost"
             href="{{ url_for('main.qr_location_print', code=node.code) }}"
             target="_blank"
             rel="noopener"
             style="padding:6px 12px;font-size:12px;">
            Print Label
          </a>
          {% endif %}
        </div>
        {% if node.children and node.children|length %}
          {{ render_tree(node.children) }}
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% endmacro %}

  {{ render_tree(location_tree) }}
  </form>
</div>
{% elif total_location_items == 0 %}
<div class="card qr-batch__empty">
  <h2>No locations available</h2>
  <p class="qr-batch__subtitle">
    Assign locations to your active listings to generate printable location labels.
  </p>
  <a class="btn btn-primary" href="{{ url_for('main.inventory_active') }}">Go to Active Listings</a>
</div>
{% endif %}
</div>

<script>
  (function () {
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const printAllBtn = document.getElementById('printAllBtn');
    const selectedCount = document.getElementById('selectedCount');
    const checkboxes = () => Array.from(document.querySelectorAll('.location-checkbox'));

    const updateCount = () => {
      if (!selectedCount) return;
      selectedCount.textContent = checkboxes().filter(cb => cb.checked).length;
    };

    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        checkboxes().forEach(cb => { cb.checked = true; });
        updateCount();
      });
    }
    if (deselectAllBtn) {
      deselectAllBtn.addEventListener('click', () => {
        checkboxes().forEach(cb => { cb.checked = false; });
        updateCount();
      });
    }
    if (printAllBtn) {
      printAllBtn.addEventListener('click', () => {
        checkboxes().forEach(cb => { cb.checked = true; });
        updateCount();
        printAllBtn.closest('form').submit();
      });
    }

    checkboxes().forEach(cb => cb.addEventListener('change', updateCount));
    updateCount();
  })();
</script>
{% endblock %}
