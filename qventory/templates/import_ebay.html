{% extends "base_new.html" %}
{% block title %}Import from eBay â€“ Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">Import from eBay</span>
</nav>
{% endblock %}

{% block content %}

<div class="card page-shell page-shell--compact">
  <h2><i class="fab fa-ebay" style="color:#E53238"></i> Import Inventory from eBay</h2>

  {% if not ebay_connected %}
    <!-- Not Connected State -->
    <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:20px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <i class="fas fa-exclamation-triangle" style="color:#ef4444;font-size:24px"></i>
        <div>
          <div style="font-weight:600;color:#ef4444">eBay Account Not Connected</div>
          <div style="font-size:13px;color:var(--sub);margin-top:4px">
            You need to connect your eBay seller account before importing inventory.
          </div>
        </div>
      </div>
      <div style="margin-top:16px">
        <a href="{{ url_for('main.settings') }}" class="btn btn-primary">
          <i class="fas fa-cog"></i> Go to Settings
        </a>
      </div>
    </div>
  {% else %}
    <!-- Connected State -->
    <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:16px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px">
        <i class="fas fa-check-circle" style="color:#10b981;font-size:20px"></i>
        <div style="font-size:13px">
          <span style="color:#10b981;font-weight:600">Connected to eBay</span>
          <span style="color:var(--sub)"> â€¢ Account: {{ ebay_username }}</span>
        </div>
      </div>
    </div>

    <!-- Import Options -->
    <form method="post" id="importForm">
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Import Mode</label>
        <div style="display:grid;gap:12px">
          <label style="display:flex;align-items:start;gap:10px;padding:12px;background:rgba(156,163,175,0.05);border:2px solid rgba(156,163,175,0.2);border-radius:8px;cursor:pointer">
            <input type="radio" name="import_mode" value="new_only" style="margin-top:2px">
            <div>
              <div style="font-weight:600;color:var(--text)">Import New Items Only</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">
                Only import listings that don't exist in Qventory
              </div>
            </div>
          </label>

          <label style="display:flex;align-items:start;gap:10px;padding:12px;background:rgba(156,163,175,0.05);border:2px solid rgba(156,163,175,0.2);border-radius:8px;cursor:pointer">
            <input type="radio" name="import_mode" value="update_existing" style="margin-top:2px">
            <div>
              <div style="font-weight:600;color:var(--text)">Update Existing Items</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">
                Update items that already exist (match by eBay Item ID)
              </div>
            </div>
          </label>

          <label style="display:flex;align-items:start;gap:10px;padding:12px;background:rgba(96,165,250,0.05);border:2px solid rgba(96,165,250,0.2);border-radius:8px;cursor:pointer">
            <input type="radio" name="import_mode" value="sync_all" checked style="margin-top:2px">
            <div>
              <div style="font-weight:600;color:var(--text)">Full Sync (recommended)</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">
                Import new items and update existing ones
              </div>
            </div>
          </label>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Listing Status</label>
        <select name="listing_status" class="input">
          <option value="ACTIVE">Active Listings Only</option>
          <option value="ALL">All Listings (Active + Ended)</option>
        </select>
      </div>

      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Sales History <span style="font-weight:400;color:var(--sub);font-size:13px">(optional)</span></label>
        <select name="days_back" class="input">
          <option value="">All Time (Lifetime Sales)</option>
          <option value="7">Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="180">Last 6 Months</option>
          <option value="365">Last Year</option>
        </select>
        <div style="font-size:12px;color:var(--sub);margin-top:6px">
          How far back to import sales/orders. Leave as "All Time" for first import.
        </div>
      </div>

      <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:16px;margin-bottom:20px">
        <div style="display:flex;align-items:start;gap:12px">
          <i class="fas fa-info-circle" style="color:#3b82f6;margin-top:2px"></i>
          <div style="font-size:13px;color:var(--sub)">
            <strong style="color:var(--text)">What will be imported:</strong>
            <ul style="margin:8px 0 0 0;padding-left:20px">
              <li><strong>Inventory:</strong> Active items, titles, descriptions, images, prices, SKUs</li>
              <li><strong>Sales:</strong> Orders, sold items, buyer info, shipping details, fees</li>
              <li><strong>Tracking:</strong> Shipped/delivered dates, carrier info, tracking numbers</li>
            </ul>
          </div>
        </div>
      </div>

      <div id="importProgress" style="display:none;margin-bottom:20px">
        <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:16px">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div class="spinner" style="width:20px;height:20px;border:3px solid rgba(59,130,246,0.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite"></div>
            <div style="font-weight:600;color:#3b82f6">Importing from eBay...</div>
          </div>
          <div id="importStatus" style="font-size:13px;color:var(--sub)"></div>
        </div>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button type="submit" class="btn btn-primary" id="importBtn">
          <i class="fab fa-ebay"></i> Start Import
        </button>
        <button type="button" class="btn" id="rematchBtn" style="background:rgba(139,92,246,0.1);border-color:rgba(139,92,246,0.3);color:#a78bfa">
          <i class="fas fa-link"></i> Re-Match Sales to Items
        </button>
        <a href="{{ url_for('main.dashboard') }}" class="btn">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </form>

    <!-- Rematch Explanation -->
    <div style="margin-top:24px;padding:16px;background:rgba(139,92,246,0.05);border:1px solid rgba(139,92,246,0.2);border-radius:8px">
      <div style="display:flex;align-items:start;gap:12px">
        <i class="fas fa-lightbulb" style="color:#a78bfa;font-size:20px;margin-top:2px"></i>
        <div style="font-size:13px">
          <div style="font-weight:600;color:var(--text);margin-bottom:6px">ðŸ’¡ Re-Match Sales to Items</div>
          <div style="color:var(--sub);line-height:1.5">
            If you imported sales before importing inventory, some sales might not be linked to items.
            Click <strong style="color:#a78bfa">"Re-Match Sales to Items"</strong> to automatically match your historical sales to items in your inventory.
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
let pollInterval = null;
let currentJobId = null;

document.getElementById('importForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const importBtn = document.getElementById('importBtn');
  const importProgress = document.getElementById('importProgress');
  const importStatus = document.getElementById('importStatus');

  // Disable form
  importBtn.disabled = true;
  importProgress.style.display = 'block';
  importStatus.innerHTML = `
    <div style="color:#3b82f6;font-weight:600">Starting import...</div>
    <div style="margin-top:4px;font-size:12px">Connecting to eBay API...</div>
  `;

  try {
    const response = await fetch('{{ url_for("main.import_ebay") }}', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    // Check for upgrade required (403)
    if (response.status === 403 && result.upgrade_required) {
      importStatus.innerHTML = `
        <div style="color:#ef4444;font-weight:600">âœ— Plan Limit Reached</div>
        <div style="margin-top:8px;padding:12px;background:rgba(239,68,68,0.05);border-radius:6px">
          <div style="font-size:13px;color:var(--sub)">
            ${result.error}
          </div>
        </div>
        <div style="margin-top:12px">
          <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn">
            <i class="fas fa-arrow-up"></i> Upgrade Plan
          </a>
        </div>
      `;
      importBtn.disabled = false;
      return;
    }

    if (result.ok) {
      currentJobId = result.job_id;

      importStatus.innerHTML = `
        <div style="color:#10b981;font-weight:600">âœ“ Import started in background!</div>
        <div style="margin-top:8px;padding:12px;background:rgba(59,130,246,0.05);border-radius:6px">
          <div style="font-size:13px;color:var(--text);margin-bottom:8px">
            <i class="fas fa-info-circle"></i> <strong>You can continue working</strong>
          </div>
          <div style="font-size:12px;color:var(--sub)">
            â€¢ The import is running in the background<br>
            â€¢ You'll be notified when it's complete<br>
            â€¢ You can close this page and come back later<br>
            â€¢ Check progress below or refresh the page
          </div>
        </div>
        <div id="progressDetails" style="margin-top:12px"></div>
      `;

      // Start polling for status
      startPolling(currentJobId);
    } else {
      throw new Error(result.error || 'Failed to start import');
    }
  } catch (error) {
    importStatus.innerHTML = `
      <div style="color:#ef4444;font-weight:600">âœ— Failed to start import</div>
      <div style="margin-top:4px">${error.message}</div>
    `;
    importBtn.disabled = false;
  }
});

function startPolling(jobId) {
  // Poll every 2 seconds
  pollInterval = setInterval(() => {
    checkJobStatus(jobId);
  }, 2000);

  // Initial check
  checkJobStatus(jobId);
}

async function checkJobStatus(jobId) {
  try {
    const response = await fetch(`/api/import/status/${jobId}`);
    const data = await response.json();

    if (data.ok) {
      const job = data.job;
      updateProgressDisplay(job);

      // Stop polling if completed or failed
      if (job.status === 'completed' || job.status === 'failed') {
        clearInterval(pollInterval);
        showFinalResult(job);
      }
    }
  } catch (error) {
    console.error('Error checking job status:', error);
  }
}

function updateProgressDisplay(job) {
  const progressDetails = document.getElementById('progressDetails');
  if (!progressDetails) return;

  const percent = job.progress_percent || 0;
  const statusColor = job.status === 'processing' ? '#3b82f6' : (job.status === 'completed' ? '#10b981' : '#f59e0b');

  progressDetails.innerHTML = `
    <div style="background:rgba(156,163,175,0.05);border-radius:6px;padding:12px;border:1px solid rgba(156,163,175,0.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:12px;color:var(--sub);text-transform:uppercase;font-weight:600">Progress</span>
        <span style="font-size:14px;color:${statusColor};font-weight:600">${percent}%</span>
      </div>
      <div style="background:rgba(156,163,175,0.1);height:8px;border-radius:4px;overflow:hidden">
        <div style="background:${statusColor};height:100%;width:${percent}%;transition:width 0.3s"></div>
      </div>
      <div style="margin-top:8px;font-size:12px;color:var(--sub)">
        ${job.processed_items || 0} / ${job.total_items || 0} items processed
      </div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:11px">
        <div style="text-align:center;padding:6px;background:rgba(16,185,129,0.1);border-radius:4px">
          <div style="color:#10b981;font-weight:600">${job.imported_count || 0}</div>
          <div style="color:var(--sub)">Imported</div>
        </div>
        <div style="text-align:center;padding:6px;background:rgba(59,130,246,0.1);border-radius:4px">
          <div style="color:#3b82f6;font-weight:600">${job.updated_count || 0}</div>
          <div style="color:var(--sub)">Updated</div>
        </div>
        <div style="text-align:center;padding:6px;background:rgba(156,163,175,0.1);border-radius:4px">
          <div style="color:var(--sub);font-weight:600">${job.skipped_count || 0}</div>
          <div style="color:var(--sub)">Skipped</div>
        </div>
      </div>
    </div>
  `;
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'import-toast';
  const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
  const iconColor = type === 'success' ? '#34d399' : '#ef4444';

  toast.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;">
      <i class="fas ${icon}" style="color:${iconColor};font-size:24px;"></i>
      <div style="flex:1;">
        <div style="font-weight:600;margin-bottom:4px;">${message}</div>
        <a href="{{ url_for('main.dashboard') }}" style="font-size:12px;color:#60a5fa;text-decoration:none;">
          View Inventory <i class="fas fa-arrow-right"></i>
        </a>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--sub);cursor:pointer;font-size:20px;padding:0;width:24px;height:24px;">
        Ã—
      </button>
    </div>
  `;
  document.body.appendChild(toast);

  // Auto-remove after 10 seconds
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 10000);
}

function showFinalResult(job) {
  const importStatus = document.getElementById('importStatus');

  if (job.status === 'completed') {
    // Check if plan limit was reached
    const planLimitReached = job.error_message && job.error_message.includes('Plan limit reached');

    // Show toast notification
    const totalItems = (job.imported_count || 0) + (job.updated_count || 0);
    if (planLimitReached) {
      showToast(`Import stopped - Plan limit reached! ${job.imported_count} items imported.`, 'error');
    } else {
      showToast(`eBay import completed! ${totalItems} items processed.`, 'success');
    }

    let statusHTML = `
      <div style="color:#10b981;font-weight:600;font-size:16px;margin-bottom:12px">âœ“ Import Completed Successfully!</div>
      <div style="background:rgba(16,185,129,0.05);border:1px solid rgba(16,185,129,0.2);border-radius:8px;padding:16px">
        <div style="font-size:14px;color:var(--text);margin-bottom:8px">
          <strong>Summary:</strong>
        </div>
        <div style="font-size:13px;color:var(--sub)">
          â€¢ <strong style="color:#10b981">${job.imported_count || 0}</strong> new items imported<br>
          â€¢ <strong style="color:#3b82f6">${job.updated_count || 0}</strong> existing items updated<br>
          â€¢ <strong>${job.skipped_count || 0}</strong> items skipped
        </div>
      </div>
    `;

    // Show upgrade warning if plan limit reached
    if (planLimitReached) {
      statusHTML += `
        <div style="margin-top:16px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:16px">
          <div style="display:flex;align-items:start;gap:12px">
            <i class="fas fa-exclamation-triangle" style="color:#ef4444;font-size:20px;margin-top:2px"></i>
            <div style="flex:1">
              <div style="font-weight:600;color:#ef4444;margin-bottom:6px">Plan Limit Reached</div>
              <div style="font-size:13px;color:var(--sub);line-height:1.5">
                ${job.error_message}
              </div>
              <div style="margin-top:12px">
                <a href="{{ url_for('main.upgrade') }}" class="btn submitbtn" style="display:inline-block;">
                  <i class="fas fa-arrow-up"></i> Upgrade Plan
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    statusHTML += `
      <div style="margin-top:16px">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
          <i class="fas fa-th-large"></i> View Inventory
        </a>
      </div>
    `;

    importStatus.innerHTML = statusHTML;
  } else if (job.status === 'failed') {
    // Show error toast notification
    showToast('eBay import failed. Please try again.', 'error');

    importStatus.innerHTML = `
      <div style="color:#ef4444;font-weight:600;font-size:16px;margin-bottom:12px">âœ— Import Failed</div>
      <div style="background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:16px">
        <div style="font-size:13px;color:var(--sub)">
          ${job.error_message || 'An unknown error occurred'}
        </div>
      </div>
      <div style="margin-top:16px">
        <button onclick="location.reload()" class="btn btn-primary">
          <i class="fas fa-redo"></i> Try Again
        </button>
      </div>
    `;
  }

  // Hide spinner
  document.querySelector('.spinner').style.display = 'none';
}

// Rematch sales to items button
document.getElementById('rematchBtn')?.addEventListener('click', async () => {
  const btn = document.getElementById('rematchBtn');

  if (!confirm('This will attempt to match all unlinked sales to items in your inventory. Continue?')) {
    return;
  }

  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Matching...';

  try {
    const response = await fetch('/api/import/rematch_sales', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.ok) {
      alert('âœ“ Re-match task started!\n\nThis will run in the background and match your historical sales to items. Check /inventory/sold in a few minutes to see the results.');
      btn.innerHTML = '<i class="fas fa-check"></i> Task Started';
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }, 3000);
    } else {
      alert('Error: ' + (data.error || 'Failed to start rematch task'));
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  } catch (error) {
    console.error('Rematch error:', error);
    alert('Failed to start rematch task');
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
});

// Check for existing running jobs on page load
window.addEventListener('DOMContentLoaded', async () => {
  // Could add API endpoint to get user's most recent job and auto-resume polling
  // For now, jobs can be checked manually by refreshing
});
</script>

<style>
.import-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--card);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  z-index: 10000;
  min-width: 320px;
  max-width: 420px;
  animation: slideIn 0.3s ease;
  opacity: 1;
  transition: opacity 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@media (max-width: 480px) {
  .import-toast {
    left: 10px;
    right: 10px;
    min-width: auto;
  }
}
</style>

{% endblock %}
