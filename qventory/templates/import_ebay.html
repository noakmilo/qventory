{% extends "base.html" %}
{% block title %}Import from eBay – Qventory{% endblock %}
{% block content %}

<div class="card" style="max-width:800px;margin:0 auto">
  <h2><i class="fab fa-ebay" style="color:#E53238"></i> Import Inventory from eBay</h2>

  {% if not ebay_connected %}
    <!-- Not Connected State -->
    <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:20px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <i class="fas fa-exclamation-triangle" style="color:#ef4444;font-size:24px"></i>
        <div>
          <div style="font-weight:600;color:#ef4444">eBay Account Not Connected</div>
          <div style="font-size:13px;color:var(--sub);margin-top:4px">
            You need to connect your eBay seller account before importing inventory.
          </div>
        </div>
      </div>
      <div style="margin-top:16px">
        <a href="{{ url_for('main.settings') }}" class="btn btn-primary">
          <i class="fas fa-cog"></i> Go to Settings
        </a>
      </div>
    </div>
  {% else %}
    <!-- Connected State -->
    <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:16px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px">
        <i class="fas fa-check-circle" style="color:#10b981;font-size:20px"></i>
        <div style="font-size:13px">
          <span style="color:#10b981;font-weight:600">Connected to eBay</span>
          <span style="color:var(--sub)"> • Account: {{ ebay_username }}</span>
        </div>
      </div>
    </div>

    <!-- Import Options -->
    <form method="post" id="importForm">
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Import Mode</label>
        <div style="display:grid;gap:12px">
          <label style="display:flex;align-items:start;gap:10px;padding:12px;background:rgba(96,165,250,0.05);border:2px solid rgba(96,165,250,0.2);border-radius:8px;cursor:pointer">
            <input type="radio" name="import_mode" value="new_only" checked style="margin-top:2px">
            <div>
              <div style="font-weight:600;color:var(--text)">Import New Items Only</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">
                Only import listings that don't exist in Qventory (recommended)
              </div>
            </div>
          </label>

          <label style="display:flex;align-items:start;gap:10px;padding:12px;background:rgba(156,163,175,0.05);border:2px solid rgba(156,163,175,0.2);border-radius:8px;cursor:pointer">
            <input type="radio" name="import_mode" value="update_existing" style="margin-top:2px">
            <div>
              <div style="font-weight:600;color:var(--text)">Update Existing Items</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">
                Update items that already exist (match by eBay Item ID)
              </div>
            </div>
          </label>

          <label style="display:flex;align-items:start;gap:10px;padding:12px;background:rgba(156,163,175,0.05);border:2px solid rgba(156,163,175,0.2);border-radius:8px;cursor:pointer">
            <input type="radio" name="import_mode" value="sync_all" style="margin-top:2px">
            <div>
              <div style="font-weight:600;color:var(--text)">Full Sync</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">
                Import new items and update existing ones
              </div>
            </div>
          </label>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Listing Status</label>
        <select name="listing_status" class="input">
          <option value="ACTIVE">Active Listings Only</option>
          <option value="ALL">All Listings (Active + Ended)</option>
        </select>
      </div>


      <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:16px;margin-bottom:20px">
        <div style="display:flex;align-items:start;gap:12px">
          <i class="fas fa-info-circle" style="color:#3b82f6;margin-top:2px"></i>
          <div style="font-size:13px;color:var(--sub)">
            <strong style="color:var(--text)">What will be imported:</strong>
            <ul style="margin:8px 0 0 0;padding-left:20px">
              <li>Item title, description, and images</li>
              <li>eBay Item ID and listing URL</li>
              <li>Price and quantity</li>
              <li>Custom SKU (if present)</li>
              <li>Listing status and dates</li>
            </ul>
          </div>
        </div>
      </div>

      <div id="importProgress" style="display:none;margin-bottom:20px">
        <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:16px">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div class="spinner" style="width:20px;height:20px;border:3px solid rgba(59,130,246,0.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite"></div>
            <div style="font-weight:600;color:#3b82f6">Importing from eBay...</div>
          </div>
          <div id="importStatus" style="font-size:13px;color:var(--sub)"></div>
        </div>
      </div>

      <div style="display:flex;gap:12px">
        <button type="submit" class="btn btn-primary" id="importBtn">
          <i class="fab fa-ebay"></i> Start Import
        </button>
        <a href="{{ url_for('main.dashboard') }}" class="btn">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </form>
  {% endif %}
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
document.getElementById('importForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const importBtn = document.getElementById('importBtn');
  const importProgress = document.getElementById('importProgress');
  const importStatus = document.getElementById('importStatus');

  // Disable form
  importBtn.disabled = true;
  importProgress.style.display = 'block';
  importStatus.textContent = 'Connecting to eBay API...';

  try {
    const response = await fetch('{{ url_for("main.import_ebay") }}', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.ok) {
      importStatus.innerHTML = `
        <div style="color:#10b981;font-weight:600">✓ Import completed successfully!</div>
        <div style="margin-top:8px">
          • ${result.imported || 0} new items imported<br>
          • ${result.updated || 0} existing items updated<br>
          • ${result.skipped || 0} items skipped
        </div>
      `;

      setTimeout(() => {
        window.location.href = '{{ url_for("main.dashboard") }}';
      }, 2000);
    } else {
      throw new Error(result.error || 'Import failed');
    }
  } catch (error) {
    importStatus.innerHTML = `
      <div style="color:#ef4444;font-weight:600">✗ Import failed</div>
      <div style="margin-top:4px">${error.message}</div>
    `;
    importBtn.disabled = false;
  }
});
</script>

{% endblock %}
