{% set it = item if item is defined else it %}
{% set has_price = it.item_price is not none %}
{% set has_cost = it.item_cost is not none and it.item_cost > 0 %}
{% set roi = ( (it.item_price - it.item_cost) / it.item_cost * 100 ) if (has_price and has_cost) else None %}
{% set un = current_user.username %}
<tr>
  <td>
    {% if it.item_thumb %}
      <button class="thumb-wrap" type="button" data-full="{{ it.item_thumb }}" aria-label="View image">
        <img src="{{ it.item_thumb }}" alt="{{ it.title }}" class="thumb-img">
        <span class="thumb-zoom"><i class="fas fa-search"></i></span>
      </button>
    {% else %}
      <div style="width:36px;height:36px;border-radius:6px;border:1px dashed #bbb;display:grid;place-items:center;font-size:12px;color:#888;">—</div>
    {% endif %}
  </td>
  <td>{{ it.title }}</td>
  <td><span class="tag itsku">{{ it.sku }}</span></td>

  <td class="mobile-hide">{% if it.supplier %}<span class="tag">{{ it.supplier }}</span>{% else %}—{% endif %}</td>
  <td class="mobile-hide">{% if it.item_cost %}<span class="tag"><i class="fas fa-receipt"></i> ${{ '%.2f'|format(it.item_cost) }}</span>{% else %}—{% endif %}</td>
  <td>{% if it.item_price %}<span class="tag"><i class="fas fa-tag"></i> ${{ '%.2f'|format(it.item_price) }}</span>{% else %}—{% endif %}</td>
  <td class="mobile-hide">{% if has_price and has_cost %}<span class="tag">ROI {{ roi|round(0) }}%</span>{% else %}—{% endif %}</td>

  <!-- Location con QR -->
  <td>
    {% if it.location_code %}
    <a href="{{ url_for('main.public_view_location', username=un, code=it.location_code) }}">{{ it.location_code }}</a>
    &nbsp;
    <a class="tag qr-link"
       href="{{ url_for('main.qr_for_location', username=un, code=it.location_code) }}"
       data-caption="QR for {{ it.location_code }}">
      <i class="fas fa-qrcode"></i> QR
    </a>
    {% else %}—{% endif %}
  </td>

  <td class="mobile-hide">
    <div class="platform-badges">
      {% if it.web_url %}<a class="tag" href="{{ it.web_url }}" target="_blank">Web</a>{% endif %}
      {% if it.ebay_url %}<a class="tag" href="{{ it.ebay_url }}" target="_blank">eBay</a>{% endif %}
      {% if it.amazon_url %}<a class="tag" href="{{ it.amazon_url }}" target="_blank">Amazon</a>{% endif %}
      {% if it.mercari_url %}<a class="tag" href="{{ it.mercari_url }}" target="_blank">Mercari</a>{% endif %}
      {% if it.vinted_url %}<a class="tag" href="{{ it.vinted_url }}" target="_blank">Vinted</a>{% endif %}
      {% if it.poshmark_url %}<a class="tag" href="{{ it.poshmark_url }}" target="_blank">Poshmark</a>{% endif %}
      {% if it.depop_url %}<a class="tag" href="{{ it.depop_url }}" target="_blank">Depop</a>{% endif %}
    </div>
  </td>

  <td>
    {% if current_user.is_authenticated %}
    <button class="btn settingsbtn ai-research-btn"
            data-item-id="{{ it.id }}"
            data-item-title="{{ it.title }}"
            data-item-notes="{{ it.notes if it.notes else '' }}"
            title="AI Market Research">
      <i class="fas fa-brain"></i>
    </button>
    <button class="btn settingsbtn profit-calc-btn"
            data-item-id="{{ it.id }}"
            data-item-title="{{ it.title }}"
            data-item-cost="{{ it.item_cost if it.item_cost else '' }}"
            data-item-price="{{ it.item_price if it.item_price else '' }}"
            title="Profit Calculator">
      <i class="fas fa-calculator"></i>
    </button>
    <a class="btn settingsbtn" href="{{ url_for('main.edit_item', item_id=it.id) }}"><i class="fas fa-edit"></i></a>
    <form style="display:inline" method="post" action="{{ url_for('main.print_item', item_id=it.id) }}">
      <button class="btn settingsbtn" type="submit"><i class="fas fa-print"></i></button>
    </form>
    <form style="display:inline" method="post" action="{{ url_for('main.delete_item', item_id=it.id) }}" onsubmit="return confirm('Delete this item?')">
      <button class="btn settingsbtn" type="submit"><i class="fas fa-trash-alt"></i></button>
    </form>
    {% else %}
    <span class="tag">Login to edit</span>
    {% endif %}
  </td>
</tr>
