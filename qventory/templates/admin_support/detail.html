{% extends "base_admin.html" %}
{% block title %}Support Ticket – Admin – Qventory{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">/</span>
<a href="{{ url_for('main.admin_support_inbox') }}">Support Tickets</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">{{ ticket.ticket_code }}</span>
{% endblock %}

{% block content %}
<div class="card" style="width:98%;margin:0 auto;">
  <div class="admin-header">
    <div>
      <h1>{{ ticket.subject }}</h1>
      <p style="color:var(--sub);">{{ ticket.ticket_code }} · <span class="tag status-badge status-{{ ticket.status }}">{{ ticket.status|capitalize }}</span> · {{ ticket.user.email }}</p>
    </div>
    <div class="admin-actions">
      <form method="post" action="{{ url_for('main.admin_support_status', ticket_code=ticket.ticket_code) }}">
        <input type="hidden" name="status" value="resolved">
        <button class="btn" type="submit" {% if ticket.status != 'open' %}disabled{% endif %}><i class="fas fa-check"></i> Resolve</button>
      </form>
      <form method="post" action="{{ url_for('main.admin_support_status', ticket_code=ticket.ticket_code) }}">
        <input type="hidden" name="status" value="closed">
        <button class="btn" type="submit" {% if ticket.status != 'open' %}disabled{% endif %}><i class="fas fa-lock"></i> Close</button>
      </form>
      <a class="btn" href="{{ url_for('main.admin_support_inbox') }}"><i class="fas fa-arrow-left"></i> Back</a>
    </div>
  </div>

  <hr class="divider">

  <div class="support-thread">
    {% for message in messages %}
    <div class="support-message support-message--{{ message.sender_role }}">
      <div class="support-message-meta">
        <span>{{ message.sender_role|capitalize }}</span>
        <span>{{ message.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
      </div>
      <div class="support-message-body">{{ message.body }}</div>
      {% if message.attachments.count() %}
      <div class="support-attachments">
        {% for att in message.attachments %}
        <a href="{{ att.image_url }}" target="_blank" rel="noopener">
          <img src="{{ att.image_url }}" alt="Attachment">
        </a>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <hr class="divider">

  <h3>Reply</h3>
  {% if ticket.status != 'open' %}
    <div class="muted">This ticket is closed.</div>
  {% else %}
  <form method="post" action="{{ url_for('main.admin_support_message', ticket_code=ticket.ticket_code) }}" enctype="multipart/form-data" style="display:grid;gap:12px;">
    <div>
      <label>Message</label>
      <textarea class="input" name="body" rows="4" required></textarea>
    </div>
    <div>
      <label>Attachments (up to 3 images, 2MB each)</label>
      <input class="input" type="file" name="attachments" accept="image/*" multiple>
    </div>
    <div>
      <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i> Send Reply</button>
    </div>
  </form>
  {% endif %}
</div>

<style>
  .support-thread {
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .support-message {
    padding:14px 16px;
    border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--glass-border);
  }
  .support-message--user {
    border-color: rgba(96,165,250,0.3);
  }
  .support-message--admin {
    border-color: rgba(16,185,129,0.3);
  }
  .support-message-meta {
    display:flex;
    gap:10px;
    font-size:12px;
    color:var(--sub);
    margin-bottom:8px;
  }
  .support-message-body {
    white-space:pre-wrap;
  }
  .support-attachments {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .support-attachments img {
    width:120px;
    height:90px;
    object-fit:cover;
    border-radius:10px;
    border:1px solid var(--glass-border);
  }
  .status-badge {
    border-color: transparent;
  }
  .status-open {
    background: rgba(34,197,94,0.15);
    color: #22c55e;
    border-color: rgba(34,197,94,0.35);
  }
  .status-resolved {
    background: rgba(59,130,246,0.15);
    color: #60a5fa;
    border-color: rgba(59,130,246,0.35);
  }
  .status-closed {
    background: rgba(148,163,184,0.2);
    color: #94a3b8;
    border-color: rgba(148,163,184,0.4);
  }
</style>
{% endblock %}
