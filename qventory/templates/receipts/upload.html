{% extends "base_new.html" %}

{% block title %}Upload Receipt - Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <a href="{{ url_for('receipts.list_receipts') }}">Receipts</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">Upload</span>
</nav>
{% endblock %}

{% block content %}
<div class="container page-shell page-shell--medium">

    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;flex-wrap:wrap;gap:16px">
        <div>
            <h1 style="color:var(--text);font-size:28px;margin-bottom:8px">
                <i class="fas fa-receipt"></i> Upload Receipt
            </h1>
            <p style="color:var(--sub);font-size:14px">
                Upload a photo or scan of your receipt to automatically extract items and prices with AI
            </p>
        </div>
        <a href="{{ url_for('receipts.list_receipts') }}" class="btn btn--secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <!-- AI OCR Usage Stats -->
    {% if usage_stats %}
    <div style="background:{% if usage_stats.can_process %}rgba(59,130,246,0.05){% else %}rgba(245,158,11,0.05){% endif %};border:1px solid {% if usage_stats.can_process %}rgba(59,130,246,0.2){% else %}rgba(245,158,11,0.2){% endif %};border-radius:8px;padding:16px;margin-bottom:24px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
            <div style="flex:1;min-width:250px">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                    <i class="fas fa-robot" style="color:{% if usage_stats.can_process %}#3b82f6{% else %}#f59e0b{% endif %}"></i>
                    <strong style="color:var(--text);font-size:14px">AI OCR Usage - {{ usage_stats.plan_display }} Plan</strong>
                </div>
                {% if usage_stats.limit %}
                <div style="background:rgba(0,0,0,0.05);height:8px;border-radius:4px;overflow:hidden;margin-bottom:6px">
                    <div style="background:{% if usage_stats.can_process %}#3b82f6{% else %}#f59e0b{% endif %};height:100%;width:{{ (usage_stats.used / usage_stats.limit * 100)|round }}%;transition:width 0.3s"></div>
                </div>
                <small style="color:var(--sub);font-size:13px">
                    {{ usage_stats.used }} / {{ usage_stats.limit }} AI receipts used this {{ usage_stats.period }}
                    {% if not usage_stats.can_process %}<strong style="color:#f59e0b">- Limit reached!</strong>{% endif %}
                </small>
                {% else %}
                <small style="color:#10b981;font-size:13px">
                    <i class="fas fa-infinity"></i> Unlimited AI OCR processing
                </small>
                {% endif %}
            </div>
            {% if not usage_stats.can_process %}
            <a href="{{ url_for('main.upgrade') }}" class="btn btn--warning" style="white-space:nowrap">
                <i class="fas fa-arrow-up"></i> Upgrade Plan
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Upload Card -->
    <div class="card">
        <div class="card-body" style="padding:32px">

            <!-- Upload Form -->
            <form method="POST" enctype="multipart/form-data" id="upload-form">
                <!-- Hidden file input -->
                <input
                    type="file"
                    id="file-input"
                    name="receipt_image"
                    accept="image/*,.heic,.heif"
                    capture="environment"
                    style="display:none"
                >

                <!-- Single Upload Button -->
                <div style="margin-bottom:24px">
                    <button
                        type="button"
                        class="btn btn--primary btn--xl"
                        id="upload-btn-trigger"
                        style="width:100%;padding:24px;font-size:16px"
                        {% if usage_stats and not usage_stats.can_process %}disabled{% endif %}
                    >
                        <i class="fas fa-camera" style="font-size:20px;margin-right:12px"></i>
                        Upload or Take a Photo
                    </button>
                    <div style="text-align:center;margin-top:12px">
                        <small style="color:var(--sub);font-size:13px">
                            <i class="fas fa-check-circle" style="color:#10b981;margin-right:4px"></i>
                            JPG, PNG, GIF, HEIC • Min 800px • Max 10MB
                        </small>
                        <br>
                        <small style="color:var(--sub);font-size:12px;margin-top:4px;display:inline-block">
                            Auto-compressed to ~400KB for fast AI processing
                        </small>
                    </div>
                    {% if usage_stats and not usage_stats.can_process %}
                    <div style="background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.2);border-radius:8px;padding:12px;margin-top:16px;text-align:center">
                        <strong style="color:#f59e0b">Limit Reached:</strong>
                        <span style="color:var(--sub)">{{ usage_stats.message }}</span>
                        <a href="{{ url_for('main.upgrade') }}" style="color:#f59e0b;margin-left:8px">Upgrade your plan</a>
                    </div>
                    {% endif %}
                </div>

                <!-- Image Preview -->
                <div id="image-preview" style="display:none;margin-bottom:24px">
                    <label style="color:var(--text);font-weight:600;font-size:14px;display:block;margin-bottom:8px">Preview</label>
                    <div style="border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center;background:rgba(0,0,0,0.02)">
                        <img id="preview-img" src="" alt="Receipt preview" style="max-width:100%;max-height:400px;border-radius:4px">
                    </div>
                </div>

                <!-- Upload Actions -->
                <div id="upload-actions" style="display:none;gap:12px">
                    <button type="submit" class="btn btn--success" style="flex:1" id="submit-btn">
                        <i class="fas fa-check"></i> Upload & Process
                    </button>
                    <button type="button" class="btn btn--secondary" id="cancel-btn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>

                <!-- Loading State with Progress Bar -->
                <div id="upload-progress" style="display:none;margin-top:24px">
                    <div style="background:linear-gradient(135deg, rgba(139,92,246,0.05) 0%, rgba(59,130,246,0.05) 100%);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)">
                        <!-- Progress Bar -->
                        <div style="position:relative;background:rgba(0,0,0,0.05);height:8px;border-radius:4px;overflow:hidden;margin-bottom:16px">
                            <div id="progressBar" style="background:linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%);height:100%;width:0%;transition:width 0.5s ease;border-radius:4px;position:relative;overflow:hidden">
                                <!-- Shimmer effect -->
                                <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation:shimmer 2s infinite"></div>
                            </div>
                        </div>

                        <!-- Status Text -->
                        <div style="display:flex;align-items:center;gap:12px">
                            <div class="spinner-border" style="width:20px;height:20px;border-width:2.5px;color:#3b82f6" role="status">
                               <!--  <span class="visually-hidden">Loading...</span> -->
                            </div>
                            <div style="flex:1">
                                <strong id="progress-title" style="color:var(--text);display:block;margin-bottom:2px;font-size:14px">Processing receipt...</strong>
                                <small id="progress-text" style="color:var(--sub);font-size:12px">Uploading image and extracting text...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                @keyframes shimmer {
                    0% { left: -100%; }
                    100% { left: 100%; }
                }
                </style>
            </form>

            <!-- Info Section -->
            <div style="margin-top:40px;padding:24px;background:rgba(59,130,246,0.03);border:1px solid rgba(59,130,246,0.1);border-radius:8px">
                <h5 style="color:var(--text);font-size:16px;margin-bottom:16px;font-weight:600">
                    <i class="fas fa-info-circle" style="color:#3b82f6;margin-right:8px"></i>
                    How AI Receipt Processing Works
                </h5>
                <ol style="margin:0;padding-left:20px;color:var(--sub);line-height:1.8">
                    <li style="margin-bottom:8px">
                        <strong style="color:var(--text)">Upload:</strong> Take a photo or upload an existing image of your receipt
                    </li>
                    <li style="margin-bottom:8px">
                        <strong style="color:var(--text)">AI Extract:</strong> GPT-4 Vision AI automatically reads items, quantities, prices, and totals with high accuracy
                    </li>
                    <li style="margin-bottom:8px">
                        <strong style="color:var(--text)">Review:</strong> Check the extracted data and make corrections if needed
                    </li>
                    <li style="margin-bottom:0">
                        <strong style="color:var(--text)">Associate:</strong> Link items to your inventory or record as expenses for tracking
                    </li>
                </ol>
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(59,130,246,0.1)">
                    <small style="color:var(--sub);font-size:12px">
                        <i class="fas fa-bolt" style="color:#3b82f6;margin-right:4px"></i>
                        Powered by OpenAI GPT-4 Vision for best-in-class accuracy
                    </small>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Include heic2any library for HEIC conversion -->
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

<script>
/**
 * Convert HEIC/HEIF to JPEG using heic2any
 */
async function convertHEICtoJPEG(file) {
    try {
        console.log('Converting HEIC to JPEG...');
        const convertedBlob = await heic2any({
            blob: file,
            toType: 'image/jpeg',
            quality: 0.9
        });

        // Convert blob to File
        const convertedFile = new File(
            [convertedBlob],
            file.name.replace(/\.(heic|heif)$/i, '.jpg'),
            { type: 'image/jpeg' }
        );

        console.log('HEIC converted to JPEG successfully');
        return convertedFile;
    } catch (error) {
        console.error('HEIC conversion error:', error);
        throw new Error('Failed to convert HEIC image. Please try a different format.');
    }
}

/**
 * Compress image to target size (~400KB)
 */
function compressImage(file, maxSizeKB = 400) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = function(e) {
            const img = new Image();

            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Check minimum resolution for OCR accuracy
                const MIN_DIMENSION = 800;
                const minDimension = Math.min(width, height);

                if (minDimension < MIN_DIMENSION) {
                    reject(new Error(
                        `Image resolution too low (${width}x${height}). ` +
                        `Minimum ${MIN_DIMENSION}px required for accurate text extraction. ` +
                        `Please use a higher quality image.`
                    ));
                    return;
                }

                // Calculate scaling to reduce file size
                const MAX_DIMENSION = 1600;

                if (width > height && width > MAX_DIMENSION) {
                    height = Math.round((height * MAX_DIMENSION) / width);
                    width = MAX_DIMENSION;
                } else if (height > MAX_DIMENSION) {
                    width = Math.round((width * MAX_DIMENSION) / height);
                    height = MAX_DIMENSION;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Start with quality 0.85, reduce if needed
                let quality = 0.85;

                function tryCompress() {
                    canvas.toBlob(function(blob) {
                        const sizeKB = blob.size / 1024;

                        // If still too large and quality can be reduced, try again
                        if (sizeKB > maxSizeKB && quality > 0.5) {
                            quality -= 0.1;
                            tryCompress();
                        } else {
                            // Convert blob to File
                            const compressedFile = new File(
                                [blob],
                                file.name.replace(/\.[^.]+$/, '.jpg'),
                                { type: 'image/jpeg' }
                            );
                            resolve(compressedFile);
                        }
                    }, 'image/jpeg', quality);
                }

                tryCompress();
            };

            img.onerror = function() {
                reject(new Error('Failed to load image'));
            };

            img.src = e.target.result;
        };

        reader.onerror = function() {
            reject(new Error('Failed to read file'));
        };

        reader.readAsDataURL(file);
    });
}

// Single button handler
document.getElementById('upload-btn-trigger').addEventListener('click', function() {
    document.getElementById('file-input').click();
});

// Handle file selection
async function handleFileSelect(e) {
    let file = e.target.files[0];
    if (!file) {
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('upload-actions').style.display = 'none';
        return;
    }

    // Show original file info
    const fileSizeKB = Math.round(file.size / 1024);
    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
    console.log(`Selected file: ${file.name} - ${fileSizeKB}KB`);

    // Validation 1: File type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/heic', 'image/heif'];
    const isValidExtension = /\.(jpe?g|png|gif|heic|heif)$/i.test(file.name);

    if (!validTypes.includes(file.type) && !isValidExtension) {
        alert('Invalid file type. Please upload an image file (JPG, PNG, GIF, or HEIC).');
        e.target.value = '';
        return;
    }

    // Validation 2: Maximum file size (10MB before compression)
    const MAX_FILE_SIZE_MB = 10;
    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        alert(`File too large (${fileSizeMB}MB). Maximum size is ${MAX_FILE_SIZE_MB}MB. Please use a smaller image.`);
        e.target.value = '';
        return;
    }

    // Check if it's HEIC and convert to JPEG immediately
    const isHEIC = file.name.toLowerCase().match(/\.(heic|heif)$/);

    try {
        if (isHEIC) {
            // Show conversion progress
            const progressDiv = document.getElementById('upload-progress');
            const progressText = document.getElementById('progress-text');
            progressDiv.style.display = 'block';
            progressText.textContent = 'Converting HEIC to JPEG...';

            // Convert HEIC to JPEG
            file = await convertHEICtoJPEG(file);

            // Hide progress
            progressDiv.style.display = 'none';

            console.log(`Converted to: ${file.name} - ${Math.round(file.size / 1024)}KB`);
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('upload-actions').style.display = 'flex';
        };
        reader.readAsDataURL(file);

        // Store the converted file for upload
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('file-input').files = dataTransfer.files;

    } catch (error) {
        alert(error.message);
        document.getElementById('file-input').value = '';
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('upload-actions').style.display = 'none';
        document.getElementById('upload-progress').style.display = 'none';
    }
}

document.getElementById('file-input').addEventListener('change', handleFileSelect);

// Cancel button - reset everything
document.getElementById('cancel-btn').addEventListener('click', function() {
    document.getElementById('file-input').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('upload-actions').style.display = 'none';
});

// Form submission with compression
document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('file-input');
    const originalFile = fileInput.files[0];

    if (!originalFile) {
        alert('Please select a file to upload.');
        return;
    }

    // Show loading state
    const submitBtn = document.getElementById('submit-btn');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progressBar');
    const progressTitle = document.getElementById('progress-title');
    const progressText = document.getElementById('progress-text');
    const uploadActions = document.getElementById('upload-actions');

    submitBtn.disabled = true;
    uploadActions.style.display = 'none';
    progressDiv.style.display = 'block';

    // Helper to update progress
    function updateProgress(percent, title, text) {
        progressBar.style.width = percent + '%';
        progressTitle.textContent = title;
        progressText.textContent = text;
    }

    try {
        // Stage 1: Preparing
        updateProgress(10, 'Preparing upload...', 'Getting image ready for processing');
        await new Promise(resolve => setTimeout(resolve, 300));

        // Compress image if it's larger than 500KB
        const fileSizeKB = originalFile.size / 1024;
        let fileToUpload = originalFile;

        if (fileSizeKB > 500) {
            // Stage 2: Compressing
            updateProgress(25, 'Compressing image...', `Optimizing ${Math.round(fileSizeKB)}KB → ~400KB`);

            fileToUpload = await compressImage(originalFile, 400);

            const compressedSizeKB = Math.round(fileToUpload.size / 1024);
            console.log(`Compressed: ${Math.round(fileSizeKB)}KB → ${compressedSizeKB}KB`);
        }

        // Stage 3: Uploading
        updateProgress(50, 'Uploading to cloud...', `Sending image (${Math.round(fileToUpload.size / 1024)}KB) to server`);

        // Create FormData with compressed image
        const formData = new FormData();
        formData.append('receipt_image', fileToUpload);

        // Submit form via fetch
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            // Stage 4: Processing with AI
            updateProgress(75, 'Processing with AI...', 'GPT-4 Vision is extracting items and prices');
            await new Promise(resolve => setTimeout(resolve, 500));

            // Stage 5: Complete
            updateProgress(100, 'Complete!', 'Redirecting to receipt details...');
            await new Promise(resolve => setTimeout(resolve, 500));

            // Redirect to the response URL (receipt detail page)
            window.location.href = response.url;
        } else {
            throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
        }

    } catch (error) {
        console.error('Upload error:', error);
        alert(`Upload failed: ${error.message}`);
        submitBtn.disabled = false;
        uploadActions.style.display = 'flex';
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
    }
});
</script>
{% endblock %}
