{% extends "base.html" %}

{% block title %}Receipts - Qventory{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Receipts</h1>
        <a href="{{ url_for('receipts.upload') }}" class="btn btn-primary">
            <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Upload Receipt
        </a>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0">{{ stats.total_receipts }}</h3>
                    <small class="text-muted">Total</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0">{{ stats.extracted }}</h3>
                    <small class="text-muted">Extracted</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0">{{ stats.partially_associated }}</h3>
                    <small class="text-muted">In Progress</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0">{{ stats.completed }}</h3>
                    <small class="text-muted">Completed</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0">{{ stats.processing }}</h3>
                    <small class="text-muted">Processing</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="status" class="form-label">Status</label>
                    <select name="status" id="status" class="form-select" onchange="this.form.submit()">
                        <option value="all" {% if current_status == 'all' %}selected{% endif %}>All</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="processing" {% if current_status == 'processing' %}selected{% endif %}>Processing</option>
                        <option value="extracted" {% if current_status == 'extracted' %}selected{% endif %}>Extracted</option>
                        <option value="partially_associated" {% if current_status == 'partially_associated' %}selected{% endif %}>Partially Associated</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>Failed</option>
                        <option value="discarded" {% if current_status == 'discarded' %}selected{% endif %}>Discarded</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="sort" class="form-label">Sort By</label>
                    <select name="sort" id="sort" class="form-select" onchange="this.form.submit()">
                        <option value="date_desc" {% if current_sort == 'date_desc' %}selected{% endif %}>Date (Newest)</option>
                        <option value="date_asc" {% if current_sort == 'date_asc' %}selected{% endif %}>Date (Oldest)</option>
                        <option value="merchant" {% if current_sort == 'merchant' %}selected{% endif %}>Merchant</option>
                        <option value="total" {% if current_sort == 'total' %}selected{% endif %}>Total Amount</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipts List -->
    {% if receipts %}
    <div class="row">
        {% for receipt in receipts %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <!-- Receipt Image -->
                <a href="{{ url_for('receipts.view_receipt', receipt_id=receipt.id) }}">
                    <img
                        src="{{ receipt.thumbnail_url or receipt.image_url }}"
                        class="card-img-top"
                        alt="Receipt"
                        style="height: 200px; object-fit: cover;"
                    >
                </a>

                <div class="card-body">
                    <!-- Merchant Name -->
                    <h5 class="card-title">
                        {{ receipt.merchant_name or 'Unknown Merchant' }}
                    </h5>

                    <!-- Receipt Details -->
                    <p class="card-text small text-muted">
                        {% if receipt.receipt_date %}
                        <strong>Date:</strong> {{ receipt.receipt_date.strftime('%b %d, %Y') }}<br>
                        {% endif %}
                        {% if receipt.total_amount %}
                        <strong>Total:</strong> ${{ "%.2f"|format(receipt.total_amount) }}<br>
                        {% endif %}
                        <strong>Uploaded:</strong> {{ receipt.uploaded_at|timeago }}<br>
                        <strong>Items:</strong> {{ receipt.items_count }}
                    </p>

                    <!-- Status Badge -->
                    <div class="mb-2">
                        {% if receipt.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                        {% elif receipt.status == 'partially_associated' %}
                        <span class="badge bg-warning">In Progress</span>
                        {% elif receipt.status == 'extracted' %}
                        <span class="badge bg-info">Ready to Review</span>
                        {% elif receipt.status == 'processing' %}
                        <span class="badge bg-primary">Processing...</span>
                        {% elif receipt.status == 'failed' %}
                        <span class="badge bg-danger">Failed</span>
                        {% elif receipt.status == 'discarded' %}
                        <span class="badge bg-secondary">Discarded</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ receipt.status }}</span>
                        {% endif %}
                    </div>

                    <!-- Progress Bar -->
                    {% if receipt.items_count > 0 %}
                    <div class="mb-2">
                        <small class="text-muted">
                            {{ receipt.associated_items_count }}/{{ receipt.items_count }} items associated
                        </small>
                        <div class="progress" style="height: 5px;">
                            <div
                                class="progress-bar"
                                role="progressbar"
                                style="width: {{ receipt.association_progress }}%"
                                aria-valuenow="{{ receipt.association_progress }}"
                                aria-valuemin="0"
                                aria-valuemax="100"
                            ></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex gap-2">
                        <a
                            href="{{ url_for('receipts.view_receipt', receipt_id=receipt.id) }}"
                            class="btn btn-sm btn-primary flex-fill"
                        >
                            View Details
                        </a>
                        <button
                            class="btn btn-sm btn-outline-danger"
                            onclick="deleteReceipt({{ receipt.id }})"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
        <svg width="64" height="64" fill="currentColor" class="text-muted mb-3" viewBox="0 0 16 16">
            <path d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1h-3zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5zM.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5z"/>
        </svg>
        <h4>No receipts yet</h4>
        <p class="text-muted">Upload your first receipt to get started</p>
        <a href="{{ url_for('receipts.upload') }}" class="btn btn-primary">Upload Receipt</a>
    </div>
    {% endif %}
</div>

<script>
function deleteReceipt(receiptId) {
    if (!confirm('Are you sure you want to delete this receipt? This action cannot be undone.')) {
        return;
    }

    fetch(`/receipts/${receiptId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Delete failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Delete failed. Please try again.');
    });
}
</script>
{% endblock %}
