{% extends "base_new.html" %}

{% block title %}Receipts - Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">Receipts</span>
</nav>
{% endblock %}

{% block content %}
<div class="container page-shell page-shell--large">

    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;flex-wrap:wrap;gap:16px">
        <div>
            <h1 style="color:var(--text);font-size:28px;margin-bottom:8px">
                <i class="fas fa-receipt"></i> Receipts
            </h1>
            <p style="color:var(--sub);font-size:14px">
                Manage your receipts and track inventory purchases with AI-powered OCR
            </p>
        </div>
        <a href="{{ url_for('receipts.upload') }}" class="btn btn--primary">
            <i class="fas fa-plus"></i> Upload Receipt
        </a>
    </div>

    <!-- Statistics Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">
        <div class="metric-card">
            <div class="metric-label">Total</div>
            <div class="metric-value">{{ stats.total_receipts }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Extracted</div>
            <div class="metric-value" style="color:#3b82f6">{{ stats.extracted }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">In Progress</div>
            <div class="metric-value" style="color:#f59e0b">{{ stats.partially_associated }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Completed</div>
            <div class="metric-value" style="color:#10b981">{{ stats.completed }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Processing</div>
            <div class="metric-value" style="color:#8b5cf6">{{ stats.processing }}</div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card" style="margin-bottom:24px">
        <div class="card-body" style="padding:20px">
            <form method="GET" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px">
                <div>
                    <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:8px">
                        <i class="fas fa-filter" style="margin-right:6px"></i>Status
                    </label>
                    <select name="status" class="form-control" onchange="this.form.submit()"
                            style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px">
                        <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Receipts</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="processing" {% if current_status == 'processing' %}selected{% endif %}>Processing</option>
                        <option value="extracted" {% if current_status == 'extracted' %}selected{% endif %}>Extracted</option>
                        <option value="partially_associated" {% if current_status == 'partially_associated' %}selected{% endif %}>Partially Associated</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>Failed</option>
                        <option value="discarded" {% if current_status == 'discarded' %}selected{% endif %}>Discarded</option>
                    </select>
                </div>
                <div>
                    <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:8px">
                        <i class="fas fa-sort" style="margin-right:6px"></i>Sort By
                    </label>
                    <select name="sort" class="form-control" onchange="this.form.submit()"
                            style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px">
                        <option value="date_desc" {% if current_sort == 'date_desc' %}selected{% endif %}>Date (Newest First)</option>
                        <option value="date_asc" {% if current_sort == 'date_asc' %}selected{% endif %}>Date (Oldest First)</option>
                        <option value="merchant" {% if current_sort == 'merchant' %}selected{% endif %}>Merchant Name</option>
                        <option value="total" {% if current_sort == 'total' %}selected{% endif %}>Total Amount</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipts Grid -->
    {% if receipts %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px">
        {% for receipt in receipts %}
        <div class="card" style="overflow:hidden;transition:transform 0.2s,box-shadow 0.2s;cursor:pointer"
             onclick="window.location.href='{{ url_for('receipts.view_receipt', receipt_id=receipt.id) }}'"
             onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 16px rgba(0,0,0,0.12)'"
             onmouseout="this.style.transform='';this.style.boxShadow=''">

            <!-- Receipt Image -->
            <div style="position:relative;height:154px;overflow:hidden;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)">
                <img
                    src="{{ receipt.thumbnail_url or receipt.image_url }}"
                    alt="Receipt"
                    style="width:100%;height:100%;object-fit:cover;display:block"
                    loading="lazy"
                >

                <!-- Status Badge Overlay -->
                <div style="position:absolute;top:8px;right:8px">
                    {% if receipt.status == 'completed' %}
                    <span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        <i class="fas fa-check-circle"></i> Completed
                    </span>
                    {% elif receipt.status == 'partially_associated' %}
                    <span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        <i class="fas fa-clock"></i> In Progress
                    </span>
                    {% elif receipt.status == 'extracted' %}
                    <span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        <i class="fas fa-eye"></i> Ready
                    </span>
                    {% elif receipt.status == 'processing' %}
                    <span style="background:#8b5cf6;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        <i class="fas fa-spinner fa-spin"></i> Processing
                    </span>
                    {% elif receipt.status == 'failed' %}
                    <span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        <i class="fas fa-exclamation-circle"></i> Failed
                    </span>
                    {% elif receipt.status == 'discarded' %}
                    <span style="background:#6b7280;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        <i class="fas fa-trash"></i> Discarded
                    </span>
                    {% else %}
                    <span style="background:#6b7280;color:white;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.2);backdrop-filter:blur(4px)">
                        {{ receipt.status }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Card Body -->
            <div class="card-body" style="padding:14px">
                <!-- Merchant Name -->
                <h5 style="color:var(--text);font-size:13px;font-weight:600;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                    {{ receipt.merchant_name or 'Unknown Merchant' }}
                </h5>

                <!-- Receipt Details Grid -->
                <div style="display:grid;grid-template-columns:auto 1fr;gap:7px;color:var(--sub);font-size:11px;margin-bottom:11px">
                    {% if receipt.receipt_date %}
                    <div style="display:flex;align-items:center">
                        <i class="fas fa-calendar" style="width:12px;color:#3b82f6;font-size:10px"></i>
                    </div>
                    <div>
                        <span style="color:var(--sub)">Date:</span>
                        <strong style="color:var(--text);margin-left:3px">{{ receipt.receipt_date.strftime('%b %d, %Y') }}</strong>
                    </div>
                    {% endif %}

                    {% if receipt.total_amount %}
                    <div style="display:flex;align-items:center">
                        <i class="fas fa-dollar-sign" style="width:12px;color:#10b981;font-size:10px"></i>
                    </div>
                    <div>
                        <span style="color:var(--sub)">Total:</span>
                        <strong style="color:#10b981;font-size:12px;margin-left:3px">${{ "%.2f"|format(receipt.total_amount) }}</strong>
                    </div>
                    {% endif %}

                    <div style="display:flex;align-items:center">
                        <i class="fas fa-clock" style="width:12px;color:#f59e0b;font-size:10px"></i>
                    </div>
                    <div>
                        <span style="color:var(--sub)">Uploaded:</span>
                        <span style="color:var(--text);margin-left:3px">{{ receipt.uploaded_at|timeago }}</span>
                    </div>

                    <div style="display:flex;align-items:center">
                        <i class="fas fa-list" style="width:12px;color:#8b5cf6;font-size:10px"></i>
                    </div>
                    <div>
                        <span style="color:var(--sub)">Items:</span>
                        <strong style="color:var(--text);margin-left:3px">{{ receipt.items_count }}</strong>
                    </div>
                </div>

                <!-- Progress Bar -->
                {% if receipt.items_count > 0 %}
                <div style="margin-bottom:11px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <small style="color:var(--sub);font-size:10px;font-weight:500">
                            <i class="fas fa-link" style="margin-right:3px"></i>Progress
                        </small>
                        <small style="color:var(--text);font-weight:700;font-size:10px">{{ receipt.association_progress }}%</small>
                    </div>
                    <div style="background:rgba(0,0,0,0.06);height:6px;border-radius:3px;overflow:hidden">
                        <div style="background:{% if receipt.association_progress == 100 %}#10b981{% elif receipt.association_progress > 0 %}#f59e0b{% else %}#cbd5e1{% endif %};height:100%;width:{{ receipt.association_progress }}%;transition:width 0.4s ease;border-radius:3px"></div>
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div style="display:grid;grid-template-columns:1fr auto;gap:7px" onclick="event.stopPropagation()">
                    <button
                        onclick="window.location.href='{{ url_for('receipts.view_receipt', receipt_id=receipt.id) }}'"
                        class="btn btn--primary"
                        style="width:100%;font-size:11px;padding:7px"
                    >
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button
                        onclick="if(confirm('Delete this receipt? This cannot be undone.')) { deleteReceipt({{ receipt.id }}); }"
                        class="btn btn--danger"
                        style="font-size:11px;padding:7px 10px"
                        title="Delete Receipt"
                    >
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="card" style="text-align:center;padding:80px 20px">
        <div style="margin-bottom:24px">
            <i class="fas fa-receipt" style="font-size:80px;color:var(--sub);opacity:0.2"></i>
        </div>
        <h3 style="color:var(--text);font-size:24px;font-weight:600;margin-bottom:12px">No receipts yet</h3>
        <p style="color:var(--sub);font-size:15px;margin-bottom:32px;max-width:400px;margin-left:auto;margin-right:auto">
            Start tracking your expenses by uploading your first receipt. Our AI will automatically extract items, prices, and totals.
        </p>
        <a href="{{ url_for('receipts.upload') }}" class="btn btn--primary" style="padding:12px 32px;font-size:16px">
            <i class="fas fa-upload"></i> Upload Your First Receipt
        </a>
    </div>
    {% endif %}

</div>

<script>
function deleteReceipt(receiptId) {
    fetch(`/receipts/${receiptId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Delete failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Delete failed. Please try again.');
    });
}
</script>
{% endblock %}
