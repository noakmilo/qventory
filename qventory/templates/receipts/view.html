{% extends "base_new.html" %}

{% block title %}Receipt Details - Qventory{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <span class="breadcrumb-separator">/</span>
  <a href="{{ url_for('receipts.list_receipts') }}">Receipts</a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current">{{ receipt.merchant_name or 'Receipt #' + receipt.id|string }}</span>
</nav>
{% endblock %}

{% block content %}
<div class="container page-shell page-shell--large">
    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;flex-wrap:wrap;gap:16px">
        <div>
            <h1 style="color:var(--text);font-size:28px;margin-bottom:8px">
                <i class="fas fa-receipt"></i> {{ receipt.merchant_name or 'Receipt #' + receipt.id|string }}
            </h1>
            <p style="color:var(--sub);font-size:14px">
                <i class="fas fa-clock"></i> Uploaded {{ receipt.uploaded_at|timeago }}
                {% if receipt.receipt_date %}
                <span style="margin:0 8px">â€¢</span>
                <i class="fas fa-calendar"></i> {{ receipt.receipt_date.strftime('%b %d, %Y') }}
                {% endif %}
            </p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            {% if receipt.status not in ['completed', 'discarded'] %}
            <form method="POST" action="{{ url_for('receipts.mark_complete', receipt_id=receipt.id) }}" style="display: inline;">
                <button type="submit" class="btn btn--success">
                    <i class="fas fa-check"></i> Mark Complete
                </button>
            </form>
            <form method="POST" action="{{ url_for('receipts.discard_receipt', receipt_id=receipt.id) }}" style="display: inline;">
                <button type="submit" class="btn btn--secondary">
                    <i class="fas fa-trash"></i> Discard
                </button>
            </form>
            {% endif %}
            <a href="{{ url_for('receipts.list_receipts') }}" class="btn btn--secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Processing State Banner -->
    {% if receipt.status == 'processing' %}
    <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, rgba(139,92,246,0.05) 0%, rgba(59,130,246,0.05) 100%);border:1px solid rgba(139,92,246,0.2)">
        <div class="card-body" style="padding:32px;text-align:center">
            <div style="margin-bottom:20px">
                <div style="display:inline-block;position:relative">
                    <i class="fas fa-robot" style="font-size:64px;color:#8b5cf6;animation:pulse 2s infinite"></i>
                    <div style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;border:3px solid #8b5cf6;opacity:0.3;animation:ripple 2s infinite"></div>
                </div>
            </div>

            <h3 style="color:var(--text);font-size:24px;font-weight:600;margin-bottom:8px">
                AI Processing Your Receipt
            </h3>
            <p style="color:var(--sub);font-size:15px;margin-bottom:24px">
                Our AI is reading and extracting items, prices, and totals from your receipt...
            </p>

            <!-- Animated Progress Bar -->
            <div style="max-width:500px;margin:0 auto 20px">
                <div style="background:rgba(0,0,0,0.08);height:12px;border-radius:6px;overflow:hidden;position:relative">
                    <div id="progressBar" style="background:linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%);height:100%;width:0%;transition:width 0.5s ease;border-radius:6px;position:relative;overflow:hidden">
                        <!-- Shimmer effect -->
                        <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation:shimmer 2s infinite"></div>
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:8px">
                    <small id="progressText" style="color:var(--sub);font-size:13px">Analyzing image...</small>
                    <small id="progressPercent" style="color:var(--text);font-weight:600;font-size:13px">0%</small>
                </div>
            </div>

            <!-- Processing Steps -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;max-width:600px;margin:24px auto 0">
                <div class="processing-step" data-step="1" style="padding:12px;background:rgba(139,92,246,0.08);border-radius:8px;border:1px solid rgba(139,92,246,0.15)">
                    <i class="fas fa-upload" style="font-size:20px;color:#8b5cf6;margin-bottom:8px"></i>
                    <div style="font-size:12px;color:var(--sub)">Uploading</div>
                </div>
                <div class="processing-step" data-step="2" style="padding:12px;background:rgba(0,0,0,0.02);border-radius:8px;border:1px solid var(--border)">
                    <i class="fas fa-eye" style="font-size:20px;color:var(--sub);margin-bottom:8px"></i>
                    <div style="font-size:12px;color:var(--sub)">Reading</div>
                </div>
                <div class="processing-step" data-step="3" style="padding:12px;background:rgba(0,0,0,0.02);border-radius:8px;border:1px solid var(--border)">
                    <i class="fas fa-list" style="font-size:20px;color:var(--sub);margin-bottom:8px"></i>
                    <div style="font-size:12px;color:var(--sub)">Extracting</div>
                </div>
                <div class="processing-step" data-step="4" style="padding:12px;background:rgba(0,0,0,0.02);border-radius:8px;border:1px solid var(--border)">
                    <i class="fas fa-check" style="font-size:20px;color:var(--sub);margin-bottom:8px"></i>
                    <div style="font-size:12px;color:var(--sub)">Complete</div>
                </div>
            </div>

            <div style="margin-top:24px;padding-top:24px;border-top:1px solid rgba(0,0,0,0.05)">
                <small style="color:var(--sub);font-size:12px">
                    <i class="fas fa-info-circle" style="margin-right:4px"></i>
                    This usually takes 10-30 seconds. The page will automatically refresh when ready.
                </small>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>

    <script>
        // Auto-refresh progress simulation and actual page refresh
        let progress = 0;
        let currentStep = 1;
        const steps = [
            { percent: 25, text: "Uploading to AI...", duration: 2000 },
            { percent: 50, text: "Reading receipt with GPT-4 Vision...", duration: 8000 },
            { percent: 75, text: "Extracting items and prices...", duration: 5000 },
            { percent: 95, text: "Finalizing...", duration: 3000 }
        ];

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');

            if (currentStep <= steps.length) {
                const step = steps[currentStep - 1];

                // Update progress bar
                progressBar.style.width = step.percent + '%';
                progressText.textContent = step.text;
                progressPercent.textContent = step.percent + '%';

                // Update step indicators
                document.querySelectorAll('.processing-step').forEach((el, idx) => {
                    if (idx + 1 <= currentStep) {
                        el.style.background = 'rgba(139,92,246,0.08)';
                        el.style.borderColor = 'rgba(139,92,246,0.15)';
                        el.querySelector('i').style.color = '#8b5cf6';
                    }
                });

                currentStep++;

                // Schedule next step
                if (currentStep <= steps.length) {
                    setTimeout(updateProgress, step.duration);
                }
            }
        }

        // Start progress animation
        setTimeout(updateProgress, 1000);

        // Auto-refresh page every 5 seconds to check status
        let refreshInterval = setInterval(() => {
            fetch(window.location.href, { method: 'HEAD' })
                .then(() => {
                    // Refresh the page
                    window.location.reload();
                })
                .catch(err => console.error('Refresh check failed:', err));
        }, 5000);

        // Stop refreshing after 2 minutes (in case something went wrong)
        setTimeout(() => {
            clearInterval(refreshInterval);
            console.log('Auto-refresh stopped after 2 minutes');
        }, 120000);
    </script>
    {% endif %}

    <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:24px;align-items:start">
    <style>
        @media (max-width: 992px) {
            div[style*="grid-template-columns:1fr 1.5fr"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
        <!-- Left Column: Receipt Image -->
        <div style="position:sticky;top:20px">
            <div class="card">
                <div class="card-body" style="padding:0">
                    <!-- Image Header -->
                    <div style="padding:20px;border-bottom:1px solid var(--border)">
                        <h5 style="color:var(--text);font-size:16px;font-weight:600;margin:0;display:flex;align-items:center;gap:8px">
                            <i class="fas fa-image" style="color:var(--primary)"></i>
                            Receipt Image
                        </h5>
                    </div>

                    <!-- Image Content -->
                    <div style="padding:20px;text-align:center">
                        <div style="border:1px solid var(--border);border-radius:8px;padding:12px;background:rgba(0,0,0,0.02);margin-bottom:12px">
                            <img
                                src="{{ receipt.image_url }}"
                                alt="Receipt"
                                style="max-width:100%;max-height:500px;border-radius:6px;cursor:pointer;transition:transform 0.2s"
                                onclick="window.open(this.src, '_blank')"
                                onmouseover="this.style.transform='scale(1.02)'"
                                onmouseout="this.style.transform='scale(1)'"
                            >
                        </div>
                        <p style="color:var(--sub);font-size:13px;margin:0">
                            <i class="fas fa-search-plus" style="margin-right:4px"></i>
                            Click to view full size
                        </p>
                    </div>

                    <!-- Receipt Summary Footer -->
                    <div style="padding:20px;border-top:1px solid var(--border);background:rgba(0,0,0,0.01)">
                        <!-- Status Badge -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                            <strong style="color:var(--text);font-size:14px">Status:</strong>
                            {% if receipt.status == 'completed' %}
                            <span style="background:#10b981;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                                <i class="fas fa-check-circle"></i> Completed
                            </span>
                            {% elif receipt.status == 'partially_associated' %}
                            <span style="background:#f59e0b;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                                <i class="fas fa-clock"></i> In Progress
                            </span>
                            {% elif receipt.status == 'extracted' %}
                            <span style="background:#3b82f6;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                                <i class="fas fa-info-circle"></i> Ready to Review
                            </span>
                            {% elif receipt.status == 'processing' %}
                            <span style="background:#8b5cf6;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                                <span class="spinner-border" style="width:12px;height:12px;border-width:2px"></span> Processing...
                            </span>
                            {% elif receipt.status == 'failed' %}
                            <span style="background:#ef4444;color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px">
                                <i class="fas fa-times-circle"></i> Failed
                            </span>
                            {% else %}
                            <span style="background:var(--sub);color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600">{{ receipt.status }}</span>
                            {% endif %}
                        </div>

                        {% if receipt.total_amount %}
                        <!-- Totals -->
                        <div style="margin-bottom:16px">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                <span style="color:var(--sub);font-size:13px">Subtotal:</span>
                                <span style="color:var(--text);font-weight:500;font-size:13px">${{ "%.2f"|format(receipt.subtotal or 0) }}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                                <span style="color:var(--sub);font-size:13px">Tax:</span>
                                <span style="color:var(--text);font-weight:500;font-size:13px">${{ "%.2f"|format(receipt.tax_amount or 0) }}</span>
                            </div>
                            <div style="border-top:1px solid var(--border);padding-top:12px;display:flex;justify-content:space-between;align-items:center">
                                <strong style="color:var(--text);font-size:14px">Total:</strong>
                                <strong style="color:#10b981;font-size:20px">${{ "%.2f"|format(receipt.total_amount) }}</strong>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Progress Bar -->
                        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <small style="color:var(--sub);font-size:12px">
                                    <i class="fas fa-link" style="margin-right:4px"></i>
                                    {{ receipt.associated_items_count }}/{{ receipt.items_count }} items linked
                                </small>
                                <small style="color:var(--text);font-weight:600;font-size:12px">{{ receipt.association_progress }}%</small>
                            </div>
                            <div style="background:rgba(0,0,0,0.08);height:8px;border-radius:4px;overflow:hidden">
                                <div style="background:#10b981;height:100%;width:{{ receipt.association_progress }}%;transition:width 0.3s;border-radius:4px"></div>
                            </div>
                        </div>

                        {% if receipt.ocr_confidence %}
                        <!-- AI Info -->
                        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                            <small style="color:var(--sub);font-size:12px;display:block;margin-bottom:6px">
                                <i class="fas fa-robot" style="margin-right:4px;color:#8b5cf6"></i>
                                AI Confidence: <strong style="color:var(--text)">{{ "%.0f"|format(receipt.ocr_confidence * 100) }}%</strong>
                            </small>
                            <small style="color:var(--sub);font-size:12px;display:block">
                                <i class="fas fa-brain" style="margin-right:4px;color:#3b82f6"></i>
                                Provider: <strong style="color:var(--text)">{{ receipt.ocr_provider or 'GPT-4 Vision' }}</strong>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Line Items -->
        <div>
            <div class="card">
                <div class="card-body" style="padding:0">
                    <!-- Items Header -->
                    <div style="padding:20px;border-bottom:1px solid var(--border)">
                        <h5 style="color:var(--text);font-size:16px;font-weight:600;margin:0;display:flex;align-items:center;gap:8px">
                            <i class="fas fa-list" style="color:var(--primary)"></i>
                            Receipt Items ({{ receipt_items|length }})
                        </h5>
                    </div>

                    <!-- Items Content -->
                    <div style="padding:20px">
                    {% if receipt_items %}
                    <div class="receipt-items">
                        {% for item in receipt_items %}
                        <div class="receipt-item mb-4 pb-4 border-bottom" data-item-id="{{ item.id }}">
                            <!-- Item Header -->
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        {{ item.line_number }}. {{ item.final_description }}
                                    </h6>
                                    <p class="text-muted small mb-0">
                                        Qty: {{ item.final_quantity }}
                                        {% if item.final_unit_price %}
                                        @ ${{ "%.2f"|format(item.final_unit_price) }}
                                        {% endif %}
                                        {% if item.final_total_price %}
                                        = <strong>${{ "%.2f"|format(item.final_total_price) }}</strong>
                                        {% endif %}
                                    </p>
                                </div>

                                <!-- Association Status -->
                                <div>
                                    {% if item.inventory_item_id %}
                                    <span class="badge bg-success">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                        </svg>
                                        Inventory
                                    </span>
                                    {% elif item.expense_id %}
                                    <span class="badge bg-info">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                        </svg>
                                        Expense
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">Not Associated</span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Association Details (if associated) -->
                            {% if item.inventory_item %}
                            <div class="alert alert-success py-2 mb-2">
                                <small>
                                    <strong>Linked to:</strong> {{ item.inventory_item.title }} ({{ item.inventory_item.sku }})
                                    <br>
                                    <strong>Location:</strong> {{ item.inventory_item.location_code or 'N/A' }}
                                </small>
                            </div>
                            {% elif item.expense %}
                            <div class="alert alert-info py-2 mb-2">
                                <small>
                                    <strong>Expense:</strong> {{ item.expense.description }}
                                    <br>
                                    <strong>Category:</strong> {{ item.expense.category }}
                                </small>
                            </div>
                            {% endif %}

                            <!-- Association Actions -->
                            <div class="association-controls">
                                {% if not item.is_associated %}
                                <!-- Associate with Inventory -->
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Associate with Inventory Item:</label>
                                    <div class="input-group input-group-sm">
                                        <input
                                            type="text"
                                            class="form-control inventory-autocomplete"
                                            placeholder="Type to search items..."
                                            data-receipt-item-id="{{ item.id }}"
                                        >
                                        <button
                                            class="btn btn-outline-primary associate-inventory-btn"
                                            type="button"
                                            data-receipt-item-id="{{ item.id }}"
                                            disabled
                                        >
                                            Link
                                        </button>
                                    </div>
                                    <div class="form-check form-check-sm mt-1">
                                        <input
                                            class="form-check-input update-cost-checkbox"
                                            type="checkbox"
                                            id="update-cost-{{ item.id }}"
                                            checked
                                        >
                                        <label class="form-check-label small" for="update-cost-{{ item.id }}">
                                            Update item cost to ${{ "%.2f"|format(item.final_unit_price or 0) }}
                                        </label>
                                    </div>
                                </div>

                                <!-- OR -->
                                <div class="text-center text-muted small my-2">â€” OR â€”</div>

                                <!-- Record as Expense -->
                                <button
                                    class="btn btn-sm btn-outline-info w-100 record-expense-btn"
                                    type="button"
                                    data-receipt-item-id="{{ item.id }}"
                                    data-description="{{ item.final_description }}"
                                    data-amount="{{ item.final_total_price or 0 }}"
                                >
                                    Record as Expense
                                </button>
                                {% else %}
                                <!-- Remove Association -->
                                <button
                                    class="btn btn-sm btn-outline-danger w-100 remove-association-btn"
                                    type="button"
                                    data-receipt-item-id="{{ item.id }}"
                                    data-has-expense="{{ 'true' if item.expense_id else 'false' }}"
                                >
                                    Remove Association
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align:center;padding:40px 20px;color:var(--sub)">
                        <i class="fas fa-inbox" style="font-size:48px;color:var(--border);margin-bottom:16px"></i>
                        <p style="font-size:15px;margin:0">No items extracted from this receipt.</p>
                        {% if receipt.status == 'failed' %}
                        <p style="font-size:13px;color:#ef4444;margin-top:8px">
                            <i class="fas fa-exclamation-circle"></i> OCR processing failed: {{ receipt.ocr_error_message }}
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div id="inventory-items-data" style="display: none;">
    {{ inventory_items|tojson }}
</div>

<!-- Add Expense Modal (from expenses.html) -->
<div id="expenseModal" class="modal" hidden>
  <div class="modal__backdrop" onclick="closeExpenseModal()"></div>
  <div class="modal__dialog" style="max-width:600px">
    <div class="modal__header">
      <h3 id="modalTitle">Record as Expense</h3>
      <button class="modal__close" onclick="closeExpenseModal()">Ã—</button>
    </div>

    <form id="expenseForm" onsubmit="saveExpenseFromReceipt(event)">
      <div class="modal__body">
        <input type="hidden" id="receiptItemId">

        <div class="form-group" style="margin-bottom:16px">
          <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:6px">Description *</label>
          <input type="text" id="expense_description" required class="form-control"
                 placeholder="e.g., Shipping boxes, Garage rent, Gas"
                 style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div class="form-group">
            <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:6px">Amount *</label>
            <input type="number" id="expense_amount" step="0.01" required class="form-control"
                   placeholder="0.00"
                   style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)">
          </div>

          <div class="form-group">
            <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:6px">Date *</label>
            <input type="date" id="expense_date" required class="form-control"
                   style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)">
          </div>
        </div>

        <div class="form-group" style="margin-bottom:16px">
          <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:6px">Category</label>
          <select id="expense_category" class="form-control"
                  style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)">
            <option value="">Select category...</option>
            <option value="Inventory">Inventory</option>
            <option value="Shipping">Shipping</option>
            <option value="Supplies">Supplies</option>
            <option value="Rent">Rent</option>
            <option value="Transportation">Transportation</option>
            <option value="Marketing">Marketing</option>
            <option value="Equipment">Equipment</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label style="color:var(--text);font-weight:600;font-size:13px;display:block;margin-bottom:6px">Notes (optional)</label>
          <textarea id="expense_notes" rows="3" class="form-control"
                    placeholder="Additional details..."
                    style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)"></textarea>
        </div>
      </div>

      <div class="modal__footer" style="display:flex;gap:12px;justify-content:flex-end;padding:16px;border-top:1px solid var(--border)">
        <button type="button" class="btn btn--secondary" onclick="closeExpenseModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">
          <i class="fas fa-save"></i> Save Expense
        </button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='receipts.js') }}"></script>

<script>
// Expense Modal Functions
function openExpenseModal(receiptItemId, description, amount) {
    document.getElementById('receiptItemId').value = receiptItemId;
    document.getElementById('expense_description').value = description || '';
    document.getElementById('expense_amount').value = amount || '';
    document.getElementById('expense_date').valueAsDate = new Date();
    document.getElementById('expense_category').value = 'Inventory'; // Default to Inventory
    document.getElementById('expense_notes').value = '';
    document.getElementById('expenseModal').hidden = false;
}

function closeExpenseModal() {
    document.getElementById('expenseModal').hidden = true;
}

async function saveExpenseFromReceipt(e) {
    e.preventDefault();

    const receiptItemId = document.getElementById('receiptItemId').value;
    const description = document.getElementById('expense_description').value;
    const amount = parseFloat(document.getElementById('expense_amount').value);
    const category = document.getElementById('expense_category').value || 'Receipt Item';
    const expenseDate = document.getElementById('expense_date').value;
    const notes = document.getElementById('expense_notes').value;

    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

    try {
        const response = await fetch(`/receipts/${getReceiptId()}/associate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                receipt_item_id: receiptItemId,
                association_type: 'expense',
                expense_description: description,
                expense_amount: amount,
                expense_category: category,
                expense_date: expenseDate,
                expense_notes: notes
            })
        });

        const data = await response.json();

        if (data.success) {
            closeExpenseModal();
            window.location.reload();
        } else {
            alert('Expense creation failed: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Expense creation failed. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function getReceiptId() {
    const pathParts = window.location.pathname.split('/');
    return pathParts[pathParts.length - 1];
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('expenseModal').hidden) {
        closeExpenseModal();
    }
});
</script>

{% endblock %}
