{% extends "base.html" %}
{% block title %}Reset Password – Qventory{% endblock %}
{% block content %}
<div class="card" style="max-width:480px;margin:0 auto;padding:40px 32px;">
  <!-- Header with Icon -->
  <div style="text-align:center;margin-bottom:32px;">
    <div style="width:80px;height:80px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:20px;display:inline-flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 4px 20px rgba(245,158,11,0.3);">
      <i class="fas fa-lock-open" style="font-size:36px;color:white;"></i>
    </div>
    <h2 style="margin:0 0 12px 0;font-size:24px;font-weight:700;">Reset your password</h2>
    <p style="color:var(--text-secondary);margin:0;font-size:15px;">Enter the code sent to</p>
    <p style="font-weight:600;color:#f59e0b;margin:8px 0 0 0;font-size:15px;">{{ email }}</p>
  </div>

  <form method="post" id="resetForm">
    <input type="hidden" name="email" value="{{ email }}">
    <input type="hidden" name="code" id="codeInput">

    <!-- Verification Code -->
    <div style="margin-bottom:24px;">
      <label style="display:block;margin-bottom:12px;font-weight:600;font-size:14px;color:var(--text);">Verification code</label>

      <div id="codeInputs" style="display:flex;gap:12px;justify-content:center;margin-bottom:16px;">
        <input type="text" maxlength="1" class="code-digit" data-index="0" inputmode="numeric" pattern="[0-9]" autocomplete="off"
          style="width:56px;height:64px;text-align:center;font-size:28px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text);transition:all 0.2s;font-family:monospace;">
        <input type="text" maxlength="1" class="code-digit" data-index="1" inputmode="numeric" pattern="[0-9]" autocomplete="off"
          style="width:56px;height:64px;text-align:center;font-size:28px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text);transition:all 0.2s;font-family:monospace;">
        <input type="text" maxlength="1" class="code-digit" data-index="2" inputmode="numeric" pattern="[0-9]" autocomplete="off"
          style="width:56px;height:64px;text-align:center;font-size:28px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text);transition:all 0.2s;font-family:monospace;">
        <input type="text" maxlength="1" class="code-digit" data-index="3" inputmode="numeric" pattern="[0-9]" autocomplete="off"
          style="width:56px;height:64px;text-align:center;font-size:28px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text);transition:all 0.2s;font-family:monospace;">
        <input type="text" maxlength="1" class="code-digit" data-index="4" inputmode="numeric" pattern="[0-9]" autocomplete="off"
          style="width:56px;height:64px;text-align:center;font-size:28px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text);transition:all 0.2s;font-family:monospace;">
        <input type="text" maxlength="1" class="code-digit" data-index="5" inputmode="numeric" pattern="[0-9]" autocomplete="off"
          style="width:56px;height:64px;text-align:center;font-size:28px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text);transition:all 0.2s;font-family:monospace;">
      </div>

      <div style="text-align:center;">
        <p class="tag" style="display:inline-flex;align-items:center;gap:6px;background:var(--surface-secondary);padding:8px 16px;border-radius:8px;">
          <i class="fas fa-clock" style="color:#f59e0b;"></i>
          <span style="color:var(--text-secondary);font-size:13px;">Expires in 15 minutes</span>
        </p>
      </div>
    </div>

    <!-- New Password Fields (shown after code validation) -->
    <div id="passwordFields" style="display:none;">
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:var(--text);">New Password</label>
        <input class="input" type="password" name="new_password" id="newPassword" minlength="6" placeholder="••••••••">
      </div>

      <div style="margin-bottom:24px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:var(--text);">Confirm New Password</label>
        <input class="input" type="password" name="confirm_password" id="confirmPassword" minlength="6" placeholder="••••••••">
      </div>

      <button class="btn submitbtn" type="submit" style="width:100%;">
        Reset Password
      </button>
    </div>
  </form>

  <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);text-align:center;">
    <p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px;">Didn't receive the code?</p>
    <form method="post" action="{{ url_for('auth.resend_reset_code') }}" style="display:inline;">
      <input type="hidden" name="email" value="{{ email }}">
      <button class="btn" type="submit" style="background:var(--surface-secondary);">
        <i class="fas fa-redo"></i> Resend Code
      </button>
    </form>
  </div>

  <div style="margin-top:16px;text-align:center;">
    <a href="{{ url_for('auth.login') }}" style="color:var(--text-secondary);font-size:14px;">
      <i class="fas fa-arrow-left"></i> Back to Sign In
    </a>
  </div>
</div>

<style>
.code-digit:focus {
  outline: none;
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

.code-digit:hover {
  border-color: #f59e0b;
}

.code-digit.filled {
  border-color: #f59e0b;
  background: rgba(245, 158, 11, 0.05);
}

.code-digit.error {
  border-color: #ef4444;
  animation: shake 0.3s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}

.code-digit.success {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.05);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
(function() {
  const inputs = document.querySelectorAll('.code-digit');
  const hiddenInput = document.getElementById('codeInput');
  const passwordFields = document.getElementById('passwordFields');

  inputs[0].focus();

  inputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      const value = e.target.value;
      if (!/^\d*$/.test(value)) {
        e.target.value = '';
        return;
      }
      if (value) {
        input.classList.add('filled');
        if (index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      } else {
        input.classList.remove('filled');
      }
      checkCompletion();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        inputs[index - 1].focus();
        inputs[index - 1].value = '';
        inputs[index - 1].classList.remove('filled');
      }
      if (e.key === 'ArrowLeft' && index > 0) {
        e.preventDefault();
        inputs[index - 1].focus();
      }
      if (e.key === 'ArrowRight' && index < inputs.length - 1) {
        e.preventDefault();
        inputs[index + 1].focus();
      }
    });

    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedData = e.clipboardData.getData('text').trim();
      if (/^\d{6}$/.test(pastedData)) {
        pastedData.split('').forEach((char, i) => {
          if (inputs[i]) {
            inputs[i].value = char;
            inputs[i].classList.add('filled');
          }
        });
        checkCompletion();
      }
    });

    input.addEventListener('keypress', (e) => {
      if (!/\d/.test(e.key)) e.preventDefault();
    });
  });

  function checkCompletion() {
    const code = Array.from(inputs).map(input => input.value).join('');
    if (code.length === 6) {
      inputs.forEach(input => {
        input.classList.add('success');
        input.disabled = true;
      });
      hiddenInput.value = code;
      setTimeout(() => {
        passwordFields.style.display = 'block';
        passwordFields.style.animation = 'fadeIn 0.3s ease-in';
        document.getElementById('newPassword').focus();
      }, 300);
    }
  }
})();
</script>
{% endblock %}
