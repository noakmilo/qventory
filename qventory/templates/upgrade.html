{% extends "base_new.html" %}
{% block title %}Upgrade Plan – Qventory{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Upgrade</span>
{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 1400px; margin: 0 auto;">
  <div style="text-align: center; margin-bottom: 40px;">
    <h1 style="margin-bottom: 8px; font-size: 2.5rem;">Choose Your Plan</h1>
    <p style="color: var(--sub); font-size: 1.1rem;">
      Select the plan that best fits your inventory needs. Every plan includes a {{ trial_days }}-day trial before billing starts, and you can cancel anytime with no fees.
    </p>

    {% if items_remaining is not none %}
    <div style="margin-top: 20px; padding: 16px; background: var(--warning-bg, #fff3cd); border: 1px solid var(--warning-border, #ffc107); border-radius: var(--radius); max-width: 600px; margin-left: auto; margin-right: auto;">
      <i class="fas fa-exclamation-triangle" style="color: var(--warning, #856404);"></i>
      <strong style="color: var(--warning, #856404);">
        You have {{ items_remaining }} items remaining in your current plan.
      </strong>
    </div>
    {% endif %}
  </div>

  <!-- Current Plan Badge -->
  {% if current_user_plan %}
  <div style="text-align: center; margin-bottom: 24px;">
    <span style="display: inline-block; padding: 8px 16px; background: var(--accent); color: white; border-radius: 20px; font-size: var(--fs-sm); font-weight: 600;">
      Current Plan: {{ current_user_plan.replace('_', ' ').title() }}
    </span>
  </div>
  {% endif %}

  <!-- Plans Grid -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 40px;">
    {% for plan in plans %}
    <div class="glass" style="padding: 24px; border-radius: var(--radius); {% if plan.plan == current_user_plan %}border: 2px solid var(--accent); box-shadow: 0 0 20px rgba(var(--accent-rgb, 59, 130, 246), 0.3);{% else %}border: 1px solid var(--border);{% endif %} display: flex; flex-direction: column;">

      <!-- Plan Header -->
      <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="margin: 0 0 8px 0; font-size: 1.8rem; text-transform: capitalize; color: var(--accent);">
          {{ plan.plan.replace('_', ' ').title() }}
        </h2>

        {% if plan.plan == current_user_plan %}
        <span style="display: inline-block; padding: 4px 12px; background: var(--accent); color: white; border-radius: 12px; font-size: var(--fs-xs); font-weight: 600; margin-bottom: 12px;">
          Current Plan
        </span>
        {% endif %}

        <!-- Pricing Placeholder -->
        <div style="margin-top: 12px;">
          <span style="font-size: 2.5rem; font-weight: 700; color: var(--text);">
            {% if plan.monthly_price is not none %}
              ${{ "%.2f"|format(plan.monthly_price) }}
            {% else %}
              Custom
            {% endif %}
          </span>
          {% if plan.monthly_price is not none %}
          <span style="color: var(--sub); font-size: var(--fs-sm);">/month</span>
          {% endif %}
        </div>
      </div>

      <!-- Items Limit -->
      <div style="padding: 16px; background: var(--muted); border-radius: 8px; margin-bottom: 16px; text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">
          {% if plan.max_items is none %}
          ∞
          {% else %}
          {{ plan.max_items }}
          {% endif %}
        </div>
        <div style="color: var(--sub); font-size: var(--fs-sm); margin-top: 4px;">
          {% if plan.max_items is none %}
          Unlimited Items
          {% else %}
          Max Items
          {% endif %}
        </div>
      </div>

      <!-- Features List -->
      <div style="flex: 1; margin-bottom: 20px;">
        {% set token_config = token_configs.get(plan.plan) %}
        {% set free_all_access = plan.plan == 'free' %}
        <ul style="list-style: none; padding: 0; margin: 0; color: var(--text);">
          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas fa-warehouse" style="width: 20px; color: var(--accent);"></i>
            <span>Active Inventory + A/B/S/C locations</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas fa-receipt" style="width: 20px; color: var(--accent);"></i>
            <span>Receipts + expense tracking</span>
          </li>

          {% set ai_enabled = free_all_access or plan.can_use_ai_research %}
          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas {% if ai_enabled %}fa-check-circle{% else %}fa-times-circle{% endif %}" style="width: 20px; color: {% if ai_enabled %}var(--success, #10b981){% else %}var(--sub){% endif %};"></i>
            <span style="{% if not ai_enabled %}color: var(--sub); text-decoration: line-through;{% endif %}">AI Research</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas fa-bolt" style="width: 20px; color: var(--accent);"></i>
            <span>
              {% if token_config %}
                {{ token_config.daily_tokens }} AI tokens / day
              {% else %}
                AI tokens / day
              {% endif %}
            </span>
          </li>

          {% set bulk_enabled = free_all_access or plan.can_bulk_operations %}
          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas {% if bulk_enabled %}fa-check-circle{% else %}fa-times-circle{% endif %}" style="width: 20px; color: {% if bulk_enabled %}var(--success, #10b981){% else %}var(--sub){% endif %};"></i>
            <span style="{% if not bulk_enabled %}color: var(--sub); text-decoration: line-through;{% endif %}">Bulk Operations</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas {% if plan.can_export_csv %}fa-check-circle{% else %}fa-times-circle{% endif %}" style="width: 20px; color: {% if plan.can_export_csv %}var(--success, #10b981){% else %}var(--sub){% endif %};"></i>
            <span style="{% if not plan.can_export_csv %}color: var(--sub); text-decoration: line-through;{% endif %}">Export CSV</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas {% if plan.can_import_csv %}fa-check-circle{% else %}fa-times-circle{% endif %}" style="width: 20px; color: {% if plan.can_import_csv %}var(--success, #10b981){% else %}var(--sub){% endif %};"></i>
            <span style="{% if not plan.can_import_csv %}color: var(--sub); text-decoration: line-through;{% endif %}">Import CSV</span>
          </li>

          {% set analytics_enabled = free_all_access or plan.can_use_analytics %}
          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas {% if analytics_enabled %}fa-check-circle{% else %}fa-times-circle{% endif %}" style="width: 20px; color: {% if analytics_enabled %}var(--success, #10b981){% else %}var(--sub){% endif %};"></i>
            <span style="{% if not analytics_enabled %}color: var(--sub); text-decoration: line-through;{% endif %}">Analytics</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas fa-truck" style="width: 20px; color: var(--accent);"></i>
            <span>Fulfillment tracking</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas fa-file-invoice-dollar" style="width: 20px; color: var(--accent);"></i>
            <span>Tax reports</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <i class="fas fa-undo-alt" style="width: 20px; color: var(--accent);"></i>
            <span>Auto-relist rules</span>
          </li>

          <li style="display: flex; align-items: center; gap: 12px; padding: 8px 0;">
            <i class="fas fa-headset" style="width: 20px; color: var(--accent);"></i>
            <span style="text-transform: capitalize;">{{ plan.support_level }} Support</span>
          </li>
        </ul>
      </div>

      <!-- Action Button -->
      <div style="text-align: center;">
        {% if has_stripe_subscription %}
          {% if plan.plan == current_user_plan %}
          <a href="{{ url_for('main.stripe_customer_portal') }}" class="btn submitbtn" style="width: 100%; display: inline-block;">
            Manage
          </a>
          {% elif plan.plan == 'free' %}
          <a href="{{ url_for('main.stripe_customer_portal') }}" class="btn" style="width: 100%; display: inline-block;">
            Downgrade
          </a>
          {% else %}
          <a href="{{ url_for('main.stripe_customer_portal') }}" class="btn submitbtn" style="width: 100%; display: inline-block;">
            Change Plan
          </a>
          {% endif %}
        {% else %}
          {% if plan.plan == current_user_plan %}
          <button class="btn" disabled style="width: 100%; opacity: 0.6; cursor: not-allowed;">
            Current Plan
          </button>
          {% elif plan.plan == 'free' %}
          <a href="mailto:support@qventory.com" class="btn" style="width: 100%; display: inline-block;">
            Contact Support to Downgrade
          </a>
          {% else %}
          <form method="POST" action="{{ url_for('main.stripe_checkout') }}">
            <input type="hidden" name="plan" value="{{ plan.plan }}">
            <button class="btn submitbtn" type="submit" style="width: 100%;">
              Upgrade Now
            </button>
          </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Notice -->
  <div style="text-align: center; padding: 24px; background: var(--muted); border-radius: var(--radius); max-width: 800px; margin: 0 auto;">
    <i class="fas fa-lock" style="color: var(--accent); font-size: 1.5rem; margin-bottom: 12px;"></i>
    <h3 style="margin: 0 0 8px 0; color: var(--text);">Secure checkout with Stripe</h3>
    <p style="color: var(--sub); margin: 0; line-height: 1.6;">
      Upgrades are processed with Stripe Checkout. Your plan updates automatically after payment confirmation.
    </p>
  </div>
</div>

{% endblock %}
