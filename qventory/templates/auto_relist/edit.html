{% extends "base_new.html" %}

{% block title %}Edit Auto-Relist Rule - Qventory{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">/</span>
<a href="{{ url_for('auto_relist.dashboard') }}" class="breadcrumb-link">Auto Relist</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Edit Rule #{{ rule.id }}</span>
{% endblock %}

{% block content %}
<div class="container page-shell">

  <div style="margin-bottom:24px;">
    <h1 style="color:var(--text);font-size:28px;margin-bottom:8px;">
      <i class="fas fa-edit"></i> Edit Rule #{{ rule.id }}
    </h1>
    <p style="color:var(--text-secondary);font-size:14px;">
      {{ rule.item_title or rule.sku or 'Unknown Item' }}
    </p>
  </div>

  <form method="POST" action="{{ url_for('auto_relist.edit_rule', rule_id=rule.id) }}">

    <!-- Mode (readonly, just display) -->
    <div class="card" style="margin-bottom:24px;">
      <div style="padding:20px;border-bottom:1px solid var(--border);">
        <h2 style="color:var(--text);font-size:18px;">Mode</h2>
      </div>
      <div style="padding:24px;">
        <div style="display:inline-block;padding:12px 24px;background:var(--bg-secondary);border-radius:8px;">
          {% if rule.mode == 'auto' %}
          <i class="fas fa-robot" style="color:#60a5fa;margin-right:8px;"></i>
          <strong>Automatic Mode</strong>
          {% else %}
          <i class="fas fa-hand-pointer" style="color:#fbbf24;margin-right:8px;"></i>
          <strong>Manual Mode</strong>
          {% endif %}
        </div>
        <input type="hidden" name="mode" value="{{ rule.mode }}">
      </div>
    </div>

    <!-- AUTO Mode Settings -->
    {% if rule.mode == 'auto' %}
    <div class="card" style="margin-bottom:24px;">
      <div style="padding:20px;border-bottom:1px solid var(--border);">
        <h2 style="color:var(--text);font-size:18px;">Schedule Settings</h2>
      </div>
      <div style="padding:24px;">

        <!-- Frequency -->
        <div class="form-group">
          <label for="frequency">Relist Frequency *</label>
          <select name="frequency" id="frequency" class="form-control" required>
            <option value="daily" {% if rule.frequency == 'daily' %}selected{% endif %}>Every Day</option>
            <option value="every_3_days" {% if rule.frequency == 'every_3_days' %}selected{% endif %}>Every 3 Days</option>
            <option value="weekly" {% if rule.frequency == 'weekly' %}selected{% endif %}>Every Week (7 days)</option>
            <option value="every_10_days" {% if rule.frequency == 'every_10_days' %}selected{% endif %}>Every 10 Days</option>
            <option value="biweekly" {% if rule.frequency == 'biweekly' %}selected{% endif %}>Every 2 Weeks (14 days)</option>
            <option value="every_20_days" {% if rule.frequency == 'every_20_days' %}selected{% endif %}>Every 20 Days</option>
            <option value="monthly" {% if rule.frequency == 'monthly' %}selected{% endif %}>Every Month (30 days)</option>
            <option value="custom" {% if rule.frequency == 'custom' %}selected{% endif %}>Custom Interval</option>
          </select>
        </div>

        <!-- Custom Interval -->
        <div class="form-group" id="custom_interval_group" style="{% if rule.frequency != 'custom' %}display:none;{% endif %}">
          <label for="custom_interval_days">Custom Interval (days) *</label>
          <input type="number" name="custom_interval_days" id="custom_interval_days" class="form-control" min="1" max="365" value="{{ rule.custom_interval_days or 7 }}">
        </div>

        <!-- Quiet Hours -->
        <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
          <h3 style="font-size:14px;margin-bottom:16px;color:var(--text);">
            <i class="fas fa-moon"></i> Quiet Hours
          </h3>

          <label class="checkbox-label" style="margin-bottom:12px;">
            <input type="checkbox" name="enable_quiet_hours" id="enable_quiet_hours" {% if rule.quiet_hours_start and rule.quiet_hours_end %}checked{% endif %}>
            <span>Only run during a specific time window</span>
          </label>

          <div id="quiet_hours_content" style="margin-top:12px;{% if not (rule.quiet_hours_start and rule.quiet_hours_end) %}display:none;{% endif %}">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">
              When enabled, relists will be scheduled within this window based on your timezone.
            </p>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label for="quiet_hours_start">Start Time</label>
                <input type="time" name="quiet_hours_start" id="quiet_hours_start" class="form-control" value="{{ rule.quiet_hours_start.strftime('%H:%M') if rule.quiet_hours_start else '' }}" {% if not (rule.quiet_hours_start and rule.quiet_hours_end) %}disabled{% endif %}>
              </div>
              <div class="form-group">
                <label for="quiet_hours_end">End Time</label>
                <input type="time" name="quiet_hours_end" id="quiet_hours_end" class="form-control" value="{{ rule.quiet_hours_end.strftime('%H:%M') if rule.quiet_hours_end else '' }}" {% if not (rule.quiet_hours_start and rule.quiet_hours_end) %}disabled{% endif %}>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="timezone">Timezone</label>
            <select name="timezone" id="timezone" class="form-control">
              <option value="America/Los_Angeles" {% if rule.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific (Los Angeles)</option>
              <option value="America/Denver" {% if rule.timezone == 'America/Denver' %}selected{% endif %}>Mountain (Denver)</option>
              <option value="America/Chicago" {% if rule.timezone == 'America/Chicago' %}selected{% endif %}>Central (Chicago)</option>
              <option value="America/New_York" {% if rule.timezone == 'America/New_York' %}selected{% endif %}>Eastern (New York)</option>
            </select>
          </div>
        </div>

        <!-- Safety Rules -->
        <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
          <h3 style="font-size:14px;margin-bottom:16px;color:var(--text);">
            <i class="fas fa-shield-alt"></i> Safety Rules
          </h3>

          <div style="display:grid;gap:12px;">
            <label class="checkbox-label">
              <input type="checkbox" name="require_positive_quantity" {% if rule.require_positive_quantity %}checked{% endif %}>
              <span>Skip if quantity is zero</span>
            </label>

            <label class="checkbox-label">
              <input type="checkbox" name="check_active_returns" {% if rule.check_active_returns %}checked{% endif %}>
              <span>Skip if there are active returns</span>
            </label>

            <label class="checkbox-label">
              <input type="checkbox" name="pause_on_error" {% if rule.pause_on_error %}checked{% endif %}>
              <span>Pause rule after consecutive errors</span>
            </label>
          </div>

          <div class="form-group" style="margin-top:16px;">
            <label for="min_hours_since_last_order">Skip if orders in last (hours)</label>
            <input type="number" name="min_hours_since_last_order" id="min_hours_since_last_order" class="form-control" value="{{ rule.min_hours_since_last_order }}" min="0">
          </div>

          <div class="form-group">
            <label for="max_consecutive_errors">Max consecutive errors before pause</label>
            <input type="number" name="max_consecutive_errors" id="max_consecutive_errors" class="form-control" value="{{ rule.max_consecutive_errors }}" min="1" max="10">
          </div>
        </div>

        <!-- Price Decrease Strategy -->
        <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
          <h3 style="font-size:14px;margin-bottom:16px;color:var(--text);">
            <i class="fas fa-chart-line-down"></i> Price Decrease Strategy
          </h3>
          <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">
            Automatically decrease price with each relist until item sells or reaches minimum price
          </p>

          <label class="checkbox-label" style="margin-bottom:16px;">
            <input type="checkbox" name="enable_price_decrease" id="enable_price_decrease" {% if rule.enable_price_decrease %}checked{% endif %}>
            <span>Enable automatic price decrease</span>
          </label>

          <div id="price_decrease_settings" style="{% if not rule.enable_price_decrease %}display:none;{% endif %}padding-left:24px;border-left:3px solid var(--border);">
            <div class="form-group">
              <label for="price_decrease_type">Decrease Type *</label>
              <select name="price_decrease_type" id="price_decrease_type" class="form-control">
                <option value="fixed" {% if rule.price_decrease_type == 'fixed' %}selected{% endif %}>Fixed Amount ($)</option>
                <option value="percentage" {% if rule.price_decrease_type == 'percentage' %}selected{% endif %}>Percentage (%)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="price_decrease_amount">
                <span id="decrease_label">
                  {% if rule.price_decrease_type == 'percentage' %}Decrease Percentage (%) *{% else %}Decrease Amount ($) *{% endif %}
                </span>
              </label>
              <input type="number" name="price_decrease_amount" id="price_decrease_amount" class="form-control" value="{{ rule.price_decrease_amount }}" min="0.01" step="0.01" placeholder="2.00">
              <small style="color:var(--text-tertiary);font-size:11px;" id="decrease_hint">
                {% if rule.price_decrease_type == 'percentage' %}
                Example: $30.00 → $27.00 (10%) → $24.30
                {% else %}
                Example: $29.99 → $27.99 → $25.99
                {% endif %}
              </small>
            </div>

            <div class="form-group">
              <label for="min_price">Minimum Price (floor) *</label>
              <input type="number" name="min_price" id="min_price" class="form-control" value="{{ rule.min_price }}" min="0.01" step="0.01" placeholder="15.00">
              <small style="color:var(--text-tertiary);font-size:11px;">
                Price will never go below this amount
              </small>
            </div>
          </div>
        </div>

      </div>
    </div>
    {% endif %}

    <!-- Common Settings -->
    <div class="card" style="margin-bottom:24px;">
      <div style="padding:20px;border-bottom:1px solid var(--border);">
        <h2 style="color:var(--text);font-size:18px;">Additional Options</h2>
      </div>
      <div style="padding:24px;">

        <div class="form-group">
          <label for="withdraw_publish_delay_seconds">Delay between withdraw and publish (seconds)</label>
          <input type="number" name="withdraw_publish_delay_seconds" id="withdraw_publish_delay_seconds" class="form-control" value="{{ rule.withdraw_publish_delay_seconds }}" min="5" max="120">
        </div>

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea name="notes" id="notes" class="form-control" rows="3">{{ rule.notes or '' }}</textarea>
        </div>

      </div>
    </div>

    <!-- Submit -->
    <div style="display:flex;justify-content:space-between;gap:12px;">
      <a href="{{ url_for('auto_relist.dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Cancel
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> Save Changes
      </button>
    </div>

  </form>

</div>

<style>
.checkbox-label {
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  padding:8px;
  border-radius:4px;
  transition:background 0.2s;
}

.checkbox-label:hover {
  background:var(--bg-secondary);
}

.checkbox-label input[type="checkbox"] {
  width:18px;
  height:18px;
  cursor:pointer;
}

.form-group {
  margin-bottom:16px;
}

.form-group label {
  display:block;
  font-size:13px;
  font-weight:500;
  color:var(--text);
  margin-bottom:6px;
}

.form-control {
  width:100%;
  padding:10px 12px;
  font-size:14px;
  border:1px solid var(--border);
  border-radius:6px;
  background:var(--bg);
  color:var(--text);
  font-family:inherit;
}

.form-control:focus {
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const frequencySelect = document.getElementById('frequency');
  const customIntervalGroup = document.getElementById('custom_interval_group');
  const enableQuietHours = document.getElementById('enable_quiet_hours');
  const quietHoursContent = document.getElementById('quiet_hours_content');
  const quietInputs = quietHoursContent ? quietHoursContent.querySelectorAll('input[type="time"]') : [];

  if (frequencySelect) {
    frequencySelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customIntervalGroup.style.display = 'block';
      } else {
        customIntervalGroup.style.display = 'none';
      }
    });
  }

  if (enableQuietHours && quietHoursContent) {
    const syncQuietHoursState = () => {
      const enabled = enableQuietHours.checked;
      quietHoursContent.style.display = enabled ? 'block' : 'none';
      quietInputs.forEach(input => {
        input.disabled = !enabled;
        if (!enabled) {
          input.value = '';
        }
      });
    };

    enableQuietHours.addEventListener('change', syncQuietHoursState);
    syncQuietHoursState();
  }

  // ==================== PRICE DECREASE HANDLING ====================

  const enablePriceDecrease = document.getElementById('enable_price_decrease');
  const priceDecreaseSettings = document.getElementById('price_decrease_settings');
  const priceDecreaseType = document.getElementById('price_decrease_type');
  const decreaseLabel = document.getElementById('decrease_label');
  const decreaseHint = document.getElementById('decrease_hint');

  if (enablePriceDecrease) {
    // Toggle price decrease settings visibility
    enablePriceDecrease.addEventListener('change', function() {
      if (this.checked) {
        priceDecreaseSettings.style.display = 'block';
        document.getElementById('price_decrease_amount').required = true;
        document.getElementById('min_price').required = true;
      } else {
        priceDecreaseSettings.style.display = 'none';
        document.getElementById('price_decrease_amount').required = false;
        document.getElementById('min_price').required = false;
      }
    });

    // Update labels based on decrease type
    priceDecreaseType.addEventListener('change', function() {
      if (this.value === 'fixed') {
        decreaseLabel.textContent = 'Decrease Amount ($) *';
        decreaseHint.textContent = 'Example: $29.99 → $27.99 → $25.99';
        document.getElementById('price_decrease_amount').placeholder = '2.00';
      } else if (this.value === 'percentage') {
        decreaseLabel.textContent = 'Decrease Percentage (%) *';
        decreaseHint.textContent = 'Example: $30.00 → $27.00 (10%) → $24.30';
        document.getElementById('price_decrease_amount').placeholder = '10';
      }
    });
  }
});
</script>
{% endblock %}
