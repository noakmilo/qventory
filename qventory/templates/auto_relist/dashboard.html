{% extends "base_new.html" %}

{% block title %}Auto Relist - Qventory{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Auto Relist</span>
{% endblock %}

{% block content %}
<div class="container page-shell page-shell--wide">

  <!-- Header -->
  <div style="margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
    <div>
      <h1 style="color:var(--text);font-size:28px;margin-bottom:8px;">
        <i class="fas fa-sync-alt"></i> Auto Relist
      </h1>
      <p style="color:var(--text-secondary);font-size:14px;">
        Automatically refresh your eBay listings with new Item IDs
      </p>
    </div>
    <div style="display:flex;gap:12px;">
      <a href="{{ url_for('auto_relist.history') }}" class="btn btn-secondary">
        <i class="fas fa-history"></i> View History
      </a>
      <a href="{{ url_for('auto_relist.create_rule') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> New Rule
      </a>
    </div>
  </div>

  <!-- Stats Cards -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
    <div class="card" style="padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="color:var(--text-secondary);font-size:13px;">Total Rules</span>
        <span style="color:var(--primary);font-size:24px;font-weight:700;">{{ stats.total_rules }}</span>
      </div>
      <p style="color:var(--text-tertiary);font-size:11px;">{{ stats.active_rules }} active</p>
    </div>

    <div class="card" style="padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="color:var(--text-secondary);font-size:13px;">Auto Rules</span>
        <span style="color:#60a5fa;font-size:24px;font-weight:700;">{{ stats.auto_rules }}</span>
      </div>
      <p style="color:var(--text-tertiary);font-size:11px;">Scheduled</p>
    </div>

    <div class="card" style="padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="color:var(--text-secondary);font-size:13px;">Manual Rules</span>
        <span style="color:#fbbf24;font-size:24px;font-weight:700;">{{ stats.manual_rules }}</span>
      </div>
      <p style="color:var(--text-tertiary);font-size:11px;">On-demand</p>
    </div>

    <div class="card" style="padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="color:var(--text-secondary);font-size:13px;">Success Rate</span>
        <span style="color:#34d399;font-size:24px;font-weight:700;">{{ "%.1f"|format(stats.success_rate) }}%</span>
      </div>
      <p style="color:var(--text-tertiary);font-size:11px;">{{ stats.total_success }}/{{ stats.total_runs }} runs</p>
    </div>
  </div>

  <!-- Rules Table -->
  <div class="card" style="margin-bottom:24px;">
    <div style="padding:20px;border-bottom:1px solid var(--border);">
      <h2 style="color:var(--text);font-size:18px;">Active Rules</h2>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px;"></th>
            <th>Item</th>
            <th>Mode</th>
            <th>Frequency</th>
            <th>Next Run</th>
            <th>Status</th>
            <th>Stats</th>
            <th style="width:150px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if rules|length == 0 %}
          <tr>
            <td colspan="8" style="text-align:center;padding:40px;color:var(--text-secondary);">
              <i class="fas fa-sync-alt" style="font-size:48px;opacity:0.3;display:block;margin-bottom:12px;"></i>
              <p>No auto-relist rules yet</p>
              <a href="{{ url_for('auto_relist.create_rule') }}" class="btn btn-primary" style="margin-top:16px;">
                <i class="fas fa-plus"></i> Create First Rule
              </a>
            </td>
          </tr>
          {% else %}
          {% for rule in rules %}
          <tr data-rule-id="{{ rule.id }}">
            <!-- Status Indicator -->
            <td style="text-align:center;">
              {% if rule.enabled %}
              <span style="color:#34d399;font-size:18px;" title="Enabled">
                <i class="fas fa-circle"></i>
              </span>
              {% else %}
              <span style="color:var(--text-tertiary);font-size:18px;" title="Disabled">
                <i class="far fa-circle"></i>
              </span>
              {% endif %}
            </td>

            <!-- Item Info -->
            <td>
              <div style="font-weight:500;color:var(--text);">
                {{ rule.item_title or rule.sku or 'Unknown' }}
              </div>
              <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">
                {% if rule.sku %}SKU: {{ rule.sku }}{% endif %}
                {% if rule.listing_id %} | Listing: {{ rule.listing_id }}{% endif %}
              </div>
              {% if rule.enable_price_decrease and rule.mode == 'auto' %}
              <div style="margin-top:4px;">
                <span style="background:#dcfce7;color:#166534;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;" title="Price decrease: {{ rule.price_decrease_type }} ${ '%.2f'|format(rule.price_decrease_amount) }} | Min: ${{ '%.2f'|format(rule.min_price or 0) }}">
                  <i class="fas fa-chart-line-down"></i>
                  {% if rule.price_decrease_type == 'fixed' %}
                    -${{ '%.2f'|format(rule.price_decrease_amount) }}
                  {% else %}
                    -{{ rule.price_decrease_amount }}%
                  {% endif %}
                  → ${{ '%.2f'|format(rule.min_price or 0) }}
                </span>
              </div>
              {% endif %}
            </td>

            <!-- Mode -->
            <td>
              {% if rule.mode == 'auto' %}
              <span style="background:#dbeafe;color:#1e40af;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">
                AUTO
              </span>
              {% else %}
              <span style="background:#fef3c7;color:#92400e;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">
                MANUAL
              </span>
              {% endif %}
            </td>

            <!-- Frequency -->
            <td style="color:var(--text-secondary);font-size:13px;">
              {% if rule.mode == 'auto' %}
                {{ rule.frequency.replace('_', ' ').title() }}
                {% if rule.frequency == 'custom' and rule.custom_interval_days %}
                  ({{ rule.custom_interval_days }} days)
                {% endif %}
              {% else %}
                On-demand
              {% endif %}
            </td>

            <!-- Next Run -->
            <td style="color:var(--text-secondary);font-size:13px;">
              {% if rule.next_run_at and rule.enabled %}
                <span title="{{ rule.next_run_at }}">
                  {{ rule.next_run_at|timeago }}
                </span>
              {% elif not rule.enabled %}
                <span style="color:var(--text-tertiary);">—</span>
              {% elif rule.mode == 'manual' %}
                <span style="color:var(--text-tertiary);">Waiting</span>
              {% else %}
                <span style="color:var(--text-tertiary);">Not scheduled</span>
              {% endif %}
            </td>

            <!-- Last Status -->
            <td>
              {% if rule.last_run_status == 'success' %}
                <span style="color:#34d399;font-size:12px;">
                  <i class="fas fa-check-circle"></i> Success
                </span>
              {% elif rule.last_run_status == 'stopped_sold' %}
                <span style="color:#10b981;font-size:12px;" title="Item was sold - rule stopped automatically">
                  <i class="fas fa-dollar-sign"></i> Sold
                </span>
              {% elif rule.last_run_status == 'error' %}
                <span style="color:#ef4444;font-size:12px;" title="{{ rule.last_error_message }}">
                  <i class="fas fa-exclamation-circle"></i> Error
                </span>
              {% elif rule.last_run_status == 'skipped' %}
                <span style="color:#fbbf24;font-size:12px;" title="{{ rule.last_error_message }}">
                  <i class="fas fa-minus-circle"></i> Skipped
                </span>
              {% else %}
                <span style="color:var(--text-tertiary);font-size:12px;">
                  <i class="fas fa-clock"></i> Pending
                </span>
              {% endif %}
            </td>

            <!-- Stats -->
            <td style="font-size:12px;color:var(--text-secondary);">
              <div>{{ rule.success_count }}/{{ rule.run_count }} runs</div>
              <div style="color:var(--text-tertiary);font-size:11px;">
                {{ "%.0f"|format(rule.success_rate) }}% success
              </div>
            </td>

            <!-- Actions -->
            <td>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                <!-- Toggle Enable/Disable -->
                <button class="btn-icon toggle-rule-btn" data-rule-id="{{ rule.id }}" title="{% if rule.enabled %}Disable{% else %}Enable{% endif %}">
                  {% if rule.enabled %}
                  <i class="fas fa-pause"></i>
                  {% else %}
                  <i class="fas fa-play"></i>
                  {% endif %}
                </button>

                <!-- Relist Now -->
                <button class="btn-icon relist-now-btn"
                        data-rule-id="{{ rule.id }}"
                        data-item-title="{{ rule.item_title or 'Unknown Item' }}"
                        data-current-price="{{ rule.current_price or '' }}"
                        data-mode="{{ rule.mode }}"
                        title="Relist Now">
                  <i class="fas fa-sync"></i>
                </button>

                <!-- Edit -->
                <a href="{{ url_for('auto_relist.edit_rule', rule_id=rule.id) }}" class="btn-icon" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>

                <!-- Delete -->
                <button class="btn-icon delete-rule-btn" data-rule-id="{{ rule.id }}" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent History -->
  {% if history|length > 0 %}
  <div class="card">
    <div style="padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <h2 style="color:var(--text);font-size:18px;">Recent Executions</h2>
      <a href="{{ url_for('auto_relist.history') }}" style="color:var(--primary);font-size:13px;text-decoration:none;">
        View All <i class="fas fa-arrow-right"></i>
      </a>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Rule</th>
            <th>Mode</th>
            <th>Old Listing</th>
            <th>New Listing</th>
            <th>Duration</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for h in history[:10] %}
          <tr>
            <td style="font-size:12px;color:var(--text-secondary);">
              {{ h.started_at.strftime('%b %d, %I:%M %p') }}
            </td>
            <td style="font-size:13px;color:var(--text);">
              Rule #{{ h.rule_id }}
            </td>
            <td>
              {% if h.mode == 'auto' %}
              <span style="color:#60a5fa;font-size:11px;">AUTO</span>
              {% else %}
              <span style="color:#fbbf24;font-size:11px;">MANUAL</span>
              {% endif %}
            </td>
            <td style="font-family:monospace;font-size:11px;color:var(--text-secondary);">
              {{ h.old_listing_id or '—' }}
            </td>
            <td style="font-family:monospace;font-size:11px;color:var(--text);">
              {% if h.new_listing_id %}
              <a href="https://www.ebay.com/itm/{{ h.new_listing_id }}" target="_blank" style="color:var(--primary);text-decoration:none;">
                {{ h.new_listing_id }} <i class="fas fa-external-link-alt" style="font-size:9px;"></i>
              </a>
              {% else %}
              —
              {% endif %}
            </td>
            <td style="font-size:12px;color:var(--text-secondary);">
              {% if h.duration_seconds %}
                {{ h.duration_seconds }}s
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              {% if h.status == 'success' %}
              <span style="color:#34d399;font-size:12px;">
                <i class="fas fa-check-circle"></i> Success
              </span>
              {% elif h.status == 'error' %}
              <span style="color:#ef4444;font-size:12px;" title="{{ h.error_message }}">
                <i class="fas fa-exclamation-circle"></i> Error
              </span>
              {% elif h.status == 'skipped' %}
              <span style="color:#fbbf24;font-size:12px;" title="{{ h.skip_reason }}">
                <i class="fas fa-minus-circle"></i> Skipped
              </span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

</div>

<!-- Relist Modal -->
<div id="relistModal" class="modal" style="display:none;">
  <div class="modal-overlay"></div>
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3 style="margin:0;font-size:18px;color:var(--text);">
        <i class="fas fa-sync"></i> Relist Item
      </h3>
      <button class="modal-close" id="closeRelistModal">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
        Optionally modify the title and/or price before relisting. Leave blank to keep current values.
      </p>

      <!-- Current Info -->
      <div style="background:var(--bg-secondary);padding:12px;border-radius:6px;margin-bottom:16px;">
        <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px;">Current Title:</div>
        <div id="currentTitle" style="font-size:13px;color:var(--text);font-weight:500;"></div>
        <div style="font-size:11px;color:var(--text-tertiary);margin-top:8px;margin-bottom:4px;">Current Price:</div>
        <div id="currentPrice" style="font-size:13px;color:var(--text);font-weight:500;"></div>
      </div>

      <!-- New Title -->
      <div class="form-group" style="margin-bottom:16px;">
        <label for="newTitle" style="display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text);">
          New Title <span style="color:var(--text-tertiary);font-weight:normal;">(optional, max 80 chars)</span>
        </label>
        <input type="text"
               id="newTitle"
               class="form-control"
               placeholder="Leave blank to keep current title"
               maxlength="80"
               style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
          <small id="titleError" style="color:#ef4444;font-size:11px;display:none;">
            <i class="fas fa-exclamation-circle"></i> Title cannot exceed 80 characters
          </small>
          <small id="charCount" style="color:var(--text-tertiary);font-size:11px;">
            0 / 80
          </small>
        </div>
      </div>

      <!-- New Price -->
      <div class="form-group" style="margin-bottom:16px;">
        <label for="newPrice" style="display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text);">
          New Price <span style="color:var(--text-tertiary);font-weight:normal;">(optional)</span>
        </label>
        <div style="position:relative;">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:14px;">$</span>
          <input type="number"
                 id="newPrice"
                 class="form-control"
                 placeholder="Leave blank to keep current price"
                 step="0.01"
                 min="0.01"
                 style="width:100%;padding:10px 10px 10px 24px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:14px;">
        </div>
        <small style="color:var(--text-tertiary);font-size:11px;display:block;margin-top:4px;">
          Enter the new listing price
        </small>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" id="cancelRelist">
        Cancel
      </button>
      <button class="btn btn-primary" id="confirmRelist">
        <i class="fas fa-sync"></i> Relist Now
      </button>
    </div>
  </div>
</div>

<style>
.btn-icon {
  background:var(--card-bg);
  border:1px solid var(--border);
  color:var(--text-secondary);
  padding:6px 10px;
  border-radius:4px;
  cursor:pointer;
  font-size:12px;
  transition:all 0.2s;
}

.btn-icon:hover {
  background:var(--primary);
  color:white;
  border-color:var(--primary);
}

.btn-icon:disabled {
  opacity:0.5;
  cursor:not-allowed;
}

/* Modal Styles */
.modal {
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
}

.modal-overlay {
  position:absolute;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(4px);
}

.modal-content {
  position:relative;
  background:var(--bg);
  border-radius:12px;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  max-height:90vh;
  overflow-y:auto;
  width:90%;
  max-width:500px;
  z-index:10000;
}

.modal-header {
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.modal-close {
  background:none;
  border:none;
  color:var(--text-secondary);
  font-size:20px;
  cursor:pointer;
  padding:4px 8px;
  transition:color 0.2s;
}

.modal-close:hover {
  color:var(--text);
}

.modal-body {
  padding:24px;
}

.modal-footer {
  padding:16px 24px;
  border-top:1px solid var(--border);
  display:flex;
  justify-content:flex-end;
  gap:12px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle Enable/Disable
  document.querySelectorAll('.toggle-rule-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const ruleId = this.dataset.ruleId;
      const icon = this.querySelector('i');

      try {
        const response = await fetch(`/auto-relist/${ruleId}/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          // Update icon
          icon.className = data.enabled ? 'fas fa-pause' : 'fas fa-play';
          this.title = data.enabled ? 'Disable' : 'Enable';

          // Update status indicator
          const row = document.querySelector(`tr[data-rule-id="${ruleId}"]`);
          const indicator = row.querySelector('td:first-child i');
          indicator.className = data.enabled ? 'fas fa-circle' : 'far fa-circle';
          indicator.parentElement.style.color = data.enabled ? '#34d399' : 'var(--text-tertiary)';

          // Show toast
          showToast(data.enabled ? 'Rule enabled' : 'Rule disabled', 'success');
        } else {
          showToast('Error: ' + data.error, 'error');
        }
      } catch (error) {
        showToast('Network error', 'error');
      }
    });
  });

  // Relist Now - Open Modal
  const relistModal = document.getElementById('relistModal');
  const newTitleInput = document.getElementById('newTitle');
  const newPriceInput = document.getElementById('newPrice');
  const charCount = document.getElementById('charCount');
  const titleError = document.getElementById('titleError');
  const confirmRelistBtn = document.getElementById('confirmRelist');
  let currentRuleId = null;

  // Character counter for title
  newTitleInput.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length} / 80`;

    if (length > 80) {
      titleError.style.display = 'block';
      charCount.style.color = '#ef4444';
      confirmRelistBtn.disabled = true;
    } else {
      titleError.style.display = 'none';
      charCount.style.color = 'var(--text-tertiary)';
      confirmRelistBtn.disabled = false;
    }
  });

  // Open modal on relist button click
  document.querySelectorAll('.relist-now-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      currentRuleId = this.dataset.ruleId;
      const mode = this.dataset.mode;
      const itemTitle = this.dataset.itemTitle || 'Unknown Item';
      const currentPrice = this.dataset.currentPrice;

      // Populate current info
      document.getElementById('currentTitle').textContent = itemTitle;
      document.getElementById('currentPrice').textContent = (currentPrice && currentPrice !== '') ? `$${currentPrice}` : 'N/A';

      // Reset inputs
      newTitleInput.value = '';
      newPriceInput.value = '';
      charCount.textContent = '0 / 80';
      titleError.style.display = 'none';
      confirmRelistBtn.disabled = false;

      // Show modal (only if manual mode, otherwise relist directly)
      if (mode === 'manual') {
        relistModal.style.display = 'flex';
      } else {
        // Auto mode: relist directly without modal
        performRelist(currentRuleId, {});
      }
    });
  });

  // Close modal
  document.getElementById('closeRelistModal').addEventListener('click', () => {
    relistModal.style.display = 'none';
  });

  document.getElementById('cancelRelist').addEventListener('click', () => {
    relistModal.style.display = 'none';
  });

  relistModal.querySelector('.modal-overlay').addEventListener('click', () => {
    relistModal.style.display = 'none';
  });

  // Confirm relist with optional changes
  confirmRelistBtn.addEventListener('click', async function() {
    const changes = {};

    // Get new values if provided
    const newTitle = newTitleInput.value.trim();
    const newPrice = newPriceInput.value.trim();

    if (newTitle && newTitle.length > 0) {
      if (newTitle.length > 80) {
        showToast('Title cannot exceed 80 characters', 'error');
        return;
      }
      changes.title = newTitle;
    }

    if (newPrice && newPrice.length > 0) {
      const priceFloat = parseFloat(newPrice);
      if (isNaN(priceFloat) || priceFloat <= 0) {
        showToast('Please enter a valid price', 'error');
        return;
      }
      changes.price = priceFloat;
    }

    // Close modal and perform relist
    relistModal.style.display = 'none';
    performRelist(currentRuleId, changes);
  });

  // Perform relist API call
  async function performRelist(ruleId, changes) {
    const btn = document.querySelector(`.relist-now-btn[data-rule-id="${ruleId}"]`);
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
      const response = await fetch(`/auto-relist/${ruleId}/relist-now`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(changes)
      });

      const data = await response.json();

      if (data.success) {
        const hasChanges = Object.keys(changes).length > 0;
        const message = hasChanges
          ? `${data.message} (with changes applied)`
          : data.message;
        showToast(message, 'success');
        setTimeout(() => window.location.reload(), 2000);
      } else {
        showToast('Error: ' + data.error, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i>';
      }
    } catch (error) {
      showToast('Network error', 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sync"></i>';
    }
  }

  // Delete Rule
  document.querySelectorAll('.delete-rule-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const ruleId = this.dataset.ruleId;

      if (!confirm('Delete this rule? This action cannot be undone.')) return;

      try {
        const response = await fetch(`/auto-relist/${ruleId}/delete`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showToast('Rule deleted', 'success');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast('Error: ' + data.error, 'error');
        }
      } catch (error) {
        showToast('Network error', 'error');
      }
    });
  });

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position:fixed;
      top:20px;
      right:20px;
      z-index:9999;
      background:${type === 'success' ? '#d1fae5' : '#fee2e2'};
      color:${type === 'success' ? '#065f46' : '#991b1b'};
      padding:16px 24px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      font-size:14px;
      font-weight:500;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
  }
});
</script>
{% endblock %}
