{% extends "base.html" %}
{% block title %}Edit Item – Qventory{% endblock %}
{% block content %}
<div class="card">
  <h2><i class="fas fa-edit"></i> Edit Item</h2>

  <form method="post" class="grid cols-3" id="editItemForm">
    <!-- Título -->
    <div style="grid-column:1/-1">
      <label><i class="fas fa-heading"></i> Title</label>
      <input class="input" type="text" name="title" value="{{ item.title }}" required>
    </div>

    <!-- Miniatura + Proveedor -->
    <div>
      <label><i class="fas fa-image"></i> Thumbnail URL (Cloudinary)</label>
      <input class="input" type="url" name="item_thumb" id="item_thumb" value="{{ item.item_thumb or '' }}" placeholder="https://res.cloudinary.com/...">
      <div class="thumb-preview" id="thumbPreview">
        {% if item.item_thumb %}
          <img src="{{ item.item_thumb }}" alt="thumbnail" />
        {% else %}
          <span class="thumb-placeholder">No image</span>
        {% endif %}
      </div>
    </div>

    <div>
      <label><i class="fas fa-truck"></i> Supplier</label>
      <input class="input" type="text" name="supplier" value="{{ item.supplier or '' }}" placeholder="e.g., Goodwill / Target / Wholesale ABC">
    </div>

    <!-- Precios -->
    <div>
      <label><i class="fas fa-dollar-sign"></i> Cost</label>
      <input class="input" type="number" step="0.01" min="0" name="item_cost" value="{{ '%.2f'|format(item.item_cost) if item.item_cost is not none else '' }}" placeholder="0.00">
    </div>
    <div>
      <label><i class="fas fa-tags"></i> Price</label>
      <input class="input" type="number" step="0.01" min="0" name="item_price" value="{{ '%.2f'|format(item.item_price) if item.item_price is not none else '' }}" placeholder="0.00">
    </div>
    <div>
      <label><i class="fas fa-percentage"></i> ROI (auto)</label>
      {% set has_price = item.item_price is not none %}
      {% set has_cost = item.item_cost is not none and item.item_cost > 0 %}
      {% set roi = ( (item.item_price - item.item_cost) / item.item_cost * 100 ) if (has_price and has_cost) else None %}
      <input class="input" type="text" value="{{ (roi|round(0)|string + '%') if roi is not none else '—' }}" disabled>
    </div>

    <!-- Fecha de publicación -->
    <div>
      <label><i class="far fa-calendar-alt"></i> Listing Date</label>
      <input class="input" type="date" name="listing_date" value="{{ item.listing_date.strftime('%Y-%m-%d') if item.listing_date else '' }}">
    </div>

    <!-- Listing principal -->
    <div style="grid-column:1/-1">
      <label><i class="fas fa-link"></i> Listing Link (optional)</label>
      <input class="input" type="url" name="listing_link" value="{{ item.listing_link or '' }}">
    </div>

    <!-- Bloque de Links de Marketplace -->
    <div style="grid-column:1/-1"><hr style="border-color:var(--border);opacity:.3;margin:8px 0"></div>
    <div style="grid-column:1/-1">
      <h3 style="margin:0 0 8px 0;font-size:16px"><i class="fas fa-store"></i> Marketplace Links (optional)</h3>
    </div>

    <div>
      <label><i class="fas fa-globe"></i> Website</label>
      <input class="input" type="url" name="web_url" value="{{ item.web_url or '' }}">
    </div>
    <div>
      <label><i class="fab fa-store"></i> eBay</label>
      <input class="input" type="url" name="ebay_url" value="{{ item.ebay_url or '' }}">
    </div>
    <div>
      <label><i class="fab fa-store"></i> Amazon</label>
      <input class="input" type="url" name="amazon_url" value="{{ item.amazon_url or '' }}">
    </div>
    <div>
      <label><i class="fas fa-store"></i> Mercari</label>
      <input class="input" type="url" name="mercari_url" value="{{ item.mercari_url or '' }}">
    </div>
    <div>
      <label><i class="fas fa-tshirt"></i> Vinted</label>
      <input class="input" type="url" name="vinted_url" value="{{ item.vinted_url or '' }}">
    </div>
    <div>
      <label><i class="fas fa-shopping-bag"></i> Poshmark</label>
      <input class="input" type="url" name="poshmark_url" value="{{ item.poshmark_url or '' }}">
    </div>
    <div>
      <label><i class="fas fa-shopping-cart"></i> Depop</label>
      <input class="input" type="url" name="depop_url" value="{{ item.depop_url or '' }}">
    </div>

    <!-- Sección: Location -->
    <div style="grid-column:1/-1; margin-top:16px">
      <div class="card" style="margin:0">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px">
          <h3 style="margin:0;font-size:16px"><i class="fas fa-map-marker-alt"></i> Location</h3>
          <button type="button" id="btnScanLocation" class="btn" style="padding:4px 8px; font-size:12px" title="Scan location QR code">
            <i class="fas fa-qrcode"></i> Scan QR
          </button>
        </div>

        {% if settings.enable_A %}
        <div>
          <label><i class="fas fa-tag"></i> {{ settings.label_A }} (A)</label>
          <input class="input" type="text" name="A" id="input_A" value="{{ item.A or '' }}" placeholder="e.g., 1">
        </div>
        {% endif %}

        {% if settings.enable_B %}
        <div>
          <label><i class="fas fa-tag"></i> {{ settings.label_B }} (B)</label>
          <input class="input" type="text" name="B" id="input_B" value="{{ item.B or '' }}" placeholder="e.g., 1">
        </div>
        {% endif %}

        {% if settings.enable_S %}
        <div>
          <label><i class="fas fa-tag"></i> {{ settings.label_S }} (S)</label>
          <input class="input" type="text" name="S" id="input_S" value="{{ item.S or '' }}" placeholder="e.g., 1">
        </div>
        {% endif %}

        {% if settings.enable_C %}
        <div>
          <label><i class="fas fa-tag"></i> {{ settings.label_C }} (C)</label>
          <input class="input" type="text" name="C" id="input_C" value="{{ item.C or '' }}" placeholder="e.g., 1">
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Acciones -->
    <div style="grid-column:1/-1; margin-top:8px">
      <button class="btn" type="submit"><i class="fas fa-save"></i> Save</button>
      <a class="btn" href="{{ url_for('main.dashboard') }}"><i class="fas fa-times"></i> Cancel</a>
    </div>
  </form>
</div>

<!-- Modal del QR Scanner -->
<div id="qrModal" class="scan-modal hidden" aria-hidden="true" aria-label="QR code scanner">
  <div class="scan-sheet">
    <div class="scan-header">
      <strong><i class="fas fa-qrcode"></i> Scan location QR code</strong>
      <div class="scan-actions">
        <button type="button" id="qrFlashlight" class="icon-top" aria-label="Toggle flashlight" title="Toggle flashlight">
          <i class="fas fa-lightbulb"></i>
        </button>
        <button type="button" id="qrFlip" class="icon-top" aria-label="Flip camera" title="Flip camera">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button type="button" id="qrClose" class="icon-top" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="scan-body">
      <div class="viewport">
        <video id="qrVideo" playsinline autoplay muted></video>
        <div class="guide"></div>
        <div id="qrTarget" class="scan-target"></div>
        <div id="qrSpinner" class="spinner"></div>
        <div id="qrSuccess" class="success-indicator">
          <i class="fas fa-check"></i>
        </div>
      </div>
      <div class="scan-tip">Align the QR code inside the frame</div>
      <div id="qrResult" class="scan-result"></div>
    </div>
  </div>
</div>

<style>
  /* Vista previa de miniatura */
  .thumb-preview{
    margin-top:6px; width:100%; max-width:220px; aspect-ratio:1/1; border:1px solid #e5e7eb;
    border-radius:10px; overflow:hidden; display:grid; place-items:center; background:#f8f9fa;
  }
  .thumb-preview img{ width:100%; height:100%; object-fit:cover; display:block; }
  .thumb-placeholder{ font-size:12px; color:#888; padding:10px; }

  /* Modal y estilos del escáner */
  body.modal-open{ overflow:hidden; touch-action:none; }
  .scan-modal.hidden{ display:none; }
  .scan-modal{
    position:fixed; inset:0; background:rgba(0,0,0,.6);
    display:grid; place-items:center; z-index:9999; padding:16px;
  }
  .scan-sheet{
    width:min(420px, 92vw); background:#0f1115; color:#fff;
    border-radius:14px; overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.5); border:1px solid #222;
  }
  .scan-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; background:#141821; border-bottom:1px solid #222;
  }
  .scan-actions .icon-top{
    border:none; background:transparent; color:#fff; font-size:18px; margin-left:6px; opacity:.85; cursor:pointer;
    display:flex; align-items:center; justify-content:center; width:30px; height:30px;
  }
  .scan-actions .icon-top:hover{ opacity:1; }
  .scan-actions .icon-top.active{ opacity:1; color:#ffd700; }

  .scan-body{ padding:12px; display:flex; flex-direction:column; gap:10px; }

  .viewport{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 4;
    max-height: 60vh;
    border-radius:12px;
    overflow:hidden;
    background:#000;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  }
  #qrVideo, .scan-target{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:none;
  }
  .guide{
    position:absolute; inset:10%;
    border:2px dashed rgba(255,255,255,.6);
    border-radius:10px;
    pointer-events:none;
    animation: pulse-guide 2s infinite;
  }
  @keyframes pulse-guide { 0%,100%{opacity:.6} 50%{opacity:1} }

  .success-indicator {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px; color: #00ff00; display: none;
    text-shadow: 0 0 20px rgba(0,255,0,0.8);
    animation: success-flash 0.5s ease-out;
  }
  @keyframes success-flash { 0%{transform:translate(-50%,-50%) scale(.5);opacity:0} 50%{transform:translate(-50%,-50%) scale(1.2);opacity:1} 100%{transform:translate(-50%,-50%) scale(1);opacity:1} }

  .scan-tip{ text-align:center; font-size:12px; opacity:.8; }
  .scan-result {
    background:#1a1d23; border:1px solid #333; border-radius:8px;
    padding:8px 12px; font-family:monospace; font-size:12px; color:#0ff;
    min-height:20px; display:none;
  }

  .spinner{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); }
  .spinner::after{
    content:""; width:28px; height:28px; border-radius:50%;
    border:3px solid rgba(255,255,255,.3); border-top-color:#fff; animation:spin .9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Iconos en etiquetas */
  label i { margin-right: 8px; width: 16px; color: #666; }
  .btn i { margin-right: 5px; }
</style>

<script>
/* ===== Miniatura: vista previa reactiva ===== */
(function(){
  const input = document.getElementById('item_thumb');
  const box   = document.getElementById('thumbPreview');
  function renderPreview(url){
    if (!box) return;
    box.innerHTML = '';
    if (!url){ const sp = document.createElement('span'); sp.className='thumb-placeholder'; sp.textContent='No image'; box.appendChild(sp); return; }
    const img = document.createElement('img'); img.alt='thumbnail'; img.src=url; box.appendChild(img);
  }
  input && input.addEventListener('input', (e)=>renderPreview(e.target.value.trim()));
})();

/* ===== QR Scanner (BarcodeDetector → jsQR fallback) ===== */
(function(){
  const btnScan = document.getElementById('btnScanLocation');
  const modal = document.getElementById('qrModal');
  const btnClose = document.getElementById('qrClose');
  const btnFlip = document.getElementById('qrFlip');
  const btnFlash = document.getElementById('qrFlashlight');
  const video = document.getElementById('qrVideo');
  const target = document.getElementById('qrTarget');
  const spinner = document.getElementById('qrSpinner');
  const success = document.getElementById('qrSuccess');
  const result = document.getElementById('qrResult');

  const CAM_CACHE_KEY = 'qv_qr_cam_device_id';
  let stream=null, rafId=null, detector=null;
  let usingBD=false, usingJsQR=false, jsQRLoaded=false;
  let videoDevices=[], currentDeviceIdx=-1, devicesLoaded=false;
  let flashlightOn=false, lastDetections=[];

  function openModal(){ document.body.classList.add('modal-open'); modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ document.body.classList.remove('modal-open'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
  function showSpinner(on){ spinner.style.display = on ? 'flex' : 'none'; }
  function cleanupLoop(){ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } }
  function cleanupAll(){
    cleanupLoop();
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    flashlightOn=false; btnFlash.classList.remove('active');
    video.srcObject=null; video.style.display='none'; target.style.display='none';
    result.style.display='none'; success.style.display='none';
    usingBD=false; usingJsQR=false; lastDetections.length=0;
  }
  function showError(err){ console.error('[QR]', err); alert(err?.message || 'Camera error'); }

  async function loadVideoDevices(){
    if (devicesLoaded) return;
    const devs = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devs.filter(d=>d.kind==='videoinput');
    const prefers=['back','rear','environment'];
    videoDevices.sort((a,b)=>{
      const la=(a.label||'').toLowerCase(), lb=(b.label||'').toLowerCase();
      const as = prefers.some(p=>la.includes(p)) ? 1:0;
      const bs = prefers.some(p=>lb.includes(p)) ? 1:0;
      return bs - as;
    });
    devicesLoaded=true;
  }

  async function startWithDevice(deviceId){
    cleanupLoop(); showSpinner(true);
    const constraints = {
      video: deviceId ? { deviceId:{exact:deviceId}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30}, facingMode:'environment' }
                      : { facingMode:{ideal:'environment'}, width:{ideal:1280,min:640}, height:{ideal:720,min:480}, frameRate:{ideal:30} },
      audio:false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
    video.srcObject = stream;
    await video.play();
    showSpinner(false);
  }

  async function flipCamera(){
    await loadVideoDevices();
    if (!videoDevices.length) return;
    currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
    await startWithDevice(videoDevices[currentDeviceIdx].deviceId);
    if (usingBD) startBDLoop();
    if (usingJsQR) startJsQRLoop();
  }

  async function toggleFlashlight(){
    if (!stream) return;
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.()||{};
      if (!caps.torch) return alert('Flashlight not supported on this camera');
      flashlightOn = !flashlightOn;
      await track.applyConstraints({ advanced:[{ torch: flashlightOn }] });
      btnFlash.classList.toggle('active', flashlightOn);
    }catch{ alert('Unable to control flashlight'); }
  }

  function parseLocationQR(qrText){
    try{
      let part = qrText.includes('/location/') ? qrText.split('/location/')[1] : qrText;
      if (!part) return null;
      const m = part.match(/^(?:.*?)(A(\w+))?(B(\w+))?(S(\w+))?(C(\w+))?/i);
      if (!m) return null;
      return { A:m[2]||null, B:m[4]||null, S:m[6]||null, C:m[8]||null, original:part };
    }catch(e){ return null; }
  }

  function populateLocationFields(loc){
    ['A','B','S','C'].forEach(k=>{
      const el=document.getElementById(`input_${k}`);
      if (el && loc[k]){ el.value=loc[k]; el.style.background='#e8f5e8'; setTimeout(()=>el.style.background='',1200); }
    });
  }

  function onDetected(val){
    const loc = parseLocationQR(val);
    if (loc){
      result.textContent = `Location: ${loc.original}`;
      result.style.display='block';
      success.style.display='block'; setTimeout(()=>success.style.display='none',480);
      try{ navigator.vibrate && navigator.vibrate([60,40,60]); }catch(_){}
      setTimeout(()=>{ populateLocationFields(loc); cleanupAll(); closeModal(); }, 560);
    } else {
      result.textContent = `QR: ${String(val).slice(0,80)}…`;
      result.style.display='block';
    }
  }

  async function startBarcodeDetector(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      detector = new window.BarcodeDetector({ formats:['qr_code'] });
      usingBD=true; usingJsQR=false;
      video.style.display='block';
      startBDLoop();
      return true;
    }catch{ return false; }
  }

  function startBDLoop(){
    cleanupLoop();
    let frame=0;
    const tick = async ()=>{
      frame++;
      try{
        if (frame%3===0 && detector){
          const codes = await detector.detect(video);
          if (codes?.length){
            const v = (codes[0].rawValue||'').trim();
            if (v){ onDetected(v); return; }
          }
        }
      }catch(_){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function loadJsQR(){
    if (jsQRLoaded) return Promise.resolve();
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async=true;
      s.onload=()=>{ jsQRLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error('Failed to load jsQR'));
      document.head.appendChild(s);
    });
  }

  function startJsQRLoop(){
    usingBD=false; usingJsQR=true;
    cleanupLoop();

    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d',{ willReadFrequently:true });
    const ROI_INSET=0.10;
    let lastTS=0; const MIN_INTERVAL=80;

    const tick=(now)=>{
      try{
        if (!usingJsQR) return;
        if (now-lastTS>=MIN_INTERVAL && video.videoWidth>0){
          lastTS=now;
          const vw=video.videoWidth, vh=video.videoHeight;
          const rx=Math.floor(vw*ROI_INSET), ry=Math.floor(vh*ROI_INSET);
          const rw=Math.floor(vw*(1-2*ROI_INSET)), rh=Math.floor(vh*(1-2*ROI_INSET));
          canvas.width=rw; canvas.height=rh;
          ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);
          const img=ctx.getImageData(0,0,rw,rh);
          const qr=window.jsQR && window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
          const v=(qr?.data||'').trim();
          if (v){ onDetected(v); return; }
        }
      }catch(_){}
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  async function startScan(){
    // Open first to avoid autoplay restrictions
    document.body.classList.add('modal-open');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden','false');
    result.style.display='none'; success.style.display='none';

    try{
      const cached = localStorage.getItem(CAM_CACHE_KEY);
      if (cached){ await startWithDevice(cached); }
      else{
        await loadVideoDevices();
        if (videoDevices.length) currentDeviceIdx=0;
        await startWithDevice(videoDevices[currentDeviceIdx]?.deviceId);
      }

      const ok = await startBarcodeDetector();
      if (!ok){ await loadJsQR(); startJsQRLoop(); }
    }catch(e){
      showError(e);
      cleanupAll(); closeModal();
    }
  }

  btnScan?.addEventListener('click', startScan);
  btnFlip?.addEventListener('click', flipCamera);
  btnFlash?.addEventListener('click', toggleFlashlight);
  btnClose?.addEventListener('click', ()=>{ cleanupAll(); closeModal(); });
  modal?.addEventListener('click', (e)=>{ if(e.target===modal){ cleanupAll(); closeModal(); }});
})();
</script>
{% endblock %}
