{% extends "base.html" %}
{% block title %}{{ code }} – Location – Qventory{% endblock %}
{% block content %}

<div class="row">
  <!-- Inventario -->
  <div class="card inventory-shell" style="flex:1 1 100%;min-width:320px">
    <div class="items-header">
      <h2><i class="fas fa-map-marker-alt"></i> Location: {{ code }}</h2>
      <div class="backup-actions">
        <span class="tag" style="font-size:var(--fs-sm)">
          <i class="fas fa-boxes"></i> {{ items|length }} items
        </span>
      </div>
    </div>

    <!-- Descripción de ubicación -->
    {% if parts %}
    <div style="margin-bottom:var(--space-3);padding:var(--space-2);background:var(--muted);border-radius:var(--radius);border:1px solid var(--glass-border)">
      <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:var(--fs-sm)">
        {% if parts.A and settings.enable_A %}
        <span class="tag"><strong>{{ settings.label_A }}:</strong> {{ parts.A }}</span>
        {% endif %}
        {% if parts.B and settings.enable_B %}
        <span class="tag"><strong>{{ settings.label_B }}:</strong> {{ parts.B }}</span>
        {% endif %}
        {% if parts.S and settings.enable_S %}
        <span class="tag"><strong>{{ settings.label_S }}:</strong> {{ parts.S }}</span>
        {% endif %}
        {% if parts.C and settings.enable_C %}
        <span class="tag"><strong>{{ settings.label_C }}:</strong> {{ parts.C }}</span>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="table-wrap">
      {% set un = username if username is defined else (current_user.username if current_user.is_authenticated else '') %}
      <table>
        <thead>
          <tr>
            <th style="width:44px"></th>
            <th>Title</th>
            <th>SKU</th>
            <th class="mobile-hide">Supplier</th>
            <th class="mobile-hide">Cost</th>
            <th>Price</th>
            <th class="mobile-hide">ROI</th>
            <th>Location</th>
            <th class="mobile-hide">Listings</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
            {% set has_price = it.item_price is not none %}
            {% set has_cost = it.item_cost is not none and it.item_cost > 0 %}
            {% set roi = ( (it.item_price - it.item_cost) / it.item_cost * 100 ) if (has_price and has_cost) else None %}
            <tr>
              <td>
                {% if it.item_thumb %}
                  <button class="thumb-wrap" type="button" data-full="{{ it.item_thumb }}" aria-label="View image">
                    <img src="{{ it.item_thumb }}" alt="{{ it.title }}" class="thumb-img">
                    <span class="thumb-zoom"><i class="fas fa-search"></i></span>
                  </button>
                {% else %}
                  <div style="width:36px;height:36px;border-radius:6px;border:1px dashed #bbb;display:grid;place-items:center;font-size:12px;color:#888;">—</div>
                {% endif %}
              </td>
              <td>{{ it.title }}</td>
              <td><span class="tag itsku">{{ it.sku }}</span></td>

              <td class="mobile-hide">{% if it.supplier %}<span class="tag">{{ it.supplier }}</span>{% else %}—{% endif %}</td>
              <td class="mobile-hide">{% if it.item_cost %}<span class="tag"><i class="fas fa-receipt"></i> ${{ '%.2f'|format(it.item_cost) }}</span>{% else %}—{% endif %}</td>
              <td>{% if it.item_price %}<span class="tag"><i class="fas fa-tag"></i> ${{ '%.2f'|format(it.item_price) }}</span>{% else %}—{% endif %}</td>
              <td class="mobile-hide">{% if has_price and has_cost %}<span class="tag">ROI {{ roi|round(0) }}%</span>{% else %}—{% endif %}</td>

              <!-- Location con QR -->
              <td>
                {% if it.location_code %}
                <a href="{{ url_for('main.public_view_location', username=un, code=it.location_code) }}">{{ it.location_code }}</a>
                &nbsp;
                <a class="tag qr-link"
                   href="{{ url_for('main.qr_for_location', username=un, code=it.location_code) }}"
                   data-caption="QR for {{ it.location_code }}">
                  <i class="fas fa-qrcode"></i> QR
                </a>
                {% else %}—{% endif %}
              </td>

              <td class="mobile-hide">
                <div class="platform-badges">
                  {% if it.web_url %}<a class="tag" href="{{ it.web_url }}" target="_blank">Web</a>{% endif %}
                  {% if it.ebay_url %}<a class="tag" href="{{ it.ebay_url }}" target="_blank">eBay</a>{% endif %}
                  {% if it.amazon_url %}<a class="tag" href="{{ it.amazon_url }}" target="_blank">Amazon</a>{% endif %}
                  {% if it.mercari_url %}<a class="tag" href="{{ it.mercari_url }}" target="_blank">Mercari</a>{% endif %}
                  {% if it.vinted_url %}<a class="tag" href="{{ it.vinted_url }}" target="_blank">Vinted</a>{% endif %}
                  {% if it.poshmark_url %}<a class="tag" href="{{ it.poshmark_url }}" target="_blank">Poshmark</a>{% endif %}
                  {% if it.depop_url %}<a class="tag" href="{{ it.depop_url }}" target="_blank">Depop</a>{% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if items|length == 0 %}
      <div style="text-align:center;padding:var(--space-5);color:var(--sub)">
        <i class="fas fa-inbox" style="font-size:48px;opacity:0.3;margin-bottom:var(--space-2)"></i>
        <p style="margin:0">No items found in this location.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ===== Modal QR para Locations ===== -->
<div id="qrModal" class="qr-modal hidden" role="dialog" aria-hidden="true" aria-labelledby="qrTitle">
  <div class="qr-sheet">
    <div class="qr-header">
      <strong id="qrTitle"><i class="fas fa-qrcode"></i> QR</strong>
      <div class="qr-actions">
        <a id="qrOpenNew" class="qr-icon" href="#" target="_blank" title="Open in new tab" aria-label="Open in new tab">
          <i class="fas fa-external-link-alt"></i>
        </a>
        <button type="button" id="qrClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="qr-viewport">
        <img id="qrImage" alt="QR code">
      </div>
      <div id="qrCaption" class="qr-tip"></div>
    </div>
  </div>
</div>

<!-- ===== Modal de Imagen Ampliada ===== -->
<div id="imgModal" class="qr-modal hidden" hidden role="dialog" aria-hidden="true" aria-label="Image viewer">
  <div class="qr-sheet" style="max-width:90vw;width:auto">
    <div class="qr-header">
      <strong><i class="fas fa-image"></i> Image</strong>
      <div class="qr-actions">
        <button type="button" id="imgClose" class="qr-icon" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="qr-body">
      <div class="img-viewport">
        <img id="imgModalImg" alt="">
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Modal QR para Locations ===== */
(function(){
  const qrModal   = document.getElementById('qrModal');
  const qrClose   = document.getElementById('qrClose');
  const qrImage   = document.getElementById('qrImage');
  const qrOpenNew = document.getElementById('qrOpenNew');
  const qrCaption = document.getElementById('qrCaption');
  const qrTitle   = document.getElementById('qrTitle');

  function openQrModal(url, caption){
    document.body.classList.add('modal-open');
    qrModal.classList.remove('hidden');
    qrModal.setAttribute('aria-hidden','false');
    qrImage.src = '';
    qrImage.src = url;
    qrOpenNew.href = url;
    qrCaption.textContent = caption || '';
    qrTitle.textContent = caption || 'QR';
  }

  function closeQrModal(){
    document.body.classList.remove('modal-open');
    qrModal.classList.add('hidden');
    qrModal.setAttribute('aria-hidden','true');
    qrImage.src = '';
  }

  document.body.addEventListener('click', (e) => {
    const a = e.target.closest('a.qr-link');
    if (!a) return;
    e.preventDefault();
    const url = a.getAttribute('href');
    const caption = a.getAttribute('data-caption') || a.textContent || 'QR';
    openQrModal(url, caption);
  });

  qrClose?.addEventListener('click', closeQrModal);
  qrModal?.addEventListener('click', (e)=>{ if (e.target === qrModal) closeQrModal(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !qrModal.classList.contains('hidden')) closeQrModal(); });
})();
</script>

<script>
/* ===== Modal de imagen ampliada ===== */
(function(){
  const modal  = document.getElementById('imgModal');
  const imgEl  = document.getElementById('imgModalImg');
  const closeBtn = document.getElementById('imgClose');

  function openImg(url, alt){
    if(!url) return;
    document.body.classList.add('modal-open');
    modal.removeAttribute('hidden');
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden','false');
    imgEl.src = url;
    imgEl.alt = alt || '';
  }

  function closeImg(){
    modal.setAttribute('hidden', '');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    imgEl.src = '';
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.thumb-wrap');
    if(!btn) return;
    const url = btn.getAttribute('data-full');
    const alt = btn.querySelector('img')?.getAttribute('alt') || '';
    openImg(url, alt);
  });

  closeBtn?.addEventListener('click', closeImg);
  modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeImg(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeImg(); });
})();
</script>

{% endblock %}
